<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rentokil OneView</title>
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Universal grid layout engine and widgets registry -->
  <script src="widgets.js"></script>
  <script src="layoutEngine.js"></script>
  <script src="dashboardConfigs.js"></script>
  <script src="roleDefaults.js"></script>
  <script src="src/data/transformers/unifyDeals.js?v=2"></script>
    <!-- Route & Prospect Scout assets for Sales tab embedding -->
    <link rel="stylesheet" href="src/modules/route_scout/styles.css" />
    <script type="module" src="src/modules/route_scout/app.js"></script>
    <!-- SheetJS will be loaded on-demand to avoid ORB blocking -->
    <script>
        async function ensureSheetJs(){
            if (window.XLSX) return true;
            const isLocal = (location.hostname === 'localhost' || location.hostname === '127.0.0.1');
            const sources = [
                '/xlsx/xlsx.full.min.js',
                'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
                'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
            ];

            // Helper to safely load a script with ORB-aware attributes
            const loadScript = (src) => new Promise((resolve) => {
                const s = document.createElement('script');
                s.src = src;
                s.async = true;
                s.crossOrigin = 'anonymous';
                s.referrerPolicy = 'no-referrer';
                s.onload = () => resolve(true);
                s.onerror = () => resolve(false);
                document.head.appendChild(s);
            });

            // Validate local file content before attempting to execute it to avoid SyntaxErrors
            const tryLocalFirst = async () => {
                try {
                    const res = await fetch('/xlsx/xlsx.full.min.js', { cache: 'no-store' });
                    if (!res.ok) return false;
                    const text = await res.text();
                    // Minimal sanity checks for a valid SheetJS bundle (avoid plain text placeholders)
                    const looksJs = /XLSX|sheet_to_json|read\(/.test(text) && /\bvar\b|\bfunction\b|\(function/.test(text);
                    if (!looksJs) return false;
                    // Load via script tag (prefer caching behavior over Blob URL here)
                    return await loadScript('/xlsx/xlsx.full.min.js');
                } catch { return false; }
            };

            // Local preview: try local bundle only to avoid noisy CDN errors
            if (isLocal) {
                const ok = await tryLocalFirst();
                if (ok && window.XLSX) return true;
                console.info('SheetJS not available locally; XLSX features disabled in preview.');
                return !!window.XLSX;
            }

            // Production: attempt CDN sources in order
            for (const key of sources.filter(s => s !== '/xlsx/xlsx.full.min.js')) {
                const ok = await loadScript(key);
                if (ok && window.XLSX) return true;
            }
            console.warn('SheetJS failed to load from CDNs. XLSX-dependent features will be skipped.');
            return !!window.XLSX;
        }
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rentokil-blue': '#005AA7',
                        'brand-color': 'var(--brand-color)',
                        'brand-color-light': 'var(--brand-color-light)',
                        'brand-color-dark': 'var(--brand-color-dark)'
                    },
                    fontFamily: {
                        // Make Tailwind's "font-sans" resolve to our CSS variable
                        sans: ['var(--app-font)', 'ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- PDF.js for parsing uploaded quote PDFs -->
    <!-- PDF.js will be loaded on-demand via ensurePdfJs() with multiple CDN fallbacks and local /pdfjs/ path to avoid ORB blocking. -->
    <script>
            if (window['pdfjsLib']) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.108/build/pdf.worker.min.js';
            }
    </script>
    
    <style>
        /* Custom CSS variables for dynamic branding */
        :root {
            --brand-color: #E4002B;
            --brand-tagline-color: #6D6E71; /* General UI grey */
            --brand-contrast-text-color: #2B2B2B; /* Darker grey for colored backgrounds */
            --brand-body-text-color: #374151; /* Default body text (gray-700) */
            --app-font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            /* Artwork-style icon palette (used when data-fixed-colors="true") */
            /* Black Widow: high-contrast defaults for light theme */
            --widow-body-fill: #111827;          /* gray-900 body for definition on light */
            --widow-outline-stroke: #EF4444;     /* red-500 outline */
            --widow-leg-stroke: #374151;         /* gray-700 legs */
            --widow-mark-fill: #EF4444;          /* red-500 hourglass */
            --widow-stroke-width: 2.4;           /* thicker for readability */
            /* Brown Recluse: high-contrast defaults for light theme */
            --recluse-body-fill: #6B7280;        /* gray-500 body */
            --recluse-outline-stroke: #111827;   /* gray-900 outline */
            --recluse-leg-stroke: #4B5563;       /* gray-600 legs */
            --recluse-mark-stroke: #F59E0B;      /* amber-500 violin mark */
            --recluse-stroke-width: 2.4;         /* thicker for readability */
        }

        /* Dark theme variable overrides for readable text */
        html.theme-dark, body.theme-dark, .theme-dark {
            --brand-body-text-color: #E5E7EB; /* gray-200 */
            --brand-tagline-color: #9CA3AF;  /* gray-400 for secondary text */
            --brand-contrast-text-color: #F9FAFB; /* near-white on brand backgrounds */
            /* Black Widow: dark theme overrides for clarity */
            --widow-body-fill: #F3F4F6;          /* gray-100 body for visibility on dark */
            --widow-outline-stroke: #F87171;     /* red-400 outline */
            --widow-leg-stroke: #D1D5DB;         /* gray-300 legs */
            --widow-mark-fill: #F87171;          /* red-400 hourglass */
            /* Brown Recluse: dark theme overrides */
            --recluse-body-fill: #E5E7EB;        /* gray-200 body */
            --recluse-outline-stroke: #1F2937;   /* gray-800 outline */
            --recluse-leg-stroke: #9CA3AF;       /* gray-400 legs */
            --recluse-mark-stroke: #FBBF24;      /* amber-400 violin */
        }

        /* Custom animations */
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse-red {
            animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes count-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .count-up {
            animation: count-up 0.8s ease-out;
        }
        
        /* Presentation mode styles */
        .presentation-mode {
            background: #111827;
            color: var(--brand-tagline-color);
        }

        /* Universal grid + widget styles */
        :root { --accent-red: #D62828; }
        .universal-grid { grid-auto-flow: dense; }
        .grid-animate .widget-card { transition: transform 180ms ease, width 180ms ease, height 180ms ease, box-shadow 120ms ease; }
        .widget-card { position: relative; user-select: none; transition: transform 160ms ease; border-radius: 12px; }
        .widget-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.08); transform: scale(1.02); }
        /* Header uses theme-aware background via classes, no hardcoded white */
        .widget-card .drag-handle { cursor: grab; display: none; }
        .universal-grid.layout-mode .drag-handle { display: inline-flex; }
        /* Resize handles: sides + corners */
        .resize-handle { position: absolute; background: rgba(0,0,0,0.12); display: none; }
        .universal-grid.layout-mode .resize-handle { display: block; }
        .resize-handle.handle-top { top: -4px; left: 16px; right: 16px; height: 6px; border-radius: 3px; }
        .resize-handle.handle-bottom { bottom: -4px; left: 16px; right: 16px; height: 6px; border-radius: 3px; }
        .resize-handle.handle-left { left: -4px; top: 16px; bottom: 16px; width: 6px; border-radius: 3px; }
        .resize-handle.handle-right { right: -4px; top: 16px; bottom: 16px; width: 6px; border-radius: 3px; }
        .resize-handle.handle-tl { top: -6px; left: -6px; width: 12px; height: 12px; border-radius: 50%; }
        .resize-handle.handle-tr { top: -6px; right: -6px; width: 12px; height: 12px; border-radius: 50%; }
        .resize-handle.handle-bl { bottom: -6px; left: -6px; width: 12px; height: 12px; border-radius: 50%; }
        .resize-handle.handle-br { bottom: -6px; right: -6px; width: 12px; height: 12px; border-radius: 50%; }
        .size-label { position:absolute; top:6px; left:8px; background:rgba(17,24,39,0.85); color:#fff; font-size:11px; padding:2px 6px; border-radius:6px; pointer-events:none; }

        /* Reposition Add Widget to top-right of dashboard area */
        #dashboardContent { position: relative; }
        .add-widget-fab { position: absolute; top: 0; right: 0; z-index: 1001; }
        .add-widget-fab button { box-shadow: 0 10px 20px rgba(0,0,0,0.15); }

        /* Drag/resize visual states */
        .universal-grid.dragging .widget-card { opacity: 0.8; }
        .universal-grid .widget-card.drag-active { opacity: 1; box-shadow: 0 0 0 2px var(--accent-red) inset, 0 0 0 2px var(--accent-red), 0 12px 24px rgba(0,0,0,0.18); z-index: 3; }
        .universal-grid.grid-animate .widget-card { transition: transform 180ms ease, width 180ms ease, height 180ms ease, box-shadow 120ms ease; }

        /* Hide manual refresh buttons; dashboard auto-updates */
        button[onclick="refreshDashboard()"], #mail-refresh { display: none !important; }

        .widget-library-backdrop { position: fixed; inset: 0; background: rgba(17,24,39,0.55); display: none; align-items: center; justify-content: center; z-index: 50; }
        .widget-library-modal { width: 720px; max-width: 90vw; max-height: 80vh; overflow: auto; background: #fff; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.25); }
        .widget-library-modal header { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; }
        .widget-library-modal .filters { padding: 12px 16px; display:flex; gap:8px; align-items:center; border-bottom: 1px solid #e5e7eb; }
        .widget-library-modal .items { padding: 12px 16px; display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
        .widget-library-modal .item { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; display: flex; align-items: center; justify-content: space-between; }
        .widget-library-modal footer { padding: 12px 16px; border-top: 1px solid #e5e7eb; display:flex; align-items:center; justify-content:flex-end; gap: 8px; }

        .presentation-mode .kpi-card {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            border: 1px solid #4b5563;
        }
        
        /* Theme styles */
        .theme-brand {
            --primary: var(--brand-color);
            --primary-light: var(--brand-color-light);
            --secondary: var(--brand-color-dark);
        }

        /* Light theme overrides for Tailwind dark classes */
        [data-theme="light"] body { background-color: #f8fafc !important; color: #111827 !important; }
        [data-theme="light"] #commandBar { background-color: rgba(255,255,255,0.92) !important; border-color: #e5e7eb !important; }
        [data-theme="light"] .bg-gray-800 { background-color: #ffffff !important; color: #111827 !important; }
        [data-theme="light"] .bg-gray-800\/50 { background-color: rgba(255,255,255,0.5) !important; }
        [data-theme="light"] .bg-gray-900\/95 { background-color: rgba(255,255,255,0.95) !important; }
        [data-theme="light"] .hover\:bg-gray-700:hover { background-color: #f3f4f6 !important; }
        [data-theme="light"] .border-gray-700, [data-theme="light"] .border-gray-800 { border-color: #e5e7eb !important; }
        [data-theme="light"] .text-white { color: #111827 !important; }
        [data-theme="light"] #commandPaletteContainer { background: linear-gradient(135deg, #ffffff, #f3f4f6) !important; }

        /* Hide standalone buttons to unify under Actions menu */
        #commandBar button[onclick="openWidgetManager()"],
        #commandBar button[onclick="openSettingsAdminPanel()"] { display: none !important; }
        
.theme-dark {
            --primary: #1f2937;
            --primary-light: #374151;
            --secondary: #6b7280;
            background-color: #111827;
            color: #e5e7eb;
}

.theme-light {
            --primary: #ffffff;
            --primary-light: #f9fafb;
            --secondary: #e5e7eb;
        }

        /* Theme application overrides */
        body { color: var(--brand-body-text-color); }
        body.theme-dark { background-color: #111827; color: #e5e7eb; }
        .theme-dark header { background-color: #1f2937 !important; border-color: #374151 !important; }
        .theme-dark .bg-white { background-color: #1f2937 !important; }
        .theme-dark .bg-gray-50 { background-color: #0f172a !important; }
        .theme-dark .bg-gray-100 { background-color: #111827 !important; }
        .theme-dark .bg-gray-200 { background-color: #1f2937 !important; }
        .theme-dark .text-gray-800 { color: #e5e7eb !important; }
        .theme-dark .text-gray-700 { color: #d1d5db !important; }
        .theme-dark .text-gray-600 { color: #9ca3af !important; }
        .theme-dark .text-gray-500 { color: #9ca3af !important; }
            .theme-dark .border-gray-200 { border-color: #374151 !important; }
            /* Reduce white boxes on logos in dark mode */
            /* Remove blend on logo to preserve brand color accuracy */
  /* Default logos render normally */
  .theme-dark #brandLogo,
  .theme-brand #brandLogo { mix-blend-mode: normal; filter: none; background: transparent; }

  /* Only apply blend for Rentokil image with white box */
  .theme-dark img#brandLogo[src*="Rentokil"],
  .theme-brand img#brandLogo[src*="Rentokil"] {
    mix-blend-mode: normal;
    filter: none;
    background: transparent;
  }
            .theme-dark #logoTextOverlay { z-index: 10; }
            .theme-dark .border-gray-300 { border-color: #4b5563 !important; }
        .theme-dark .hover\:bg-gray-50:hover { background-color: #111827 !important; }

        /* Ensure Settings footer buttons are readable in dark mode */
        .theme-dark #settingsFooter button { color: #E5E7EB !important; border-color: #475569 !important; }
        .theme-dark #settingsFooter button.bg-brand { color: var(--brand-contrast-text-color) !important; }

        /* Form controls in dark theme */
        .theme-dark input,
        .theme-dark select,
        .theme-dark textarea { background-color: #111827 !important; color: #e5e7eb !important; border-color: #374151 !important; }

        /* Hide any stray standalone checkbox directly under Settings modal root */
        #settingsModal > input[type="checkbox"] { display: none !important; }
        .theme-dark input::placeholder,
        .theme-dark textarea::placeholder { color: #9ca3af !important; }

        body.theme-brand { background-color: var(--primary-light); }
        .theme-brand header { background-color: var(--primary) !important; color: var(--brand-tagline-color); }
        .theme-brand .border-gray-200 { border-color: var(--secondary) !important; }

        /* Action menu styles */
        .action-menu { position: relative; }
        .action-menu-panel { position: absolute; right: 0; top: 100%; z-index: 50; }

        /* Dynamic branding support */
        .bg-brand { background-color: var(--brand-color) !important; }
        .text-brand { color: var(--brand-color) !important; }
        .text-tagline { color: var(--brand-tagline-color) !important; }
        .border-brand { border-color: var(--brand-color) !important; }
        .border-tagline { border-color: var(--brand-tagline-color) !important; }
        /* Logo overlay text-shadow utilities */
        .logo-text-shadow-subtle { text-shadow: 0 1px 2px rgba(0, 0, 0, 0.35); }
        .logo-text-shadow-medium { text-shadow: 0 2px 3px rgba(0, 0, 0, 0.5); }
        .logo-text-shadow-strong { text-shadow: 0 3px 5px rgba(0, 0, 0, 0.6); }
        /* Brand ring utility for active nav emphasis */
        .ring-brand { outline: 2px solid var(--brand-color); outline-offset: 2px; }
        /* Scoped override: darker contrast text only on brand background */
        .bg-brand .text-white { color: var(--brand-contrast-text-color) !important; }
        .bg-brand .hover\:text-white:hover { color: var(--brand-contrast-text-color) !important; }
        .bg-brand .border-white { border-color: var(--brand-tagline-color) !important; }

        /* Modal window sizing/resizing */
        .modal-window {
            resize: both;
            overflow: hidden; /* contain content for predictable scrolling */
            position: relative; /* ensure ::after bottom highlight positions to window */
            width: var(--modal-width, min(90vw, 1024px)) !important;
            height: var(--modal-height, min(80vh, 700px)) !important;
            max-width: none !important;
            max-height: none !important;
        }
        /* Disable previous interior hover bar */
        .modal-window.hover-delay-active::after { display: none; }
        /* Neon glow when hovering over resize edges/corners */
        .modal-resize-handle { transition: box-shadow 0.15s ease; }
        .modal-resize-handle:hover {
            box-shadow: 0 0 6px var(--brand-color), 0 0 14px var(--brand-color);
            background: transparent;
        }
        .modal-resize-glow { position: absolute; background: var(--brand-color, #ef4444); opacity: 0; }
        .modal-resize-handle:hover .modal-resize-glow {
            opacity: 1;
            filter: drop-shadow(0 0 6px var(--brand-color)) drop-shadow(0 0 14px var(--brand-color));
        }
        .modal-window .modal-body-scroll { overflow: auto; }
        /* Settings modal should not be resizable */
        #settingsModal .modal-window { resize: none; }
        @media (max-width: 640px) {
            .modal-window { width: calc(100vw - 32px) !important; height: calc(100vh - 32px) !important; }
        }

        /* Sidebar nav animations */
        .nav-btn { position: relative; overflow: hidden; }
        .nav-active { border-left: 3px solid var(--brand-color); }
        .ripple {
            position: absolute;
            width: 8px; height: 8px;
            background: rgba(255,255,255,0.7);
            border-radius: 9999px;
            pointer-events: none;
            transform: translate(-50%, -50%) scale(1);
            animation: ripple-expand 0.6s ease-out forwards;
        }
        @keyframes ripple-expand {
            to { transform: translate(-50%, -50%) scale(30); opacity: 0; }
        }

        /* Pest-themed icon animations */
        .icon { display: inline-block; width: 1.25rem; height: 1.25rem; line-height: 1.25rem; }
        /* Realism: subtle color stroke and depth */
        .icon { filter: drop-shadow(0 1px 1px rgba(0,0,0,0.12)); }
        .nav-btn:hover .icon { filter: drop-shadow(0 2px 2px rgba(0,0,0,0.18)) brightness(1.05) saturate(1.1); }
        .nav-active .icon { filter: drop-shadow(0 2px 3px rgba(0,0,0,0.22)); }
        .icon-click { transform-origin: center; }
        /* Click: more lifelike moves per insect type */
        .nav-active .icon-fly { animation: dart-once 0.8s ease-out 1; }
        .nav-active .icon-scurry { animation: scurry-once 0.9s ease-out 1; }
        .nav-active .icon-skitter { animation: skitter-once 0.9s ease-out 1; }
        .nav-active .icon-spider { animation: drop-once 0.9s ease-out 1; }
        .nav-active .icon-inch { animation: inch-once 1s ease-out 1; }
        .nav-active .icon-chirp { animation: chirp-once 0.8s ease-out 1; }
        .nav-active .icon-swirl { animation: swirl-once 0.8s ease-out 1; }
        /* Hover loops */
        .icon-fly:hover { animation: fly-loop 1.4s ease-in-out infinite; }
        .icon-scurry:hover { animation: scurry-loop 1.2s ease-in-out infinite; }
        .icon-skitter:hover { animation: skitter-loop 1.2s ease-in-out infinite; }
        .icon-spider:hover { animation: spider-loop 1.4s ease-in-out infinite; }
        .icon-inch:hover { animation: inch-loop 1.6s ease-in-out infinite; }
        .icon-chirp:hover { animation: chirp-loop 1s ease-in-out infinite; }
        .icon-swirl:hover { animation: swirl-loop 1.2s ease-in-out infinite; }

        /* Micro-transform animations to make SVGs feel alive */
        svg.icon { transform-box: fill-box; }
        /* Ensure PNG icons inherit font sizing and align like emojis */
        img.icon { width: 1em; height: 1em; vertical-align: -0.15em; object-fit: contain; image-rendering: -webkit-optimize-contrast; }
        /* Treat all PNGs from /Icons/ as emoji-like when used inline */
        img[src^="/Icons/"] { width: 1em; height: 1em; vertical-align: -0.15em; object-fit: contain; image-rendering: -webkit-optimize-contrast; }
        .icon-fly .wings { transform-origin: 12px 10px; }
        .icon-fly:hover .wings { animation: wing-flutter var(--fly-flutter-dur, 0.5s) ease-in-out infinite; animation-delay: var(--fly-flutter-delay, 0s); }
        .nav-active .icon-fly .wings { animation: wing-dart var(--fly-dart-dur, 0.45s) ease-out 1; }
        .icon-fly .body { transform-origin: 12px 12px; }
        .icon-fly:hover .body { animation: body-bob var(--fly-bob-dur, 1.4s) ease-in-out infinite; animation-delay: var(--fly-bob-delay, 0s); }

        .icon-scurry .legs-l, .icon-scurry .legs-r { transform-origin: 12px 13px; }
        .icon-scurry:hover .legs-l { animation: leg-step-l var(--scurry-step-dur, 0.6s) ease-in-out infinite; animation-delay: var(--scurry-step-delay-l, 0s); }
        .icon-scurry:hover .legs-r { animation: leg-step-r var(--scurry-step-dur, 0.6s) ease-in-out infinite; animation-delay: var(--scurry-step-delay-r, 0.1s); }
        .nav-active .icon-scurry .legs-l, .nav-active .icon-scurry .legs-r { animation: leg-splay var(--scurry-splay-dur, 0.5s) ease-out 1; }

        .icon-skitter .legs-l, .icon-skitter .legs-r { transform-origin: 12px 13px; }
        .icon-skitter:hover .legs-l { animation: leg-jitter-l var(--skitter-jitter-dur, 0.4s) ease-in-out infinite; animation-delay: var(--skitter-jitter-delay-l, 0s); }
        .icon-skitter:hover .legs-r { animation: leg-jitter-r var(--skitter-jitter-dur, 0.4s) ease-in-out infinite; animation-delay: var(--skitter-jitter-delay-r, 0.05s); }
        .nav-active .icon-skitter .body { animation: skitter-once 0.9s ease-out 1; }

        .icon-spider .legs, .icon-spider .body { transform-origin: 12px 12px; }
        .icon-spider:hover .legs { animation: spider-legs-loop var(--spider-legs-dur, 1.8s) ease-in-out infinite; animation-delay: var(--spider-legs-delay, 0s); }
        .nav-active .icon-spider .body { animation: drop-once 0.9s ease-out 1; }

        .icon-inch .segments { transform-origin: 12px 14px; }
        .icon-inch:hover .segments { animation: inch-roll var(--inch-roll-dur, 1.6s) ease-in-out infinite; animation-delay: var(--inch-roll-delay, 0s); }
        .nav-active .icon-inch .segments { animation: inch-once 1s ease-out 1; }

        .icon-chirp .wing { transform-origin: 11px 14px; }
        .icon-chirp:hover .wing { animation: chirp-flutter var(--chirp-flutter-dur, 0.9s) ease-in-out infinite; animation-delay: var(--chirp-flutter-delay, 0s); }
        .nav-active .icon-chirp .wing { animation: chirp-once 0.8s ease-out 1; }

        .icon-swirl .wings { transform-origin: 12px 10px; }
        .icon-swirl:hover .wings { animation: swirl-loop var(--swirl-loop-dur, 1.2s) ease-in-out infinite; animation-delay: var(--swirl-loop-delay, 0s); }
        .nav-active .icon-swirl .wings { animation: swirl-once 0.8s ease-out 1; }

        @keyframes wing-flutter { 0%,100% { transform: rotate(0deg) } 50% { transform: rotate(12deg) } }
        @keyframes wing-dart { 0% { transform: rotate(0deg) translate(0,0) } 40% { transform: rotate(18deg) translate(1px,-1px) } 100% { transform: rotate(0deg) translate(0,0) } }
        @keyframes body-bob { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-1px) } }
        @keyframes leg-step-l { 0%,100% { transform: rotate(0deg) } 50% { transform: rotate(10deg) } }
        @keyframes leg-step-r { 0%,100% { transform: rotate(0deg) } 50% { transform: rotate(-10deg) } }
        @keyframes leg-splay { 0% { transform: rotate(0deg) } 100% { transform: rotate(12deg) } }
        @keyframes leg-jitter-l { 0%,100% { transform: rotate(0deg) } 25% { transform: rotate(6deg) } 75% { transform: rotate(-6deg) } }
        @keyframes leg-jitter-r { 0%,100% { transform: rotate(0deg) } 25% { transform: rotate(-6deg) } 75% { transform: rotate(6deg) } }
        @keyframes spider-legs-loop { 0%,100% { transform: rotate(0deg) } 50% { transform: rotate(8deg) } }
        @keyframes inch-roll { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-1px) } }
        @keyframes chirp-flutter { 0%,100% { transform: rotate(0deg) } 50% { transform: rotate(8deg) } }
        /* Keyframes */
        @keyframes fly-loop {
            0% { transform: translate(0,0) rotate(0deg); }
            25% { transform: translate(2px,-2px) rotate(-10deg); }
            50% { transform: translate(-2px,1px) rotate(12deg); }
            75% { transform: translate(1px,-1px) rotate(-8deg); }
            100% { transform: translate(0,0) rotate(0deg); }
        }
        @keyframes dart-once {
            0% { transform: translate(0,0) scale(1); }
            30% { transform: translate(8px,-6px) scale(1.1) rotate(-12deg); }
            60% { transform: translate(-4px,3px) scale(1) rotate(8deg); }
            100% { transform: translate(0,0) scale(1); }
        }
        @keyframes scurry-loop {
            0% { transform: translateX(0) }
            25% { transform: translateX(2px) rotate(2deg) }
            50% { transform: translateX(-2px) rotate(-2deg) }
            75% { transform: translateX(1px) rotate(1deg) }
            100% { transform: translateX(0) }
        }
        @keyframes scurry-once {
            0% { transform: translateX(0) }
            40% { transform: translateX(10px) }
            100% { transform: translateX(0) }
        }
        @keyframes skitter-loop {
            0% { transform: translate(0,0) }
            25% { transform: translate(3px,0) }
            50% { transform: translate(-3px,1px) }
            75% { transform: translate(2px,-1px) }
            100% { transform: translate(0,0) }
        }
        @keyframes skitter-once {
            0% { transform: translate(0,0) }
            30% { transform: translate(8px,1px) }
            60% { transform: translate(-6px,-1px) }
            100% { transform: translate(0,0) }
        }
        @keyframes spider-loop {
            0% { transform: translateY(0) }
            25% { transform: translateY(2px) }
            50% { transform: translateY(-2px) }
            75% { transform: translateY(1px) }
            100% { transform: translateY(0) }
        }
        @keyframes drop-once {
            0% { transform: translateY(-2px) }
            40% { transform: translateY(8px) }
            100% { transform: translateY(0) }
        }
        @keyframes inch-loop {
            0% { transform: translateX(0) }
            50% { transform: translateX(2px) scaleY(1.05) }
            100% { transform: translateX(0) }
        }
        @keyframes inch-once {
            0% { transform: translateX(0) }
            40% { transform: translateX(8px) }
            100% { transform: translateX(0) }
        }
        @keyframes chirp-loop {
            0%,100% { transform: rotate(0deg) }
            50% { transform: rotate(10deg) }
        }
        @keyframes chirp-once {
            0% { transform: rotate(0deg) }
            30% { transform: rotate(12deg) }
            100% { transform: rotate(0deg) }
        }
        @keyframes swirl-loop {
            0% { transform: rotate(0deg) }
            50% { transform: rotate(15deg) }
            100% { transform: rotate(0deg) }
        }
        @keyframes swirl-once {
            0% { transform: rotate(0deg) }
            40% { transform: rotate(20deg) }
            100% { transform: rotate(0deg) }
        }
        .hover\:bg-brand:hover { background-color: var(--brand-color) !important; }
        .hover\:text-brand:hover { color: var(--brand-color) !important; }
        .focus\:ring-brand:focus { --tw-ring-color: var(--brand-color) !important; }

        /* Nav icon visual quality improvements */
        .nav-btn svg.icon {
            shape-rendering: geometricPrecision;
            text-rendering: optimizeLegibility;
            image-rendering: -webkit-optimize-contrast;
        }
        .nav-btn svg.icon *,
        svg.icon * {
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        svg.icon path,
        svg.icon line,
        svg.icon polyline,
        svg.icon circle,
        svg.icon rect {
            vector-effect: non-scaling-stroke;
        }
        svg.icon { stroke-width: 1.75; }

        /* Mail feature icons: micro-animations for lively feel */
        .icon-mail .flap { transform-origin: 12px 7px; }
        .icon-mail:hover .flap { animation: flap-loop 1.2s ease-in-out infinite; }
        .icon-label .tag { transform-origin: 6px 12px; }
        .icon-label:hover .tag { animation: tag-wiggle 1.1s ease-in-out infinite; }
        .icon-label .hole { transform-origin: 6px 12px; }
        .icon-label:hover .hole { animation: hole-pulse 1.1s ease-in-out infinite; }
        .icon-unread .seal { transform-origin: 12px 8px; }
        .icon-unread:hover .seal { animation: seal-bounce 1.2s ease-in-out infinite; }
        .icon-search .glass { transform-origin: 11px 11px; }
        .icon-search:hover .glass { animation: magnify-pulse 1.2s ease-in-out infinite; }
        .icon-page .arrow { transform-origin: 12px 12px; }
        .icon-page:hover .arrow { animation: arrow-wiggle 1s ease-in-out infinite; }
        .icon-thread .bubble { transform-origin: 10px 11px; }
        .icon-thread:hover .bubble { animation: bubble-bounce 1.2s ease-in-out infinite; }
        .icon-compose .pencil { transform-origin: 14px 10px; }
        .icon-compose:hover .pencil { animation: pencil-wiggle 1.1s ease-in-out infinite; }
        .icon-attach .clip { transform-origin: 12px 5px; }
        .icon-attach:hover .clip { animation: clip-swing 1.4s ease-in-out infinite; }
        .icon-send:hover .dart { animation: dart-once 0.8s ease-out 1; }

        @keyframes flap-loop { 0%,100% { transform: rotate(0deg) } 50% { transform: rotate(8deg) } }
        @keyframes tag-wiggle { 0%,100% { transform: rotate(0deg) } 25% { transform: rotate(6deg) } 75% { transform: rotate(-6deg) } }
        @keyframes hole-pulse { 0%,100% { transform: scale(1) } 50% { transform: scale(1.2) } }
        @keyframes seal-bounce { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-1px) } }
        @keyframes magnify-pulse { 0%,100% { transform: scale(1) } 50% { transform: scale(1.08) } }
        @keyframes arrow-wiggle { 0%,100% { transform: translateX(0) } 50% { transform: translateX(1px) } }
        @keyframes bubble-bounce { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-1px) } }
        @keyframes pencil-wiggle { 0%,100% { transform: rotate(0deg) } 50% { transform: rotate(-8deg) } }
        @keyframes clip-swing { 0%,100% { transform: rotate(0deg) } 50% { transform: rotate(10deg) } }

        /* Modal Enhancements */
        .modal-resizable {
            resize: both;
            overflow: auto;
            max-width: 95vw;
            max-height: 85vh;
            min-width: 320px;
            min-height: 240px;
        }
        .scroll-x { overflow-x: auto; }

        /* Settings Panel Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .settings-section {
            border-bottom: 1px solid #e5e7eb;
            padding: 1.5rem;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .settings-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--brand-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: var(--brand-tagline-color);
            background-color: white;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--brand-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .btn-primary {
            background-color: var(--brand-color);
            color: var(--brand-contrast-text-color);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }

        .btn-primary:hover {
            background-color: var(--brand-color-dark);
        }

        .btn-secondary {
            background-color: #6b7280;
            color: var(--brand-contrast-text-color);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-danger {
            background-color: #dc2626;
            color: var(--brand-contrast-text-color);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .system-info {
            background-color: #f9fafb;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .info-label {
            font-weight: 500;
            color: #6b7280;
        }

        .info-value {
            color: #374151;
        }

        .hidden {
            display: none !important;
        }

        /* Ensure native selects and inputs use tagline grey text across light theme */
        select, input, textarea { color: var(--brand-tagline-color); }
    </style>
</head>
        <body class="bg-gray-50 font-sans">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gray-800 flex items-center justify-center z-50">
        <div class="text-center text-tagline">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-tagline mx-auto mb-4"></div>
            <h2 id="loadingTitle" class="text-2xl font-bold">Loading System...</h2>
            <p class="mt-2">Initializing dashboards and metrics</p>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-40 transition-transform duration-300 overflow-y-auto">
            <!-- Logo Area -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col items-center">
        <div id="brandLogoContainer" class="relative w-48 h-48 bg-transparent rounded-lg flex items-center justify-center">
                        <img id="brandLogo" src="" alt="Company Logo" class="w-44 h-44 object-contain" style="display:none;">
                        <span id="brandInitial" class="text-brand font-bold text-8xl">B</span>
                        <!-- Brand-specific tagline inside the logo container, positioned above overlay -->
                        <div id="brandTaglineInner" class="absolute bottom-8 left-1/2 -translate-x-1/2 text-xs text-tagline text-center hidden"></div>
                        <!-- Overlayed Title/Subitle on Logo -->
                        <div id="logoTextOverlay" class="absolute bottom-1 left-1/2 -translate-x-1/2 leading-tight pointer-events-none flex items-center gap-1">
<span id="appTitle" class="text-brand text-sm font-semibold">Rentokil OneView</span>
                            <span id="appSubtitle" class="text-tagline text-[11px]">Streamlined Operations</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Info -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-brand rounded-full flex items-center justify-center">
                        <span id="userInitial" class="text-tagline font-bold">U</span>
                    </div>
                    <div>
                        <p id="userName" class="font-medium text-tagline">Loading...</p>
                        <p id="userRole" class="text-xs text-tagline">Loading...</p>
                    </div>
                    <div id="testModeIndicator" class="hidden mt-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            Test Mode
                        </span>
                        <button onclick="exitTestMode()" class="ml-2 text-xs text-yellow-600 hover:text-yellow-800">
                            Exit
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="p-4 space-y-2" id="sidebarNav">
                <button id="nav-sales" data-view="sales" onclick="showDashboard('sales', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <span class="text-xl" aria-hidden="true">ðŸ¦—</span>
                        <span>Sales</span>
                    </span>
                </button>
<button id="nav-operations" data-view="operations" onclick="showDashboard('operations', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <span class="text-xl" aria-hidden="true">ðŸª³</span>
                        <span>Operations</span>
                    </span>
                </button>
<button id="nav-branch" data-view="branch" onclick="showDashboard('branch', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <svg data-icon-name="moth" class="icon icon-chirp icon-click w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Moth">
                            <title>Moth</title>
                            <defs>
                                <linearGradient id="grad-branch-body" x1="0" y1="0" x2="1" y2="0">
                                    <stop offset="0%" stop-color="currentColor" stop-opacity="0.25" />
                                    <stop offset="100%" stop-color="currentColor" stop-opacity="0.45" />
                                </linearGradient>
                            </defs>
                            <g class="wings">
                                <path d="M12 8c4 0 6 3 3 5-3 2-7 2-9 0" opacity="0.85"></path>
                                <ellipse cx="12" cy="8" rx="3" ry="2" fill="url(#grad-branch-body)" opacity="0.95"></ellipse>
                            </g>
                            <g class="body"><circle cx="12" cy="12" r="1" fill="currentColor" opacity="0.9"></circle></g>
                        </svg>
                        <span>Branch Manager</span>
                    </span>
                </button>
<button id="nav-area" data-view="area" onclick="showDashboard('area', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <svg data-icon-name="asp" class="icon icon-skitter icon-click w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Asp">
                            <title>Roach</title>
                            <defs>
                                <linearGradient id="grad-area-body" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="currentColor" stop-opacity="0.85" />
                                    <stop offset="100%" stop-color="currentColor" stop-opacity="0.55" />
                                </linearGradient>
                            </defs>
                            <g class="body"><ellipse cx="12" cy="13" rx="5" ry="3" fill="url(#grad-area-body)" opacity="0.25"></ellipse></g>
                            <path d="M12 10.8v4.2" opacity="0.85"></path>
                            <g class="legs-l"><path d="M7 10l-3-2M7 16l-3 2" opacity="0.9"></path></g>
                            <g class="legs-r"><path d="M17 10l3-2M17 16l3 2" opacity="0.9"></path></g>
                            <g class="antennae"><path d="M11 11l-2-2M13 11l2-2" opacity="0.7"></path></g>
                        </svg>
                        <span>Area Management</span>
                    </span>
                </button>
<button id="nav-region" data-view="region" onclick="showDashboard('region', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <svg data-icon-name="widow" class="icon icon-spider icon-click w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Black Widow">
                            <title>Spider</title>
                            <defs>
                                <radialGradient id="grad-region-body" cx="50%" cy="50%" r="60%">
                                    <stop offset="0%" stop-color="currentColor" stop-opacity="0.85" />
                                    <stop offset="100%" stop-color="currentColor" stop-opacity="0.45" />
                                </radialGradient>
                            </defs>
                            <g class="body"><circle cx="12" cy="12" r="2" fill="url(#grad-region-body)" opacity="0.9"></circle></g>
                            <g class="legs">
                                <path d="M12 10V6M12 18v-4" opacity="0.9"></path>
                                <path d="M9 11l-3-3M15 11l3-3M9 13l-3 3M15 13l3 3" opacity="0.9"></path>
                                <path d="M10.2 10.8l-2.6-2.2M13.8 10.8l2.6-2.2M10.2 14.2l-2.6 2.2M13.8 14.2l2.6 2.2" opacity="0.9"></path>
                            </g>
                        </svg>
                        <span>Region Management</span>
                    </span>
                </button>
<button id="nav-market" data-view="market" onclick="showDashboard('market', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <svg data-icon-name="mosquito" class="icon icon-fly icon-click w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Fly">
                            <title>Fly</title>
                            <defs>
                                <linearGradient id="grad-market-wings" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="currentColor" stop-opacity="0.15" />
                                    <stop offset="100%" stop-color="currentColor" stop-opacity="0.35" />
                                </linearGradient>
                                <linearGradient id="grad-market-body" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="currentColor" stop-opacity="0.85" />
                                    <stop offset="100%" stop-color="currentColor" stop-opacity="0.55" />
                                </linearGradient>
                            </defs>
                            <g class="wings" opacity="0.7">
                                <ellipse cx="10" cy="10" rx="2.8" ry="2" fill="url(#grad-market-wings)" opacity="0.9"></ellipse>
                                <ellipse cx="14" cy="10" rx="2.8" ry="2" fill="url(#grad-market-wings)" opacity="0.9"></ellipse>
                                <path d="M9.4 9.4c1.2-0.5 2-0.2 2.6 0.5M14.6 9.4c-1.2-0.5-2-0.2-2.6 0.5" opacity="0.5"></path>
                            </g>
                            <g class="body"><ellipse cx="12" cy="12" rx="3.5" ry="2.5" fill="url(#grad-market-body)" opacity="0.28"></ellipse>
                                <circle cx="10.8" cy="10.6" r="0.8" fill="currentColor"></circle>
                                <circle cx="13.2" cy="10.6" r="0.8" fill="currentColor"></circle>
                            </g>
                            <g class="legs-l"><path d="M8 14l-2 2" opacity="0.9"></path></g>
                            <g class="legs-r"><path d="M16 14l2 2" opacity="0.9"></path></g>
                        </svg>
                        <span>Market Management</span>
                    </span>
                </button>
                <!-- Executive tab removed per requirement -->
                <div class="mt-4 mb-2 text-xs uppercase tracking-wide text-gray-500">Leadership</div>
<button id="nav-director" data-view="director" onclick="showDashboard('director', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <span class="text-xl" aria-hidden="true">ðŸ•·ï¸</span>
                <span>Market Sales & Operations Systems Director</span>
                    </span>
                </button>
                <!-- Explore moved below Workspace -->
                <details id="workspaceGroup" class="mt-4 mb-2" open>
                  <summary class="text-xs uppercase tracking-wide text-gray-500 cursor-pointer select-none">Workspace</summary>
<button id="nav-gmail" data-view="gmail" onclick="showDashboard('gmail', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <svg data-icon-name="mail" class="icon icon-mail icon-click w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M3 7h18v10H3z" class="box"></path>
                            <path d="M3 7l9 6 9-6" class="flap"></path>
                        </svg>
                        <span>Mail</span>
                    </span>
                </button>
<button id="nav-drive" data-view="drive" onclick="showDashboard('drive', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <svg data-icon-name="caterpillar" class="icon icon-inch icon-click w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Caterpillar">
                            <title>Caterpillar</title>
                            <defs>
                                <linearGradient id="grad-drive-segment" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="currentColor" stop-opacity="0.9" />
                                    <stop offset="100%" stop-color="currentColor" stop-opacity="0.6" />
                                </linearGradient>
                            </defs>
                            <g class="segments">
                                <path d="M6 14c2 2 10 2 12 0" opacity="0.85"></path>
                                <circle cx="7.2" cy="14" r="1" fill="url(#grad-drive-segment)"></circle>
                                <circle cx="9.6" cy="14" r="1" fill="url(#grad-drive-segment)"></circle>
                                <circle cx="12" cy="14" r="1" fill="url(#grad-drive-segment)"></circle>
                                <circle cx="14.4" cy="14" r="1" fill="url(#grad-drive-segment)"></circle>
                                <circle cx="16.8" cy="14" r="1" fill="url(#grad-drive-segment)"></circle>
                            </g>
                        </svg>
                        <span>Drive</span>
                    </span>
                </button>
<button id="nav-calendar" data-view="calendar" onclick="showDashboard('calendar', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200" data-icon-name="beetle">
                    <span class="inline-flex items-center gap-2">
                        <span class="text-xl" aria-hidden="true">ðŸª²</span>
                        <span>Calendar</span>
                    </span>
                </button>
                
                </details>
                <details id="exploreGroup" class="mt-4 mb-2" open>
                  <summary class="text-xs uppercase tracking-wide text-gray-500 cursor-pointer select-none">Explore</summary>
<button id="nav-insights" data-view="insights" onclick="showDashboard('insights', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <svg data-icon-name="insights" class="icon icon-insights icon-click w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Insights">
                            <title>Insights</title>
                            <defs>
                                <radialGradient id="grad-insights-lens" cx="50%" cy="50%" r="60%">
                                    <stop offset="0%" stop-color="currentColor" stop-opacity="0.35" />
                                    <stop offset="100%" stop-color="currentColor" stop-opacity="0.55" />
                                </radialGradient>
                                <radialGradient id="grad-insights-core" cx="50%" cy="50%" r="60%">
                                    <stop offset="0%" stop-color="currentColor" stop-opacity="0.18" />
                                    <stop offset="100%" stop-color="currentColor" stop-opacity="0.08" />
                                </radialGradient>
                            </defs>
                            <circle cx="10" cy="10" r="5.5" fill="url(#grad-insights-lens)" opacity="0.9"></circle>
                            <circle cx="10" cy="10" r="3.4" fill="url(#grad-insights-core)" opacity="0.9"></circle>
                            <path d="M14.5 14.5 L20 20" opacity="0.9"></path>
                            <path d="M8.2 7.8c1.9-0.9 3.5 0.2 4.1 1.3" opacity="0.6"></path>
                        </svg>
                        <span>Insights</span>
                    </span>
                </button>
<button id="nav-quality" data-view="quality" onclick="showDashboard('quality', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <svg data-icon-name="quality" class="icon icon-quality icon-click w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Quality">
                            <title>Quality</title>
                            <defs>
                                <linearGradient id="grad-quality-badge" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="currentColor" stop-opacity="0.45" />
                                    <stop offset="100%" stop-color="currentColor" stop-opacity="0.25" />
                                </linearGradient>
                            </defs>
                            <path d="M10 4h4" opacity="0.9"></path>
                            <path d="M11 4v4l-3 5v4c0 1 1 2 2 2h6c1 0 2-1 2-2v-4l-3-5V4" opacity="0.9"></path>
                            <rect x="10.5" y="12" width="6" height="4.5" rx="0.8" ry="0.8" fill="url(#grad-quality-badge)" opacity="0.95"></rect>
                            <path d="M10.8 13.2h5.4" opacity="0.6"></path>
                        </svg>
                        <span>Quality</span>
                    </span>
                </button>
<button id="nav-fieldtools" data-view="fieldtools" onclick="showDashboard('fieldtools', event)" class="nav-btn w-full text-left px-4 py-2 rounded-lg text-tagline hover:bg-brand hover:text-white transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <svg data-icon-name="tools" class="icon icon-tools icon-click w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Field Tools">
                            <title>Field Tools</title>
                            <defs>
                                <linearGradient id="grad-tools-screen" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="currentColor" stop-opacity="0.45" />
                                    <stop offset="100%" stop-color="currentColor" stop-opacity="0.25" />
                                </linearGradient>
                            </defs>
                            <rect x="4" y="9" width="16" height="9" rx="1.2" ry="1.2" fill="url(#grad-tools-screen)" opacity="0.95"></rect>
                            <path d="M8 9V7a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" opacity="0.9"></path>
                            <path d="M7 12h10M7 15h10" opacity="0.6"></path>
                        </svg>
                        <span>Field Tools</span>
                    </span>
                </button>
                </details>
            </nav>
            
            
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="ml-64 min-h-screen">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-3">
                            <h1 id="dashboardTitle" class="text-2xl font-bold text-brand">Dashboard</h1>
                            <span id="dashboardTitleIcon" class="inline-flex" aria-hidden="true"></span>
                        </div>
<p id="dashboardSubtitle" class="text-tagline">Welcome to Rentokil OneView</p>
                    </div>
                    <!-- Replaced by unified Command Bar -->
                </div>
            </header>

            <!-- Unified Command Bar (sticky, below header) -->
            <div id="commandBar" class="sticky top-0 z-40 w-full bg-gray-900/95 backdrop-blur-xl border-b-2 border-gray-800">
              <div class="flex items-center justify-between px-6 py-3 max-w-[1600px] mx-auto">
                <!-- Left: Create New -->
                <div class="relative">
                  <button onclick="toggleActionsMenu()" id="createNewBtn" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-[var(--brand-color)] hover:bg-[var(--brand-color-dark)] text-white font-medium transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Create New
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                  </button>
                  <!-- createMenu removed: consolidated into unified Actions menu -->
                </div>

                <!-- Center: View & Sidebar -->
                <div class="flex items-center gap-2">
                  <button onclick="switchView('charts')" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-white transition-all">
                    <div class="flex items-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                      View: Charts
                    </div>
                  </button>
                  <button onclick="actuallyToggleSidebar()" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-white transition-all">
                    <div class="flex items-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                      Toggle Sidebar
                    </div>
                  </button>
                </div>

                <!-- Right: Widgets & Settings -->
                <div class="flex items-center gap-2">
                  <button onclick="openWidgetManager()" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-white transition-all">
                    <div class="flex items-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                      Widgets
                    </div>
                  </button>
                  <button onclick="openSettingsAdminPanel()" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-white transition-all">
                    <div class="flex items-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756.426-1.756 2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                      Settings
                    </div>
                  </button>
                  
                  <!-- Actions Menu -->
                  <div class="relative">
                    <button onclick="toggleActionsMenu()" id="actionsBtn" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-white transition-all">
                      <div class="flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6a1 1 0 110-2 1 1 0 010 2zm0 8a1 1 0 110-2 1 1 0 010 2zm0 8a1 1 0 110-2 1 1 0 010 2z"/></svg>
                        Actions
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                      </div>
                    </button>
                    <div id="actionsMenu" class="absolute right-0 top-full mt-2 w-72 hidden bg-gray-800 rounded-xl border-2 border-[var(--brand-color)] shadow-2xl z-50">
                      <div class="px-4 py-2 text-xs uppercase text-gray-400">Quick</div>
                      <button onclick="openSettingsAdminPanel(); toggleActionsMenu()" class="w-full px-4 py-3 text-left hover:bg-gray-700 flex items-center gap-3 text-white"><span class="text-xl menu-icon" aria-hidden="true">âš™ï¸</span><div><div class="font-medium">Open Settings</div><div class="text-xs text-gray-400">Open Settings & Admin Panel</div></div></button>
                      <button onclick="openWidgetManager(); toggleActionsMenu()" class="w-full px-4 py-3 text-left hover:bg-gray-700 flex items-center gap-3 text-white"><span class="text-xl menu-icon" aria-hidden="true">ðŸ§©</span><div><div class="font-medium">Manage Widgets</div><div class="text-xs text-gray-400">Open Widget Manager</div></div></button>
                      <button onclick="toggleLayoutMode(); toggleActionsMenu()" class="w-full px-4 py-3 text-left hover:bg-gray-700 flex items-center gap-3 text-white"><span class="text-xl menu-icon" aria-hidden="true">âœï¸</span><div><div class="font-medium">Edit Layout</div><div class="text-xs text-gray-400">Rearrange dashboard widgets</div></div></button>
                      <button onclick="openWidgetLibrary(); toggleActionsMenu()" class="w-full px-4 py-3 text-left hover:bg-gray-700 flex items-center gap-3 text-white"><span class="text-xl menu-icon" aria-hidden="true">âž•</span><div><div class="font-medium">Add Widget</div><div class="text-xs text-gray-400">Add widget to dashboard</div></div></button>
                      <div class="px-4 py-2 text-xs uppercase text-gray-400 border-t border-gray-700">View</div>
                      <button onclick="switchView('dashboard'); toggleActionsMenu()" class="w-full px-4 py-2 text-left hover:bg-gray-700 text-white"><span class="menu-icon" aria-hidden="true">ðŸ“Š</span> Dashboard</button>
                      <button onclick="switchView('charts'); toggleActionsMenu()" class="w-full px-4 py-2 text-left hover:bg-gray-700 text-white"><span class="menu-icon" aria-hidden="true">ðŸ“ˆ</span> Charts</button>
                      <button onclick="switchView('table'); toggleActionsMenu()" class="w-full px-4 py-2 text-left hover:bg-gray-700 text-white"><span class="menu-icon" aria-hidden="true">ðŸ“‹</span> Table</button>
                      <div class="px-4 py-2 text-xs uppercase text-gray-400 border-t border-gray-700">System</div>
                      <button onclick="actuallyToggleSidebar(); toggleActionsMenu()" class="w-full px-4 py-3 text-left hover:bg-gray-700 flex items-center gap-3 text-white"><span class="text-xl menu-icon" aria-hidden="true">ðŸ“‘</span><div><div class="font-medium">Toggle Sidebar</div><div class="text-xs text-gray-400">Show or hide sidebar</div></div></button>
                      <button onclick="changeTheme('dark'); toggleActionsMenu()" class="w-full px-4 py-2 text-left hover:bg-gray-700 text-white"><span class="menu-icon" aria-hidden="true">ðŸŒ™</span> Set Theme: Dark</button>
                      <button onclick="changeTheme('light'); toggleActionsMenu()" class="w-full px-4 py-2 text-left hover:bg-gray-700 text-white"><span class="menu-icon" aria-hidden="true">â˜€ï¸</span> Set Theme: Light</button>
                      <button onclick="saveSettingsFromUI(); toggleActionsMenu()" class="w-full px-4 py-2 text-left hover:bg-gray-700 text-white"><span class="menu-icon" aria-hidden="true">ðŸ’¾</span> Save Settings</button>
                      <div class="px-4 py-2 text-xs uppercase text-gray-400 border-t border-gray-700">Brands</div>
                      <button onclick="applyBrandPreset('Rentokil'); toggleActionsMenu()" class="w-full px-4 py-2 text-left hover:bg-gray-700 text-white"><span class="menu-icon" aria-hidden="true">ðŸ·ï¸</span> Set Brand: Rentokil</button>
                      <button onclick="applyBrandPreset('Presto-X'); toggleActionsMenu()" class="w-full px-4 py-2 text-left hover:bg-gray-700 text-white"><span class="menu-icon" aria-hidden="true">ðŸ·ï¸</span> Set Brand: Presto-X</button>
                      <button onclick="applyBrandPreset('Terminix'); toggleActionsMenu()" class="w-full px-4 py-2 text-left hover:bg-gray-700 text-white"><span class="menu-icon" aria-hidden="true">ðŸ·ï¸</span> Set Brand: Terminix</button>
                      <button onclick="resetBrandSettings(); toggleActionsMenu()" class="w-full px-4 py-2 text-left hover:bg-gray-700 text-white"><span class="menu-icon" aria-hidden="true">â™»ï¸</span> Reset Branding</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts View Container (initially hidden) -->
            <div id="chartsView" class="hidden p-6">
              <!-- Charts content goes here; placeholder for view switch -->
            </div>

            <!-- Command Palette Modal -->
            <div id="commandPalette" class="fixed inset-0 z-[100] hidden">
              <div class="absolute inset-0 bg-black/70 backdrop-blur-md" onclick="closeCommandPalette()"></div>
              <div id="commandPaletteContainer" class="absolute top-[15%] left-1/2 -translate-x-1/2 w-[650px] bg-gradient-to-br from-gray-900 to-gray-800 border-2 border-[var(--brand-color)] rounded-2xl shadow-[0_0_60px_rgba(214,45,45,0.45)] overflow-hidden modal-container relative">
                <div id="commandPaletteHeader" class="flex items-center gap-3 px-6 py-4 border-b-2 border-gray-700">
                  <svg class="w-6 h-6 text-[var(--brand-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                  <input type="text" id="commandInput" placeholder="Type a command or search..." class="flex-1 bg-transparent text-white text-lg outline-none placeholder-gray-500" oninput="filterCommands(this.value)" onkeydown="handleCommandKeydown(event)">
                  <kbd class="px-3 py-1 bg-gray-700 rounded text-xs text-gray-400 border border-gray-600">ESC</kbd>
                </div>
                <!-- Resize Handle - Bottom Right Corner -->
                <div id="commandPaletteResize" class="resize-handle absolute bottom-0 right-0 w-8 h-8 cursor-nwse-resize z-10 flex items-center justify-center bg-gradient-to-br from-transparent to-[var(--brand-color)]/30 hover:to-[var(--brand-color)]/60 rounded-tl-xl transition-all duration-200 group">
                  <div class="absolute bottom-1 right-1">
                    <svg class="w-4 h-4 text-gray-400 group-hover:text-[var(--brand-color)] transition-colors" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M14 10l-4 4v-3H7v-2h3V6l4 4z"/>
                      <path d="M10 14l-4-4h3V7h2v3h3l-4 4z" opacity="0.5"/>
                    </svg>
                  </div>
                  <div class="absolute bottom-2 right-2 space-y-1 pointer-events-none">
                    <div class="flex gap-1">
                      <div class="w-1 h-1 rounded-full bg-gray-500 group-hover:bg-[var(--brand-color)]"></div>
                      <div class="w-1 h-1 rounded-full bg-gray-500 group-hover:bg-[var(--brand-color)]"></div>
                    </div>
                    <div class="flex gap-1">
                      <div class="w-1 h-1 rounded-full bg-gray-500 group-hover:bg-[var(--brand-color)]"></div>
                    </div>
                  </div>
                </div>
                <div id="commandResults" class="max-h-[500px] overflow-y-auto"></div>
                <div class="flex items-center justify-between px-6 py-3 bg-gray-800/50 border-t border-gray-700 text-xs text-gray-500">
                  <div class="flex items-center gap-4">
                    <span class="flex items-center gap-1"><kbd class="px-2 py-1 bg-gray-700 rounded">â†‘â†“</kbd> Navigate</span>
                    <span class="flex items-center gap-1"><kbd class="px-2 py-1 bg-gray-700 rounded">â†µ</kbd> Select</span>
                    <span class="flex items-center gap-1"><kbd class="px-2 py-1 bg-gray-700 rounded">ESC</kbd> Close</span>
                  </div>
                  <span>ðŸ’¡ Tip: Use keyboard shortcuts for speed</span>
                </div>
              </div>
            </div>

            <!-- Dashboard Content -->
            <main id="dashboardContent" class="p-6">
                <!-- Dashboard content will be loaded here -->
            </main>
        </div>
    </div>

    <!-- Settings Panel Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center" onclick="settingsOverlayClick(event)">
        <div id="settingsModalContainer" class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 flex flex-col modal-window modal-container relative">
            <div id="settingsModalHeader" class="flex justify-between items-center p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-800">Settings & Admin Panel</h2>
                <button onclick="closeSettingsPanel()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <!-- Quick Controls: Theme + Save -->
            <div class="flex items-center gap-3 px-6 py-4 border-b bg-gray-50">
              <label for="themeSelectSettings" class="text-sm text-gray-700">Theme</label>
              <select id="themeSelectSettings" class="px-3 py-2 border rounded-md">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
              </select>
              <div class="flex-1"></div>
              <button onclick="saveSettingsFromUI()" class="px-4 py-2 rounded-md bg-[var(--brand-color)] text-white hover:bg-[var(--brand-color-dark)]">Save Settings</button>
            </div>
            <!-- Settings Sections Navigation -->
            <div id="settingsSectionsNav" class="px-6 py-3 border-b bg-gray-50 flex flex-wrap gap-2 text-sm">
              <button class="px-2 py-1 border rounded hover:bg-gray-100" onclick="document.getElementById('brandSettingsSection')?.scrollIntoView({behavior:'smooth'})">Brand</button>
              <button class="px-2 py-1 border rounded hover:bg-gray-100" onclick="document.getElementById('logoBuilderSection')?.scrollIntoView({behavior:'smooth'})">Logo Builder</button>
              <button class="px-2 py-1 border rounded hover:bg-gray-100" onclick="document.getElementById('presentationModeSection')?.scrollIntoView({behavior:'smooth'})">Presentation</button>
              <button class="px-2 py-1 border rounded hover:bg-gray-100" onclick="document.getElementById('directorSettingsSection')?.scrollIntoView({behavior:'smooth'})">Director</button>
              <button class="px-2 py-1 border rounded hover:bg-gray-100" onclick="document.getElementById('sidebarIconsSettingsSection')?.scrollIntoView({behavior:'smooth'})">Sidebar Icons</button>
              <button class="px-2 py-1 border rounded hover:bg-gray-100" onclick="document.getElementById('dashboardIconSettingsSection')?.scrollIntoView({behavior:'smooth'})">Dashboard Icon</button>
              <button class="px-2 py-1 border rounded hover:bg-gray-100" onclick="document.getElementById('systemSettingsSection')?.scrollIntoView({behavior:'smooth'})">System</button>
              <button class="px-2 py-1 border rounded hover:bg-gray-100" onclick="document.getElementById('dataManagementSection')?.scrollIntoView({behavior:'smooth'})">Data</button>
              <button class="px-2 py-1 border rounded hover:bg-gray-100" onclick="document.getElementById('pestIconsSection')?.scrollIntoView({behavior:'smooth'})">Pest Icons</button>
            </div>
            <!-- Resize Handle - Bottom Right Corner -->
            <div id="settingsResizeHandle" class="resize-handle absolute bottom-0 right-0 w-8 h-8 cursor-nwse-resize z-10 flex items-center justify-center bg-gradient-to-br from-transparent to-[var(--brand-color)]/30 hover:to-[var(--brand-color)]/60 rounded-tl-xl transition-all duration-200 group">
              <div class="absolute bottom-1 right-1">
                <svg class="w-4 h-4 text-gray-400 group-hover:text-[var(--brand-color)] transition-colors" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M14 10l-4 4v-3H7v-2h3V6l4 4z"/>
                  <path d="M10 14l-4-4h3V7h2v3h3l-4 4z" opacity="0.5"/>
                </svg>
              </div>
              <div class="absolute bottom-2 right-2 space-y-1 pointer-events-none">
                <div class="flex gap-1">
                  <div class="w-1 h-1 rounded-full bg-gray-500 group-hover:bg-[var(--brand-color)]"></div>
                  <div class="w-1 h-1 rounded-full bg-gray-500 group-hover:bg-[var(--brand-color)]"></div>
                </div>
                <div class="flex gap-1">
                  <div class="w-1 h-1 rounded-full bg-gray-500 group-hover:bg-[var(--brand-color)]"></div>
                </div>
              </div>
            </div>
            
            <div class="p-6 flex-1 overflow-y-auto pb-24">
                <!-- Brand Settings -->
                <div class="mb-8" id="brandSettingsSection">
                  <details class="group">
                    <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">Brand Configuration</summary>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium mb-2">Company / Brand</label>
                        <select id="settingsCompanyName" class="w-full px-3 py-2 border rounded-md" onchange="applyBrandPreset(this.value)">
                          <option value="Presto-X">Presto-X</option>
                          <option value="Rentokil">Rentokil</option>
                          <option value="Terminix">Terminix</option>
                          <option value="BugOut">BugOut</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2">Brand Color</label>
                        <input type="color" id="settingsBrandColor" class="w-full h-10 border rounded-md">
                        <div class="mt-2">
                          <label class="block text-xs font-medium mb-1">Quick Colors</label>
                          <div id="brandColorSwatches" class="flex flex-wrap gap-2">
                            <button class="w-8 h-8 rounded border" data-color="#005AA7" style="background:#005AA7" title="Rentokil Blue"></button>
                            <button class="w-8 h-8 rounded border" data-color="#E30613" style="background:#E30613" title="Presto-X Red"></button>
                            <button class="w-8 h-8 rounded border" data-color="#0EA5E9" style="background:#0EA5E9" title="Sky Blue"></button>
                            <button class="w-8 h-8 rounded border" data-color="#22C55E" style="background:#22C55E" title="Green"></button>
                            <button class="w-8 h-8 rounded border" data-color="#F59E0B" style="background:#F59E0B" title="Amber"></button>
                            <button class="w-8 h-8 rounded border" data-color="#7C3AED" style="background:#7C3AED" title="Purple"></button>
                            <button class="w-8 h-8 rounded border" data-color="#374151" style="background:#374151" title="Slate"></button>
                            <button class="w-8 h-8 rounded border" data-color="#111827" style="background:#111827" title="Near Black"></button>
                          </div>
                          <div class="mt-2 flex items-center gap-2">
                            <button onclick="toggleAdvancedColor(true)" class="px-2 py-1 text-xs border rounded">Open Advanced Color Wheel</button>
                            <input type="color" id="settingsBrandColorAdvanced" class="hidden w-16 h-16 rounded-full border" onchange="applyBrandColor(this.value)">
                            <button id="closeAdvancedColorButton" onclick="toggleAdvancedColor(false)" class="hidden px-2 py-1 text-xs border rounded">Close</button>
                          </div>
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2">Tagline/Text Grey</label>
                        <input type="color" id="settingsTaglineColor" class="w-full h-10 border rounded-md" value="#6D6E71">
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2">Primary/Body Text Color</label>
                        <input type="color" id="settingsBodyTextColor" class="w-full h-10 border rounded-md" value="#374151">
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2">Contrast Text (on colored backgrounds)</label>
                        <input type="color" id="settingsContrastTextColor" class="w-full h-10 border rounded-md" value="#2B2B2B">
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2">Logo URL</label>
                        <input type="url" id="settingsLogoUrl" class="w-full px-3 py-2 border rounded-md" placeholder="https://example.com/logo.png">
                      </div>
                      <div class="flex items-center gap-2">
                        <input type="checkbox" id="settingsUseWordmark" class="w-5 h-5">
                        <label for="settingsUseWordmark" class="text-sm font-medium">Use wordmark instead of image (transparent)</label>
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2">Font Family</label>
                        <select id="settingsFontFamily" class="w-full px-3 py-2 border rounded-md" onchange="changeFontFamily(this.value)">
                          <option value="system">System UI</option>
                          <option value="Inter">Inter</option>
                          <option value="Roboto">Roboto</option>
                          <option value="Open Sans">Open Sans</option>
                          <option value="Source Sans 3">Source Sans 3</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2">System Type</label>
                        <select id="settingsSystemType" class="w-full px-3 py-2 border rounded-md">
                          <option value="Rentokil OneView">Rentokil OneView</option>
                          <option value="Service Management">Service Management</option>
                          <option value="Operations Dashboard">Operations Dashboard</option>
                        </select>
                      </div>
                    </div>
                    <button onclick="saveBrandSettings()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Brand Settings</button>
                    <div class="mt-4">
                      <label class="block text-sm font-medium mb-2">Brand Presets</label>
                      <div class="flex flex-wrap gap-2">
                        <button onclick="applyBrandPreset('Presto-X')" class="px-3 py-2 border rounded-md hover:bg-gray-50">Presto-X</button>
                        <button onclick="applyBrandPreset('BugOut')" class="px-3 py-2 border rounded-md hover:bg-gray-50">BugOut</button>
                        <button onclick="applyBrandPreset('Terminix')" class="px-3 py-2 border rounded-md hover:bg-gray-50">Terminix</button>
                        <button onclick="applyBrandPreset('Rentokil')" class="px-3 py-2 border rounded-md hover:bg-gray-50">Rentokil</button>
                        <button onclick="resetBrandSettings()" class="px-3 py-2 border rounded-md hover:bg-gray-50 text-gray-700">Reset Branding</button>
                      </div>
                      <p class="text-xs text-gray-500 mt-2">Selecting a preset updates local settings and previews the theme.</p>
                    </div>
                  </details>
                </div>

                    <!-- Logo Builder -->
                    <div class="mt-8" id="logoBuilderSection">
                        <details class="group">
                            <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">Logo Builder</summary>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="useLogoBuilder" class="w-5 h-5" onchange="toggleLogoBuilder(this.checked)">
                                        <label for="useLogoBuilder" class="text-sm font-medium">Enable Logo Builder</label>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Initials</label>
                                        <input type="text" id="logoInitialsInput" class="w-full px-3 py-2 border rounded-md" placeholder="B" oninput="updateLogoPreview()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Shape</label>
                                        <select id="logoShapeSelect" class="w-full px-3 py-2 border rounded-md" onchange="updateLogoPreview()">
                                            <option value="rounded">Rounded</option>
                                            <option value="circle">Circle</option>
                                            <option value="square">Square</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Background Color</label>
                                            <input type="color" id="logoBgColorInput" class="w-full h-10 border rounded-md" onchange="updateLogoPreview()">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Text Color</label>
                                            <input type="color" id="logoTextColorInput" class="w-full h-10 border rounded-md" onchange="updateLogoPreview()">
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" id="logoBorderToggle" class="w-5 h-5" onchange="updateLogoPreview()">
                                            <label for="logoBorderToggle" class="text-sm">Border</label>
                                        </div>
                                        <input type="color" id="logoBorderColorInput" class="w-16 h-8 border rounded-md" onchange="updateLogoPreview()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Font Size</label>
                                        <input type="range" id="logoFontSizeRange" min="24" max="96" step="2" class="w-full" oninput="updateLogoPreview()">
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" id="logoTextShadowEnabled" class="w-5 h-5" onchange="toggleLogoTextShadow(this.checked)">
                                            <label for="logoTextShadowEnabled" class="text-sm">Text Shadow</label>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Shadow Level</label>
                                            <select id="logoTextShadowLevel" class="w-full px-3 py-2 border rounded-md" onchange="changeLogoTextShadowLevel(this.value)">
                                                <option value="subtle">Subtle</option>
                                                <option value="medium">Medium</option>
                                                <option value="strong">Strong</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="pt-2">
                                        <button type="button" onclick="saveLogoBuilder()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Logo Builder</button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-center">
                                    <div id="logoBuilderPreview" class="w-32 h-32 border border-gray-300 rounded-md flex items-center justify-center bg-white">
                                        <span id="logoBuilderInitial" class="font-bold">B</span>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>

                <!-- Presentation Mode Settings -->
                <div class="mb-8" id="presentationModeSection">
                    <details class="group">
                        <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">Presentation Mode</summary>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Auto-refresh Interval</label>
                            <select id="refreshInterval" class="w-full px-3 py-2 border rounded-md" onchange="updateRefreshInterval(this.value)">
                                <option value="10">10 seconds</option>
                                <option value="30" selected>30 seconds</option>
                                <option value="60">1 minute</option>
                                <option value="300">5 minutes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Animation Speed</label>
                            <select id="animationSpeed" class="w-full px-3 py-2 border rounded-md">
                                <option value="slow">Slow</option>
                                <option value="normal" selected>Normal</option>
                                <option value="fast">Fast</option>
                            </select>
                        </div>
                    </div>
                    </details>
                </div>

                <!-- Director Tools & Preferences -->
                <div class="mb-8" id="directorSettingsSection">
                    <details class="group">
                        <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">Director Tools & Preferences</summary>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Default Director View</label>
                            <select id="directorDefaultView" class="w-full px-3 py-2 border rounded-md">
                                <option value="overview">Rollout Overview</option>
                                <option value="cohorts">Cohorts</option>
                                <option value="trainings">Training Scheduler</option>
                                <option value="targets">Adoption Targets</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Show Advanced Metrics</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="directorShowAdvanced" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Icon Motion Intensity</label>
                            <select id="directorIconMotion" class="w-full px-3 py-2 border rounded-md">
                                <option value="subtle">Subtle</option>
                                <option value="normal" selected>Normal</option>
                                <option value="lively">Lively</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Broadcast on Generate Report</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="directorBroadcastOnReport" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                    <button onclick="saveDirectorSettings()" class="mt-4 px-4 py-2 bg-brand text-white rounded-md hover:bg-opacity-90">Save Director Settings</button>
                    </details>
                </div>

                <!-- Sidebar Icons -->
                <div class="mb-8" id="sidebarIconsSettingsSection">
                    <details class="group">
                        <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">Sidebar Icons</summary>
                        <p class="text-sm text-gray-600 mb-3">Choose insect emojis for each sidebar item. Saved choices apply immediately.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-end gap-2">
                                <label class="block text-sm font-medium mb-2" for="sidebarIcon-sales">Sales</label>
                                <select id="sidebarIcon-sales" class="w-full px-3 py-2 border rounded-md"></select>
                                <span id="sidebarIconPreview-sales" class="inline-block sidebar-icon-preview" aria-label="Sales icon preview"></span>
                            </div>
                            <div class="flex items-end gap-2">
                                <label class="block text-sm font-medium mb-2" for="sidebarIcon-operations">Operations</label>
                                <select id="sidebarIcon-operations" class="w-full px-3 py-2 border rounded-md"></select>
                                <span id="sidebarIconPreview-operations" class="inline-block sidebar-icon-preview" aria-label="Operations icon preview"></span>
                            </div>
                            <div class="flex items-end gap-2">
                                <label class="block text-sm font-medium mb-2" for="sidebarIcon-branch">Branch Manager</label>
                                <select id="sidebarIcon-branch" class="w-full px-3 py-2 border rounded-md"></select>
                                <span id="sidebarIconPreview-branch" class="inline-block sidebar-icon-preview" aria-label="Branch icon preview"></span>
                            </div>
                            <div class="flex items-end gap-2">
                                <label class="block text-sm font-medium mb-2" for="sidebarIcon-area">Area Management</label>
                                <select id="sidebarIcon-area" class="w-full px-3 py-2 border rounded-md"></select>
                                <span id="sidebarIconPreview-area" class="inline-block sidebar-icon-preview" aria-label="Area icon preview"></span>
                            </div>
                            <div class="flex items-end gap-2">
                                <label class="block text-sm font-medium mb-2" for="sidebarIcon-region">Region Management</label>
                                <select id="sidebarIcon-region" class="w-full px-3 py-2 border rounded-md"></select>
                                <span id="sidebarIconPreview-region" class="inline-block sidebar-icon-preview" aria-label="Region icon preview"></span>
                            </div>
                            <div class="flex items-end gap-2">
                                <label class="block text-sm font-medium mb-2" for="sidebarIcon-market">Market Management</label>
                                <select id="sidebarIcon-market" class="w-full px-3 py-2 border rounded-md"></select>
                                <span id="sidebarIconPreview-market" class="inline-block sidebar-icon-preview" aria-label="Market icon preview"></span>
                            </div>
                            <div class="flex items-end gap-2">
                                <label class="block text-sm font-medium mb-2" for="sidebarIcon-director">Director</label>
                                <select id="sidebarIcon-director" class="w-full px-3 py-2 border rounded-md"></select>
                                <span id="sidebarIconPreview-director" class="inline-block sidebar-icon-preview" aria-label="Director icon preview"></span>
                            </div>
                            <div class="flex items-end gap-2">
                                <label class="block text-sm font-medium mb-2" for="sidebarIcon-drive">Drive</label>
                                <select id="sidebarIcon-drive" class="w-full px-3 py-2 border rounded-md"></select>
                                <span id="sidebarIconPreview-drive" class="inline-block sidebar-icon-preview" aria-label="Drive icon preview"></span>
                            </div>
                            <div class="flex items-end gap-2">
                                <label class="block text-sm font-medium mb-2" for="sidebarIcon-calendar">Calendar</label>
                                <select id="sidebarIcon-calendar" class="w-full px-3 py-2 border rounded-md"></select>
                                <span id="sidebarIconPreview-calendar" class="inline-block sidebar-icon-preview" aria-label="Calendar icon preview"></span>
                            </div>
                            <div class="flex items-end gap-2">
                                <label class="block text-sm font-medium mb-2" for="sidebarIcon-gmail">Gmail</label>
                                <select id="sidebarIcon-gmail" class="w-full px-3 py-2 border rounded-md"></select>
                                <span id="sidebarIconPreview-gmail" class="inline-block sidebar-icon-preview" aria-label="Gmail icon preview"></span>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center gap-3">
                            <label class="block text-sm font-medium" for="sidebarIconSize">Icon size</label>
                            <input id="sidebarIconSize" type="range" min="20" max="64" step="1" class="w-48" />
                            <span id="sidebarIconSizeValue" class="text-sm text-gray-600">32px</span>
                        </div>
                        <button onclick="saveSidebarIconSettings()" class="mt-4 px-4 py-2 bg-brand text-white rounded-md hover:bg-opacity-90">Save Sidebar Icons</button>
                    </details>
                </div>

                <!-- Dashboard Title Icon Override -->
                <div class="mb-8" id="dashboardIconSettingsSection">
                    <details class="group">
                        <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">Dashboard Title Icon</summary>
                        <p class="text-sm text-gray-600 mb-3">By default, the header mirrors the active sidebar icon. Choose a custom icon to override just the dashboard title.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-end gap-2">
                                <label class="block text-sm font-medium mb-2" for="dashboardIconOverride">Dashboard icon</label>
                                <select id="dashboardIconOverride" class="w-full px-3 py-2 border rounded-md"></select>
                                <span id="dashboardIconPreview" class="inline-block sidebar-icon-preview" aria-label="Dashboard icon preview"></span>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center gap-3">
                            <label class="block text-sm font-medium" for="dashboardIconSize">Icon size</label>
                            <input id="dashboardIconSize" type="range" min="28" max="96" step="1" class="w-48" />
                            <span id="dashboardIconSizeValue" class="text-sm text-gray-600">48px</span>
                        </div>
                        <button onclick="saveDashboardIconOverride()" class="mt-4 px-4 py-2 bg-brand text-white rounded-md hover:bg-opacity-90">Save Dashboard Icon</button>
                    </details>
                </div>

                <!-- System Settings -->
                <div class="mb-8" id="systemSettingsSection">
                    <details class="group">
                        <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">System Settings</summary>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="font-medium">Dark Mode</label>
                                <p class="text-sm text-gray-600">Enable dark theme for better visibility</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="darkModeToggle" class="sr-only peer" onchange="toggleDarkMode(this.checked)">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="font-medium">Show emojis/icons</label>
                                <p class="text-sm text-gray-600">Turn on to display decorative emojis/icons across the app</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="settingsHideIconsToggle" class="sr-only peer" onchange="setSettingsIconVisibility(!this.checked)">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="font-medium">Auto-save Forms</label>
                                <p class="text-sm text-gray-600">Automatically save form data locally</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="autoSaveToggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="font-medium">Notifications</label>
                                <p class="text-sm text-gray-600">Show desktop notifications for important events</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="notificationsToggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="font-medium">Action Chip Colors</label>
                                <p class="text-sm text-gray-600">Configure color scheme for Next Action chips</p>
                            </div>
                            <select id="chipColorSchemeSelector" class="px-3 py-2 border rounded-md" onchange="setChipColorScheme(this.value)">
                                <option value="default">Default</option>
                                <option value="highcontrast">High Contrast</option>
                                <option value="pastel">Pastel</option>
                                <option value="grayscale">Grayscale</option>
                            </select>
                        </div>
                    </div>
                    </details>
                </div>

                <!-- Dashboard Visibility -->
                <div class="mb-8" id="dashboardVisibilitySection">
                    <details class="group" open>
                        <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">Dashboard Visibility</summary>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center justify-between">
                                <label for="prefsUnifiedTrackerVisible" class="text-sm font-medium">Show Unified Tracker</label>
                                <input type="checkbox" id="prefsUnifiedTrackerVisible" class="w-5 h-5">
                            </div>
                            <!-- Future: add more sections here -->
                        </div>
                        <div class="mt-4">
                            <button id="saveDashboardPrefsBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Dashboard Preferences</button>
                        </div>
                    </details>
                </div>

                <!-- Data Management -->
                <div class="mb-8" id="dataManagementSection">
                    <details class="group">
                        <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">Data Management</summary>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="exportData()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <span class="data-icon" aria-hidden="true">ðŸ“¥</span> Export Data
                        </button>
                        <button onclick="importData()" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">
                            <span class="data-icon" aria-hidden="true">ðŸ“¤</span> Import Data
                        </button>
                        <button onclick="clearCache()" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700">
                            <span class="data-icon" aria-hidden="true">ðŸ—‘ï¸</span> Clear Cache
                        </button>
                        <button onclick="resetSystem()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            <span class="data-icon" aria-hidden="true">âš ï¸</span> Reset System
                        </button>
                    </div>
                    </details>
                </div>

                <!-- Pest Icons (auto-shown when icons are registered) -->
                <div id="pestIconsSection" class="mb-8 hidden">
                    <details class="group" open>
                        <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">Pest Icons</summary>
                        <p class="text-sm text-gray-600 mb-3">Icons preview. Provide SVGs that use <code>currentColor</code> for fill/stroke to follow branding automatically.</p>
                        <div id="pestIconDemoList" class="flex flex-wrap items-center gap-4"></div>
                        <div class="mt-4 p-3 border rounded-md bg-gray-50">
                            <div class="flex flex-col md:flex-row md:items-end gap-3">
                <div class="flex-1">
                    <label class="block text-sm font-medium mb-1">Icon Name</label>
                    <input id="pestIconUploadName" type="text" list="pestNameSuggestions" placeholder="Type a name (e.g., Termite)" class="w-full px-3 py-2 border rounded-md" />
                    <datalist id="pestNameSuggestions">
                        <option value="Bee"></option>
                        <option value="Wasp"></option>
                        <option value="Mosquito"></option>
                        <option value="Spider"></option>
                        <option value="Ant"></option>
                        <option value="Fire Ant"></option>
                        <option value="Termite"></option>
                        <option value="Scorpion"></option>
                        <option value="Moth"></option>
                        <option value="Silverfish"></option>
                        <option value="Caterpillar"></option>
                        <option value="Grasshopper"></option>
                    </datalist>
                    <p class="text-xs text-gray-500 mt-1">You can edit or type a custom icon name. Names appear in the sidebar menus.</p>
                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium mb-1">Upload Icon (SVG/PNG/JPG)</label>
                                    <input id="pestIconUploadFile" type="file" accept="image/svg+xml,image/png,image/jpeg" class="w-full px-3 py-2 border rounded-md" />
                                </div>
                                <div>
                                    <button type="button" onclick="handlePestIconUpload()" class="px-4 py-2 bg-brand text-white rounded-md">Add / Replace Icon</button>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">For best branding, prefer SVGs with <code>fill=&quot;currentColor&quot;</code> or <code>stroke=&quot;currentColor&quot;</code>. Images are tinted using an overlay.</p>
                        </div>
                        <div class="mt-4 p-3 border rounded-md bg-gray-50">
                            <h4 class="text-sm font-semibold mb-2">Manage Uploaded Icons</h4>
                            <div id="pestIconManager" class="flex flex-col gap-2"></div>
                        </div>
                        <div class="mt-4 p-3 border rounded-md bg-gray-50">
                            <h4 class="text-sm font-semibold mb-2">Emoji & Icon Logic</h4>
                            <div class="flex flex-wrap items-center gap-2 mb-3">
                                <button type="button" onclick="(function(){ try { window.resetEmojiRegistry(); } catch(e){} try { initPestIconDemo(); } catch(e){} })()" class="px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Remove All Emojis</button>
                                <button type="button" onclick="(function(){ try { window.reinstallEmojiRegistry(); } catch(e){} try { initPestIconDemo(); } catch(e){} })()" class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Reinstall Default Emojis</button>
                                <button type="button" onclick="(function(){ try { window.open('/backups/Presto-X.html.2025-11-10.bak','_blank'); } catch(e){} })()" class="px-3 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-800">Open Previous Build</button>
                            </div>
                            <div class="flex items-center gap-3">
                                <label for="iconLogicModeSelectPresto" class="text-sm font-medium">Icon Logic Mode</label>
                                <select id="iconLogicModeSelectPresto" onchange="window.setIconLogicMode(this.value)" class="px-2 py-1 border rounded-md">
                                    <option value="current">Current (emoji fallback)</option>
                                    <option value="legacy">Legacy (image-first)</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-3 mt-2">
                                <label for="emojiLikeCheckboxPresto" class="text-sm font-medium">Emoji-like rendering for PNGs</label>
                                <input id="emojiLikeCheckboxPresto" type="checkbox" onchange="window.setEmojiLikeMode(this.checked ? 'on' : 'off')" />
                            </div>
                            <script>
                                document.addEventListener('DOMContentLoaded', function(){
                                    try {
                                        const sel = document.getElementById('iconLogicModeSelectPresto');
                                        if (sel) sel.value = window.iconLogicMode || 'current';
                                        const chk = document.getElementById('emojiLikeCheckboxPresto');
                                        if (chk) chk.checked = (window.emojiLikeMode || 'on') === 'on';
                                    } catch(e) {}
                                });
                            </script>
                        </div>
                    </details>
                </div>
                <script id="pest-icons-support">
                    // Central icon resolver: local, cached PNGs in /public/icons
                    // Uses provided identifiers; supports @2x retina source when available.
                    window.getIcon = function getIcon(name){
                        if (!name) return '/Icons/unknown.png';
                        // Accept names with or without extension; normalize to key without extension
                        const base = String(name).replace(/\.(png|jpg|jpeg|svg)$/i, '');
                        // Prefer registered image URL if available
                        try {
                            const spec = (window.pestIcons || {})[base];
                            if (spec && spec.type === 'img' && typeof spec.url === 'string') {
                                return spec.url; // already correct, may include spaces and proper casing
                            }
                        } catch(_) {}
                        // Map normalized keys to actual filenames in /Icons (Title Case with spaces)
                        const fileMap = {
                            // Pests
                            fireAnt: 'Fire Ant',
                            termite: 'Termite',
                            bee: 'Bee',
                            hornet: 'Hornet',
                            asp: 'Asp',
                            centipede: 'Centipede',
                            millipede: 'Millipede',
                            bedBug: 'Bed Bug',
                            brownRecluse: 'Brown Recluse',
                            mouse: 'Mouse',
                            rat: 'Rat',
                            tick: 'Tick',
                            flea: 'Flea',
                            bat: 'Bat',
                            // App variants
                            gmailDark: 'GMail Mice_Dark',
                            gmailLight: 'GMail Mice_Light',
                            gmailMiceDark: 'GMail Mice_Dark',
                            gmailMiceLight: 'GMail Mice_Light',
                            calendarDark: 'Google Calendar Mice_Dark',
                            calendarLight: 'Google Calendar Mice_Light',
                            calendarMiceDark: 'Google Calendar Mice_Dark',
                            calendarMiceLight: 'Google Calendar Mice_Light',
                            calendarTermites: 'Google Calendar Termites',
                            driveDark: 'Google Drive Ant_Dark',
                            driveLight: 'Google Drive Ant_Light',
                            driveAntDark: 'Google Drive Ant_Dark',
                            driveAntLight: 'Google Drive Ant_Light',
                            gmail: 'Gmail Mouse Chewing',
                            calendar: 'Google Calendar Mice Chewing',
                            drive: 'Google Drive Fire Ant'
                        };
                        const resolved = fileMap[base] || base;
                        return '/Icons/' + encodeURIComponent(resolved) + '.png';
                    };
                    window.getIconSrcSet = function getIconSrcSet(name){
                        // Accept raw or percent-encoded names; always resolve using raw
                        const rawName = decodeURIComponent(String(name || ''));
                        const base = window.getIcon(rawName);
                        // Avoid referencing non-existent @2x assets; use base for both DPRs
                        return base + ' 1x, ' + base + ' 2x';
                    };
                    // Icon logic mode with revert option
                    window.iconLogicMode = window.iconLogicMode || (localStorage.getItem('iconLogicMode') || 'current');
                    // Map emoji to image names only when appropriate; supports legacy revert
                    window.getIconNameFromEmoji = function(emoji){
                        const key = String(emoji || '').trim();
                        if (window.iconLogicMode === 'legacy') {
                            const legacy = {
                                'ðŸž': 'Ladybug',
                                'ðŸª²': 'beetle',
                                'ðŸœ': 'fireAnt',
                                'ðŸ›': 'termite',
                                'ðŸ': 'bee',
                                'ðŸ¦Ÿ': 'mosquito',
                                'ðŸ¦‹': 'butterfly',
                                'ðŸª°': 'fly',
                                'ðŸª±': 'worm',
                                'ðŸ¦‚': 'scorpion',
                                'ðŸ': 'snake',
                                'ðŸ¦Ž': 'lizard',
                                'ðŸ¦—': 'mantis',
                                'ðŸ“Š': 'chart',
                                'âš™ï¸': 'settings',
                                'ðŸ“': 'drive',
                                'ðŸ“…': 'calendar',
                                'âœ‰ï¸': 'gmail'
                            };
                            return legacy[key] || 'beetle';
                        }
                        // Current behavior: avoid forcing mosquito to any image; prefer emoji glyph
                        const current = {
                            'ðŸž': 'Ladybug',
                            'ðŸª²': 'beetle',
                            'ðŸœ': 'fireAnt',
                            'ðŸ›': 'termite',
                            'ðŸ': 'bee',
                            // no mapping for mosquito
                            'ðŸ¦‹': 'butterfly',
                            'ðŸª°': 'fly',
                            'ðŸª±': 'worm',
                            'ðŸ¦‚': 'scorpion',
                            'ðŸ': 'snake',
                            'ðŸ¦Ž': 'lizard',
                            'ðŸ¦—': 'mantis',
                            'ðŸ“Š': 'chart',
                            'âš™ï¸': 'settings',
                            'ðŸ“': 'drive',
                            'ðŸ“…': 'calendar',
                            'âœ‰ï¸': 'gmail'
                        };
                        return current[key] || '';
                    };
                    // Global icon resolver: prefer registered image, otherwise native emoji glyph
                    window.resolveIcon = function resolveIcon(name, emojiText){
                        const isEmoji = !name && String(emojiText || '').trim().length > 0;
                        if (isEmoji) {
                            const pestName = (typeof window.getPestNameFromEmoji === 'function') ? window.getPestNameFromEmoji(emojiText) : null;
                            const spec = pestName && (window.pestIcons || {})[pestName];
                            if (spec) {
                                return { type: spec.type, name: pestName, src: spec.url, srcset: null, text: emojiText };
                            }
                            return { type: 'emoji', text: String(emojiText || '') };
                        }
                        const iconName = String(name || '').trim();
                        if (!iconName) return { type: 'emoji', text: String(emojiText || '') };
                        const src = window.getIcon(iconName);
                        const srcset = window.getIconSrcSet(iconName);
                        return { type: 'img', name: iconName, src, srcset };
                    };

                    // Create icon element; returns <img> for images or <span> for emoji
                    window.createIconImg = function createIconImg(opts){
                        const { name, emoji, title } = (opts || {});
                        const plan = window.resolveIcon(name, emoji);
                        if (plan.type === 'emoji') {
                            const span = document.createElement('span');
                            span.className = 'icon';
                            span.textContent = String(plan.text || '');
                            span.setAttribute('aria-hidden', 'true');
                            return span;
                        }
                        const img = document.createElement('img');
                        img.className = 'icon';
                        img.alt = String(title || name || '');
                        img.decoding = 'async';
                        img.referrerPolicy = 'no-referrer';
                        img.crossOrigin = 'anonymous';
                        img.src = plan.src;
                        if (plan.srcset) img.srcset = plan.srcset;
                        return img;
                    };

                    // Safe migration: keep emoji visible until PNG successfully decodes
                    window.applyIconToElement = function applyIconToElement(el, nameOrEmoji, title){
                        try {
                            if (!el) return false;
                            const text = (el.textContent || '').trim();
                            const chars = Array.from(text);
                            const firstChar = chars[0] || '';
                            const isEmojiInput = /\p{Extended_Pictographic}/u.test(String(nameOrEmoji || ''));
                            const iconName = isEmojiInput ? window.getIconNameFromEmoji(nameOrEmoji) : String(nameOrEmoji || window.getIconNameFromEmoji(firstChar));
                            const descriptiveTitle = title || text;

                            // Build emoji holder to avoid flicker
                            // Wrap only if not already processed
                            if (!el.__iconApplied) {
                                const original = document.createElement('span');
                                original.textContent = firstChar + (chars.length > 1 ? '' : '');
                                original.setAttribute('aria-hidden', 'false');
                                original.style.display = 'inline';

                                const remainder = document.createTextNode(chars.slice(1).join(''));
                                // Replace element contents with [emojiHolder][rest]
                                el.textContent = '';
                                el.appendChild(original);
                                el.appendChild(remainder);
                                el.__emojiHolder = original;
                            }

                            // Prepare icon element: in current mode with emoji input, prefer native glyph
                            const img = (isEmojiInput && window.iconLogicMode === 'current')
                                ? window.createIconImg({ name: null, emoji: nameOrEmoji, title: descriptiveTitle })
                                : window.createIconImg({ name: iconName, title: descriptiveTitle });
                            img.style.display = 'none';
                            el.insertBefore(img, el.__emojiHolder.nextSibling);

                            const markApplied = () => { el.__iconApplied = true; };
                            const showImg = () => {
                                try {
                                    img.style.display = 'inline';
                                    // Hide emoji holder after image is visible
                                    if (el.__emojiHolder) el.__emojiHolder.style.display = 'none';
                                } catch {}
                            };

                            const onFail = () => {
                                try { if (img && img.parentNode) img.parentNode.removeChild(img); } catch {}
                                markApplied();
                                return false;
                            };

                            // Prefer decode(); fallback to onload/onerror
                            if (img.decode) {
                                img.decode().then(() => { showImg(); markApplied(); }).catch(onFail);
                            } else {
                                img.onload = () => { showImg(); markApplied(); };
                                img.onerror = onFail;
                            }
                            return true;
                        } catch(e) {
                            console.warn('applyIconToElement error:', e);
                            return false;
                        }
                    };

                    // Dev-only: scan for missing PNGs and record checklist
                    window.iconChecklist = { scanned: 0, pngPresent: 0, fallback: 0 };
                    window.scanMissingIconsDev = function scanMissingIconsDev(){
                        const isLocal = (location.hostname === 'localhost' || location.hostname === '127.0.0.1');
                        if (!isLocal) return; // only in local preview/dev
                        const names = ['chart','gmail','download','upload','trash','warning'];
                        names.forEach(n => {
                            window.iconChecklist.scanned++;
                            const img = new Image();
                            img.src = window.getIcon(n);
                            img.onload = () => { window.iconChecklist.pngPresent++; };
                            img.onerror = () => {
                                window.iconChecklist.fallback++;
                                console.warn('Missing icon PNG (dev):', n, img.src);
                            };
                        });
                    };

                    // Auto-migrate common emoji-only buttons without changing templates
                    window.autoApplyEmojiIcons = function autoApplyEmojiIcons(){
                        const nodes = Array.from(document.querySelectorAll('button, .btn'));
                        const map = {
                            'ðŸ“Š': 'chart',
                            'âœ‰ï¸': 'gmail',
                            'ðŸ“¥': 'download',
                            'ðŸ“¤': 'upload',
                            'ðŸ—‘ï¸': 'trash',
                            'âš ï¸': 'warning'
                        };
                        nodes.forEach(el => {
                            const txt = (el.textContent || '').trim();
                            const first = Array.from(txt)[0];
                            if (map[first]) {
                                window.applyIconToElement(el, first, txt);
                            }
                        });
                    };

                    document.addEventListener('DOMContentLoaded', function(){
                        try {
                            window.autoApplyEmojiIcons();
                            window.scanMissingIconsDev();
                        } catch {}
                    });

                    // Normalize existing PNG <img> tags from /Icons/ to behave like emojis
                    window.normalizePngIcons = function normalizePngIcons(){
                        try {
                            const imgs = Array.from(document.querySelectorAll('img[src$=".png"]'));
                            imgs.forEach(img => {
                                const src = img.getAttribute('src') || '';
                                if (!src.startsWith('/Icons/')) return; // only treat icons folder
                                // Avoid altering brand-icon wrappers which manage their own sizing
                                if (img.closest('.brand-icon')) return;
                                // Apply emoji-like presentation
                                img.classList.add('icon');
                                // Ensure DPR without relying on missing @2x assets
                                if (!img.srcset) {
                                    try {
                                        img.srcset = src + ' 1x, ' + src + ' 2x';
                                    } catch {}
                                }
                                img.decoding = img.decoding || 'async';
                                img.referrerPolicy = img.referrerPolicy || 'no-referrer';
                                img.crossOrigin = img.crossOrigin || 'anonymous';
                            });
                        } catch(e) { /* noop */ }
                    };
                    document.addEventListener('DOMContentLoaded', function(){
                        try { window.normalizePngIcons(); } catch {}
                    });
                    window.pestIcons = window.pestIcons || {};

                    function registerPestIcon(name, svgString) {
                        window.pestIcons[name] = { type: 'svg', svg: svgString };
                        initPestIconDemo();
                    }

                    function registerPestIconUrl(name, url) {
                        window.pestIcons[name] = { type: 'img', url: url };
                        initPestIconDemo();
                    }

                    // Helper to register image with a friendly display name
                    function registerPestIconUrlWithLabel(name, url, displayName) {
                        try {
                            registerPestIconUrl(name, url);
                            if (window.pestIcons[name]) window.pestIcons[name].displayName = displayName;
                        } catch(e) { /* noop */ }
                    }

                    // --- Background cleaning utilities ---
                    // Detect an approximately uniform background by sampling edges and corners.
                    function estimateUniformBackground(ctx, w, h) {
                        const samples = [];
                        const take = (x, y) => {
                            const d = ctx.getImageData(x, y, 1, 1).data;
                            samples.push([d[0], d[1], d[2], d[3]]);
                        };
                        const step = Math.max(1, Math.floor(Math.min(w, h) / 20));
                        for (let x = 0; x < w; x += step) { take(x, 0); take(x, h - 1); }
                        for (let y = 0; y < h; y += step) { take(0, y); take(w - 1, y); }
                        // Average color
                        const avg = samples.reduce((acc, s) => [acc[0]+s[0], acc[1]+s[1], acc[2]+s[2], acc[3]+s[3]], [0,0,0,0]).map(v => Math.round(v / samples.length));
                        // Compute variance to ensure uniformity
                        const variance = samples.reduce((acc, s) => acc + ((s[0]-avg[0])**2 + (s[1]-avg[1])**2 + (s[2]-avg[2])**2), 0) / samples.length;
                        return { color: avg, variance };
                    }

                    function colorDistanceSq(r1,g1,b1,r2,g2,b2) {
                        const dr = r1 - r2, dg = g1 - g2, db = b1 - b2;
                        return dr*dr + dg*dg + db*db;
                    }

                    // Remove pixels close to the estimated background color and return a data URL
                    function cleanImageUniformBackground(img) {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth || img.width;
                        canvas.height = img.naturalHeight || img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const { color: bg, variance } = estimateUniformBackground(ctx, canvas.width, canvas.height);
                        // If edge colors vary widely, we will still attempt a tolerant clean
                        // but rely on a later flood-fill pass if this removes too little.
                        const data = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const buf = data.data;
                        const tolSq = 80*80; // slightly more tolerant for near-white backdrops
                        const softSq = 110*110; // expand soft edge range to catch halos
                        let cleared = 0;
                        for (let i = 0; i < buf.length; i += 4) {
                            const dSq = colorDistanceSq(buf[i], buf[i+1], buf[i+2], bg[0], bg[1], bg[2]);
                            if (dSq <= tolSq) {
                                buf[i+3] = 0; // fully transparent
                                cleared++;
                            } else if (dSq <= softSq) {
                                // Fade alpha near the boundary to avoid harsh halos
                                const t = (dSq - tolSq) / (softSq - tolSq);
                                buf[i+3] = Math.round(buf[i+3] * t);
                            }
                        }
                        ctx.putImageData(data, 0, 0);
                        return { url: canvas.toDataURL('image/png'), cleared, variance };
                    }

                    // Flood-fill from borders to remove contiguous background even if slightly non-uniform
                    function cleanImageBackgroundFloodFill(img, opts) {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth || img.width;
                        canvas.height = img.naturalHeight || img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const { color: bg } = estimateUniformBackground(ctx, canvas.width, canvas.height);
                        const data = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const buf = data.data;
                        const w = canvas.width, h = canvas.height;
                        const fillTolSq = (opts && opts.fillTolSq) ? opts.fillTolSq : 115*115; // slightly higher tolerance for app art
                        const visited = new Uint8Array(w*h);
                        const q = [];
                        // Seed queue from a thin edge band to reduce risk of touching subject
                        const band = (opts && typeof opts.bandPx === 'number')
                            ? Math.max(1, Math.floor(opts.bandPx))
                            : Math.max(1, Math.floor(Math.min(w,h) * 0.01));
                        for (let x=0; x<w; x++) {
                            for (let y=0; y<band; y++) q.push(y*w + x);              // top band
                            for (let y=h-band; y<h; y++) q.push(y*w + x);            // bottom band
                        }
                        for (let y=0; y<h; y++) {
                            for (let x=0; x<band; x++) q.push(y*w + x);              // left band
                            for (let x=w-band; x<w; x++) q.push(y*w + x);            // right band
                        }
                        let cleared = 0;
                        while (q.length) {
                            const idx = q.pop();
                            if (visited[idx]) continue;
                            visited[idx] = 1;
                            const p = idx*4;
                            const r = buf[p], g = buf[p+1], b = buf[p+2], a = buf[p+3];
                            if (a === 0) continue; // already transparent
                            const dSq = colorDistanceSq(r,g,b,bg[0],bg[1],bg[2]);
                            if (dSq <= fillTolSq) {
                                buf[p+3] = 0; cleared++;
                                // push neighbors (4-connected)
                                const x = idx % w, y = (idx - x) / w;
                                if (x>0) q.push(idx-1);
                                if (x<w-1) q.push(idx+1);
                                if (y>0) q.push(idx-w);
                                if (y<h-1) q.push(idx+w);
                            }
                        }
                        // Alpha trim: drop faint edge halos
                        const trimThresh = (opts && typeof opts.alphaTrim === 'number') ? opts.alphaTrim : 14;
                        if (trimThresh > 0) {
                            for (let i = 0; i < buf.length; i += 4) {
                                if (buf[i+3] <= trimThresh) buf[i+3] = 0;
                            }
                        }
                        ctx.putImageData(data, 0, 0);
                        return { url: canvas.toDataURL('image/png'), cleared };
                    }

                    // Load an image URL, clean background if uniform, then register by name.
                    function cleanAndRegisterIcon(name, url, displayName) {
                        return new Promise((resolve) => {
                            try {
                                const img = new Image();
                                img.crossOrigin = 'anonymous';
                                img.onload = () => {
                                    let finalUrl = url;
                                    try {
                                        const firstPass = cleanImageUniformBackground(img);
                                        // If uniform pass barely cleared anything or variance is high, try flood fill
                                        const iw = img.naturalWidth || img.width || 1;
                                        const ih = img.naturalHeight || img.height || 1;
                                        if (!firstPass || firstPass.cleared < (iw*ih*0.02) || firstPass.variance > 1200) {
                                            // Use slightly stronger flood-fill for calendar/mail art
                                            const isAppArt = (name === 'calendar' || name === 'mail' || /Google\s+Calendar|Gmail/i.test(String(displayName)));
                                            const secondPass = cleanImageBackgroundFloodFill(img, {
                                                fillTolSq: isAppArt ? 130*130 : 115*115,
                                                bandPx: isAppArt ? 2 : undefined,
                                                alphaTrim: 16
                                            });
                                            // Safeguard: only accept flood-fill if majority cleared are near edges
                                            if (secondPass && secondPass.cleared > (iw*ih*0.01)) {
                                                finalUrl = secondPass.url;
                                            } else {
                                                finalUrl = firstPass ? firstPass.url : url;
                                            }
                                        } else {
                                            finalUrl = firstPass.url;
                                        }
                                    } catch(e) { finalUrl = url; }
                                    registerPestIconUrlWithLabel(name, finalUrl, displayName);
                                    try { window.dispatchEvent(new CustomEvent('brand:updated')); } catch(e) {}
                                    resolve(true);
                                };
                                img.onerror = () => {
                                    // Do NOT register a broken URL; allow emoji fallback
                                    try { console.warn('Icon failed to load:', name, url); } catch(_) {}
                                    try { window.dispatchEvent(new CustomEvent('brand:updated')); } catch(e) {}
                                    resolve(false);
                                };
                                img.src = url;
                            } catch(e) {
                                // Do not register on exception; allow emoji fallback
                                try { console.warn('Icon registration error:', name, e); } catch(_) {}
                                try { window.dispatchEvent(new CustomEvent('brand:updated')); } catch(_) {}
                                resolve(false);
                            }
                        });
                    }

                    // Convert a raw label to a normalized registry key (camelCase)
                    function normalizeIconName(label) {
                        const s = String(label || '').trim();
                        if (!s) return '';
                        // Remove extension, non-letter/space/dash
                        let base = s.replace(/\.[a-zA-Z0-9]+$/,'');
                        base = base.replace(/[_]+/g,' ');
                        // Title-case words then camelCase key
                        const words = base.split(/[^a-zA-Z0-9]+/).filter(Boolean);
                        if (words.length === 0) return '';
                        const titled = words.map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
                        const camel = titled[0].toLowerCase() + titled.slice(1).map(w => w).join('');
                        return camel;
                    }

                    // Title-case with spaces from a registry key like "bedBug" -> "Bed Bug"
                    function toTitleWithSpaces(name) {
                        const s = String(name || '');
                        if (!s) return '';
                        // Insert space before capitals, then title-case
                        const spaced = s.replace(/([a-z])([A-Z])/g, '$1 $2').replace(/[-_]+/g,' ');
                        return spaced.split(' ').filter(Boolean).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    }

                    // New: register emoji icons
                    function registerPestEmoji(name, emojiChar) {
                        window.pestIcons[name] = { type: 'emoji', emoji: emojiChar };
                        initPestIconDemo();
                    }
                    // Utilities: reset and reinstall emoji registry
                    window.resetEmojiRegistry = function resetEmojiRegistry(){
                        try {
                            const reg = window.pestIcons || {};
                            let removed = 0;
                            Object.keys(reg).forEach(k => {
                                const v = reg[k];
                                if (v && v.type === 'emoji') { delete reg[k]; removed++; }
                            });
                            try { window.dispatchEvent(new CustomEvent('brand:updated')); } catch(e) {}
                            return removed;
                        } catch(e) { return 0; }
                    };
                    window.reinstallEmojiRegistry = function reinstallEmojiRegistry(){
                        try {
                            const defaultEmojiMap = {
                                bee: 'ðŸ',
                                wasp: 'ðŸ',
                                mosquito: 'ðŸ¦Ÿ',
                                spider: 'ðŸ•·',
                                widow: 'ðŸ•¸ï¸',
                                caterpillar: 'ðŸ›',
                                moth: 'ðŸ¦‹',
                                silverfish: 'ðŸª°',
                                ant: 'ðŸœ',
                                beetle: 'ðŸª²',
                                roach: 'ðŸª³',
                                grasshopper: 'ðŸ¦—',
                                calendar: 'ðŸ“…',
                                mail: 'âœ‰ï¸'
                            };
                            Object.entries(defaultEmojiMap).forEach(([name, emoji]) => {
                                try { registerPestEmoji(name, emoji); } catch(_) {}
                            });
                            try { window.dispatchEvent(new CustomEvent('brand:updated')); } catch(e) {}
                        } catch(e) { /* noop */ }
                    };
                    window.setIconLogicMode = function setIconLogicMode(mode){
                        const val = (mode === 'legacy') ? 'legacy' : 'current';
                        try { localStorage.setItem('iconLogicMode', val); } catch(e) {}
                        window.iconLogicMode = val;
                        try { window.dispatchEvent(new CustomEvent('brand:updated')); } catch(e) {}
                    };
                    window.emojiLikeMode = window.emojiLikeMode || (localStorage.getItem('emojiLikeMode') || 'off');
                    window.setEmojiLikeMode = function setEmojiLikeMode(mode){
                        const val = (mode === 'off') ? 'off' : 'on';
                        try { localStorage.setItem('emojiLikeMode', val); } catch(e) {}
                        window.emojiLikeMode = val;
                        try { window.dispatchEvent(new CustomEvent('brand:updated')); } catch(e) {}
                    };

                    function getPestIconElement(name, options) {
                        options = options || {};
                        let inlineEmojiLike = !!options.inlineEmojiLike; // render PNG as 1em inline emoji
                        // Resolve theme-aware variants for app icons when available
                        let resolvedName = name;
                        let spec = window.pestIcons[name];
                        try {
                            const isDark = document.documentElement.classList.contains('theme-dark') || document.body.classList.contains('theme-dark');
                            const themedCandidates = {
                                gmail: isDark ? 'gmailDark' : 'gmailLight',
                                mail: isDark ? 'gmailDark' : 'gmailLight',
                                calendar: isDark ? 'calendarDark' : 'calendarLight',
                                drive: isDark ? 'driveDark' : 'driveLight'
                            };
                            const candidate = themedCandidates[name];
                            if (candidate && window.pestIcons[candidate]) {
                                resolvedName = candidate;
                                spec = window.pestIcons[resolvedName];
                            }
                        } catch(e) { /* noop */ }
                        const size = options.size || 24;
                        const variant = options.variant || 'primary';
                        const tintOpacity = options.tintOpacity != null ? options.tintOpacity : 0.0;
                        const fixedColors = !!options.fixedColors; // when true, do not tint image/SVG

                        const wrapper = document.createElement('span');
                        wrapper.className = inlineEmojiLike ? 'emoji-like' : 'brand-icon';
                        if (variant === 'accent') wrapper.classList.add('accent');
                        if (variant === 'contrast') wrapper.classList.add('contrast');
                        if (!inlineEmojiLike) {
                            wrapper.style.setProperty('--icon-size', size + 'px');
                        } else {
                            // inline emoji-like uses font-size scaling; only set when explicitly provided
                            if (options.sizeEm != null) {
                                wrapper.style.fontSize = options.sizeEm + 'em';
                            } else if (options.size != null) {
                                wrapper.style.fontSize = options.size + 'px';
                            }
                        }
                        if (variant === 'accent') {
                            wrapper.style.color = 'var(--brand-accent)';
                        } else if (variant === 'contrast') {
                            wrapper.style.color = 'var(--brand-contrast-text-color)';
                        } else {
                            wrapper.style.color = 'var(--brand-color)';
                        }
                        wrapper.style.setProperty('--icon-tint-opacity', String(tintOpacity));

                        if (!spec) {
                            const missing = document.createElement('span');
                            missing.className = 'text-xs text-gray-400';
                            missing.textContent = '(missing icon)';
                            wrapper.appendChild(missing);
                            return wrapper;
                        }

                        // Default inline mode from global when not explicitly provided
                        // Respect explicit sizing: only default to emoji-like when no size is specified
                        if (!options.hasOwnProperty('inlineEmojiLike')) {
                            const noExplicitSize = (options.size == null && options.sizeEm == null);
                            if (window.emojiLikeMode === 'on' && spec && spec.type === 'img' && noExplicitSize) inlineEmojiLike = true;
                        }
                        if (spec.type === 'svg' && !inlineEmojiLike) {
                            wrapper.innerHTML = spec.svg;
                            const svg = wrapper.querySelector('svg');
                            if (svg) {
                                svg.style.width = 'var(--icon-size)';
                                svg.style.height = 'var(--icon-size)';
                                if (fixedColors) {
                                    svg.setAttribute('data-fixed-colors', 'true');
                                    wrapper.setAttribute('data-fixed-colors', 'true');
                                }
                            }
                        } else if (spec.type === 'img') {
                            const img = document.createElement('img');
                            img.src = spec.url;
                            try {
                                if (typeof spec.url === 'string' && spec.url.indexOf('/Icons/') === 0) {
                                    const file = spec.url.replace(/^\/Icons\//,'').replace(/\.png$/i,'');
                                    img.srcset = window.getIconSrcSet(file);
                                }
                            } catch(_) { /* noop */ }
                            img.decoding = 'async';
                            img.loading = 'eager';
                            img.alt = (resolvedName || name) + ' icon';
                            if (!inlineEmojiLike) {
                                img.style.width = 'var(--icon-size)';
                                img.style.height = 'var(--icon-size)';
                            } else {
                                img.style.width = '1em';
                                img.style.height = '1em';
                                img.style.verticalAlign = 'middle';
                            }
                            img.style.objectFit = 'contain';
                            wrapper.appendChild(img);
                            if (!fixedColors && !inlineEmojiLike) {
                                const overlay = document.createElement('span');
                                overlay.className = (variant === 'contrast') ? 'brand-icon-contrast-overlay' : 'brand-icon-color-overlay';
                                wrapper.appendChild(overlay);
                            } else {
                                wrapper.setAttribute('data-fixed-colors', 'true');
                            }
                        } else if (spec.type === 'emoji') {
                            // Render native emoji glyph with consistent sizing
                            const span = document.createElement('span');
                            span.textContent = String(spec.emoji || '');
                            span.style.fontSize = inlineEmojiLike ? '1em' : 'var(--icon-size)';
                            span.style.lineHeight = 1;
                            wrapper.setAttribute('data-fixed-colors', 'true');
                            wrapper.appendChild(span);
                        }
                        return wrapper;
                    }

                    // Copy PNG icon image to clipboard (with Safari-friendly fallback)
                    window.copyPestIconImage = async function copyPestIconImage(name) {
                        try {
                            const spec = (window.pestIcons || {})[name];
                            let url = '';
                            if (spec && spec.type === 'img' && typeof spec.url === 'string') {
                                url = spec.url;
                            } else {
                                url = window.getIcon(name);
                            }
                            const res = await fetch(url);
                            const blob = await res.blob();
                            const item = new ClipboardItem({ ['image/png']: blob });
                            await navigator.clipboard.write([item]);
                            return true;
                        } catch (err) {
                            // Fallback: draw to canvas and copy data URL as text
                            try {
                                const img = new Image();
                                img.crossOrigin = 'anonymous';
                                img.src = window.getIcon(name);
                                await new Promise((resolve, reject) => {
                                    img.onload = resolve;
                                    img.onerror = reject;
                                });
                                const canvas = document.createElement('canvas');
                                canvas.width = img.naturalWidth || 32;
                                canvas.height = img.naturalHeight || 32;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);
                                const dataUrl = canvas.toDataURL('image/png');
                                await navigator.clipboard.writeText(dataUrl);
                                return true;
                            } catch (_) {
                                return false;
                            }
                        }
                    };

                    function initPestIconDemo() {
                        const list = document.getElementById('pestIconDemoList');
                        const section = document.getElementById('pestIconsSection');
                        if (!list || !section) return;

                        const names = Object.keys(window.pestIcons || {});
                        if (names.length === 0) {
                            section.classList.add('hidden');
                            list.innerHTML = '';
                            return;
                        }

                        section.classList.remove('hidden');
                        list.innerHTML = '';
                        names.forEach((n) => {
                            const item = document.createElement('div');
                            item.className = 'flex items-center gap-2';
                            const iconEl = getPestIconElement(n, { size: 28, fixedColors: true });
                            const label = document.createElement('span');
                            label.className = 'text-sm text-gray-600';
                            label.textContent = n;
                            const copyBtn = document.createElement('button');
                            copyBtn.type = 'button';
                            copyBtn.textContent = 'Copy';
                            copyBtn.className = 'text-xs px-2 py-1 border rounded';
                            copyBtn.addEventListener('click', async () => {
                                copyBtn.disabled = true;
                                const ok = await window.copyPestIconImage(n);
                                copyBtn.textContent = ok ? 'Copied!' : 'Failed';
                                setTimeout(() => { copyBtn.textContent = 'Copy'; copyBtn.disabled = false; }, 1200);
                            });
                            item.appendChild(iconEl);
                            item.appendChild(label);
                            item.appendChild(copyBtn);
                            list.appendChild(item);
                        });
                    }

                    document.addEventListener('DOMContentLoaded', initPestIconDemo);
                </script>
                <style id="pest-icons-style">
                    .brand-icon { display:inline-block; position:relative; line-height:0; color: var(--brand-color); }
                    .brand-icon.accent { color: var(--brand-accent); }
                    .brand-icon.contrast { color: var(--brand-contrast-text-color); }
.brand-icon svg { width: var(--icon-size, 24px); height: var(--icon-size, 24px); }
/* Preserve explicit icon colors when data-fixed-colors is present */
.brand-icon svg:not([data-fixed-colors="true"]) [fill] { fill: currentColor !important; }
.brand-icon svg:not([data-fixed-colors="true"]) [stroke] { stroke: currentColor !important; }
.brand-icon img { width: var(--icon-size, 24px); height: var(--icon-size, 24px); display:block; image-rendering:-webkit-optimize-contrast; image-rendering:crisp-edges; }
.brand-icon .brand-icon-color-overlay { position:absolute; inset:0; background: currentColor; mix-blend-mode: multiply; opacity: var(--icon-tint-opacity, 0.35); pointer-events:none; }
.brand-icon .brand-icon-contrast-overlay { position:absolute; inset:0; background: currentColor; mix-blend-mode: screen; opacity: var(--icon-tint-opacity, 0.25); pointer-events:none; }
/* Fixed-color icons should render exactly as-provided â€” no glow */
                    .brand-icon[data-fixed-colors="true"] img,
                    .brand-icon[data-fixed-colors="true"] svg { filter: none !important; }
                    /* Ensure dark theme also has no glow */
                    html.theme-dark .brand-icon[data-fixed-colors="true"] img,
                    html.theme-dark .brand-icon[data-fixed-colors="true"] svg { filter: none !important; }
                    /* Guard: overlays must not appear for fixed-color icons */
                    .brand-icon[data-fixed-colors="true"] .brand-icon-color-overlay,
                    .brand-icon[data-fixed-colors="true"] .brand-icon-contrast-overlay { display: none !important; }

                    /* Emoji-like inline image rendering (mimic OS emoji metrics) */
                    .emoji-like { display:inline-block; width:1em; height:1em; line-height:1; vertical-align:-0.12em; font-size: var(--icon-size, 1em); }
                    .emoji-like img { width:1em; height:1em; object-fit:contain; display:inline-block; image-rendering:-webkit-optimize-contrast; image-rendering:crisp-edges; filter:none !important; }
                    html.theme-dark .emoji-like img, html.theme-light .emoji-like img { filter:none !important; }

                    /* Stronger, wrapper-level animations for emoji-based nav icons â€” hover only */
                    .nav-btn:hover .icon-fly .brand-icon { animation: nav-fly-bob var(--fly-bob-dur, 1.2s) ease-in-out infinite; }
                    .nav-btn:hover .icon-scurry .brand-icon { animation: nav-scurry var(--scurry-step-dur, 0.7s) linear infinite; }
                    .nav-btn:hover .icon-skitter .brand-icon { animation: nav-skitter var(--skitter-jitter-dur, 0.6s) ease-in-out infinite; }
                    .nav-btn:hover .icon-spider .brand-icon { animation: nav-spider var(--spider-legs-dur, 1.8s) ease-in-out infinite; }
                    .nav-btn:hover .icon-inch .brand-icon { animation: nav-inch var(--inch-roll-dur, 1.4s) ease-in-out infinite; }
                    .nav-btn:hover .icon-chirp .brand-icon { animation: nav-chirp var(--chirp-flutter-dur, 1.0s) ease-in-out infinite; }
                    .nav-btn:hover .icon-swirl .brand-icon { animation: nav-swirl var(--swirl-loop-dur, 1.2s) ease-in-out infinite; }

                    /* Hover-only animations for SVG icons: Insights, Quality, Field Tools */
                    .nav-btn .icon-insights,
                    .nav-btn .icon-quality,
                    .nav-btn .icon-tools {
                      transition: transform 0.18s ease, filter 0.18s ease;
                      will-change: transform;
                    }
                    .nav-btn:hover .icon-insights { animation: nav-insights 0.9s ease-in-out infinite; }
                    .nav-btn:hover .icon-quality { animation: nav-quality 0.9s ease-in-out infinite; }
                    .nav-btn:hover .icon-tools { animation: nav-tools 0.9s ease-in-out infinite; }

                    @keyframes nav-insights {
                      0% { transform: translateY(0) scale(1); }
                      50% { transform: translateY(-2px) scale(1.06) rotate(2deg); }
                      100% { transform: translateY(0) scale(1); }
                    }
                    @keyframes nav-quality {
                      0% { transform: scale(1); }
                      40% { transform: scale(1.08) rotate(-2deg); }
                      60% { transform: scale(1.08) rotate(2deg); }
                      100% { transform: scale(1); }
                    }
                    @keyframes nav-tools {
                      0% { transform: rotate(0deg); }
                      50% { transform: rotate(6deg); }
                      100% { transform: rotate(0deg); }
                    }

                    /* Hover intensifier */
.nav-btn:hover .brand-icon { filter: drop-shadow(0 0 6px var(--icon-accent, currentColor)); transform: translateY(-1px); }
/* Do not apply brand glow/transform to fixed-color icons (e.g., Google app art) */
.nav-btn:hover .brand-icon[data-fixed-colors="true"] { filter: none; transform: none; }

                    @keyframes nav-fly-bob {
                      0% { transform: translateY(0) rotate(0deg); }
                      50% { transform: translateY(calc(3px * var(--fly-amp, 1))) rotate(calc(5deg * var(--fly-amp, 1))); }
                      100% { transform: translateY(0) rotate(0deg); }
                    }
                    @keyframes nav-scurry {
                      0% { transform: translateX(0); }
                      25% { transform: translateX(calc(2px * var(--scurry-amp, 1))); }
                      75% { transform: translateX(calc(-2px * var(--scurry-amp, 1))); }
                      100% { transform: translateX(0); }
                    }
                    @keyframes nav-skitter {
                      0% { transform: translate(0,0); }
                      33% { transform: translate(calc(1px * var(--skitter-amp, 1)), calc(-1px * var(--skitter-amp, 1))); }
                      66% { transform: translate(calc(-1px * var(--skitter-amp, 1)), calc(1px * var(--skitter-amp, 1))); }
                      100% { transform: translate(0,0); }
                    }
                    @keyframes nav-spider {
                      0% { transform: scale(1); }
                      50% { transform: scale(calc(1 + 0.06 * var(--spider-amp, 1))); }
                      100% { transform: scale(1); }
                    }
                    @keyframes nav-inch {
                      0% { transform: translateX(0) scale(1); }
                      50% { transform: translateX(calc(2px * var(--inch-amp, 1))) scale(calc(1.04 * var(--inch-amp, 1))); }
                      100% { transform: translateX(0) scale(1); }
                    }
                    @keyframes nav-chirp {
                      0% { transform: rotate(0deg); }
                      50% { transform: rotate(calc(8deg * var(--chirp-amp, 1))); }
                      100% { transform: rotate(0deg); }
                    }
                    @keyframes nav-swirl {
                      0% { transform: rotate(0deg) scale(1); }
                      50% { transform: rotate(calc(14deg * var(--swirl-amp, 1))) scale(calc(1.05 * var(--swirl-amp, 1))); }
                      100% { transform: rotate(0deg) scale(1); }
                    }
                </style>
                <script id="pest-icons-nav-replace">
                    function replaceNavIconsWithRegistered() {
                        const ENLARGE_RATIO = 1.33; // default: slightly larger than base for visibility
                        const ENLARGE_RATIO_MAIL = 1.66; // Gmail: make sidebar icon larger
                        const iconMap = {
                            asp: { name: 'asp', variant: 'primary' },
                            bee: { name: 'bee', variant: 'primary' },
                            wasp: { name: 'wasp', variant: 'accent' },
                            mosquito: { name: 'mosquito', variant: 'primary' },
                            spider: { name: 'spider', variant: 'primary' },
                            caterpillar: { name: 'caterpillar', variant: 'primary' },
                            moth: { name: 'moth', variant: 'accent' },
                            silverfish: { name: 'silverfish', variant: 'primary' },
                            ant: { name: 'ant', variant: 'primary' },
                            beetle: { name: 'beetle', variant: 'primary' },
                            roach: { name: 'roach', variant: 'primary' },
                            grasshopper: { name: 'grasshopper', variant: 'primary' },
                            centipede: { name: 'centipede', variant: 'primary' },
                            millipede: { name: 'millipede', variant: 'primary' },
                            widow: { name: 'widow', variant: 'accent' },
                            insights: { name: 'insights', variant: 'accent' },
                            quality: { name: 'quality', variant: 'primary' },
                            tools: { name: 'tools', variant: 'primary' },
                            calendar: { name: 'calendar', variant: 'accent' },
                            mail: { name: 'mail', variant: 'accent' }
                        };
                        // 1) Replace any declared SVG nav icons with branded versions and uniform sizing
                        document.querySelectorAll('svg[data-icon-name]').forEach(svg => {
                            const key = svg.getAttribute('data-icon-name');
                            const spec = iconMap[key];
                            if (!spec) return;
                            const nonPest = new Set(['insights','quality','tools','calendar','mail']);
                            const hasRegistered = !!window.pestIcons[spec.name];
                            // Reference the parent button to clean up any duplicate emoji icons
                            const parentBtn = svg.closest('button.nav-btn');
                            // Boost visibility: enlarge sidebar icons slightly
                            const baseSize = Math.max(svg.clientWidth, svg.clientHeight) || 24;
                            const sizeRatio = (key === 'mail') ? ENLARGE_RATIO_MAIL : ENLARGE_RATIO;
                            const sizePx = Math.round(baseSize * sizeRatio); // larger for Gmail
                            // Create a wrapper that will carry the animation classes
                            const wrapper = document.createElement('span');
                            // Ensure header mirroring and hover effects treat replaced icons uniformly
                            wrapper.classList.add('brand-icon');
                            wrapper.style.display = 'inline-block';
                            wrapper.style.position = 'relative';
                            wrapper.style.width = sizePx + 'px';
                            wrapper.style.height = sizePx + 'px';
                            // Provide a consistent size variable used by brand-icon styles
                            try { wrapper.style.setProperty('--icon-size', sizePx + 'px'); } catch(_) { /* noop */ }
                            // Preserve layout and animation classes on the wrapper
                            const preserve = ['icon','icon-fly','icon-scurry','icon-skitter','icon-spider','icon-swirl','icon-inch','icon-chirp','icon-insights','icon-quality','icon-tools','icon-click','w-6','h-6'];
                            svg.classList.forEach(cls => { if (preserve.includes(cls)) wrapper.classList.add(cls); });
                            // Insert the new branded icon element inside the wrapper
                            let brandEl;
                            if (hasRegistered) {
                                brandEl = getPestIconElement(spec.name, { size: sizePx, variant: spec.variant, fixedColors: true });
                            } else if (!nonPest.has(key)) {
                                // Generic emoji fallback to fully remove original SVG
                                if (!window.pestIcons.beetle) { try { registerPestEmoji('beetle', 'ðŸª²'); } catch(e) { /* noop */ } }
                                brandEl = getPestIconElement('beetle', { size: sizePx, variant: 'primary', fixedColors: true });
                            } else {
                                // Keep non-pest app icons unchanged when no replacement is registered
                                return;
                            }
                            brandEl.style.position = 'absolute';
                            brandEl.style.inset = '0';
                            brandEl.style.pointerEvents = 'none';
                            wrapper.appendChild(brandEl);
                            // Do not retain original SVG; fully replace to remove SVG versions
                            // Replace in DOM
                            svg.parentNode.replaceChild(wrapper, svg);
                            // Remove any leading emoji spans to avoid doubled icons when branded icon is present
                            if (parentBtn) {
                                parentBtn.querySelectorAll('span.text-xl[aria-hidden="true"]').forEach(el => el.remove());
                            }
                        });

                        // 2) Normalize size for emoji-based nav buttons (those without SVG/data-icon-name)
                        document.querySelectorAll('.nav-btn').forEach(btn => {
                            // Skip buttons already processed (have brand-icon or svg)
                            if (btn.querySelector('.brand-icon') || btn.querySelector('svg[data-icon-name]')) return;
                            const group = btn.querySelector('.inline-flex');
                            const rawText = btn.textContent || '';
                            // Match a leading emoji sequence
                            const m = rawText.match(/^\s*([\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}](?:\uFE0F|\u200D[\u{1F300}-\u{1FAFF}])?)/u);
                            if (!m) return;
                            const emojiChar = m[1];
                            // Compute target size from button font-size
                            let sizePx = 28;
                            try {
                                const cs = getComputedStyle(btn);
                                const fs = parseFloat(cs.fontSize) || 16;
                                sizePx = Math.round(fs * ENLARGE_RATIO);
                            } catch(_) {}
                            // Build a brand-icon-like wrapper so header mirroring and hover effects work consistently
                            const wrapper = document.createElement('span');
                            wrapper.className = 'brand-icon';
                            wrapper.style.setProperty('--icon-size', sizePx + 'px');
                            // Render native emoji glyph with brand-icon sizing
                            const span = document.createElement('span');
                            span.textContent = emojiChar;
                            span.style.fontSize = 'var(--icon-size)';
                            span.style.lineHeight = 1;
                            wrapper.setAttribute('data-fixed-colors', 'true');
                            wrapper.appendChild(span);
                            if (group) {
                                // Remove any existing emoji span in the group
                                group.querySelectorAll('span.text-xl[aria-hidden="true"], span.text-2xl[aria-hidden="true"]').forEach(el => el.remove());
                                group.insertBefore(wrapper, group.firstChild);
                            } else {
                                // Fallback: replace button content but preserve label text
                                btn.textContent = '';
                                btn.appendChild(wrapper);
                                // Best-effort: infer label by removing leading emoji from raw text
                                const rest = rawText.replace(m[0], '').trimStart();
                                if (rest) btn.appendChild(document.createTextNode(' ' + rest));
                            }
                        });
                    }
                    document.addEventListener('DOMContentLoaded', () => {
                        try { replaceNavIconsWithRegistered(); } catch(e) { console.warn('Nav icon replace failed', e); }
                    });
                    window.addEventListener('brand:updated', () => {
                        try { replaceNavIconsWithRegistered(); } catch(e) { /* noop */ }
                        try { applySidebarIcons(); } catch(e) { /* noop */ }
                        try { if (typeof currentDashboard === 'string') updateDashboardTitleIcon(currentDashboard); } catch(e) { /* noop */ }
                    });
                    async function handlePestIconUpload(){
                        try {
                            const name = document.getElementById('pestIconUploadName').value;
                            const file = document.getElementById('pestIconUploadFile').files[0];
                            if (!file) { alert('Please select a file'); return; }
                            const reader = new FileReader();
                            reader.onload = function(){
                                const result = reader.result;
                                if (typeof result === 'string') {
                                    if (file.type === 'image/svg+xml') {
                                        registerPestIcon(name, result);
                                    } else {
                                        registerPestIconUrl(name, result);
                                    }
                                    initPestIconDemo();
                                    replaceNavIconsWithRegistered();
                                    // Notify settings to refresh icon choices after upload
                                    try { window.dispatchEvent(new CustomEvent('brand:updated')); } catch(e) { /* noop */ }
                                    try { loadSidebarIconSettings(); } catch(e) { /* noop */ }
                                }
                            };
                            if (file.type === 'image/svg+xml') {
                                reader.readAsText(file);
                            } else {
                                reader.readAsDataURL(file);
                            }
                        } catch(e){ console.warn('Icon upload failed', e); }
                    }
                    function renamePestIcon(oldName, newName){
                        try {
                            const from = String(oldName || '').trim();
                            const to = String(newName || '').trim();
                            if (!from || !to) return;
                            if (from === to) return;
                            const icons = window.pestIcons || {};
                            if (!icons[from]) return;
                            if (icons[to]) { alert('An icon with that name already exists.'); return; }
                            icons[to] = icons[from];
                            delete icons[from];
                            const cfg = getSidebarIconConfig();
                            SIDEBAR_ICON_KEYS.forEach(k => {
                                if (cfg[k] === ('pest:' + from)) cfg[k] = 'pest:' + to;
                            });
                            setSidebarIconConfig(cfg);
                            applySidebarIcons();
                            try { loadSidebarIconSettings(); } catch(e) { /* noop */ }
                            try { enforceUniqueSidebarIcons(); } catch(e) { /* noop */ }
                            try { initPestIconManager(); } catch(e) { /* noop */ }
                            try { window.dispatchEvent(new CustomEvent('brand:updated')); } catch(e) { /* noop */ }
                        } catch(e) { /* noop */ }
                    }
                    function initPestIconManager(){
                        const container = document.getElementById('pestIconManager');
                        if (!container) return;
                        container.innerHTML = '';
                        const icons = window.pestIcons || {};
                        Object.keys(icons).forEach(name => {
                            const spec = icons[name];
                            if (!spec || (spec.type !== 'img' && spec.type !== 'svg')) return;
                            const row = document.createElement('div');
                            row.className = 'flex items-center gap-2';
                            const preview = getPestIconElement(name, { size: 20, fixedColors: true });
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.value = name;
                            input.className = 'flex-1 px-2 py-1 border rounded-md';
                            const btn = document.createElement('button');
                            btn.textContent = 'Rename';
                            btn.className = 'px-2 py-1 bg-brand text-white rounded-md';
                            btn.addEventListener('click', () => renamePestIcon(name, input.value));
                            row.appendChild(preview);
                            row.appendChild(input);
                            row.appendChild(btn);
                            container.appendChild(row);
                        });
                    }
                </script>
                <script id="pest-icons-defaults">
                    // Pre-register basic SVG icons so overlays populate without manual upload
                    document.addEventListener('DOMContentLoaded', function(){
                        const svgWrap = (inner, title) => (
                            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" role="img">' +
                            (title ? ('<title>'+title+'</title>') : '') +
                            inner +
                            '</svg>'
                        );
                        const defs = {
                            bee: svgWrap(
                                '<g class="wings" opacity="0.7">\n' +
                                '  <ellipse cx="10" cy="10" rx="2.8" ry="2"/>\n' +
                                '  <ellipse cx="14" cy="10" rx="2.8" ry="2"/>\n' +
                                '</g>\n' +
                                '<g class="body">\n' +
                                '  <ellipse cx="12" cy="12" rx="3.5" ry="2.5"/>\n' +
                                '  <path d="M11 12h2M10.5 13h3M10.5 14h3"/>\n' +
                                '</g>\n' +
                                '<g class="legs-l"><path d="M9 14l-2 2M9 12l-2 1"/></g>\n' +
                                '<g class="legs-r"><path d="M15 14l2 2M15 12l2 1"/></g>\n' +
                                '<g class="head"><circle cx="12" cy="10.2" r="0.9"/><path d="M11.2 10.2l-1.2-1.1M12.8 10.2l1.2-1.1"/></g>',
                                'Bee'
                            ),
                            wasp: svgWrap(
                                '<g class="wings" opacity="0.7"><path d="M10 10l-2-2M14 10l2-2"/></g>\n' +
                                '<g class="body"><path d="M12 8v8"/></g>\n' +
                                '<g class="legs-l"><path d="M9 16l-2 2"/></g>\n' +
                                '<g class="legs-r"><path d="M15 16l2 2"/></g>',
                                'Wasp'
                            ),
                            mosquito: svgWrap(
                                '<g class="wings" opacity="0.7">\n' +
                                '  <ellipse cx="14" cy="9.5" rx="2.6" ry="1.6"/>\n' +
                                '  <ellipse cx="16.5" cy="10.2" rx="2.6" ry="1.6"/>\n' +
                                '</g>\n' +
                                '<g class="body">\n' +
                                '  <ellipse cx="12" cy="12" rx="3.4" ry="2.2"/>\n' +
                                '  <circle cx="10.2" cy="10.6" r="0.8"/>\n' +
                                '</g>\n' +
                                '<g class="legs-l"><path d="M9 14l-2 2M9.8 12l-2 -2"/></g>\n' +
                                '<g class="legs-r"><path d="M15 14l2 2M14.2 12l2 -2"/></g>',
                                'Mosquito'
                            ),
                            roach: svgWrap(
                                '<g class="body">\n' +
                                '  <ellipse cx="12" cy="12" rx="5" ry="3"/>\n' +
                                '  <path d="M12 10.2v3.6"/>\n' +
                                '</g>\n' +
                                '<g class="legs-l"><path d="M8.5 11l-3-2M9 14.5l-3 2"/></g>\n' +
                                '<g class="legs-r"><path d="M15.5 11l3-2M15 14.5l3 2"/></g>\n' +
                                '<g class="antennae"><path d="M11 10l-2-2M13 10l2-2"/></g>',
                                'Roach'
                            ),
                            ant: svgWrap(
                                '<g class="body">\n' +
                                '  <circle cx="9" cy="12" r="2"/>\n' +
                                '  <circle cx="12.5" cy="12" r="2"/>\n' +
                                '  <circle cx="16" cy="12" r="2"/>\n' +
                                '</g>\n' +
                                '<g class="legs-l"><path d="M8 10l-2-2M10 14l-2 2"/></g>\n' +
                                '<g class="legs-r"><path d="M16 10l2-2M14 14l2 2"/></g>\n' +
                                '<g class="antennae"><path d="M9.4 10l-2-1.8M16.6 10l2-1.8"/></g>',
                                'Ant'
                            ),
                            beetle: svgWrap('<g class="body"><circle cx="12" cy="12" r="3"/></g><path d="M12 9v6"/>', 'Beetle'),
                            spider: svgWrap(
                                '<g class="body"><circle cx="12" cy="12" r="2"/></g>\n' +
                                '<g class="legs">\n' +
                                '  <path d="M12 10V6M12 18v-4"/>\n' +
                                '  <path d="M9 11l-3-3M15 11l3-3M9 13l-3 3M15 13l3 3"/>\n' +
                                '</g>',
                                'Spider'
                            ),
                            widow:
                                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" data-fixed-colors="true">\n' +
                                '  <title>Black Widow</title>\n' +
                                '  <g class="legs" stroke="var(--widow-leg-stroke)" stroke-linecap="round" stroke-linejoin="round" stroke-width="var(--widow-stroke-width)">\n' +
                                '    <path d="M12 9.2V6.4M12 18.2v-3.6"/>\n' +
                                '    <path d="M9.2 11.2l-3-3M14.8 11.2l3-3"/>\n' +
                                '    <path d="M9.2 13.2l-3 3M14.8 13.2l3 3"/>\n' +
                                '    <path d="M10.4 11l-2.4-2M13.6 11l2.4-2"/>\n' +
                                '    <path d="M10.4 13.4l-2.4 2M13.6 13.4l2.4 2"/>\n' +
                                '  </g>\n' +
                                '  <g class="body">\n' +
                                '    <ellipse cx="12" cy="14.2" rx="3.6" ry="2.8" fill="var(--widow-body-fill)" stroke="var(--widow-outline-stroke)" stroke-width="var(--widow-stroke-width)"/>\n' +
                                '    <circle cx="12" cy="10.2" r="1.3" fill="var(--widow-body-fill)" stroke="var(--widow-outline-stroke)" stroke-width="var(--widow-stroke-width)"/>\n' +
                                '  </g>\n' +
                                '  <path class="hourglass" d="M12 12.4c-1.2 0.9-2 1.9-2 3s0.8 2.1 2 3c1.2-0.9 2-1.9 2-3s-0.8-2.1-2-3z" fill="var(--widow-mark-fill)" stroke="none"/>\n' +
                                '</svg>',
                            insights: svgWrap('<circle cx="10" cy="10" r="5"/><path d="M14.5 14.5L20 20"/>', 'Insights'),
                            quality: svgWrap('<rect x="8" y="8" width="8" height="10" rx="1"/><path d="M10 6h4"/>', 'Quality'),
                            tools: svgWrap('<rect x="4" y="9" width="16" height="9" rx="1"/><path d="M8 9V7h8v2"/><path d="M7 12h10M7 15h10"/>', 'Field Tools'),
                            caterpillar: svgWrap(
                                '<g class="body">\n' +
                                '  <circle cx="8" cy="13" r="2"/>\n' +
                                '  <circle cx="11" cy="13" r="2.2"/>\n' +
                                '  <circle cx="14" cy="12.8" r="2.3"/>\n' +
                                '  <circle cx="17" cy="12.6" r="2.4"/>\n' +
                                '  <circle cx="19.5" cy="12.5" r="2.2"/>\n' +
                                '</g>\n' +
                                '<g class="head">\n' +
                                '  <circle cx="21.5" cy="12.2" r="1.6"/>\n' +
                                '  <path d="M20.9 10.8l-1 -1.2M22.1 10.8l1 -1.2"/>\n' +
                                '  <circle cx="21" cy="12" r="0.2"/>\n' +
                                '  <path d="M21.2 12.8c0.4 0 0.7 -0.2 0.9 -0.4"/>\n' +
                                '</g>\n' +
                                '<g class="legs" opacity="0.9">\n' +
                                '  <path d="M8 15l-0.8 1.2M11 15l-0.8 1.2M14 15l-0.8 1.2M17 15l-0.8 1.2M19.5 14.8l-0.8 1.2"/>\n' +
                                '</g>',
                                'Caterpillar'
                            ),
                            scorpion: svgWrap(
                                '<g class="body">\n' +
                                '  <ellipse cx="10" cy="13" rx="2.4" ry="1.6"/>\n' +
                                '  <ellipse cx="12.8" cy="12.6" rx="2.2" ry="1.5"/>\n' +
                                '  <ellipse cx="15.2" cy="12.2" rx="2" ry="1.4"/>\n' +
                                '</g>\n' +
                                '<g class="claws">\n' +
                                '  <path d="M8.2 12.6l-2 1.8M7.2 14.4l-1.6 1.2"/>\n' +
                                '  <path d="M16.8 12.6l2 1.8M17.8 14.4l1.6 1.2"/>\n' +
                                '</g>\n' +
                                '<g class="legs">\n' +
                                '  <path d="M11 14l-2 2M12 14l-1.4 2.2M14 14l1.6 2M15 13.8l2 2.2"/>\n' +
                                '</g>\n' +
                                '<g class="tail">\n' +
                                '  <path d="M16.2 11.4c2 0.8 4 2.6 4.6 5.2"/>\n' +
                                '  <ellipse cx="21.2" cy="18" rx="1.3" ry="1"/>\n' +
                                '</g>',
                                'Scorpion'
                            ),
                            fly: svgWrap(
                                '<g class="wings" opacity="0.7">\n' +
                                '  <ellipse cx="10" cy="9.5" rx="3.6" ry="2.2"/>\n' +
                                '  <ellipse cx="14" cy="9.5" rx="3.6" ry="2.2"/>\n' +
                                '</g>\n' +
                                '<g class="body">\n' +
                                '  <circle cx="12" cy="11.2" r="1.2"/>\n' +
                                '  <ellipse cx="12" cy="13.6" rx="2.6" ry="1.9"/>\n' +
                                '  <ellipse cx="12" cy="16.2" rx="2.1" ry="1.5"/>\n' +
                                '</g>\n' +
                                '<g class="legs">\n' +
                                '  <path d="M10 16.2l-1.6 2M14 16.2l1.6 2M11.2 14.8l-2 1.6M12.8 14.8l2 1.6"/>\n' +
                                '</g>',
                                'Fly'
                            ),
                            moth: svgWrap(
                                '<g class="wings" opacity="0.75">\n' +
                                '  <path d="M6 14c2.6-2.8 5.2-3.8 7-3.8 1.8 0 4.4 1 7 3.8"/>\n' +
                                '  <path d="M6 14c2.8 2.4 5.4 3.2 7 3.2s4.2-0.8 7-3.2"/>\n' +
                                '</g>\n' +
                                '<g class="body">\n' +
                                '  <circle cx="13" cy="10.2" r="0.9"/>\n' +
                                '  <rect x="12" y="11" width="2" height="4" rx="1"/>\n' +
                                '  <path d="M12 11l-1.2-1.2M14 11l1.2-1.2"/>\n' +
                                '</g>',
                                'Moth'
                            ),
                            grasshopper: svgWrap(
                                '<g class="head">\n' +
                                '  <circle cx="7.5" cy="12.5" r="1.2"/>\n' +
                                '  <path d="M6 10.8l-3-2.2M8.6 11l3-2.2"/>\n' +
                                '</g>\n' +
                                '<g class="thorax">\n' +
                                '  <rect x="8.6" y="11" width="4.2" height="2.6" rx="1"/>\n' +
                                '</g>\n' +
                                '<g class="abdomen">\n' +
                                '  <path d="M12.6 12.2c3.8 0.2 6.2 1.6 7.4 3.8"/>\n' +
                                '  <path d="M12.8 13.2c3.2 0.2 5.4 1.4 6.6 3.2"/>\n' +
                                '</g>\n' +
                                '<g class="hind-leg">\n' +
                                '  <path d="M14 12l2.6-2.2M16.6 9.8l2.8 6.4"/>\n' +
                                '</g>\n' +
                                '<g class="legs">\n' +
                                '  <path d="M9.6 13.2l-2 2.8M11.4 13.4l-1.2 2.8"/>\n' +
                                '</g>',
                                'Grasshopper'
                            ),
                            centipede: svgWrap(
                                '<g class="body">\n' +
                                '  <path d="M6 12c5.2 0 9.6 2.4 12.8 6"/>\n' +
                                '  <path d="M6 12.8c5 0 9 2 12 5.2"/>\n' +
                                '</g>\n' +
                                '<g class="legs" opacity="0.9">\n' +
                                '  <path d="M7 12.4l-1.2 1.6M8.2 12.6l-1.2 1.6M9.4 12.8l-1.2 1.6M10.6 13l-1.2 1.6M11.8 13.2l-1.2 1.6M13 13.4l-1.2 1.6M14.2 13.6l-1.2 1.6M15.4 13.8l-1.2 1.6M16.6 14l-1.2 1.6M17.8 14.2l-1.2 1.6"/>\n' +
                                '</g>\n' +
                                '<g class="antennae">\n' +
                                '  <path d="M5.2 11.4l-2 -1.4M6 11.4l2 -1.4"/>\n' +
                                '</g>',
                                'Centipede'
                            ),
                            millipede: svgWrap(
                                '<g class="body">\n' +
                                '  <path d="M6 12c7.8 0 13.6 3.2 17.6 9.2"/>\n' +
                                '  <path d="M6 12.8c7.6 0 13 3 16.8 8.4"/>\n' +
                                '</g>\n' +
                                '<g class="legs" opacity="0.9">\n' +
                                '  <path d="M7 13l-1 1.6M8 13.2l-1 1.6M9 13.4l-1 1.6M10 13.6l-1 1.6M11 13.8l-1 1.6M12 14l-1 1.6M13 14.2l-1 1.6M14 14.4l-1 1.6M15 14.6l-1 1.6M16 14.8l-1 1.6M17 15l-1 1.6M18 15.2l-1 1.6M19 15.4l-1 1.6M20 15.6l-1 1.6"/>\n' +
                                '</g>\n' +
                                '<g class="heads">\n' +
                                '  <circle cx="6.2" cy="11.6" r="0.6"/>\n' +
                                '  <circle cx="23.6" cy="21.2" r="0.6"/>\n' +
                                '</g>',
                                'Millipede'
                            ),
                            silverfish: svgWrap(
                                '<g class="body">\n' +
                                '  <ellipse cx="12" cy="12" rx="3.6" ry="2.2"/>\n' +
                                '  <path d="M9.6 12.2l-2.2 2.2M14.4 12.2l2.2 2.2"/>\n' +
                                '</g>\n' +
                                '<g class="fins" opacity="0.9">\n' +
                                '  <path d="M10.4 10.6l-2 -1.6M13.6 10.6l2 -1.6"/>\n' +
                                '</g>\n' +
                                '<g class="tail">\n' +
                                '  <path d="M12 14.4l2.2 2.6M12 14.4l-2.2 2.6M12 14.4l0 3.2"/>\n' +
                                '</g>',
                                'Silverfish'
                            )
                        };
                        // Skip auto-registering SVG defaults to avoid forcing simplistic SVGs.
                        // Users can upload images, rely on built-in PNGs, or emoji fallbacks.
                        // Register emoji equivalents for requested icon names
                        const emojis = {
                            bee: 'ðŸ',
                            wasp: 'ðŸ',
                            hornet: 'ðŸ',
                            baitStation: 'ðŸª¤',
                            mosquito: 'ðŸ¦Ÿ',
                            spider: 'ðŸ•·',
                            widow: 'ðŸ•¸ï¸',
                            caterpillar: 'ðŸ›',
                            moth: 'ðŸ¦‹',
                            silverfish: 'ðŸª°',
                            ant: 'ðŸœ',
                            beetle: 'ðŸª²',
                            roach: 'ðŸª³',
                            grasshopper: 'ðŸ¦—',
                            mouse: 'ðŸ',
                            rat: 'ðŸ€',
                            bat: 'ðŸ¦‡',
                            // Keep Insights, Quality, Tools as SVG icons (no emoji replacement)
                            calendar: 'ðŸ“…',
                            mail: 'âœ‰ï¸'
                            // Additional aliases (not in sidebar) for completeness
                            // fly: 'ðŸª°', butterfly: 'ðŸ¦‹', cricket: 'ðŸ¦—', scorpion: 'ðŸ¦‚', worm: 'ðŸª±'
                        };
                        Object.entries(emojis).forEach(([name, emoji]) => {
                            // Only register an emoji if this icon name has not been registered yet
                            // Do not override existing SVG or image icons
                            if (!window.pestIcons[name]) {
                                try { registerPestEmoji(name, emoji); } catch(e) { /* noop */ }
                            }
                        });
                        // Targeted SVG overrides for better theme contrast
                        try {
                            if (!window.pestIcons.widow || window.pestIcons.widow.type !== 'svg') {
                                const widowSvg = defs.widow;
                                registerPestIcon('widow', widowSvg);
                            }
                        } catch(e) { /* noop */ }
                        try {
                            if (!window.pestIcons.brownRecluse || window.pestIcons.brownRecluse.type !== 'svg') {
                                const recluseSvg = (
                                    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" data-fixed-colors="true">' +
                                    '  <title>Brown Recluse</title>' +
                                    '  <g class="legs" stroke="var(--recluse-leg-stroke)" stroke-linecap="round" stroke-linejoin="round" stroke-width="var(--recluse-stroke-width)">' +
                                    '    <path d="M12 9.5V6.5M12 18.5v-3.5"/>' +
                                    '    <path d="M9.5 11.5l-3-3M14.5 11.5l3-3"/>' +
                                    '    <path d="M9.5 13.5l-3 3M14.5 13.5l3 3"/>' +
                                    '  </g>' +
                                    '  <g class="body">' +
                                    '    <ellipse cx="12" cy="14.2" rx="3.4" ry="2.6" fill="var(--recluse-body-fill)" stroke="var(--recluse-outline-stroke)" stroke-width="var(--recluse-stroke-width)"/>' +
                                    '    <circle cx="12" cy="10.4" r="1.2" fill="var(--recluse-body-fill)" stroke="var(--recluse-outline-stroke)" stroke-width="var(--recluse-stroke-width)"/>' +
                                    '  </g>' +
                                    '  <g class="violin-mark" fill="none" stroke="var(--recluse-mark-stroke)" stroke-width="var(--recluse-stroke-width)">' +
                                    '    <path d="M10.8 12.2h2.4"/>' +
                                    '    <path d="M11.2 12.2c0 1 .8 1.6 .8 2.4s-.8 1.6-.8 2.4"/>' +
                                    '  </g>' +
                                    '</svg>'
                                );
                                registerPestIcon('brownRecluse', recluseSvg);
                            }
                        } catch(e) { /* noop */ }
                        // Register built-in image icons from local /public/icons (override emoji fallbacks)
                        try {
                            const fireAntUrl = window.getIcon('fireAnt');
                            if (!window.pestIcons.fireAnt || window.pestIcons.fireAnt.type !== 'img' || window.pestIcons.fireAnt.url !== fireAntUrl) {
                                registerPestIconUrl('fireAnt', fireAntUrl);
                            }
                        } catch(e) { /* noop */ }
                        try {
                            const termiteUrl = window.getIcon('termite');
                            if (!window.pestIcons.termite || window.pestIcons.termite.type !== 'img' || window.pestIcons.termite.url !== termiteUrl) {
                                registerPestIconUrl('termite', termiteUrl);
                            }
                        } catch(e) { /* noop */ }
                        try {
                            const beeUrl = window.getIcon('bee');
                            if (!window.pestIcons.bee || window.pestIcons.bee.type !== 'img' || window.pestIcons.bee.url !== beeUrl) {
                                registerPestIconUrl('bee', beeUrl);
                            }
                        } catch(e) { /* noop */ }
                        try { replaceNavIconsWithRegistered(); } catch(e) { /* noop */ }
                        // Also register any local PNGs dropped into the project folder
                        try {
                            const localImages = [
                                'Asp.png','Bat.png','Bed Bug.png','Bee.png','Bait Station.png','Brown Recluse.png','Centipede.png','Fire Ant.png','Flea.png','Hornet.png','Millipede.png','Mouse.png','Rat.png','Termite.png','Tick.png',
                                // App-specific icons
                                'Gmail Mouse Chewing.png','Google Calendar Mice Chewing.png','Google Calendar Termites.png','Google Drive Fire Ant.png',
                                // Theme-aware app variants if present
                                'GMail Mice_Dark.png','GMail Mice_Light.png',
                                'Google Calendar Mice_Dark.png','Google Calendar Mice_Light.png',
                                'Google Drive Ant_Dark.png','Google Drive Ant_Light.png'
                            ];
                            const ICONS_DIR = '/Icons/';
                            localImages.forEach(file => {
                                const display = file.replace(/\.[a-zA-Z0-9]+$/,'');
                                const name = normalizeIconName(display);
                                // Resolve to Icons/ subfolder to match project structure
                                const url = ICONS_DIR + encodeURIComponent(file);
                                if (!name) return;
                                // Protect improved SVGs for Black Widow and Brown Recluse; allow PNGs for others
                                if ((name === 'widow' || name === 'brownRecluse') && window.pestIcons[name] && window.pestIcons[name].type === 'svg') return;
                                const existing = window.pestIcons[name];
                                const needsRegister = (!existing || existing.type !== 'img' || existing.url !== url);
                                if (!needsRegister) return;
                                // Map app-specific files to friendly registry names
                                const specialMap = {
                                    'gmailMouseChewing': { regName: 'gmail', label: 'Gmail Mouse Chewing' },
                                    'googleCalendarMiceChewing': { regName: 'calendar', label: 'Google Calendar Mice Chewing' },
                                    'googleCalendarTermites': { regName: 'calendar', label: 'Google Calendar Termites' },
                                    'googleDriveFireAnt': { regName: 'drive', label: 'Google Drive Fire Ant' },
                                    // Theme-aware mappings
                                    'gmailMiceDark': { regName: 'gmailDark', label: 'GMail Mice Dark' },
                                    'gmailMiceLight': { regName: 'gmailLight', label: 'GMail Mice Light' },
                                    'googleCalendarMiceDark': { regName: 'calendarDark', label: 'Google Calendar Mice Dark' },
                                    'googleCalendarMiceLight': { regName: 'calendarLight', label: 'Google Calendar Mice Light' },
                                    'googleDriveAntDark': { regName: 'driveDark', label: 'Google Drive Ant Dark' },
                                    'googleDriveAntLight': { regName: 'driveLight', label: 'Google Drive Ant Light' }
                                };
                                const special = specialMap[name];
                                const regName = special ? special.regName : name;
                                const label = special ? special.label : display;
                                // Apply background cleaning uniformly; cleaner falls back if clearing isnâ€™t suitable
                                cleanAndRegisterIcon(regName, url, label + ' (image)');
                            });
                        } catch(e) { /* noop */ }
                        // Notify UI to refresh any settings dependent on registered icons
                        try { window.dispatchEvent(new CustomEvent('brand:updated')); } catch(e) { /* noop */ }
                    });
                </script>

                <!-- User Management (Admin Only) -->
                <div id="userManagementSection" class="mb-8 hidden">
                    <details class="group">
                        <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">User Management</summary>
                    <div class="space-y-4">
                        <button onclick="addUser()" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                            âž• Add User
                        </button>
                        <button onclick="manageRoles()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                            ðŸ‘¥ Manage Roles
                        </button>
                    </div>
                    </details>
                </div>

                <!-- System Information -->
                <div class="border-t pt-6">
                    <details class="group">
                        <summary class="text-lg font-semibold mb-4 text-gray-800 cursor-pointer">System Information</summary>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p><strong>Version:</strong> 2.0.0</p>
                            <p><strong>Build Date:</strong> <span id="buildDate">2024-01-15</span></p>
                            <p><strong>Last Updated:</strong> <span id="lastUpdated">2024-01-15</span></p>
                        </div>
                        <div>
                            <p><strong>Current User:</strong> <span id="currentUserInfo">Loading...</span></p>
                            <p><strong>Role:</strong> <span id="currentUserRole">Loading...</span></p>
                            <p><strong>Branch:</strong> <span id="currentUserBranch">Loading...</span></p>
                        </div>
                    </div>
                    </details>
                </div>
                </div>
                <div id="settingsFooter" class="bg-white border-t px-6 py-4 flex justify-end gap-3 z-10 flex-none sticky bottom-0">
                <button type="button" onclick="closeSettingsPanel()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Close</button>
                <button type="button" onclick="saveAllSettings()" class="px-6 py-2 bg-brand text-white rounded-md hover:bg-opacity-90">Save Changes</button>
                <button type="button" onclick="(function(){ try { saveAllSettings(); } catch(e){} closeSettingsPanel(); })()" class="px-6 py-2 bg-brand text-white rounded-md hover:bg-opacity-90">Save and Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Modal (Preview) -->
    <div id="aiAssistantModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-xl w-full mx-4 modal-window">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">AI Assistant (Preview)</h2>
                <button onclick="closeAiAssistantModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-4 space-y-3">
                <div class="text-sm text-gray-700">Compose an email to a customer or internal team. When Gemini permissions are available, this will generate subject and body drafts.</div>
                <div>
                    <label class="block text-sm font-medium mb-1">Prompt</label>
                    <textarea id="aiComposePrompt" class="w-full border rounded p-2 text-sm" rows="4" placeholder="e.g., Draft a friendly install reminder to ACME for next Tuesday"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Recipients (comma-separated)</label>
                    <input id="aiComposeRecipients" class="w-full border rounded p-2 text-sm" placeholder="customer@example.com, ops@company.com" />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Subject</label>
                    <input id="aiComposeSubject" class="w-full border rounded p-2 text-sm" placeholder="Installation reminder for next Tuesday" />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Body</label>
                    <textarea id="aiComposeBody" class="w-full border rounded p-2 text-sm" rows="6" placeholder="Hello ACME team, just a friendly reminder..."></textarea>
                </div>
                <div class="flex gap-2">
                    <button class="px-3 py-2 text-sm bg-gray-200 text-gray-700 rounded cursor-not-allowed" title="Pending API permissions">Generate with Gemini</button>
                    <button onclick="openGmailComposeFromAiModal()" class="px-3 py-2 text-sm bg-brand text-white rounded">Open Gmail Compose</button>
                    <button onclick="closeAiAssistantModal()" class="px-3 py-2 text-sm bg-white border rounded">Close</button>
                </div>
                <p class="text-xs text-gray-500">Note: This is a placeholder. Integration points are ready; access will be enabled once permissions are granted.</p>
            </div>
        </div>
    </div>

    <!-- Metric Detail Modal -->
    <div id="metricModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 modal-window">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">Metric Details</h2>
                <button onclick="closeMetricModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close metric details">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="metricModalContent" class="p-4"></div>
        </div>
    </div>

    <!-- Quick Actions Drawer -->
    <div id="quickActionsOverlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-40" onclick="closeQuickActions()"></div>
    <aside id="quickActionsDrawer" class="fixed top-0 right-0 h-full w-96 max-w-full bg-white border-l border-gray-200 shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-out">
        <div class="flex items-center justify-between px-4 py-3 border-b">
            <h2 class="text-lg font-semibold text-gray-800">Create New</h2>
            <button onclick="closeQuickActions()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
                <div class="p-4 space-y-4 overflow-y-auto h-full">
            <details class="border border-gray-200 rounded-lg">
                <summary class="cursor-pointer px-3 py-2 font-medium text-gray-800 bg-gray-50 rounded-lg flex items-center justify-between">
                  <span>Sales & Setup</span>
                  <span id="qaCountSalesSetup" class="ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded bg-gray-200 text-gray-800">0</span>
                </summary>
                <div class="p-3 space-y-3">
                    <button onclick="openSalesEntryForm()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">New Proposal</button>
                    <button id="generateStartPacketBtn" onclick="generateStartPacket()" class="w-full px-4 py-3 bg-brand text-white rounded-lg hover:bg-brand-color-light transition-colors duration-200 flex items-center justify-between">
                        <span>Generate Start Packet</span>
                        <span id="salesPacketPendingCount" class="ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded bg-white/20">(0)</span>
                    </button>
                    <button onclick="openQuoteUploadModal()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">Upload Quote PDF</button>
                    <button onclick="openStartLogModal()" class="w-full px-4 py-3 bg-brand text-white rounded-lg hover:bg-brand-color-light transition-colors duration-200 flex items-center justify-between">
                        <span>Start Log Form (Sales â†’ OM)</span>
                        <span id="salesLogFormNeededCount" class="ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded bg-white/20">(0)</span>
                    </button>
                    <button onclick="openStartLogPasteModal()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">Quick Paste Start Logs</button>
                    <button onclick="openDailyPerformanceForm()" class="w-full px-4 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition-colors duration-200">Daily Sales Performance</button>
                    <button onclick="openBranchCadenceModal()" class="w-full px-4 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition-colors duration-200">Branch Cadence Entry</button>
                </div>
            </details>
            <details class="border border-gray-200 rounded-lg">
                <summary class="cursor-pointer px-3 py-2 font-medium text-gray-800 bg-gray-50 rounded-lg flex items-center justify-between">
                  <span>Operations</span>
                  <span id="qaCountOperations" class="ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded bg-gray-200 text-gray-800">0</span>
                </summary>
                <div class="p-3 space-y-3">
                    <button onclick="generateCadenceReport()" class="w-full px-4 py-3 bg-rentokil-blue text-white rounded-lg hover:bg-opacity-90 transition-colors duration-200">Generate Cadence Report</button>
                    <button onclick="updateInstallStatus()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">Update Install Status</button>
                    <button onclick="openPendingInstallsModal()" class="w-full px-4 py-3 bg-brand text-white rounded-lg hover:bg-brand-color-light transition-colors duration-200 flex items-center justify-between">
                        <span>View All Pending Installs</span>
                        <span id="opsPendingInstallsCount" class="ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded bg-white/20">(0)</span>
                    </button>
                    <button id="viewOverduePacketsBtn" onclick="openOverduePacketsModal()" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 flex items-center justify-between">
                        <span>View All Overdue Packets</span>
                        <span id="opsOverduePacketsCount" class="ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded bg-white/20">(0)</span>
                    </button>
                    <button onclick="openJobAssignmentModal('all')" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors duration-200">Assign Technician to Jobs</button>
                </div>
            </details>
            <details class="border border-gray-200 rounded-lg">
                <summary class="cursor-pointer px-3 py-2 font-medium text-gray-800 bg-gray-50 rounded-lg flex items-center justify-between">
                  <span>Utilities</span>
                  <span id="qaCountUtilities" class="ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded bg-gray-200 text-gray-800">0</span>
                </summary>
                <div class="p-3 space-y-3">
                    <button onclick="testBackendConnection()" class="w-full px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">Test Backend Connection</button>
                    <button onclick="openCadenceImportModal()" class="w-full px-4 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition-colors duration-200">Paste Cadence Rows (Import)</button>
                </div>
            </details>
        </div>
    </aside>

    <!-- Internal Chat Drawer -->
    <div id="chatOverlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-[60]" onclick="closeChatDrawer()"></div>
    <aside id="chatDrawer" class="fixed top-0 right-0 h-full w-96 max-w-full bg-white border-l border-gray-200 shadow-2xl z-[70] transform translate-x-full transition-transform duration-300 ease-out flex flex-col" style="width:min(28rem,100vw);overflow-x:hidden;">
        <div class="flex items-center justify-between px-4 py-3 border-b shrink-0">
            <h2 class="text-lg font-semibold text-gray-800">Internal Chat</h2>
            <button onclick="closeChatDrawer()" class="text-gray-500 hover:text-gray-700" aria-label="Close chat drawer">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="px-4 pt-3 border-b flex flex-wrap gap-2 shrink-0">
            <button class="px-3 py-1.5 text-sm rounded bg-brand text-white" data-chat-tab="branch">Branch</button>
            <button class="px-3 py-1.5 text-sm rounded bg-gray-100" data-chat-tab="region">Region</button>
            <button class="px-3 py-1.5 text-sm rounded bg-gray-100" data-chat-tab="market">Market</button>
            <div class="ml-auto flex items-center gap-2">
                <label class="text-xs text-gray-500">Mode</label>
                <select id="chatMode" class="text-sm border rounded px-2 py-1" style="min-width:0;">
                    <option value="board">Board</option>
                    <option value="dm">Direct</option>
                </select>
                <input id="chatRecipient" class="text-sm border rounded px-2 py-1 hidden" placeholder="Recipient email" style="min-width:0;" />
                <label class="text-xs text-gray-500 mr-1">Category</label>
                <select id="chatFilter" class="text-sm border rounded px-2 py-1" style="min-width:0;">
                    <option value="all">All</option>
                    <option value="general">General</option>
                    <option value="suggestion">Suggestion</option>
                    <option value="idea">Idea</option>
                    <option value="question">Question</option>
                </select>
            </div>
        </div>
        <div class="p-4 overflow-y-auto flex-1">
            <div id="chatScopeLabel" class="text-xs text-gray-500 mb-2">Scope: Branch</div>
            <div id="chatMessagesList" class="space-y-2"></div>
        </div>
        <div class="p-4 border-t space-y-2 shrink-0 bg-white">
            <div class="flex gap-2">
                <select id="chatCategory" class="text-sm border rounded px-2 py-1">
                    <option value="general">General</option>
                    <option value="suggestion">Suggestion</option>
                    <option value="idea">Idea</option>
                    <option value="question">Question</option>
                </select>
                <input id="chatMessageInput" class="flex-1 border rounded px-2 py-1 text-sm" placeholder="Type a message..." style="min-width:0;" />
            </div>
            <div class="flex items-center justify-between">
                <button onclick="sendChatMessage()" class="px-3 py-1.5 text-sm bg-brand text-white rounded">Send</button>
                <button onclick="clearChatMessages()" class="px-3 py-1.5 text-sm bg-gray-100 rounded">Clear</button>
            </div>
        </div>
    </aside>

            <!-- Open Chat Button (refined FAB) -->
            <button id="openChatButton" onclick="openChatDrawer()" title="Chat" aria-label="Open Internal Chat" class="fixed bottom-6 right-6 z-40 w-14 h-14 rounded-full shadow-xl flex items-center justify-center focus:outline-none">
                <span class="sr-only">Open Internal Chat</span>
                <div class="w-full h-full rounded-full chat-fab-bg" style="background: linear-gradient(135deg, var(--brand-color), var(--brand-color-dark)); box-shadow: 0 8px 24px rgba(0,0,0,0.35), inset 0 2px 8px rgba(255,255,255,0.12); border: 2px solid rgba(255,255,255,0.08);"></div>
                <svg class="absolute w-6 h-6 text-white chat-fab-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M4 5a3 3 0 013-3h10a3 3 0 013 3v9a3 3 0 01-3 3H9l-4 4v-4a3 3 0 01-3-3V5z"></path>
                </svg>
            </button>

    <!-- Director: Cohorts Manager Modal -->
    <div id="cohortsModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-40 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl mx-4 modal-window">
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold">Cohorts Manager</h3>
                <button onclick="closeCohortsManager()" class="text-gray-500 hover:text-gray-700" aria-label="Close">âœ•</button>
            </div>
            <div class="p-4 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                    <input id="cohortName" class="border rounded px-2 py-1 text-sm" placeholder="Name" />
                    <select id="cohortLevel" class="border rounded px-2 py-1 text-sm">
                        <option value="branch">Branch</option>
                        <option value="area">Area</option>
                        <option value="region">Region</option>
                        <option value="market">Market</option>
                    </select>
                    <input id="cohortOwner" class="border rounded px-2 py-1 text-sm" placeholder="Owner" />
                    <select id="cohortStatus" class="border rounded px-2 py-1 text-sm">
                        <option value="planning">Planning</option>
                        <option value="scheduling">Scheduling</option>
                        <option value="training">Training</option>
                        <option value="live">Live</option>
                    </select>
                    <input id="cohortNotes" class="border rounded px-2 py-1 text-sm" placeholder="Notes" />
                </div>
                <div class="flex gap-2">
                    <button onclick="saveCohort()" class="px-3 py-1.5 text-sm bg-brand text-white rounded">Add/Update</button>
                    <button onclick="resetCohortForm()" class="px-3 py-1.5 text-sm bg-gray-100 rounded">Clear</button>
                </div>
                <div class="overflow-auto border rounded">
                    <table class="min-w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-xs text-gray-500">Name</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Level</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Owner</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Status</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Notes</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cohortsTableBody" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- App Toast -->
    <div id="appToast" class="fixed top-4 right-4 z-[100] hidden">
        <div id="appToastInner" class="px-4 py-2 rounded-md shadow-lg bg-green-600 text-white text-sm">
            <span id="appToastMessage">Settings saved.</span>
        </div>
    </div>

    <!-- Director: Training Scheduler Modal -->
    <div id="trainingModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-40 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl mx-4 modal-window">
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold">Training Scheduler</h3>
                <button onclick="closeTrainingScheduler()" class="text-gray-500 hover:text-gray-700" aria-label="Close">âœ•</button>
            </div>
            <div class="p-4 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                    <input id="trainingTitle" class="border rounded px-2 py-1 text-sm" placeholder="Title" />
                    <input id="trainingDate" type="date" class="border rounded px-2 py-1 text-sm" />
                    <input id="trainingTime" type="time" class="border rounded px-2 py-1 text-sm" />
                    <input id="trainingAudience" class="border rounded px-2 py-1 text-sm" placeholder="Audience" />
                    <input id="trainingLocation" class="border rounded px-2 py-1 text-sm" placeholder="Location/Link" />
                </div>
                <input id="trainingNotes" class="border rounded px-2 py-1 text-sm w-full" placeholder="Notes" />
                <div class="flex gap-2">
                    <button onclick="saveTrainingSession()" class="px-3 py-1.5 text-sm bg-brand text-white rounded">Add/Update</button>
                    <button onclick="resetTrainingForm()" class="px-3 py-1.5 text-sm bg-gray-100 rounded">Clear</button>
                </div>
                <div class="overflow-auto border rounded">
                    <table class="min-w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-xs text-gray-500">Title</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Date</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Time</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Audience</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Location</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trainingTableBody" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Director: Adoption Targets Modal -->
    <div id="targetsModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-40 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl mx-4 modal-window">
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold">Adoption Targets</h3>
                <button onclick="closeAdoptionTargets()" class="text-gray-500 hover:text-gray-700" aria-label="Close">âœ•</button>
            </div>
            <div class="p-4 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                    <select id="targetLevel" class="border rounded px-2 py-1 text-sm">
                        <option value="branch">Branch</option>
                        <option value="area">Area</option>
                        <option value="region">Region</option>
                        <option value="market">Market</option>
                    </select>
                    <input id="targetName" class="border rounded px-2 py-1 text-sm" placeholder="Name" />
                    <input id="targetPercent" type="number" min="0" max="100" class="border rounded px-2 py-1 text-sm" placeholder="Target %" />
                    <input id="currentPercent" type="number" min="0" max="100" class="border rounded px-2 py-1 text-sm" placeholder="Current %" />
                    <input id="targetNotes" class="border rounded px-2 py-1 text-sm" placeholder="Notes" />
                </div>
                <div class="flex gap-2">
                    <button onclick="saveAdoptionTarget()" class="px-3 py-1.5 text-sm bg-brand text-white rounded">Add/Update</button>
                    <button onclick="resetTargetForm()" class="px-3 py-1.5 text-sm bg-gray-100 rounded">Clear</button>
                </div>
                <div class="overflow-auto border rounded">
                    <table class="min-w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-xs text-gray-500">Level</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Name</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Target %</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Current %</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Notes</th>
                                <th class="px-3 py-2 text-xs text-gray-500">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="targetsTableBody" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Director: Team Broadcast Modal -->
    <div id="commsModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-40 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl mx-4 modal-window">
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold">Team Broadcast Hub</h3>
                <button onclick="closeCommsPanel()" class="text-gray-500 hover:text-gray-700" aria-label="Close">âœ•</button>
            </div>
            <div class="p-4 space-y-3">
                <input id="commsRecipients" class="border rounded px-2 py-1 text-sm w-full" placeholder="Recipients (comma-separated emails)" />
                <input id="commsSubject" class="border rounded px-2 py-1 text-sm w-full" placeholder="Subject" />
                <textarea id="commsBody" class="border rounded px-2 py-1 text-sm w-full" rows="6" placeholder="Message"></textarea>
                <div class="flex gap-2">
                    <button onclick="sendCommunications()" class="px-3 py-1.5 text-sm bg-brand text-white rounded">Send Email + Team Broadcast</button>
                    <button onclick="clearCommunicationsForm()" class="px-3 py-1.5 text-sm bg-gray-100 rounded">Clear</button>
                </div>
                <div id="commsStatus" class="text-xs text-gray-600"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentDashboard = 'sales';
        let presentationMode = false;
        let refreshInterval = parseInt(localStorage.getItem('refreshInterval') || '30', 10) * 1000;
        let chartData = {};
        let lastDirectorData = null;

        // Action chip color schemes and icons
        const CHIP_COLOR_SCHEMES = {
            default: {
                packet: 'bg-orange-100 text-orange-800 hover:bg-orange-200',
                materials: 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200',
                schedule: 'bg-blue-100 text-blue-800 hover:bg-blue-200',
                install: 'bg-green-100 text-green-800 hover:bg-green-200',
                logbook: 'bg-purple-100 text-purple-800 hover:bg-purple-200',
                other: 'bg-gray-100 text-gray-800 hover:bg-gray-200'
            },
            highcontrast: {
                packet: 'bg-orange-600 text-white hover:bg-orange-700',
                materials: 'bg-yellow-600 text-white hover:bg-yellow-700',
                schedule: 'bg-blue-600 text-white hover:bg-blue-700',
                install: 'bg-green-600 text-white hover:bg-green-700',
                logbook: 'bg-purple-600 text-white hover:bg-purple-700',
                other: 'bg-gray-600 text-white hover:bg-gray-700'
            },
            pastel: {
                packet: 'bg-orange-200 text-orange-900 hover:bg-orange-300',
                materials: 'bg-yellow-200 text-yellow-900 hover:bg-yellow-300',
                schedule: 'bg-blue-200 text-blue-900 hover:bg-blue-300',
                install: 'bg-green-200 text-green-900 hover:bg-green-300',
                logbook: 'bg-purple-200 text-purple-900 hover:bg-purple-300',
                other: 'bg-gray-200 text-gray-900 hover:bg-gray-300'
            },
            grayscale: {
                packet: 'bg-gray-200 text-gray-800 hover:bg-gray-300',
                materials: 'bg-gray-200 text-gray-800 hover:bg-gray-300',
                schedule: 'bg-gray-200 text-gray-800 hover:bg-gray-300',
                install: 'bg-gray-200 text-gray-800 hover:bg-gray-300',
                logbook: 'bg-gray-200 text-gray-800 hover:bg-gray-300',
                other: 'bg-gray-200 text-gray-800 hover:bg-gray-300'
            }
        };

        function getChipColorScheme(){
            return localStorage.getItem('chipColorScheme') || 'default';
        }
        function setChipColorScheme(scheme){
            localStorage.setItem('chipColorScheme', scheme);
            try {
                renderUnifiedTracker(window._unifiedRows || []);
                if (currentDashboard === 'operations') renderMiniKanban(window._unifiedRows || []);
            } catch (e) { console.warn('Unable to rerender tracker after scheme change:', e); }
        }
        function getActionType(a){
            const t = String(a||'').toLowerCase();
            if (t.includes('packet')) return 'packet';
            if (t.includes('materials')) return 'materials';
            if (t.includes('schedule')) return 'schedule';
            if (t.includes('install')) return 'install';
            if (t.includes('log book') || t.includes('logbook')) return 'logbook';
            return 'other';
        }
        function getActionClass(a){
            const scheme = CHIP_COLOR_SCHEMES[getChipColorScheme()] || CHIP_COLOR_SCHEMES.default;
            const type = getActionType(a);
            return scheme[type] || scheme.other;
        }
        function getActionIcon(a){
            switch (getActionType(a)){
                case 'packet': return 'ðŸ§¾';
                case 'materials': return 'ðŸ“¦';
                case 'schedule': return 'ðŸ—“ï¸';
                case 'install': return 'ðŸ› ï¸';
                case 'logbook': return 'ðŸ“’';
                default: return 'ðŸ”¸';
            }
        }

        // --- Universal Grid Dashboard ---
        function ensureWidgetLibrary() {
            if (document.getElementById('widgetLibraryBackdrop')) return;
            const backdrop = document.createElement('div');
            backdrop.id = 'widgetLibraryBackdrop';
            backdrop.className = 'widget-library-backdrop';
            backdrop.innerHTML = `
              <div class="widget-library-modal">
                <header>
                  <div class="text-sm font-semibold text-gray-800">Widget Library</div>
                  <button class="px-2 py-1 text-sm border rounded" onclick="closeWidgetLibrary()">Close</button>
                </header>
                <div class="filters">
                  <label class="text-sm">Category:
                    <select id="widgetCategoryFilter" class="border rounded px-2 py-1 text-sm">
                      <option value="auto">Auto (by role)</option>
                      <option value="Sales">Sales</option>
                      <option value="Ops">Ops</option>
                      <option value="Manager">Manager</option>
                      <option value="Universal">Universal</option>
                      <option value="All">All</option>
                    </select>
                  </label>
                </div>
                <div class="items" id="widgetLibraryItems"></div>
                <footer>
                  <button class="px-3 py-2 bg-brand text-white rounded" onclick="closeWidgetLibrary()">Done</button>
                </footer>
              </div>`;
            document.body.appendChild(backdrop);
        }

        function openWidgetLibrary() {
            const defs = (window.Widgets && typeof window.Widgets.list === 'function') ? window.Widgets.list() : [];
            const currentRole = (window.currentDashboard === 'operations' ? 'Ops' : (window.currentDashboard === 'branch' ? 'Manager' : 'Sales'));
            const presentTypes = (window.dashboardEngine?.widgets || []).map(w => w.type);

            if (window.SlideOutPanel && typeof SlideOutPanel.open === 'function') {
              const content = document.createElement('div');
              content.innerHTML = `
                <div class="filters">
                  <label class="text-sm">Category:
                    <select id="widgetCategoryFilterSO" class="border rounded px-2 py-1 text-sm">
                      <option value="auto">Auto (by role)</option>
                      <option value="Sales">Sales</option>
                      <option value="Ops">Ops</option>
                      <option value="Manager">Manager</option>
                      <option value="Universal">Universal</option>
                      <option value="All">All</option>
                    </select>
                  </label>
                </div>
                <div class="items" id="widgetLibraryItemsSO"></div>
                <div class="mt-3"><button class="px-3 py-2 bg-brand text-white rounded" id="widgetLibDoneSO">Done</button></div>`;
              const select = content.querySelector('#widgetCategoryFilterSO');
              const items = content.querySelector('#widgetLibraryItemsSO');
              const renderList = (category) => {
                let filtered = defs;
                if (category && category !== 'All') {
                  if (category === 'auto') {
                    filtered = defs.filter(d => Array.isArray(d.role) ? d.role.includes(currentRole) : true);
                  } else if (category === 'Universal') {
                    filtered = defs.filter(d => d.category === 'Universal');
                  } else {
                    filtered = defs.filter(d => Array.isArray(d.role) ? d.role.includes(category) : false);
                  }
                }
                items.innerHTML = filtered.map(d => {
                  const already = presentTypes.includes(d.id);
                  return `
                  <div class="item">
                    <div>
                      <div class="text-sm font-semibold text-gray-800">${d.title}</div>
                      <div class="text-xs text-gray-500">${d.id}${Array.isArray(d.role)?' â€¢ '+d.role.join('/'):''}</div>
                    </div>
                    <button class="px-3 py-1.5 text-sm ${already?'bg-gray-200 cursor-not-allowed':'bg-gray-100 hover:bg-gray-200'} rounded" ${already?'disabled':''} onclick="addWidgetType('${d.id}')">${already?'Added':'Add'}</button>
                  </div>`;
                }).join('');
              };
              if (select) { select.value = 'auto'; select.onchange = (e) => renderList(e.target.value); }
              renderList('auto');
              SlideOutPanel.open(content, { title: 'Widget Library' });
              const doneBtn = content.querySelector('#widgetLibDoneSO');
              if (doneBtn) doneBtn.addEventListener('click', () => SlideOutPanel.close());
              return;
            }

            // Fallback to existing modal
            ensureWidgetLibrary();
            const backdrop = document.getElementById('widgetLibraryBackdrop');
            const items = document.getElementById('widgetLibraryItems');
            if (!backdrop || !items) return;
            const select = document.getElementById('widgetCategoryFilter');
            if (select) select.value = 'auto';
            const renderList = (category) => {
              let filtered = defs;
              if (category && category !== 'All') {
                if (category === 'auto') {
                  filtered = defs.filter(d => Array.isArray(d.role) ? d.role.includes(currentRole) : true);
                } else if (category === 'Universal') {
                  filtered = defs.filter(d => d.category === 'Universal');
                } else {
                  filtered = defs.filter(d => Array.isArray(d.role) ? d.role.includes(category) : false);
                }
              }
              items.innerHTML = filtered.map(d => {
                const already = presentTypes.includes(d.id);
                return `
                <div class="item">
                  <div>
                    <div class="text-sm font-semibold text-gray-800">${d.title}</div>
                    <div class="text-xs text-gray-500">${d.id}${Array.isArray(d.role)?' â€¢ '+d.role.join('/'):''}</div>
                  </div>
                  <button class="px-3 py-1.5 text-sm ${already?'bg-gray-200 cursor-not-allowed':'bg-gray-100 hover:bg-gray-200'} rounded" ${already?'disabled':''} onclick="addWidgetType('${d.id}')">${already?'Added':'Add'}</button>
                </div>`;
              }).join('');
            };
            renderList('auto');
            if (select) select.onchange = (e) => renderList(e.target.value);
            backdrop.style.display = 'flex';
        }

        function closeWidgetLibrary() {
            const backdrop = document.getElementById('widgetLibraryBackdrop');
            if (backdrop) backdrop.style.display = 'none';
        }

        function addWidgetType(id){
            try {
                const ok = window.dashboardEngine?.addWidget(id);
                if (ok === false) {
                  alert('Widget already added');
                } else {
                  // Refresh the library to reflect disabled state
                  openWidgetLibrary();
                }
            } catch(_) {}
        }

        // Enable universal grid engine â€” provides consistent drag/resize across dashboards
        window.universalGridEnabled = true;

        function initUniversalGrid(dashboard){
            const root = document.getElementById('dashboardContent');
            if (!root) return;
            // Add the grid container at the top if missing
            if (!document.getElementById('universalGrid')) {
                const div = document.createElement('div');
                div.id = 'universalGrid';
                // Ensure correct styling hooks for grid interactions
                div.className = 'universal-grid mb-6';
                root.prepend(div);
            }
            const container = document.getElementById('universalGrid');
            container.innerHTML = ''; // engine will render into it
            // Create engine and set widgets
            try {
                window.dashboardEngine = new LayoutEngine(container, dashboard, { rowHeight: 24, saveDebounceMs: 800 });
                // Clear any previously persisted layout to remove auto-added widgets
                try { window.dashboardEngine.clearPersisted(); } catch(_) {}
                const defaults = (window.DashboardConfigs && window.DashboardConfigs[dashboard]) ? window.DashboardConfigs[dashboard] : [];
                window.dashboardEngine.setWidgets(defaults);
            } catch(e) { console.warn('LayoutEngine init failed:', e); }

            // Intentionally do not inject an "Add Widget" button
        }

        // Update category counts in Quick Actions drawer
        function updateQuickActionsCounts(){
            const rows = window._unifiedRows || [];
            let overduePackets = 0;
            let pendingInstalls = 0;
            let scheduleNeeded = 0;
            let materialsPending = 0;
            let logBookNeeded = 0;
            rows.forEach(r => {
                const status = String(r.status||'');
                const packetSent = !!r.startPacketSent;
                const installScheduled = !!r.dateInstallScheduled;
                const installComplete = String(r.installComplete||'').toLowerCase() === 'yes' || r.installComplete === true;
                const materialsOrdered = String(r.materialsOrdered||'').toLowerCase() === 'yes' || r.materialsOrdered === true;
                const needsLog = !!r.logBookNeeded;
                if (status === 'Sold' && !packetSent) overduePackets++;
                if (packetSent && !installScheduled) scheduleNeeded++;
                if (installScheduled && !installComplete) pendingInstalls++;
                if (!materialsOrdered) materialsPending++;
                if (needsLog) logBookNeeded++;
            });
            const salesTotal = overduePackets + logBookNeeded;
            const opsTotal = pendingInstalls + overduePackets + scheduleNeeded + materialsPending;
            const utilTotal = 0; // Utilities are tools, not queue items
            const sEl = document.getElementById('qaCountSalesSetup'); if (sEl) sEl.textContent = String(salesTotal);
            const oEl = document.getElementById('qaCountOperations'); if (oEl) oEl.textContent = String(opsTotal);
            const uEl = document.getElementById('qaCountUtilities'); if (uEl) uEl.textContent = String(utilTotal);
            // Update per-button counters
            const opsPI = document.getElementById('opsPendingInstallsCount'); if (opsPI) opsPI.textContent = `(${pendingInstalls})`;
            const opsOP = document.getElementById('opsOverduePacketsCount'); if (opsOP) opsOP.textContent = `(${overduePackets})`;
            const salesPP = document.getElementById('salesPacketPendingCount'); if (salesPP) salesPP.textContent = `(${overduePackets})`;
            const salesLF = document.getElementById('salesLogFormNeededCount'); if (salesLF) salesLF.textContent = `(${logBookNeeded})`;

            // Attention glow states
            const spBtn = document.getElementById('generateStartPacketBtn');
            const odBtn = document.getElementById('viewOverduePacketsBtn');
            if (spBtn) {
                if (overduePackets > 0) { spBtn.classList.add('glow-green'); }
                else { spBtn.classList.remove('glow-green'); }
            }
            if (odBtn) {
                if (overduePackets > 0) { odBtn.classList.add('glow-red'); }
                else { odBtn.classList.remove('glow-red'); }
            }
        }

        // Update Display badges for currently visible rows and actions
        function updateDisplayBadges(rowsCount, actionsCount){
            try {
                if (typeof rowsCount === 'undefined' || typeof actionsCount === 'undefined') {
                    const rows = window._unifiedRows || [];
                    const q = (document.getElementById('trackerSearch')?.value || '').trim().toLowerCase();
                    const filtered = q ? rows.filter(function(r){
                        const c = String(r.customer || '').toLowerCase();
                        const a = String(r.serviceAddress || '').toLowerCase();
                        return c.includes(q) || a.includes(q);
                    }) : rows;
                    rowsCount = filtered.length;
                    actionsCount = filtered.reduce((sum, r) => sum + ((r.nextActions||[]).length), 0);
                }
                const rowsEl = document.getElementById('displayVisibleRowsBadge');
                const actsEl = document.getElementById('displayVisibleActionsBadge');
                if (rowsEl) rowsEl.textContent = `Rows: ${rowsCount}`;
                if (actsEl) actsEl.textContent = `Actions: ${actionsCount}`;
            } catch (e) { console.warn('updateDisplayBadges failed:', e); }
        }

        // AI Assistant placeholder card
        function renderAiAssistantCard(){
            if (typeof currentDashboard === 'string' && currentDashboard !== 'gmail') return '';
            return `
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm font-medium text-gray-800">AI Assistant (Preview)</div>
                            <div class="text-xs text-gray-500">Compose emails and summaries via Gemini. Pending permissions.</div>
                        </div>
                        <button class="px-3 py-1.5 text-sm bg-brand text-white rounded" onclick="openAiAssistantModal()">Open Composer</button>
                    </div>
                </div>`;
        }

        // Compact Rollout overview to merge Director view into Executive
        function renderRolloutOverviewMini(){
            try {
                const d = getMockDirectorRolloutData ? getMockDirectorRolloutData() : null;
                if (!d) return '';
                const t = d.totals || {};
                const items = [
                    { label: 'Branches', v: `${t.branches?.onboarded||0}/${t.branches?.total||0}` },
                    { label: 'Areas', v: `${t.areas?.onboarded||0}/${t.areas?.total||0}` },
                    { label: 'Regions', v: `${t.regions?.onboarded||0}/${t.regions?.total||0}` },
                    { label: 'Markets', v: `${t.markets?.onboarded||0}/${t.markets?.total||0}` }
                ];
                return `
                    <div class="bg-white p-4 rounded-lg shadow border border-gray-200 mb-8">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-sm font-medium text-gray-800">Director Rollout Overview</div>
                            <button class="px-3 py-1.5 text-sm bg-gray-100 rounded" onclick="showDashboard('director')">View Details</button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            ${items.map(i => `
                                <div class="p-3 bg-gray-50 rounded border">
                                    <div class="text-xs text-gray-500">${i.label}</div>
                                    <div class="text-lg font-semibold text-brand">${i.v}</div>
                                </div>`).join('')}
                        </div>
                    </div>`;
            } catch (e) { return ''; }
        }

        function openAiAssistantModal(){
            const m = document.getElementById('aiAssistantModal');
            if (m) m.classList.remove('hidden');
            setModalDefaultSize('aiAssistantModal');
            enableModalDrag('aiAssistantModal');
            enableModalResize('aiAssistantModal');
        }
        function closeAiAssistantModal(){
            const m = document.getElementById('aiAssistantModal');
            if (m) m.classList.add('hidden');
            resetModalPosition('aiAssistantModal');
        }

        function openMailCompose(prompt = '', recipients = '', subject = '', body = ''){
            try {
                const p = document.getElementById('aiComposePrompt');
                const r = document.getElementById('aiComposeRecipients');
                const s = document.getElementById('aiComposeSubject');
                const b = document.getElementById('aiComposeBody');
                if (p) p.value = prompt || '';
                if (r) r.value = recipients || '';
                if (s) s.value = subject || '';
                if (b) b.value = body || '';
            } catch(e) { /* noop */ }
            openAiAssistantModal();
        }

        function openGmailComposeFromAiModal(){
            try {
                const r = (document.getElementById('aiComposeRecipients')?.value || '').trim();
                const s = (document.getElementById('aiComposeSubject')?.value || '').trim();
                const b = (document.getElementById('aiComposeBody')?.value || '').trim();
                const url = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(r)}&su=${encodeURIComponent(s)}&body=${encodeURIComponent(b)}`;
                window.open(url, '_blank', 'noopener');
            } catch(e) { /* noop */ }
        }

        // Internal Chat logic
        let _chatCurrentTab = 'branch';
        function genChatId(){
            try {
                const a = new Uint32Array(2);
                if (window.crypto && crypto.getRandomValues) {
                    crypto.getRandomValues(a);
                    return `${Date.now().toString(36)}-${a[0].toString(36)}${a[1].toString(36)}`;
                }
            } catch(e) { /* noop */ }
            return `${Date.now()}-${Math.floor(Math.random()*1e9)}`;
        }
        function getChatMode(){
            return (document.getElementById('chatMode')?.value || 'board');
        }
        function getRecipientEmail(){
            const v = (document.getElementById('chatRecipient')?.value || '').trim().toLowerCase();
            return v;
        }
        function openChatDrawer(){
            const drawer = document.getElementById('chatDrawer');
            const overlay = document.getElementById('chatOverlay');
            if (drawer) drawer.classList.remove('translate-x-full');
            if (overlay) overlay.classList.remove('hidden');
            bindChatTabs();
            renderChatTab(_chatCurrentTab);
        }
        function closeChatDrawer(){
            const drawer = document.getElementById('chatDrawer');
            const overlay = document.getElementById('chatOverlay');
            if (drawer) drawer.classList.add('translate-x-full');
            if (overlay) overlay.classList.add('hidden');
        }
        function bindChatTabs(){
            try {
                const tabs = Array.from(document.querySelectorAll('button[data-chat-tab]'));
                tabs.forEach(function(b){
                    b.onclick = function(){
                        tabs.forEach(x => x.className = 'px-3 py-1.5 text-sm rounded bg-gray-100');
                        b.className = 'px-3 py-1.5 text-sm rounded bg-brand text-white';
                        _chatCurrentTab = b.getAttribute('data-chat-tab');
                        const mode = getChatMode();
                        const recip = getRecipientEmail();
                        document.getElementById('chatScopeLabel').textContent = mode === 'dm' && recip ? ('DM: ' + recip) : ('Scope: ' + (_chatCurrentTab.charAt(0).toUpperCase()+_chatCurrentTab.slice(1)));
                        renderChatTab(_chatCurrentTab);
                    };
                });
                const filter = document.getElementById('chatFilter');
                if (filter) filter.onchange = function(){ renderChatTab(_chatCurrentTab); };
                const modeSel = document.getElementById('chatMode');
                const recipInput = document.getElementById('chatRecipient');
                if (modeSel) modeSel.onchange = function(){
                    if (getChatMode() === 'dm') {
                        recipInput.classList.remove('hidden');
                    } else {
                        recipInput.classList.add('hidden');
                    }
                    const mode = getChatMode();
                    const recip = getRecipientEmail();
                    document.getElementById('chatScopeLabel').textContent = mode === 'dm' && recip ? ('DM: ' + recip) : ('Scope: ' + (_chatCurrentTab.charAt(0).toUpperCase()+_chatCurrentTab.slice(1)));
                    renderChatTab(_chatCurrentTab);
                };
                if (recipInput) recipInput.oninput = function(){
                    const mode = getChatMode();
                    const recip = getRecipientEmail();
                    document.getElementById('chatScopeLabel').textContent = mode === 'dm' && recip ? ('DM: ' + recip) : ('Scope: ' + (_chatCurrentTab.charAt(0).toUpperCase()+_chatCurrentTab.slice(1)));
                    renderChatTab(_chatCurrentTab);
                };
            } catch (e) { console.warn('bindChatTabs failed:', e); }
        }
        function getChatScopeKey(tab){
            if (!currentUser) return 'Unknown';
            if (tab === 'branch') return currentUser.branch || 'Unknown';
            if (tab === 'region') return currentUser.region || 'Unknown';
            return currentUser.market || 'Unknown';
        }
        function dmStorageKey(email){
            const e = String(email || '').toLowerCase();
            if (!e) return null;
            return `chat.dm.${e}`;
        }
        function storageKey(tab){
            const k = getChatScopeKey(tab);
            return `chat.${tab}.${k}`;
        }
        function getCurrentChatKey(){
            const mode = getChatMode();
            if (mode === 'dm') {
                return dmStorageKey(getRecipientEmail());
            }
            return storageKey(_chatCurrentTab);
        }
        function canEditDelete(msg){
            try {
                const me = String(currentUser?.name || '').trim();
                const by = String(msg?.by || '').trim();
                const role = String(currentUser?.role || '').toLowerCase();
                const isOwner = me && by && me === by;
                const isAdmin = Boolean(currentUser?.isAdmin) || role.includes('admin') || Boolean(currentUser?.canModerate);
                return isOwner || isAdmin;
            } catch { return false; }
        }
        function renderChatTab(tab){
            const listEl = document.getElementById('chatMessagesList');
            if (!listEl) return;
            const filter = (document.getElementById('chatFilter')?.value || 'all');
            const mode = getChatMode();
            let items = [];
            if (mode === 'dm') {
                const k = dmStorageKey(getRecipientEmail());
                items = k ? JSON.parse(localStorage.getItem(k) || '[]') : [];
            } else {
                items = JSON.parse(localStorage.getItem(storageKey(tab)) || '[]');
            }
            const filtered = filter === 'all' ? items : items.filter(i => i.category === filter);
            if (!filtered.length) {
                listEl.innerHTML = '<div class="text-sm text-gray-600">No messages yet. Start the conversation.</div>';
                return;
            }
            listEl.innerHTML = filtered.map(i => {
                const id = String(i.id || '');
                const allow = id && canEditDelete(i);
                const editedLabel = i.edited ? ' <span class="text-xs text-gray-400">(edited)</span>' : '';
                const actions = allow ? `
                    <div class="mt-1 flex gap-3">
                        <button class="text-xs text-brand hover:underline" data-action="edit" data-id="${escapeHtml(id)}">Edit</button>
                        <button class="text-xs text-red-600 hover:underline" data-action="delete" data-id="${escapeHtml(id)}">Delete</button>
                    </div>` : '';
                return `
                <div class="p-2 border rounded">
                    <div class="text-xs text-gray-500 flex items-center justify-between"><span>${escapeHtml(i.category)}</span><span>${new Date(i.at).toLocaleString()}</span></div>
                    <div class="text-sm text-gray-800">${escapeHtml(i.text)}${editedLabel}</div>
                    <div class="text-xs text-gray-400">by ${escapeHtml(i.by || 'Unknown')}</div>
                    ${actions}
                </div>`;
            }).join('');
            bindMessageActions();
        }
        function sendChatMessage(){
            const input = document.getElementById('chatMessageInput');
            const catSel = document.getElementById('chatCategory');
            const text = (input?.value || '').trim();
            const category = (catSel?.value || 'general');
            if (!text) return;
            const mode = getChatMode();
            let key = null;
            if (mode === 'dm') {
                const recip = getRecipientEmail();
                if (!recip) { alert('Please enter a recipient email'); return; }
                key = dmStorageKey(recip);
            } else {
                key = storageKey(_chatCurrentTab);
            }
            const items = JSON.parse(localStorage.getItem(key) || '[]');
            items.push({ id: genChatId(), text, category, by: currentUser?.name || '', at: new Date().toISOString(), edited: false });
            localStorage.setItem(key, JSON.stringify(items));
            input.value = '';
            renderChatTab(_chatCurrentTab);
        }
        function clearChatMessages(){
            const mode = getChatMode();
            const key = mode === 'dm' ? dmStorageKey(getRecipientEmail()) : storageKey(_chatCurrentTab);
            const ok = confirm('Clear all messages in this chat?');
            if (!ok) return;
            localStorage.removeItem(key);
            renderChatTab(_chatCurrentTab);
        }
        function bindMessageActions(){
            try {
                const listEl = document.getElementById('chatMessagesList');
                if (!listEl) return;
                const editBtns = Array.from(listEl.querySelectorAll('button[data-action="edit"]'));
                const delBtns = Array.from(listEl.querySelectorAll('button[data-action="delete"]'));
                editBtns.forEach(b => {
                    b.onclick = function(){
                        const id = b.getAttribute('data-id');
                        if (!id) return;
                        const key = getCurrentChatKey();
                        if (!key) return;
                        const items = JSON.parse(localStorage.getItem(key) || '[]');
                        const idx = items.findIndex(m => String(m.id||'') === String(id));
                        if (idx < 0) return;
                        const cur = items[idx];
                        const next = prompt('Edit message:', String(cur.text||''));
                        if (next === null) return; // cancelled
                        const t = String(next).trim();
                        if (!t) return; // ignore empty
                        items[idx] = { ...cur, text: t, edited: true };
                        localStorage.setItem(key, JSON.stringify(items));
                        renderChatTab(_chatCurrentTab);
                    };
                });
                delBtns.forEach(b => {
                    b.onclick = function(){
                        const id = b.getAttribute('data-id');
                        if (!id) return;
                        const ok = confirm('Delete this message?');
                        if (!ok) return;
                        const key = getCurrentChatKey();
                        if (!key) return;
                        const items = JSON.parse(localStorage.getItem(key) || '[]');
                        const next = items.filter(m => String(m.id||'') !== String(id));
                        localStorage.setItem(key, JSON.stringify(next));
                        renderChatTab(_chatCurrentTab);
                    };
                });
            } catch (e) { console.warn('bindMessageActions failed:', e); }
        }

        // Metric detail modal controls
        function handleMetricCardKey(e, metric, timeframe){
            const key = e.key || e.keyCode;
            if (key === 'Enter' || key === ' ' || key === 13 || key === 32) {
                e.preventDefault();
                openMetricModal(metric, timeframe);
            }
        }
        function openMetricModal(metric, timeframe){
            // Do not open metric modal while layout mode is active
            const rootLM = document.getElementById('dashboardContent');
            if (rootLM && rootLM.classList.contains('layout-mode')) return;
            const m = document.getElementById('metricModal');
            const c = document.getElementById('metricModalContent');
            if (!m || !c) return;
            const data = lastExecutiveData || { kpis:{ hoursSaved:0, dollarsSaved:0, adoptionRate:0, roiPercentage:0 }, forecast:{ threeMonth:{}, sixMonth:{}, twelveMonth:{} } };
            const fmtMoney = (v)=>'$'+Number(v||0).toLocaleString();
            const fmtPct = (v)=>Number(v||0).toFixed(1)+'%';
            let title = '';
            let html = '';
            if (metric === 'hoursSaved') {
                title = 'Hours Saved';
                html = `<div><p class="text-sm text-gray-600">Total estimated hours saved across workflows.</p><div class="mt-3 text-3xl font-bold text-brand">${Number(data.kpis.hoursSaved||0).toLocaleString()}</div></div>`;
            } else if (metric === 'dollarsSaved') {
                title = 'Dollars Saved';
                html = `<div><p class="text-sm text-gray-600">Estimated cost savings based on hours and rates.</p><div class="mt-3 text-3xl font-bold text-green-600">${fmtMoney(data.kpis.dollarsSaved)}</div></div>`;
            } else if (metric === 'adoptionRate') {
                title = 'Adoption Rate';
                html = `<div><p class="text-sm text-gray-600">Current adoption percentage across deployed branches.</p><div class="mt-3 text-3xl font-bold text-rentokil-blue">${fmtPct(data.kpis.adoptionRate)}</div></div>`;
            } else if (metric === 'roi') {
                title = 'ROI';
                const tf = String(timeframe||'').trim();
                const block = (label, f)=>`<div class="p-3 bg-gray-50 rounded mb-2"><div class="font-medium">${label}</div><div class="text-sm text-gray-700">Projected Savings: <span class="font-semibold text-green-600">${fmtMoney(f.savings)}</span></div><div class="text-sm text-gray-700">Adoption Target: <span class="font-semibold text-brand">${fmtPct(f.adoption)}</span></div></div>`;
                html = `<div><div class="text-sm text-gray-600 mb-3">Return on investment and forecast by timeframe.</div><div class="mb-3 text-3xl font-bold text-green-600">${fmtPct(data.kpis.roiPercentage)}</div>${block('3-Month', data.forecast.threeMonth || {})}${block('6-Month', data.forecast.sixMonth || {})}${block('12-Month', data.forecast.twelveMonth || {})}</div>`;
                if (tf === '3' || tf === '6' || tf === '12') {
                    // Emphasis for the selected timeframe (simple highlight)
                    html = html.replace(`<div class=\"font-medium\">${tf}-Month</div>`, `<div class=\"font-medium text-brand\">${tf}-Month</div>`);
                }
            } else if (metric === 'rollout') {
                // Director Drilldown: Branch / Region / Market tabs
                title = 'Rollout Drilldown';
                const scope = String(timeframe||'').toLowerCase();
                const ddata = (typeof lastDirectorData === 'object' && lastDirectorData) ? lastDirectorData : { rows: [] };
                const rows = Array.isArray(ddata.rows) ? ddata.rows : [];
                const groupBy = (key) => {
                    const map = new Map();
                    rows.forEach(r => {
                        const k = String(r[key]||'').trim() || 'Unassigned';
                        const cur = map.get(k) || { count: 0, adoptionSum: 0, items: [] };
                        cur.count += 1;
                        cur.adoptionSum += Number(r.adoption||0);
                        cur.items.push(r);
                        map.set(k, cur);
                    });
                    return Array.from(map.entries()).map(([name, v]) => ({ name, count: v.count, adoption: v.count ? Math.round((v.adoptionSum/v.count)) : 0, items: v.items }));
                };
                const branchGroups = groupBy('branch');
                const regionGroups = groupBy('region');
                const marketGroups = groupBy('market');
                const makeList = (groups) => {
                    if (!groups.length) return '<div class="text-sm text-gray-600">No data available.</div>';
                    const sorted = groups.sort((a,b)=> b.adoption - a.adoption);
                    return `<ul class="divide-y divide-gray-200">${sorted.map(g => `<li class="py-2 flex items-center justify-between"><div><div class="text-sm font-medium text-gray-800">${escapeHtml(g.name)}</div><div class="text-xs text-gray-500">Items: ${g.count}</div></div><div class="text-sm font-semibold text-brand">${g.adoption}%</div></li>`).join('')}</ul>`;
                };
                const renderTabContent = (tab) => {
                    if (tab === 'branch') return makeList(branchGroups);
                    if (tab === 'region') return makeList(regionGroups);
                    return makeList(marketGroups);
                };
                const initialTab = scope === 'regions' ? 'region' : (scope === 'markets' ? 'market' : 'branch');
                html = `
                    <div class="mb-3 text-sm text-gray-600">Explore adoption by branch, region, or market.</div>
                    <div class="flex gap-2 border-b pb-2 mb-3">
                        <button class="px-3 py-1.5 text-sm rounded ${initialTab==='branch'?'bg-brand text-white':'bg-gray-100'}" data-tab="branch">Branch</button>
                        <button class="px-3 py-1.5 text-sm rounded ${initialTab==='region'?'bg-brand text-white':'bg-gray-100'}" data-tab="region">Region</button>
                        <button class="px-3 py-1.5 text-sm rounded ${initialTab==='market'?'bg-brand text-white':'bg-gray-100'}" data-tab="market">Market</button>
                    </div>
                    <div id="metricTabsContent">${renderTabContent(initialTab)}</div>
                `;
                // Defer binding after insertion
                setTimeout(function(){
                    try {
                        const container = document.getElementById('metricTabsContent');
                        const btns = Array.from(c.querySelectorAll('button[data-tab]'));
                        btns.forEach(function(b){
                            b.addEventListener('click', function(){
                                const tab = b.getAttribute('data-tab');
                                btns.forEach(bb => bb.className = 'px-3 py-1.5 text-sm rounded bg-gray-100');
                                b.className = 'px-3 py-1.5 text-sm rounded bg-brand text-white';
                                if (container) container.innerHTML = renderTabContent(tab);
                            });
                        });
                    } catch (e) { console.warn('Metric tabs binding failed:', e); }
                }, 0);
            }
            c.innerHTML = `<h3 class="text-lg font-semibold text-gray-800 mb-2">${title}</h3>` + html + `<div class="mt-4 text-xs text-gray-500">Use the tabs to drill down by branch, region, or market.</div>`;
            m.classList.remove('hidden');
            setModalDefaultSize('metricModal');
            enableModalDrag('metricModal');
            enableModalResize('metricModal');
        }
        function closeMetricModal(){
            const m = document.getElementById('metricModal');
            if (m) m.classList.add('hidden');
            resetModalPosition('metricModal');
        }

        // Dynamic branding function
        function applyBranding(email) {
            const domain = (email || '').split('@')[1]?.toLowerCase() || '';
            const logoEl = document.getElementById('brandLogo');
            const initialEl = document.getElementById('brandInitial');
            const containerEl = document.getElementById('brandLogoContainer');
            const appTitle = document.getElementById('appTitle');
            const appSubtitle = document.getElementById('appSubtitle');
            const loadingTitle = document.getElementById('loadingTitle');

            // If local settings exist, prefer them
            const lsCompanyName = localStorage.getItem('companyName');
            const lsBrandColor = localStorage.getItem('brandColor');
            const lsLogoUrl = localStorage.getItem('logoUrl');
            const lsSystemType = localStorage.getItem('systemType');
            if (lsCompanyName || lsBrandColor || lsLogoUrl || lsSystemType) {
                // If logo URL missing, use known brand presets based on company name
                let presetLogo = '';
                let presetColor = '';
                const nameLower = (lsCompanyName || '').toLowerCase();
                if (!lsLogoUrl && nameLower.includes('presto-x')) {
                    presetLogo = 'https://ik.imagekit.io/9cyexhymf/Presto-X%20Logo-ARentokilCompany.png?updatedAt=1762540113819';
                    presetColor = '#D62D2D';
                } else if (!lsLogoUrl && (nameLower.includes('bugout') || nameLower.includes('bug-out'))) {
                    // Official BugOut logo
                    presetLogo = 'https://ik.imagekit.io/9cyexhymf/BugOut%20Logo.png?updatedAt=1762651397528';
                    presetColor = '#16A34A';
                } else if (!lsLogoUrl && nameLower.includes('terminix')) {
                    presetLogo = 'https://ik.imagekit.io/9cyexhymf/terminix_color_lg.png?updatedAt=1762622940808';
                    presetColor = '#3F9A38';
                } else if (!lsLogoUrl && nameLower.includes('rentokil')) {
                    presetLogo = 'https://ik.imagekit.io/9cyexhymf/Rentokil%20Logo.png?updatedAt=1762651397519';
                    presetColor = '#E4002B';
                }
                const info = {
                    name: lsCompanyName || 'Branch360',
                    color: (lsBrandColor || presetColor || getComputedStyle(document.documentElement).getPropertyValue('--brand-color') || '#334E68'),
                    logo: lsLogoUrl || presetLogo || '',
                    systemType: lsSystemType || 'Branch360'
                };
                // Ensure Rentokil uses the official PNG logo if an outdated Wikipedia URL is present
                if ((lsCompanyName || '').toLowerCase().includes('rentokil')) {
                    const preferredLogo = 'https://ik.imagekit.io/9cyexhymf/Rentokil%20Logo.png?updatedAt=1762651397519';
                    if (!info.logo || /wikipedia\.org/i.test(info.logo)) {
                        info.logo = preferredLogo;
                    }
                    // Respect selected brand color; default to Rentokil red if missing
                    info.color = info.color || '#E4002B';
                }
                applyBrandInfo(info);
                return;
            }

            // Demo default: apply Presto-X branding when previewing locally or with ?demo=1
            try {
              const isLocalPreview = (location.hostname === 'localhost' || location.hostname === '127.0.0.1');
              const params = new URLSearchParams(location.search);
              const isDemo = params.get('demo') === '1' || params.get('demoBrand') === 'presto-x';
              if (isLocalPreview || isDemo) {
                applyBrandPreset('Presto-X');
                return;
              }
            } catch(_) {}

            // Try to get brand info from backend first
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(function(brandInfo) {
                        console.log('Brand info from backend:', brandInfo);
                        applyBrandInfo(brandInfo);
                    })
                    .withFailureHandler(function(error) {
                        console.warn('Failed to get brand info from backend, using fallback:', error);
                        applyFallbackBranding(domain);
                    })
                    .getBrandInfo();
            } else {
                // Fallback for when backend is not available
                applyFallbackBranding(domain);
            }
        }

        // Graceful loader for PDF.js with localhost-first strategy to avoid ORB in preview
        async function ensurePdfJs() {
            if (window.pdfjsLib) {
                try {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = pdfjsLib.GlobalWorkerOptions.workerSrc || 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.108/pdf.worker.min.js';
                } catch (e) {}
                return true;
            }
            const isLocalPreview = (location.hostname === 'localhost' || location.hostname === '127.0.0.1');
            const tryLoad = (src) => new Promise((resolve) => {
                const s = document.createElement('script');
                s.src = src;
                s.crossOrigin = 'anonymous';
                s.onload = () => resolve(true);
                s.onerror = () => resolve(false);
                document.head.appendChild(s);
            });
            // Prefer local files on localhost to avoid cross-origin blocking in IDE previews
            const localSources = ['/pdfjs/pdf.min.js'];
            const cdnSources = [
                'https://unpkg.com/pdfjs-dist@3.11.108/build/pdf.min.js',
                'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.108/build/pdf.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.108/pdf.min.js'
            ];
            const sources = isLocalPreview ? localSources : [...cdnSources, ...localSources];
            for (const src of sources) {
                const ok = await tryLoad(src);
                if (ok && window.pdfjsLib) {
                    try {
                        if (src.startsWith('/pdfjs/')) {
                            pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdfjs/pdf.worker.min.js';
                        } else if (src.includes('unpkg') || src.includes('jsdelivr') || src.includes('cdnjs')) {
                            pdfjsLib.GlobalWorkerOptions.workerSrc = src.replace('pdf.min.js', 'pdf.worker.min.js');
                        }
                    } catch (e) {}
                    return true;
                }
            }
            const statusEl = document.getElementById('quoteParseStatus');
            if (statusEl) {
                statusEl.innerHTML = 'PDF parser unavailable in local preview. Please place <code>pdf.min.js</code> and <code>pdf.worker.min.js</code> under <code>/pdfjs/</code>.';
            }
            return false;
        }

        // Apply brand info from backend
        // Color utilities for dynamic brand variants and contrast
        function hexToRgb(hex){
            if (!hex) return {r:0,g:0,b:0};
            let s = String(hex).trim().replace('#','');
            if (s.length === 3) { s = s.split('').map(c => c + c).join(''); }
            const n = parseInt(s, 16);
            return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 };
        }
        function relativeLuminance(hex){
            const {r,g,b} = hexToRgb(hex);
            const sr = r/255, sg = g/255, sb = b/255;
            const lin = x => (x <= 0.03928 ? x/12.92 : Math.pow((x+0.055)/1.055, 2.4));
            const R = lin(sr), G = lin(sg), B = lin(sb);
            return 0.2126*R + 0.7152*G + 0.0722*B;
        }
        function getContrastText(hex){
            const L = relativeLuminance(hex);
            return L < 0.5 ? '#FFFFFF' : '#2B2B2B';
        }
        function clamp(v){ return Math.max(0, Math.min(255, Math.round(v))); }
        function toHex(r,g,b){
            const h = (clamp(r) << 16) | (clamp(g) << 8) | clamp(b);
            return '#' + h.toString(16).padStart(6, '0').toUpperCase();
        }
        function lighten(hex, pct){
            const {r,g,b} = hexToRgb(hex);
            const p = Math.max(0, Math.min(1, pct));
            return toHex(r + (255 - r)*p, g + (255 - g)*p, b + (255 - b)*p);
        }
        function darken(hex, pct){
            const {r,g,b} = hexToRgb(hex);
            const p = Math.max(0, Math.min(1, pct));
            return toHex(r*(1-p), g*(1-p), b*(1-p));
        }
        function applyBrandInfo(brandInfo) {
            const logoEl = document.getElementById('brandLogo');
            const initialEl = document.getElementById('brandInitial');
            const containerEl = document.getElementById('brandLogoContainer');
            const brandTaglineInner = document.getElementById('brandTaglineInner');
            const appTitle = document.getElementById('appTitle');
            const appSubtitle = document.getElementById('appSubtitle');
            const loadingTitle = document.getElementById('loadingTitle');

            const themePrimary = brandInfo.colorPrimary || brandInfo.color || '#334E68';
            const themeAccent = brandInfo.colorAccent || lighten(themePrimary, 0.18);
            const themeDark = brandInfo.colorDark || darken(themePrimary, 0.12);
            const themeBackground = brandInfo.background || '';
            const logoUrl = brandInfo.logo;
            const companyName = brandInfo.name;
            const subtitle = brandInfo.systemType || 'Branch360';
            const isRentokil = (companyName || '').toLowerCase().includes('rentokil');

            // Apply theme color to CSS custom property
            document.documentElement.style.setProperty('--brand-color', themePrimary);
            document.documentElement.style.setProperty('--brand-accent', themeAccent);
            document.documentElement.style.setProperty('--brand-color-dark', themeDark);
            document.documentElement.style.setProperty('--brand-color-light', themeAccent);
            document.documentElement.style.setProperty('--brand-contrast-text-color', getContrastText(themePrimary));
            if (themeBackground) {
                document.body.style.backgroundColor = themeBackground;
            }
            
            // Update logo via Logo Builder (if enabled), otherwise use provided logo/initial
            if (logoEl && initialEl && containerEl) {
                const builderEnabled = localStorage.getItem('logoBuilderEnabled') === 'true';
                if (builderEnabled) {
                    applyLogoBuilderToUI({ fallbackCompanyName: companyName, fallbackLogoUrl: logoUrl });
                    // When using builder (likely includes tagline in asset), hide inner tagline
                    if (brandTaglineInner) {
                        brandTaglineInner.textContent = '';
                        brandTaglineInner.classList.add('hidden');
                    }
                } else {
                    // Keep logo background neutral (transparent); do not force brand color
                    containerEl.style.backgroundColor = 'transparent';
                    if (logoUrl) {
                        // Use provided logo for other brands
                        logoEl.src = logoUrl;
                        logoEl.alt = companyName + ' Logo';
                        logoEl.style.display = 'block';
                        // Reset any wordmark styles when not used
                        initialEl.style.fontSize = '';
                        initialEl.style.lineHeight = '';
                        initialEl.style.letterSpacing = '';
                        initialEl.style.color = '';
                        initialEl.style.display = 'none';
                        logoEl.onerror = function() {
                            logoEl.style.display = 'none';
                            initialEl.textContent = companyName.charAt(0);
                            initialEl.style.fontSize = '';
                            initialEl.style.lineHeight = '';
                            initialEl.style.letterSpacing = '';
                            initialEl.style.color = '';
                            initialEl.style.display = 'block';
                            if (brandTaglineInner) {
                                brandTaglineInner.textContent = '';
                                brandTaglineInner.classList.add('hidden');
                            }
                        };
                        // Hide standalone tagline when an image logo is shown (to avoid duplication)
                        if (brandTaglineInner) {
                            brandTaglineInner.textContent = '';
                            brandTaglineInner.classList.add('hidden');
                        }
                    } else {
                        // Fallback to first initial in brand color for other brands
                        initialEl.textContent = companyName.charAt(0);
                        initialEl.style.fontSize = '';
                        initialEl.style.lineHeight = '';
                        initialEl.style.letterSpacing = '';
                        initialEl.style.color = '';
                        initialEl.style.display = 'block';
                        logoEl.style.display = 'none';
                        if (brandTaglineInner) {
                            brandTaglineInner.textContent = '';
                            brandTaglineInner.classList.add('hidden');
                        }
                    }
                }
            }
            
            // Keep UI title as product name; avoid repeating company name from logo
            if (appTitle) appTitle.textContent = 'Branch360';
            // Subtitle stays consistent across brands
            if (appSubtitle) appSubtitle.textContent = 'Streamlined Operations';
            if (loadingTitle) loadingTitle.textContent = `Loading ${companyName.replace(' System', '')}...`;
            
            // Update theme colors in Tailwind
            document.documentElement.style.setProperty('--brand-color', themePrimary);
            document.documentElement.style.setProperty('--brand-color-light', themeAccent);
            document.documentElement.style.setProperty('--brand-color-dark', themeDark);
            document.documentElement.style.setProperty('--brand-contrast-text-color', getContrastText(themePrimary));
            // Reinitialize icon motion to reflect updated brand accent/colors
            try { initIconMotion(); } catch (e) { console.warn('Icon motion refresh failed', e); }
        }

        // Fallback branding when backend is not available
        function applyFallbackBranding(domain) {
            let themeColor, logoUrl, companyName, subtitle;

            if (domain.includes('prestox') || domain.includes('presto-x')) {
                // Unified with backend BRAND_MAP colorPrimary
                themeColor = '#E4002B';
                // Presto-X official logo provided
                logoUrl = 'https://ik.imagekit.io/9cyexhymf/Presto-X%20Logo-ARentokilCompany.png?updatedAt=1762540113819';
                companyName = 'Presto-X System';
                subtitle = 'Branch360';
            } else if (domain.includes('bugout') || domain.includes('bug-out')) {
                themeColor = '#16A34A'; // BugOut green primary
                // Official BugOut logo
                logoUrl = 'https://ik.imagekit.io/9cyexhymf/BugOut%20Logo.png?updatedAt=1762651397528';
                companyName = 'BugOut System';
                subtitle = 'Branch360';
            } else if (domain.includes('terminix')) {
                themeColor = '#3F9A38'; // Terminix green
                logoUrl = 'https://ik.imagekit.io/9cyexhymf/terminix_color_lg.png?updatedAt=1762622940808';
                companyName = 'Terminix System';
                subtitle = 'Branch360';
            } else if (domain.includes('rentokil')) {
                themeColor = '#E4002B'; // Rentokil red primary
                logoUrl = 'https://ik.imagekit.io/9cyexhymf/Rentokil%20Logo.png?updatedAt=1762651397519';
                companyName = 'Rentokil System';
                subtitle = 'Branch360';
            } else {
                themeColor = '#334E68'; // neutral default
                // Default to initials fallback rather than external placeholder
                logoUrl = '';
                companyName = 'Branch360';
                subtitle = 'Branch360';
            }

            const logoEl = document.getElementById('brandLogo');
            const initialEl = document.getElementById('brandInitial');
            const containerEl = document.getElementById('brandLogoContainer');
            const appTitle = document.getElementById('appTitle');
            const appSubtitle = document.getElementById('appSubtitle');
            const loadingTitle = document.getElementById('loadingTitle');

            // Apply theme color to CSS custom property
            const accent = lighten(themeColor, 0.18);
            const dark = darken(themeColor, 0.12);
            const contrast = getContrastText(themeColor);
            document.documentElement.style.setProperty('--brand-color', themeColor);
            document.documentElement.style.setProperty('--brand-color-light', accent);
            document.documentElement.style.setProperty('--brand-color-dark', dark);
            document.documentElement.style.setProperty('--brand-contrast-text-color', contrast);
            
            // Update logo via Logo Builder (if enabled), otherwise use provided logo/initial
            if (logoEl && initialEl && containerEl) {
                const builderEnabled = localStorage.getItem('logoBuilderEnabled') === 'true';
                if (builderEnabled) {
                    applyLogoBuilderToUI({ fallbackCompanyName: companyName, fallbackLogoUrl: logoUrl });
                    const brandTaglineInner = document.getElementById('brandTaglineInner');
                    if (brandTaglineInner) {
                        brandTaglineInner.textContent = '';
                        brandTaglineInner.classList.add('hidden');
                    }
                } else {
                    containerEl.style.backgroundColor = 'transparent';
                    if (logoUrl) {
                        logoEl.src = logoUrl;
                        logoEl.alt = companyName + ' Logo';
                        logoEl.style.display = 'block';
                        initialEl.style.display = 'none';
                        logoEl.onerror = function() {
                            logoEl.style.display = 'none';
                            initialEl.textContent = companyName.charAt(0);
                            initialEl.style.display = 'block';
                        };
                        const brandTaglineInner = document.getElementById('brandTaglineInner');
                        if (brandTaglineInner) {
                            brandTaglineInner.textContent = '';
                            brandTaglineInner.classList.add('hidden');
                        }
                    } else {
                        initialEl.textContent = companyName.charAt(0);
                        initialEl.style.display = 'block';
                        logoEl.style.display = 'none';
                        const brandTaglineInner = document.getElementById('brandTaglineInner');
                        if (brandTaglineInner) {
                            brandTaglineInner.textContent = '';
                            brandTaglineInner.classList.add('hidden');
                        }
                    }
                }
            }
            
        // Keep UI title as product name; avoid repeating company name from logo
        if (appTitle) appTitle.textContent = 'Branch360';
            // Subtitle stays consistent across brands
            if (appSubtitle) appSubtitle.textContent = 'Streamlined Operations';
        // Brand-specific tagline inside logo container (Rentokil wordmark only)
        const brandTaglineEl = document.getElementById('brandTaglineInner');
        if (brandTaglineEl) {
            const isRentokilDomain = domain.includes('rentokil') || (companyName || '').toLowerCase().includes('rentokil');
            const logoEl = document.getElementById('brandLogo');
            const initialEl = document.getElementById('brandInitial');
            const isImageLogoVisible = !!(logoEl && logoEl.style.display !== 'none');
            const isWordmarkActive = !!(initialEl && initialEl.style.display !== 'none' && (initialEl.textContent || '').toLowerCase() === 'rentokil');
            if (isRentokilDomain && isWordmarkActive && !isImageLogoVisible) {
                brandTaglineEl.textContent = 'The Experts In Pest Control';
                brandTaglineEl.classList.remove('hidden');
            } else {
                brandTaglineEl.textContent = '';
                brandTaglineEl.classList.add('hidden');
            }
        }
            if (loadingTitle) loadingTitle.textContent = `Loading ${companyName.replace(' System', '')}...`;
            
            // Update theme colors in Tailwind
            document.documentElement.style.setProperty('--brand-color', themeColor);
        }

        // Initialize the application
        function initializeApp() {
            console.log('Initializing Branch360...');
            
            // Apply default branding immediately
            applyBranding('');
            // Initialize Settings UI values
            const schemeSel = document.getElementById('chipColorSchemeSelector');
            if (schemeSel) schemeSel.value = getChipColorScheme();
            
            // Set a timeout to prevent infinite loading
            const loadingTimeout = setTimeout(() => {
                console.warn('Loading timeout reached - showing fallback');
                currentUser = { name: 'Demo User', role: 'Market Director', email: 'demo@company.com' };
                applyBranding('demo@company.com');
                showDashboard('executive');
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
            }, 8000); // 8 second timeout
            
            // Try to load user data from backend
            try {
                loadUserData(loadingTimeout);
            } catch (error) {
                console.error('Failed to initialize app:', error);
                clearTimeout(loadingTimeout);
                // Fallback to mock data and show dashboard
                currentUser = { name: 'Demo User', role: 'Market Director', email: 'demo@company.com' };
                applyBranding('demo@company.com');
                showDashboard('executive');
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
            }
            
            loadTheme();
            loadDashboardViewPreference();
            checkCadenceStatus();
            
            // Set up auto-refresh for presentation mode
            EventRegistry.setInterval(() => {
                if (presentationMode) {
                    refreshDashboard();
                }
            }, 10000);
            
            // Check cadence status every minute
            EventRegistry.setInterval(checkCadenceStatus, 60000);

            // Close action menu on outside click or Escape (tracked)
            EventRegistry.addEventListener(document, 'click', handleGlobalClickForActionMenu);
            EventRegistry.addEventListener(document, 'keydown', function(e){ if (e.key === 'Escape') closeActionMenu(); });

            // Initialize global modal behaviors (click outside + Escape to close)
            initGlobalModalBehaviors();

            // Apply dashboard visibility after initial load (mock user)
            applyDashboardVisibility();
        }

        // Global modal utilities
        function initGlobalModalBehaviors(){
            ['metricModal','cohortsModal','trainingModal','targetsModal'].forEach(bindModalClickOutside);
            document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeTopMostModal(); });
        }
        function bindModalClickOutside(modalId){
            const el = document.getElementById(modalId);
            if (!el) return;
            el.addEventListener('click', function(ev){
                // If click is on the overlay (not inside the modal window), close it
                if (!ev.target.closest('.modal-window')) {
                    closeModalById(modalId);
                }
            });
        }
        function closeTopMostModal(){
            const ids = ['metricModal','cohortsModal','trainingModal','targetsModal'];
            for (let i=0;i<ids.length;i++){
                const el = document.getElementById(ids[i]);
                if (el && !el.classList.contains('hidden')) { closeModalById(ids[i]); return; }
            }
        }
        function closeModalById(id){
            switch(id){
                case 'metricModal': return closeMetricModal();
                case 'cohortsModal': return closeCohortsManager();
                case 'trainingModal': return closeTrainingScheduler();
                case 'targetsModal': return closeAdoptionTargets();
                default:
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
            }
        }

        // Debug function to test backend connectivity
        function testBackendConnection() {
            console.log('Testing backend connection...');
            
            // Test getCurrentUser
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('getCurrentUser success:', result);
                })
                .withFailureHandler(function(error) {
                    console.error('getCurrentUser failed:', error);
                })
                .getCurrentUser();
            
            // Test isCadenceReady
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('isCadenceReady success:', result);
                })
                .withFailureHandler(function(error) {
                    console.error('isCadenceReady failed:', error);
                })
                .isCadenceReady();
            
            // Test getDashboardData
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('getDashboardData success:', result);
                })
                .withFailureHandler(function(error) {
                    console.error('getDashboardData failed:', error);
                })
                .getDashboardData('Sales');
        }

        // Exit test mode
        function exitTestMode() {
            localStorage.removeItem('testMode');
            localStorage.removeItem('testUser');
            window.location.reload();
        }

        // Load user data
        function loadUserData(loadingTimeout) {
            console.log('Loading user data...');
            
            // Local preview fallback when Apps Script is unavailable
            if (!hasAppsScript()) {
                console.log('Apps Script unavailable - using local preview mock user');
                clearTimeout(loadingTimeout);
                currentUser = { name: 'Demo User', role: 'Market Director', email: 'demo@company.com' };
                const nameEl = document.getElementById('userName');
                const roleEl = document.getElementById('userRole');
                const initEl = document.getElementById('userInitial');
                if (nameEl) nameEl.textContent = currentUser.name;
                if (roleEl) roleEl.textContent = currentUser.role;
                if (initEl) initEl.textContent = currentUser.name.charAt(0);
                applyBranding(currentUser.email);
                // Configure Market Director owner email for preview and apply visibility
                try {
                    if (!localStorage.getItem('marketDirectorOwnerEmail')) {
                        localStorage.setItem('marketDirectorOwnerEmail', String(currentUser.email || '').toLowerCase());
                    }
                } catch (e) {}
                applyDashboardVisibility();
                showDashboard('director');
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
                return;
            }
            
            // Check if we're in test mode
            const testMode = localStorage.getItem('testMode');
            const testUser = localStorage.getItem('testUser');
            
            if (testMode === 'true' && testUser) {
                console.log('Test mode detected - using mock user data');
                clearTimeout(loadingTimeout); // Clear the timeout
                
                // Show test mode indicator
                document.getElementById('testModeIndicator').classList.remove('hidden');
                
                const userData = JSON.parse(testUser);
                currentUser = userData;
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userRole').textContent = userData.role;
                document.getElementById('userInitial').textContent = userData.name.charAt(0);
                
                // Apply dynamic branding based on email domain
                applyBranding(userData.email);
                
                // Load appropriate dashboard
                const role = userData.role.toLowerCase();
                if (role === 'sales') {
                    showDashboard('sales');
                } else if (role === 'operations') {
                    showDashboard('operations');
                } else if (role === 'branch manager') {
                    showDashboard('branch');
                } else if (role === 'executive' || role === 'admin') {
                    // Route executive/admin to the Market Sales Enablement & Efficiency Director view when authorized
                    const owner = String(localStorage.getItem('marketDirectorOwnerEmail') || '').toLowerCase();
                    if (owner && String(userData.email || '').toLowerCase() === owner) {
                        showDashboard('director');
                    } else {
                        showDashboard('operations');
                    }
                } else {
                    showDashboard('sales');
                }
                
                // Hide loading screen
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
                return;
            }
            
            // Normal backend call
            if (!hasAppsScript()) {
                // Local preview fallback: minimal user and branding
                currentUser = { name: 'Local Preview', role: 'Market Director', email: 'demo@company.com' };
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userRole').textContent = currentUser.role;
                document.getElementById('userInitial').textContent = currentUser.name.charAt(0);
                applyBranding(currentUser.email);
                applyDashboardVisibility();
                showDashboard('executive');
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
                return;
            }
            google.script.run
                .withSuccessHandler(function(userData) {
                    console.log('User data loaded successfully:', userData);
                    clearTimeout(loadingTimeout); // Clear the timeout on success
                    currentUser = userData;
                    document.getElementById('userName').textContent = userData.name;
                    document.getElementById('userRole').textContent = userData.role;
                    document.getElementById('userInitial').textContent = userData.name.charAt(0);
                    
                    // Apply dynamic branding based on branch or email via backend map
                    if (hasAppsScript()) {
                    google.script.run
                        .withSuccessHandler(function(brand){
                            applyBrandInfo(brand);
                        })
                        .withFailureHandler(function(err){
                            console.warn('getBranchBrand failed, falling back to email-based branding:', err);
                            applyBranding(userData.email);
                        })
                        .getBranchBrand(userData.branch || userData.email);
                    } else {
                        applyBranding(userData.email);
                    }
                    
                    // Apply dashboard visibility based on role
                    applyDashboardVisibility();
                    // Set Market Director owner email if not configured
                    try {
                        if (!localStorage.getItem('marketDirectorOwnerEmail')) {
                            localStorage.setItem('marketDirectorOwnerEmail', String(userData.email || '').toLowerCase());
                        }
                    } catch (e) {}
                    // Load appropriate dashboard
                    const role = userData.role.toLowerCase();
                    if (role === 'sales') {
                        showDashboard('sales');
                    } else if (role === 'operations') {
                        showDashboard('operations');
                    } else if (role === 'branch manager') {
                        showDashboard('branch');
                    } else if (role === 'executive' || role === 'admin') {
                        const owner = String(localStorage.getItem('marketDirectorOwnerEmail') || '').toLowerCase();
                        if (owner && String(userData.email || '').toLowerCase() === owner) {
                            showDashboard('director');
                        } else {
                            showDashboard('operations');
                        }
                    } else {
                        showDashboard('sales');
                    }
                    
                    // Hide loading screen
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('mainContainer').classList.remove('hidden');
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading user data:', error);
                    clearTimeout(loadingTimeout); // Clear the timeout on failure
                    // Apply default branding and fallback to sales dashboard
                    applyBranding('');
                    showDashboard('sales');
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('mainContainer').classList.remove('hidden');
        })
        .getCurrentUserRole();
    }

    // Show dashboard based on role
    function isAdminUser(){
        try {
            const role = String(currentUser?.role || '').toLowerCase();
            const explicit = Boolean(currentUser?.isAdmin) || Boolean(currentUser?.canModerate);
            const byRole = role.includes('admin');
            return explicit || byRole;
        } catch(_) { return false; }
    }
    function isDemoMode(){
        try {
            const enabled = (localStorage.getItem('demoModeEnabled') === 'true') || (localStorage.getItem('demoMode') === 'true');
            return enabled && isAdminUser();
        } catch(_) { return false; }
    }
    function enableDemoMode(flag, personaOpt){
        try {
            localStorage.setItem('demoModeEnabled', flag ? 'true' : 'false');
            if (personaOpt) localStorage.setItem('demoPersona', personaOpt);
        } catch(_) {}
        try { if (flag) { showDemoBanner(); } else { hideDemoBanner(); } } catch(_) {}
    }
    function saveDemoSettings(){
        const enabled = !!document.getElementById('demoModeToggle')?.checked;
        const persona = document.getElementById('demoPersonaSelect')?.value || 'Sales';
        try {
            localStorage.setItem('demoModeEnabled', enabled ? 'true' : 'false');
            localStorage.setItem('demoPersona', persona);
        } catch(_) {}
        try {
            if (enabled) { showDemoBanner(); } else { hideDemoBanner(); }
            showDashboard(currentDashboard || 'sales');
        } catch(_) {}
    }
    function showDemoBanner(){
        const id = 'demoModeBanner';
        let banner = document.getElementById(id);
        const persona = localStorage.getItem('demoPersona') || 'Demo';
        if (!banner) {
            banner = document.createElement('div');
            banner.id = id;
            banner.className = 'fixed top-2 right-2 z-50 px-3 py-1.5 rounded-md text-xs bg-amber-600 text-white shadow';
            document.body.appendChild(banner);
        }
        banner.textContent = `Demo Mode â€“ ${persona}`;
        banner.style.display = isDemoMode() ? '' : 'none';
    }
    function hideDemoBanner(){
        const banner = document.getElementById('demoModeBanner');
        if (banner) banner.style.display = 'none';
    }
    function showDashboard(type, evt) {
        // Demo persona override
        try {
            if (isDemoMode()) {
                const persona = (localStorage.getItem('demoPersona') || '').toLowerCase();
                const overrideMap = { 'sales':'sales', 'operations':'operations', 'branch manager':'branch', 'executive':'executive', 'admin':'director' };
                const forced = overrideMap[persona];
                if (forced) type = forced;
            }
        } catch(_) {}
        // Enforce authorization before switching views
        if (!canViewDashboard(type)) {
            try { toast('Not authorized to view this dashboard'); } catch (e) { alert('Not authorized to view this dashboard'); }
            return;
        }
            currentDashboard = type;

            // Apply role-based defaults for view mode if not set
            try {
                const saved = localStorage.getItem('dashboardView');
                const roleMap = { sales:'Sales', operations:'Ops', branch:'Manager', executive:'Executive' };
                const role = roleMap[type] || 'Sales';
                if (!saved && window.RoleDefaults && window.RoleDefaults[role]?.defaultView) {
                    localStorage.setItem('dashboardView', window.RoleDefaults[role].defaultView);
                }
                // Refresh in-memory preference
                loadDashboardViewPreference();
            } catch(_) {}

            // Ensure Mail view is only visible on the Gmail dashboard
            const mailViewNode = document.getElementById('mail-view');
            if (mailViewNode) {
                const onGmail = type === 'gmail';
                mailViewNode.style.display = onGmail ? 'block' : 'none';
                // Clear focus overlay when leaving Gmail
                if (!onGmail) {
                    document.body.classList.remove('focus-mail');
                }
            }
            
            // Update navigation active state
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-brand', 'text-white', 'text-tagline', 'ring-brand', 'font-semibold', 'nav-active');
                btn.classList.add('hover:bg-brand', 'hover:text-white');
                // Default state should be grey tagline text
                btn.classList.add('text-tagline');
            });
            const btnForType = document.querySelector(`.nav-btn[data-view="${type}"]`);
            const target = (evt && evt.currentTarget) ? evt.currentTarget : btnForType;
            if (target) {
                target.classList.add('bg-brand', 'text-white', 'ring-brand', 'font-semibold');
                target.classList.remove('hover:bg-brand', 'hover:text-white', 'text-tagline');
                target.classList.add('nav-active');

                // Ripple animation on click
                if (evt) {
                    const rect = target.getBoundingClientRect();
                    const x = evt.clientX - rect.left;
                    const y = evt.clientY - rect.top;
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    ripple.style.left = `${x}px`;
                    ripple.style.top = `${y}px`;
                    target.appendChild(ripple);
                    ripple.addEventListener('animationend', () => ripple.remove());
                }
            }
            
            // Update dashboard title and content
                    function updateDashboardTitleIcon(type){
                try {
                    const slot = document.getElementById('dashboardTitleIcon');
                    if (!slot) return;
                    slot.innerHTML = '';
                    slot.style.display = 'inline-flex';
                    slot.style.alignItems = 'center';
                    const nav = document.getElementById('nav-' + type);
                    if (!nav) return;
                    const HEADER_SCALE = (type === 'gmail') ? 2.4 : 2.0; // make Gmail header icon larger
                    const preferEmoji = (localStorage.getItem('icons.useEmoji') || 'true') === 'true';
                    // Measure actual sidebar icon (brand icon preferred, then emoji, then SVG)
                    let basePx = 24;
                    try {
                        const iconEl = nav.querySelector('.brand-icon')
                            || nav.querySelector('span.text-xl[aria-hidden="true"], span.text-2xl[aria-hidden="true"]')
                            || nav.querySelector('svg[data-icon-name]');
                        if (iconEl) {
                            if (iconEl.classList && iconEl.classList.contains('brand-icon')) {
                                const computed = getComputedStyle(iconEl);
                                const sizeVar = (computed.getPropertyValue('--icon-size') || '').trim();
                                if (sizeVar) {
                                    basePx = parseFloat(sizeVar) || basePx;
                                } else {
                                    const rect = iconEl.getBoundingClientRect();
                                    basePx = Math.round(Math.max(rect.width, rect.height)) || basePx;
                                }
                            } else if (iconEl.tagName && iconEl.tagName.toLowerCase() === 'svg') {
                                const rect = iconEl.getBoundingClientRect();
                                basePx = Math.round(Math.max(rect.width, rect.height)) || basePx;
                            } else {
                                const computed = getComputedStyle(iconEl);
                                basePx = parseFloat(computed.fontSize) || basePx;
                            }
                        }
                    } catch(_) { /* noop */ }
                    const dashOverride = getDashboardIconOverride && getDashboardIconOverride();
                    if (dashOverride && dashOverride !== 'inherit') {
                        if (String(dashOverride).startsWith('pest:')) {
                            const pestName = String(dashOverride).slice(5);
                            const el = getPestIconElement(pestName, { size: Math.round(basePx * HEADER_SCALE), fixedColors: true });
                            el.style.pointerEvents = 'none';
                            slot.appendChild(el);
                            return;
                        } else {
                            const span = document.createElement('span');
                            span.className = 'text-xl';
                            span.setAttribute('aria-hidden','true');
                            span.textContent = dashOverride;
                            try {
                                span.style.fontSize = Math.round(basePx * HEADER_SCALE) + 'px';
                            } catch(_) { span.style.fontSize = '48px'; }
                            span.style.lineHeight = '1';
                            span.style.display = 'inline-flex';
                            span.style.alignItems = 'center';
                            span.style.pointerEvents = 'none';
                            slot.appendChild(span);
                            return;
                        }
                    }
                    // Prefer theme-aware app icons for Workspace dashboards when available
                    try {
                        if (!preferEmoji && (type === 'drive' || type === 'calendar' || type === 'gmail')) {
                            const key = (type === 'gmail') ? 'gmail' : type;
                            const hasAppIcon = !!(window.pestIcons && (window.pestIcons[key] || window.pestIcons[key + 'Dark'] || window.pestIcons[key + 'Light']));
                            if (hasAppIcon) {
                                const el = getPestIconElement(key, { size: Math.round(basePx * HEADER_SCALE), fixedColors: true });
                                el.style.pointerEvents = 'none';
                                slot.appendChild(el);
                                return;
                            }
                        }
                    } catch(e) { /* noop */ }
                    // If emoji preference is enabled, try emoji first; if none, use default pool
                    if (preferEmoji) {
                        const emoji = nav.querySelector('span.text-xl[aria-hidden="true"], span.text-2xl[aria-hidden="true"]');
                        if (emoji) {
                            const clone = emoji.cloneNode(true);
                            try { clone.style.fontSize = Math.round(basePx * HEADER_SCALE) + 'px'; } catch(_) { clone.style.fontSize = '48px'; }
                            clone.style.lineHeight = '1';
                            clone.style.display = 'inline-flex';
                            clone.style.alignItems = 'center';
                            clone.style.pointerEvents = 'none';
                            slot.appendChild(clone);
                            return;
                        } else {
                            const span = document.createElement('span');
                            span.className = 'text-xl';
                            span.setAttribute('aria-hidden','true');
                            span.textContent = getDefaultEmojiFor(type);
                            try { span.style.fontSize = Math.round(basePx * HEADER_SCALE) + 'px'; } catch(_) { span.style.fontSize = '48px'; }
                            span.style.lineHeight = '1';
                            span.style.display = 'inline-flex';
                            span.style.alignItems = 'center';
                            span.style.pointerEvents = 'none';
                            slot.appendChild(span);
                            return;
                        }
                    }
                    // Prefer the already-branded icon used in the sidebar
                    const brandIcon = nav.querySelector('.brand-icon');
                    if (brandIcon) {
                        const clone = brandIcon.cloneNode(true);
                        const targetPx = Math.round(basePx * HEADER_SCALE);
                        clone.style.setProperty('--icon-size', targetPx + 'px');
                        clone.style.pointerEvents = 'none';
                        slot.appendChild(clone);
                        return;
                    }
                    // If no branded icon yet, use original SVG's data-icon-name
                    const svg = nav.querySelector('svg[data-icon-name]');
                    if (svg) {
                        const key = svg.getAttribute('data-icon-name');
                        const el = getPestIconElement(key, { size: Math.round(basePx * HEADER_SCALE), fixedColors: true });
                        el.style.pointerEvents = 'none';
                        slot.appendChild(el);
                        return;
                    }
                    // Fallback: clone an emoji span exactly as shown
                    const emoji = nav.querySelector('span.text-xl[aria-hidden="true"]');
                    if (emoji) {
                        const clone = emoji.cloneNode(true);
                        try { clone.style.fontSize = Math.round(basePx * HEADER_SCALE) + 'px'; } catch(_) { clone.style.fontSize = '48px'; }
                        clone.style.lineHeight = '1';
                        clone.style.display = 'inline-flex';
                        clone.style.alignItems = 'center';
                        clone.style.pointerEvents = 'none';
                        slot.appendChild(clone);
                        return;
                    }
                    // Last resort: generic beetle
                    const fallback = getPestIconElement('beetle', { size: 28, fixedColors: true });
                    slot.appendChild(fallback);
                } catch(e) { /* noop */ }
            }
            // Emoji helpers
            function getEmojiPool(){
                return {
                    sales: ['ðŸ¦—','ðŸœ','ðŸ›','ðŸž','ðŸª²','ðŸ¦‚','ðŸ¦Ÿ'],
                    operations: ['ðŸª³','ðŸ› ï¸','ðŸ§°','âš™ï¸','ðŸ”§','ðŸ”©'],
                    branch: ['ðŸ¦‹','ðŸ','ðŸ›','ðŸŒ¿','ðŸŒ³','ðŸª²'],
                    area: ['ðŸœ','ðŸª³','ðŸ•·ï¸','ðŸ¦Ÿ','ðŸ“','ðŸŒ'],
                    region: ['ðŸ•·ï¸','ðŸ•¸ï¸','ðŸ—ºï¸','ðŸŒŽ','ðŸŒ'],
                    market: ['ðŸ¦Ÿ','ðŸ','ðŸž','ðŸ“ˆ','ðŸ›’','ðŸ™ï¸'],
                    director: ['ðŸ•·ï¸','ðŸ‘”','ðŸ“Š','ðŸŽ¯','ðŸ§­'],
                    gmail: ['âœ‰ï¸','ðŸ“§','ðŸ“¨','ðŸ“®'],
                    drive: ['ðŸ—‚ï¸','ðŸ“','ðŸ§©','ðŸ—ƒï¸'],
                    calendar: ['ðŸ“…','ðŸ—“ï¸','â°','ðŸ“†','ðŸª²'],
                    insights: ['ðŸ”','ðŸ“Š','ðŸ“ˆ','ðŸ’¡','ðŸ§ '],
                    quality: ['âœ…','ðŸ…','ðŸ”§','ðŸ”¬','ðŸ“‹'],
                    fieldtools: ['ðŸ› ï¸','ðŸ”§','ðŸ§°','ðŸª›','ðŸ”¨']
                };
            }
            function getDefaultEmojiFor(type){
                try {
                    const pool = getEmojiPool()[type] || ['ðŸž'];
                    const key = 'icons.emojiChosen.' + type;
                    let chosen = localStorage.getItem(key);
                    if (!chosen || !pool.includes(chosen)) {
                        chosen = pool[0];
                        try { localStorage.setItem(key, chosen); } catch(_) {}
                    }
                    return chosen;
                } catch(_) { return 'ðŸž'; }
            }
            // Append all available pest emojis to the dashboard title
            function appendAllPestEmojisToTitle(){
                try {
                    const titleEl = document.getElementById('dashboardTitle');
                    if (!titleEl) return;
                    // Ensure we don't duplicate on successive calls
                    let emojiSpan = document.getElementById('dashboardTitleEmojis');
                    if (!emojiSpan) {
                        emojiSpan = document.createElement('span');
                        emojiSpan.id = 'dashboardTitleEmojis';
                        emojiSpan.setAttribute('aria-hidden','true');
                        emojiSpan.style.marginLeft = '0.5rem';
                        emojiSpan.style.whiteSpace = 'nowrap';
                        titleEl.appendChild(emojiSpan);
                    }
                    // Build a unique set of pest emojis from the registry
                    const nonPest = new Set(['calendar','mail','baitStation']);
                    const set = new Set();
                    try {
                        Object.entries(emojis || {}).forEach(([key, val]) => {
                            if (!nonPest.has(key) && typeof val === 'string' && val.length > 0) {
                                set.add(val);
                            }
                        });
                    } catch(_) {}
                    emojiSpan.textContent = Array.from(set).join(' ');
                    // Optionally render with a vendor set for consistent cross-platform look
                    ensureEmojiVendorStyles();
                    applyVendorEmojiRendering(emojiSpan);
                } catch(_) { /* noop */ }
            }
            function applyVendorEmojiRendering(node){
                try {
                    const vendor = (localStorage.getItem('icons.emojiVendor') || 'native').toLowerCase();
                    if (vendor === 'twemoji' && window.twemoji && node) {
                        window.twemoji.parse(node, { folder: 'svg', ext: '.svg', className: 'emoji' });
                    }
                } catch(_) {}
            }
            function ensureEmojiVendorStyles(){
                try {
                    if (document.getElementById('emojiVendorStyles')) return;
                    const style = document.createElement('style');
                    style.id = 'emojiVendorStyles';
                    style.textContent = 'img.emoji{height:1em;width:1em;margin:0 .05em 0 .1em;vertical-align:-0.1em;}';
                    document.head.appendChild(style);
                } catch(_) {}
            }
            function cycleEmojiFor(type){
                try {
                    const pool = getEmojiPool()[type] || ['ðŸž'];
                    const key = 'icons.emojiChosen.' + type;
                    const current = localStorage.getItem(key);
                    let idx = Math.max(0, pool.indexOf(current));
                    idx = (idx + 1) % pool.length;
                    const next = pool[idx];
                    try { localStorage.setItem(key, next); } catch(_) {}
                    try { updateDashboardTitleIcon(type); } catch(_) {}
                } catch(_) {}
            }
            function setupEmojiCycler(){
                try {
                    const slot = document.getElementById('dashboardTitleIcon');
                    if (!slot) return;
                    if (slot.dataset.emojiCyclerAttached === 'true') return;
                    slot.dataset.emojiCyclerAttached = 'true';
                    slot.style.cursor = 'pointer';
                    slot.addEventListener('click', () => {
                        const preferEmoji = (localStorage.getItem('icons.useEmoji') || 'true') === 'true';
                        if (!preferEmoji) return;
                        cycleEmojiFor(currentDashboard);
                    });
                } catch(_) {}
            }
            try { setupEmojiCycler(); } catch(_) {}
            // Toggle header theme exemption: external integrations should use neutral colors
            function setHeaderThemeExempt(exempt) {
                const titleEl = document.getElementById('dashboardTitle');
                const subEl = document.getElementById('dashboardSubtitle');
                if (!titleEl || !subEl) return;
                if (exempt) {
                    // Neutralize brand-specific classes
                    titleEl.classList.remove('text-brand');
                    subEl.classList.remove('text-tagline');
                    titleEl.classList.add('text-gray-800');
                    subEl.classList.add('text-gray-600');
                } else {
                    // Restore themed classes
                    titleEl.classList.remove('text-gray-800');
                    subEl.classList.remove('text-gray-600');
                    titleEl.classList.add('text-brand');
                    subEl.classList.add('text-tagline');
                }
            }
            // Default to themed header unless a case marks exemption
            setHeaderThemeExempt(false);
                switch(type) {
                case 'sales':
                    document.getElementById('dashboardTitle').textContent = 'New Proposal / Mark Sold';
                    document.getElementById('dashboardSubtitle').textContent = 'Track proposals, close rates, and deal metrics';
                    updateDashboardTitleIcon('sales');
                    appendAllPestEmojisToTitle();
                    loadSalesDashboard();
                    break;
                case 'operations':
                    document.getElementById('dashboardTitle').textContent = 'Operations Dashboard';
                    document.getElementById('dashboardSubtitle').textContent = 'Monitor installations, packets, and service completion';
                    updateDashboardTitleIcon('operations');
                    appendAllPestEmojisToTitle();
                    loadOperationsDashboard();
                    break;
                case 'branch':
                    document.getElementById('dashboardTitle').textContent = 'Branch Manager Dashboard';
                    document.getElementById('dashboardSubtitle').textContent = 'Branch performance and team metrics';
                    updateDashboardTitleIcon('branch');
                    appendAllPestEmojisToTitle();
                    loadBranchManagerDashboard();
                    break;
                case 'executive':
                    document.getElementById('dashboardTitle').textContent = 'Executive Dashboard';
                    document.getElementById('dashboardSubtitle').textContent = 'ROI, savings, and strategic metrics';
                    updateDashboardTitleIcon('executive');
                    appendAllPestEmojisToTitle();
                    loadExecutiveDashboard();
                    break;
                case 'area':
                    document.getElementById('dashboardTitle').textContent = 'Area Management Dashboard';
                    document.getElementById('dashboardSubtitle').textContent = 'Area-level performance and summaries';
                    updateDashboardTitleIcon('area');
                    appendAllPestEmojisToTitle();
                    loadAreaDashboard();
                    break;
                case 'region':
                    document.getElementById('dashboardTitle').textContent = 'Region Management Dashboard';
                    document.getElementById('dashboardSubtitle').textContent = 'Regional performance and summaries';
                    updateDashboardTitleIcon('region');
                    appendAllPestEmojisToTitle();
                    loadRegionDashboard();
                    break;
                case 'market':
                    document.getElementById('dashboardTitle').textContent = 'Market Management Dashboard';
                    document.getElementById('dashboardSubtitle').textContent = 'Market-level performance and summaries';
                    updateDashboardTitleIcon('market');
                    appendAllPestEmojisToTitle();
                    loadMarketDashboard();
                    break;
                case 'director':
                    document.getElementById('dashboardTitle').textContent = 'Market Sales & Operations Systems Director';
                    document.getElementById('dashboardSubtitle').textContent = 'Enablement operations, training, adoption and communications controls';
                    updateDashboardTitleIcon('director');
                    appendAllPestEmojisToTitle();
                    loadDirectorPanel();
                    break;
                case 'insights':
                    document.getElementById('dashboardTitle').textContent = 'Insights';
                    document.getElementById('dashboardSubtitle').textContent = 'Trends, forecasts, and quick diagnostics';
                    updateDashboardTitleIcon('insights');
                    appendAllPestEmojisToTitle();
                    loadInsightsDashboard();
                    break;
                case 'quality':
                    document.getElementById('dashboardTitle').textContent = 'Quality';
                    document.getElementById('dashboardSubtitle').textContent = 'QA checks, defect tracking, and standards';
                    updateDashboardTitleIcon('quality');
                    appendAllPestEmojisToTitle();
                    loadQualityDashboard();
                    break;
                case 'fieldtools':
                    document.getElementById('dashboardTitle').textContent = 'Field Tools';
                    document.getElementById('dashboardSubtitle').textContent = 'Quick utilities and links for the field';
                    updateDashboardTitleIcon('fieldtools');
                    appendAllPestEmojisToTitle();
                    loadFieldToolsDashboard();
                    break;
                case 'drive':
                    setHeaderThemeExempt(true);
                    document.getElementById('dashboardTitle').textContent = 'Google Drive';
                    document.getElementById('dashboardSubtitle').textContent = 'Recent files and quick access';
                    updateDashboardTitleIcon('drive');
                    appendAllPestEmojisToTitle();
                    loadDrivePanel();
                    break;
                case 'calendar':
                    setHeaderThemeExempt(true);
                    document.getElementById('dashboardTitle').textContent = 'Google Calendar';
                    document.getElementById('dashboardSubtitle').textContent = 'Today and upcoming events';
                    updateDashboardTitleIcon('calendar');
                    appendAllPestEmojisToTitle();
                    loadCalendarPanel();
                    break;
                case 'gmail':
                    setHeaderThemeExempt(true);
                    document.getElementById('dashboardTitle').textContent = 'Gmail';
                    document.getElementById('dashboardSubtitle').textContent = 'View threads and compose directly in the dashboard';
                    updateDashboardTitleIcon('gmail');
                    appendAllPestEmojisToTitle();
                    // Clear the dashboard content first, then render the Mail split-pane
                    // Gmail-only experience: hide legacy mail view and render Gmail panel
                    const container = document.getElementById('dashboardContent');
                    if (container) { container.innerHTML = ''; }
                    const mv = document.getElementById('mail-view');
                    if (mv) { mv.style.display = 'none'; }
                    try { stopMailViewLock(); } catch(e) {}
                    try { loadGmailPanel(); } catch(e) {}
                    break;
            }
        }

        // Load Sales Dashboard
        function loadSalesDashboard() {
            if (!hasAppsScript()) {
                renderSalesDashboard(getMockSalesData());
                return;
            }
            google.script.run
                .withSuccessHandler(function(data) {
                    renderSalesDashboard(data);
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading sales dashboard:', error);
                    renderSalesDashboard(getMockSalesData());
                })
                .getDashboardData('Sales');
        }

        // Load Operations Dashboard
        function loadOperationsDashboard() {
            if (!hasAppsScript()) {
                renderOperationsDashboard(getMockOperationsData());
                return;
            }
            google.script.run
                .withSuccessHandler(function(data) {
                    renderOperationsDashboard(data);
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading operations dashboard:', error);
                    renderOperationsDashboard(getMockOperationsData());
                })
                .getDashboardData('Operations');
        }

        // Load Branch Manager Dashboard
        function loadBranchManagerDashboard() {
            if (!hasAppsScript()) {
                renderBranchManagerDashboard(getMockBranchData());
                return;
            }
            google.script.run
                .withSuccessHandler(function(data) {
                    renderBranchManagerDashboard(data);
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading branch manager dashboard:', error);
                    renderBranchManagerDashboard(getMockBranchData());
                })
                .getDashboardData('Branch Manager');
        }

        // Load Executive Dashboard
        function loadExecutiveDashboard() {
            if (!hasAppsScript()) {
                renderExecutiveDashboard(getMockExecutiveData());
                return;
            }
            google.script.run
                .withSuccessHandler(function(data) {
                    renderExecutiveDashboard(data);
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading executive dashboard:', error);
                    renderExecutiveDashboard(getMockExecutiveData());
                })
                .getDashboardData('Executive');
        }

        // Workspace: Google Drive
        function loadDrivePanel() {
            const root = document.getElementById('dashboardContent');
            root.innerHTML = '<div class="p-4"><div class="text-sm text-gray-600">Loading Drive files...</div></div>';
            if (!hasAppsScript()) {
                renderDrivePanel(getMockDriveData());
                return;
            }
            google.script.run
                .withSuccessHandler(function(data) { renderDrivePanel(data); })
                .withFailureHandler(function(error) {
                    console.error('Error loading Drive files:', error);
                    renderDrivePanel(getMockDriveData());
                })
                .getDriveFiles(25);
        }
        function renderDrivePanel(data) {
            const root = document.getElementById('dashboardContent');
            const items = (data && data.files) ? data.files : [];
            const header = `
                <div class="flex items-center justify-between p-4 border-b border-gray-200">
                    <div>
                        <div class="text-lg font-semibold text-gray-800">Drive</div>
                        <div class="text-xs text-gray-600">Recent files and quick actions</div>
                    </div>
                    <button onclick="createNewDoc()" class="px-3 py-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-700">New Google Doc</button>
                </div>`;
            const grid = [
                '<div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">',
                ...items.map(f => {
                    const isGDoc = (f.mimeType || '').includes('application/vnd.google-apps.document');
                    return `
                    <div class="border border-gray-200 rounded-lg p-3">
                        <div class="text-sm font-medium text-gray-700">${f.name}</div>
                        <div class="text-xs text-gray-500">${f.mimeType || ''}</div>
                        <div class="text-xs text-gray-400 mb-2">Updated: ${f.lastUpdated || ''}</div>
                        <div class="flex gap-2">
                            <a href="${f.url}" target="_blank" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200">Open</a>
                            ${isGDoc ? `<a href="${f.url}" target="_blank" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200">Edit</a>` : ''}
                        </div>
                    </div>`;
                }),
                items.length === 0 ? '<div class="text-sm text-gray-600">No files found.</div>' : '',
                '</div>'
            ].join('');
            root.innerHTML = header + grid;
        }

        function createNewDoc() {
            const name = prompt('Document name', 'Untitled Document');
            if (!name) return;
            if (!hasAppsScript()) {
                try { toast('Backend not connected. Opening Docs home.'); } catch(e){}
                window.open('https://docs.google.com/document/u/0/','_blank');
                return;
            }
            google.script.run
                .withSuccessHandler(function(doc){
                    try { toast('Document created'); } catch(e){}
                    window.open(doc.url, '_blank');
                    loadDrivePanel();
                })
                .withFailureHandler(function(error){
                    console.error('createNewDoc failed:', error);
                    try { toast('Failed to create document'); } catch(e){}
                })
                .createGoogleDoc(name);
        }

        // Workspace: Google Calendar
        function loadCalendarPanel() {
            const root = document.getElementById('dashboardContent');
            root.innerHTML = '<div class="p-4"><div class="text-sm text-gray-600">Loading Calendar events...</div></div>';
            if (!hasAppsScript()) {
                renderCalendarPanel(getMockCalendarData());
                return;
            }
            const start = new Date();
            const end = new Date(Date.now() + 7*24*60*60*1000);
            google.script.run
                .withSuccessHandler(function(data) { renderCalendarPanel(data); })
                .withFailureHandler(function(error) {
                    console.error('Error loading Calendar events:', error);
                    renderCalendarPanel(getMockCalendarData());
                })
                .getCalendarEvents(start, end);
        }
        let calendarView = 'week';
        function renderCalendarPanel(data) {
            const root = document.getElementById('dashboardContent');
            const items = (data && data.events) ? data.events : [];
            const header = `
                <div class="flex items-center justify-between p-4 border-b border-gray-200">
                    <div class="flex items-center gap-3">
                        <button class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200" onclick="setCalendarRange(-1)">â—€</button>
                        <div class="text-lg font-semibold text-gray-800">Calendar</div>
                        <button class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200" onclick="setCalendarToday()">Today</button>
                        <button class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200" onclick="setCalendarRange(1)">â–¶</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="px-2 py-1 text-xs rounded ${calendarView==='day'?'bg-blue-600 text-white':'bg-gray-100 hover:bg-gray-200'}" onclick="setCalendarView('day')">Day</button>
                        <button class="px-2 py-1 text-xs rounded ${calendarView==='week'?'bg-blue-600 text-white':'bg-gray-100 hover:bg-gray-200'}" onclick="setCalendarView('week')">Week</button>
                    </div>
                </div>`;
            const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const startDate = calendarState.start || new Date();
            const weekDays = getWeekDays(startDate);
            const hours = Array.from({length: 12}, (_,i)=>i+7); // 7AM - 6PM
            const gridHeader = `
                <div class="grid" style="grid-template-columns: 80px repeat(7, 1fr);">
                    <div class="p-2 text-xs text-gray-500">&nbsp;</div>
                    ${weekDays.map(d=>`<div class="p-2 text-xs font-medium text-gray-700">${formatDay(d)}</div>`).join('')}
                </div>`;
            const gridBody = `
                <div class="grid border-t" style="grid-template-columns: 80px repeat(7, 1fr);">
                    ${hours.map(h=>`
                        <div class="border-r p-2 text-xs text-gray-400">${formatHour(h)}</div>
                        ${weekDays.map(day=>`<div class="border-r border-b relative h-16">${renderEventsAt(items, day, h)}</div>`).join('')}
                    `).join('')}
                </div>`;
            root.innerHTML = header + '<div class="p-2">' + gridHeader + gridBody + '</div>';
        }
        const calendarState = { start: new Date() };
        function setCalendarView(view) { calendarView = view; loadCalendarPanel(); }
        function setCalendarRange(offsetWeeks) {
            const d = new Date(calendarState.start);
            d.setDate(d.getDate() + offsetWeeks*7);
            calendarState.start = d;
            loadCalendarPanel();
        }
        function setCalendarToday() { calendarState.start = new Date(); loadCalendarPanel(); }
        function getWeekDays(start) {
            const d = new Date(start);
            const dayIdx = d.getDay(); // 0 Sun
            const sunday = new Date(d);
            sunday.setDate(d.getDate() - dayIdx);
            return Array.from({length:7},(_,i)=>{ const x=new Date(sunday); x.setDate(sunday.getDate()+i); return x; });
        }
        function formatDay(date) {
            return `${date.toLocaleDateString(undefined,{weekday:'short'})} ${date.getMonth()+1}/${date.getDate()}`;
        }
        function formatHour(h) { return new Date(0,0,0,h).toLocaleTimeString([], {hour:'numeric'}); }
        function sameDateStr(a, b) {
            return a && b && a.getMonth()===b.getMonth() && a.getDate()===b.getDate() && a.getFullYear()===b.getFullYear();
        }
        function renderEventsAt(items, day, hour) {
            const matches = items.filter(ev => {
                const [mm,dd,yyyy] = (ev.date||'').split('/').map(x=>parseInt(x,10));
                const d = new Date(yyyy, mm-1, dd);
                const hm = parseTime(ev.time||'');
                return sameDateStr(d, day) && hm.h===hour;
            });
            return matches.map(ev => `
                <div class="absolute inset-1 rounded bg-blue-50 border border-blue-200 p-1">
                    <div class="text-[11px] font-medium text-blue-700 truncate">${ev.title}</div>
                    <div class="text-[10px] text-blue-600">${ev.time}${ev.location? ' â€¢ '+ev.location : ''}</div>
                    <div class="mt-1 flex gap-1">
                        ${ev.hangoutLink ? `<a href="${ev.hangoutLink}" target="_blank" class="px-1 py-[2px] text-[10px] rounded bg-gray-100 hover:bg-gray-200">Join</a>` : ''}
                        <button class="px-1 py-[2px] text-[10px] rounded bg-gray-100 hover:bg-gray-200" onclick="editEventPrompt('${ev.id}')">Edit</button>
                    </div>
                </div>`).join('');
        }
        function parseTime(str) {
            try {
                const m = str.match(/(\d+):(\d+)\s*(AM|PM)/i);
                if (!m) { const hh = parseInt(str,10)||0; return { h: hh, m: 0 }; }
                let h = parseInt(m[1],10);
                const min = parseInt(m[2],10);
                const ap = m[3].toUpperCase();
                if (ap==='PM' && h<12) h += 12;
                if (ap==='AM' && h===12) h = 0;
                return { h: h, m: min };
            } catch(e) { return { h: 0, m: 0 }; }
        }

        function editEventPrompt(eventId) {
            const newTitle = prompt('Update event title (leave blank to keep)');
            const newDate = prompt('Reschedule date (MM/dd/yyyy) or leave blank');
            const newTime = prompt('Reschedule time (e.g., 2:30 PM) or leave blank');
            if (!hasAppsScript()) { try { toast('Backend not connected'); } catch(e){} return; }
            const payload = { title: newTitle || null, date: newDate || null, time: newTime || null };
            google.script.run
                .withSuccessHandler(function(){ try { toast('Event updated'); } catch(e){} loadCalendarPanel(); })
                .withFailureHandler(function(error){ console.error('updateCalendarEvent failed:', error); try { toast('Failed to update event'); } catch(e){} })
                .updateCalendarEvent(eventId, payload);
        }

        // Workspace: Gmail (enhanced)
        // Helper: keep Mail View pinned at the top of the dashboard
        function ensureMailViewAtTop() {
            const container = document.getElementById('dashboardContent');
            let mailView = document.getElementById('mail-view');
            if (!container || !mailView) return;
            // Ensure mail view is inside dashboard content
            if (mailView.parentElement !== container) {
                try { container.insertAdjacentElement('afterbegin', mailView); } catch(_) { container.appendChild(mailView); }
            }
            // If gmail panel exists, make sure mail view sits directly before it
            const gmailPanel = document.getElementById('gmail-panel');
            if (gmailPanel && mailView.nextElementSibling !== gmailPanel) {
                try { container.insertBefore(mailView, gmailPanel); } catch(_) { /* no-op */ }
            } else if (!gmailPanel && container.firstElementChild !== mailView) {
                container.insertAdjacentElement('afterbegin', mailView);
            }
            // Make sure itâ€™s visible
            mailView.style.display = 'block';
        }

        // Lock Mail View position: watches for DOM changes and reasserts placement
        let mailViewLockObserver = null;
        function startMailViewLock() {
            const container = document.getElementById('dashboardContent');
            const mailView = document.getElementById('mail-view');
            if (!container || !mailView) return;
            ensureMailViewAtTop();
            if (mailViewLockObserver) return; // already locked
            mailViewLockObserver = new MutationObserver(() => {
                // Reassert desired ordering on any child mutation
                ensureMailViewAtTop();
                const mv = document.getElementById('mail-view');
                if (mv) mv.style.display = 'block';
                const panel = document.getElementById('gmail-panel');
                if (panel && panel.parentElement === container && mv && mv.nextElementSibling !== panel) {
                    try { container.insertBefore(panel, mv.nextSibling); } catch(_) {}
                }
            });
            mailViewLockObserver.observe(container, { childList: true });
        }
        function stopMailViewLock() {
            if (mailViewLockObserver) {
                try { mailViewLockObserver.disconnect(); } catch(_) {}
                mailViewLockObserver = null;
            }
        }
        let gmailState = { raw: [], filtered: [], page: 1, pageSize: 10, search: '', label: 'Inbox', unreadCount: 0 };
        function loadGmailPanel() {
            const root = document.getElementById('dashboardContent');
            // Gmail-only: keep legacy mail view hidden and unlocked
            const mv = document.getElementById('mail-view');
            if (mv) { mv.style.display = 'none'; }
            try { stopMailViewLock(); } catch(_) {}
            // Create or reuse a dedicated Gmail panel container directly under dashboard content
            let panel = document.getElementById('gmail-panel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'gmail-panel';
                root.appendChild(panel);
            }
            panel.innerHTML = '<div class="p-4"><div class="text-sm text-gray-600">Loading Gmail threads...</div></div>';
            if (!hasAppsScript()) {
                initGmailState(getMockGmailData());
                renderGmailPanel();
                return;
            }
            google.script.run
                .withSuccessHandler(function(data) { initGmailState(data); renderGmailPanel(); })
                .withFailureHandler(function(error) {
                    console.error('Error loading Gmail threads:', error);
                    initGmailState(getMockGmailData());
                    renderGmailPanel();
                })
                .getGmailInbox(25);
        }
        function initGmailState(data) {
            const items = (data && data.threads) ? data.threads : [];
            gmailState.raw = items;
            gmailState.search = '';
            gmailState.label = 'Inbox';
            gmailState.page = 1;
            gmailState.pageSize = 10;
            gmailState.unreadCount = items.filter(t => t.unread).length;
            applyGmailFilters();
        }
        function applyGmailFilters() {
            const s = gmailState.search.trim().toLowerCase();
            let items = gmailState.raw.slice();
            if (s) {
                items = items.filter(t => `${t.subject||''} ${t.from||''} ${t.snippet||''}`.toLowerCase().includes(s));
            }
            // Simple label simulation: Inbox shows all; Unread filters unread only
            if (gmailState.label === 'Unread') {
                items = items.filter(t => t.unread);
            }
            gmailState.filtered = items;
            const maxPage = Math.max(1, Math.ceil(items.length / gmailState.pageSize));
            gmailState.page = Math.min(gmailState.page, maxPage);
        }
        function setGmailSearch(q) { gmailState.search = q || ''; gmailState.page = 1; applyGmailFilters(); renderGmailPanel(); }
        function setGmailLabel(label) { gmailState.label = label; gmailState.page = 1; applyGmailFilters(); renderGmailPanel(); }
        function changeGmailPage(dir) { const maxPage = Math.max(1, Math.ceil(gmailState.filtered.length / gmailState.pageSize)); gmailState.page = Math.min(Math.max(1, gmailState.page + dir), maxPage); renderGmailPanel(); }
        function renderGmailPanel() {
            const panel = document.getElementById('gmail-panel');
            const root = document.getElementById('dashboardContent');
            const startIdx = (gmailState.page - 1) * gmailState.pageSize;
            const endIdx = startIdx + gmailState.pageSize;
            const items = gmailState.filtered.slice(startIdx, endIdx);
            const total = gmailState.filtered.length;
            const maxPage = Math.max(1, Math.ceil(total / gmailState.pageSize));
            const header = `
                <div id="gmail-header" class="flex items-center justify-between p-4 border-b border-gray-200">
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-1 text-gray-800 font-semibold">
                            ${iconMail()}
                            <span>Gmail</span>
                        </div>
                        <div class="hidden md:flex items-center gap-2 ml-4">
                            <button class="px-2 py-1 text-xs rounded ${gmailState.label==='Inbox'?'bg-blue-600 text-white':'bg-gray-100 hover:bg-gray-200'}" onclick="setGmailLabel('Inbox')">${iconLabel()} Inbox</button>
                            <button class="px-2 py-1 text-xs rounded ${gmailState.label==='Unread'?'bg-blue-600 text-white':'bg-gray-100 hover:bg-gray-200'}" onclick="setGmailLabel('Unread')">${iconUnread()} Unread <span class="ml-1 inline-block px-1 rounded bg-white text-blue-600">${gmailState.unreadCount}</span></button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <input id="gmailSearch" class="border border-gray-300 rounded pl-8 pr-2 py-1.5 text-sm w-48" placeholder="Search" oninput="setGmailSearch(this.value)" />
                            <div class="absolute left-2 top-1.5">${iconSearch()}</div>
                        </div>
                        <button onclick="openComposeForm()" class="px-3 py-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-1">${iconCompose()} Compose</button>
                    </div>
                </div>`;
            const list = [
                '<div class="p-4 space-y-3">',
                ...items.map((t, idx) => `
                    <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 cursor-pointer" onclick="openThreadDetail(${startIdx + idx})">
                        <div class="flex justify-between">
                            <div class="text-sm font-medium ${t.unread ? 'text-blue-700 font-semibold' : 'text-gray-700'}">${t.subject || '(no subject)'}</div>
                            <div class="text-xs text-gray-400">${t.lastMessageDate || ''}</div>
                        </div>
                        <div class="text-xs text-gray-500">${t.from || ''}</div>
                        ${t.snippet ? `<div class="text-xs text-gray-600 mb-2 truncate">${t.snippet}</div>` : ''}
                        <div class="flex gap-2">
                            <a href="${t.webLink || 'https://mail.google.com/'}" target="_blank" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200">Open in Gmail</a>
                            <button onclick="event.stopPropagation(); replyTo('${t.from || ''}', '${t.subject || ''}')" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200">Reply</button>
                        </div>
                    </div>`),
                items.length === 0 ? '<div class="text-sm text-gray-600">No threads found.</div>' : '',
                '</div>'
            ].join('');
            const pager = `
                <div class="flex items-center justify-between p-4 border-t border-gray-200">
                    <div class="text-xs text-gray-500">Page ${gmailState.page} of ${maxPage} â€¢ ${total} results</div>
                    <div class="flex items-center gap-2">
                        <button onclick="changeGmailPage(-1)" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200 flex items-center gap-1">${iconPrev()} Prev</button>
                        <button onclick="changeGmailPage(1)" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200 flex items-center gap-1">${iconNext()} Next</button>
                    </div>
                </div>`;
            if (panel) {
                panel.innerHTML = header + list + pager + composeArea();
            } else if (root) {
                // Fallback: keep mail view at top, and append panel below
                const temp = document.createElement('div');
                temp.id = 'gmail-panel';
                temp.innerHTML = header + list + pager + composeArea();
                root.appendChild(temp);
            }
            // Gmail-only: do not pin or display legacy mail view
            const mv = document.getElementById('mail-view');
            if (mv) { mv.style.display = 'none'; }
            try { stopMailViewLock(); } catch(_) {}
        }
        function openThreadDetail(idx) {
            const t = gmailState.filtered[idx];
            if (!t) return;
            const modal = document.createElement('div');
            modal.id = 'gmailThreadModal';
            modal.className = 'fixed inset-0 bg-black/30 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white w-[90%] max-w-2xl rounded-lg shadow-lg modal-window">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200">
                        <div class="flex items-center gap-2 text-gray-800 font-semibold">${iconThread()} <span>${t.subject || '(no subject)'}</span></div>
                        <button class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200" onclick="closeThreadDetail()">Close</button>
                    </div>
                    <div class="p-4 space-y-2">
                        <div class="text-xs text-gray-600">From: ${t.from || ''}</div>
                        ${t.snippet ? `<div class="text-sm text-gray-700">${t.snippet}</div>` : ''}
                        <div class="mt-3 flex gap-2">
                            <a href="${t.webLink || 'https://mail.google.com/'}" target="_blank" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200">Open in Gmail</a>
                            <button onclick="replyTo('${t.from || ''}', '${t.subject || ''}')" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200">Reply</button>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            setModalDefaultSize('gmailThreadModal');
            enableModalDrag('gmailThreadModal');
            enableModalResize('gmailThreadModal');
        }
        function closeThreadDetail() { const m = document.getElementById('gmailThreadModal'); if (m) m.remove(); }

        function composeArea() {
            return `
            <div id="composeArea" class="hidden p-4 border-t border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input id="composeTo" class="border border-gray-300 rounded p-2 text-sm" placeholder="To" />
                    <input id="composeCc" class="border border-gray-300 rounded p-2 text-sm" placeholder="CC" />
                    <input id="composeBcc" class="border border-gray-300 rounded p-2 text-sm" placeholder="BCC" />
                    <input id="composeSubject" class="border border-gray-300 rounded p-2 text-sm md:col-span-3" placeholder="Subject" />
                    <textarea id="composeBody" rows="4" class="border border-gray-300 rounded p-2 text-sm md:col-span-3" placeholder="Message"></textarea>
                    <div class="md:col-span-3 flex items-center gap-2 text-sm text-gray-600">
                        ${iconAttach()} <input id="composeFiles" type="file" multiple class="text-sm" />
                        <span class="text-[11px] text-gray-500">Attachments send requires backend update or Gmail API</span>
                    </div>
                </div>
                <div class="mt-3 flex gap-2">
                    <button onclick="sendEmailFromPanel()" class="px-3 py-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-1">${iconSend()} Send</button>
                    <button onclick="closeComposeForm()" class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
                </div>
            </div>`;
        }

        // Compose Email Modal (popup)
        function ensureMailComposeModal() {
            if (document.getElementById('mailComposeModal')) return;
            const overlay = document.createElement('div');
            overlay.id = 'mailComposeModal';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
            overlay.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 flex flex-col modal-window">
                    <div class="p-4 flex justify-between items-center border-b">
                        <h2 class="text-xl font-semibold text-gray-800">Compose Email</h2>
                        <button onclick="closeComposeForm()" class="text-gray-500 hover:text-gray-700" aria-label="Close">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 flex-1 overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <input id="composeTo" class="border border-gray-300 rounded p-2 text-sm" placeholder="To" />
                            <input id="composeCc" class="border border-gray-300 rounded p-2 text-sm" placeholder="CC" />
                            <input id="composeBcc" class="border border-gray-300 rounded p-2 text-sm" placeholder="BCC" />
                            <input id="composeSubject" class="border border-gray-300 rounded p-2 text-sm md:col-span-3" placeholder="Subject" />
                            <textarea id="composeBody" rows="8" class="border border-gray-300 rounded p-2 text-sm md:col-span-3" placeholder="Message"></textarea>
                            <div class="md:col-span-3 flex items-center gap-2 text-sm text-gray-600">
                                ${iconAttach()} <input id="composeFiles" type="file" multiple class="text-sm" />
                                <span class="text-[11px] text-gray-500">Attachments send requires backend update or Gmail API</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border-t px-6 py-4 flex justify-end gap-3">
                        <button type="button" onclick="closeComposeForm()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="button" onclick="sendEmailFromPanel()" class="px-6 py-2 bg-brand text-white rounded-md hover:bg-opacity-90">Send</button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
        }
        function openComposeForm() {
            ensureMailComposeModal();
            const id = 'mailComposeModal';
            const el = document.getElementById(id);
            el.classList.remove('hidden');
            setModalDefaultSize(id);
            enableModalDrag(id);
            enableModalResize(id);
            // Hide inline panel if it exists
            const inline = document.getElementById('composeArea');
            if (inline) inline.classList.add('hidden');
        }
        function closeComposeForm() {
            const inline = document.getElementById('composeArea');
            if (inline) inline.classList.add('hidden');
            const id = 'mailComposeModal';
            const el = document.getElementById(id);
            if (el) { el.classList.add('hidden'); resetModalPosition(id); }
        }
        function replyTo(from, subject) {
            openComposeForm();
            document.getElementById('composeTo').value = from;
            document.getElementById('composeSubject').value = `Re: ${subject}`;
        }
        function sendEmailFromPanel() {
            const to = document.getElementById('composeTo').value.trim();
            const cc = document.getElementById('composeCc').value.trim();
            const bcc = document.getElementById('composeBcc').value.trim();
            const subject = document.getElementById('composeSubject').value.trim();
            const body = document.getElementById('composeBody').value.trim();
            if (!to || !subject || !body) { try { toast('Fill all fields'); } catch(e){} return; }
            if (!hasAppsScript()) {
                try { toast('Backend not connected. Opening Gmail compose.'); } catch(e){}
                let url = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                if (cc) url += `&cc=${encodeURIComponent(cc)}`;
                if (bcc) url += `&bcc=${encodeURIComponent(bcc)}`;
                window.open(url,'_blank');
                return;
            }
            // Apps Script endpoint currently supports to/subject/body only
            if (cc || bcc) { try { toast('CC/BCC not yet supported via backend'); } catch(e){} }
            google.script.run
                .withSuccessHandler(function(){ try { toast('Email sent'); } catch(e){} closeComposeForm(); loadGmailPanel(); })
                .withFailureHandler(function(error){ console.error('sendEmail failed:', error); try { toast('Failed to send'); } catch(e){} })
                .sendEmailDraft(to, subject, body);
        }

        // Icon helpers (animated)
        function iconMail() {
            return `<svg class="icon icon-mail icon-click w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 7h18v10H3z" class="box"/>
                <path d="M3 7l9 6 9-6" class="flap"/>
            </svg>`;
        }
        function iconLabel() {
            return `<svg class="icon icon-label icon-click w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 7h8l10 5-10 5H3z" class="tag"/>
                <circle cx="6" cy="12" r="1" class="hole"/>
            </svg>`;
        }
        function iconUnread() {
            return `<svg class="icon icon-unread icon-click w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <rect x="3" y="7" width="18" height="10" rx="2" class="env"/>
                <path d="M3 7l9 6 9-6" class="seal"/>
            </svg>`;
        }
        function iconSearch() {
            return `<svg class="icon icon-search icon-click w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="11" cy="11" r="5" class="glass"/>
                <path d="M16 16l4 4" class="handle"/>
            </svg>`;
        }
        function iconPrev() {
            return `<svg class="icon icon-page icon-click w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M15 18l-6-6 6-6" class="arrow"/>
            </svg>`;
        }
        function iconNext() {
            return `<svg class="icon icon-page icon-click w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M9 6l6 6-6 6" class="arrow"/>
            </svg>`;
        }
        function iconThread() {
            return `<svg class="icon icon-thread icon-click w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <rect x="3" y="6" width="14" height="10" rx="2" class="bubble"/>
                <path d="M7 16l-2 3" class="tail"/>
            </svg>`;
        }
        function iconCompose() {
            return `<svg class="icon icon-compose icon-click w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M4 20h16" class="line"/>
                <path d="M6 14l8-8 4 4-8 8H6z" class="pencil"/>
            </svg>`;
        }
        function iconAttach() {
            return `<svg class="icon icon-attach icon-click w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M7 12l7-7a4 4 0 116 6l-8 8a5 5 0 11-7-7l8-8" class="clip"/>
            </svg>`;
        }
        function iconSend() {
            return `<svg class="icon icon-send icon-click w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 12l18-8-8 18-2-8z" class="dart"/>
            </svg>`;
        }

        // Mock data for local preview
        function getMockDriveData() {
            return { files: [
                { name: 'Proposal - ACME Co.pdf', url: 'https://drive.google.com', mimeType: 'application/pdf', lastUpdated: '2025-11-01' },
                { name: 'Start Packet - TCH.pdf', url: 'https://drive.google.com', mimeType: 'application/pdf', lastUpdated: '2025-11-03' }
            ]};
        }
        function getMockCalendarData() {
            return { events: [
                { title: 'Site Assessment - ACME', date: '11/09/2025', time: '10:00 AM', location: 'ACME HQ' },
                { title: 'Branch Standup', date: '11/10/2025', time: '8:30 AM' }
            ]};
        }
        function getMockGmailData() {
            return { threads: [
                { subject: 'ACME Proposal Ready', from: 'bruce@prestox.com', lastMessageDate: '11/08/2025', snippet: 'Attached is the final proposal...', unread: true, webLink: 'https://mail.google.com' },
                { subject: 'Install Schedule Confirmed', from: 'ops@prestox.com', lastMessageDate: '11/07/2025', snippet: 'We are scheduled for next Tuesday...', unread: false, webLink: 'https://mail.google.com' }
            ]};
        }

        // Render Sales Dashboard
        function renderSalesDashboard(data) {
            const content = `
                <div class="dashboard-layout grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Proposal Volume</h3>
                        <p class="text-3xl font-bold text-brand">${data.kpis.proposalVolume}</p>
                        <p class="text-sm text-green-600 mt-1">â†‘ 12% from last month</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Close Rate</h3>
                        <p class="text-3xl font-bold text-green-600">${data.kpis.closeRate}%</p>
                        <p class="text-sm text-green-600 mt-1">â†‘ 3% from last month</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Avg Deal Size</h3>
                        <p class="text-3xl font-bold text-rentokil-blue">$${parseFloat(data.kpis.avgDealSize).toLocaleString()}</p>
                        <p class="text-sm text-green-600 mt-1">â†‘ 8% from last month</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Time Saved</h3>
                        <p class="text-3xl font-bold text-green-600">${data.kpis.timeSaved}h</p>
                        <p class="text-sm text-green-600 mt-1">â†‘ 15% from last month</p>
                    </div>
                </div>
                ${renderAiAssistantCard()}
                
                <!-- Route & Prospect Scout module container (mounted on Sales tab) -->
                <div id="sales-route-scout-root" class="rounded-lg overflow-hidden mb-8"></div>
                
                <div class="dashboard-layout grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Activity</h3>
                        <div class="space-y-3">
                            ${data.recentActivity.map(activity => `
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="font-medium text-gray-800">${activity.customer}</p>
                                        <p class="text-sm text-gray-600">${new Date(activity.date).toLocaleDateString()}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-brand">$${activity.amount.toLocaleString()}</p>
                                        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(activity.status)}">${activity.status}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="dashboard-layout grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Open Proposals</h3>
                            <button class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded" onclick="loadOpenProposals()">â†» Refresh</button>
                        </div>
                        <div id="openProposalsList">
                            <div class="text-sm text-gray-500">Loading proposals...</div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">New Proposal / Mark Sold</h3>
                        <form id="salesEntryForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Customer Name</label>
                            <input id="saleCustomer" type="text" class="w-full px-3 py-2 border rounded" placeholder="Acme Corp" required />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">POC Email</label>
                            <input id="salePocEmail" type="email" class="w-full px-3 py-2 border rounded" placeholder="poc@acme.com" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">POC Name</label>
                            <input id="salePocName" type="text" class="w-full px-3 py-2 border rounded" placeholder="Jane Doe" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">POC Phone</label>
                            <input id="salePocPhone" type="tel" class="w-full px-3 py-2 border rounded" placeholder="555-123-4567" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Branch</label>
                            <input id="saleBranch" type="text" class="w-full px-3 py-2 border rounded" placeholder="Branch 1" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Annual Value ($)</label>
                            <input id="saleAnnualValue" type="number" min="0" step="0.01" class="w-full px-3 py-2 border rounded" placeholder="12000" />
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm text-gray-600 mb-1">Service Address</label>
                            <input id="saleServiceAddress" type="text" class="w-full px-3 py-2 border rounded" placeholder="123 Main St, Suite 100, Omaha, NE 68102" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Service Scope</label>
                            <input id="saleScope" type="text" class="w-full px-3 py-2 border rounded" placeholder="General Pest + Rodent" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">AE Name</label>
                            <select id="saleAeName" class="w-full px-3 py-2 border rounded">
                                <option value="">Select AE</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">PNOL Requested?</label>
                            <select id="salePnol" class="w-full px-3 py-2 border rounded">
                                <option value="no" selected>No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Log Book Needed?</label>
                            <select id="saleLogBook" class="w-full px-3 py-2 border rounded">
                                <option value="no" selected>No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div class="md:col-span-2 flex items-center gap-3 mt-2">
                            <button type="button" id="btnSaveProposal" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Save Proposal</button>
                            <button type="button" id="btnMarkSold" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Mark Sold â†’ Queue Ops</button>
                            <span id="salesEntryStatus" class="text-sm text-gray-500"></span>
                        </div>
                        </form>
                    </div>

                    <!-- Branch Manager KPIs removed from Sales; moved to Branch Manager dashboard -->

                    <div class="bg-white p-6 rounded-lg shadow-lg" data-col-span="2">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                        <details class="border border-gray-200 rounded-lg">
                            <summary class="cursor-pointer px-3 py-2 font-medium text-gray-800 bg-gray-50 rounded-lg">Sales & Setup</summary>
                            <div class="p-3 space-y-3">
                                <button onclick="openSalesEntryForm()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">New Proposal</button>
                                <button id="generateStartPacketBtnDash" onclick="generateStartPacket()" class="w-full px-4 py-3 bg-brand text-white rounded-lg hover:bg-brand-color-light transition-colors duration-200">Generate Start Packet</button>
                                <button onclick="openQuoteUploadModal()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">Upload Quote PDF</button>
                                <button onclick="openStartLogModal()" class="w-full px-4 py-3 bg-brand text-white rounded-lg hover:bg-brand-color-light transition-colors duration-200">Start Log Form (Sales â†’ OM)</button>
                                <button onclick="openStartLogPasteModal()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">Quick Paste Start Logs</button>
                                <button onclick="openDailyPerformanceForm()" class="w-full px-4 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition-colors duration-200">Daily Sales Performance</button>
                                <button onclick="openBranchCadenceModal()" class="w-full px-4 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition-colors duration-200">Branch Cadence Entry</button>
                            </div>
                        </details>
                    </div>
                </div>
            `;
            
            document.getElementById('dashboardContent').innerHTML = content;
            // Smart insights and contextual actions for Sales
            try { if (window.renderInsightsForDashboard) window.renderInsightsForDashboard(data.kpis || {}); } catch(_){}
            // Disabled: contextual action panel buttons in Sales (Optimize Route / New Proposal / Refresh)
            // To re-enable, restore the block and guard behind a feature flag.
            // try {
            //     const actions = [
            //       { icon: 'ðŸ—ºï¸', label: 'Optimize Route', action: () => {
            //           const root = document.getElementById('sales-route-scout-root');
            //           if (root) {
            //             alert('Open a route in RouteScout and use Optimize.');
            //           } else {
            //             alert('RouteScout not mounted yet');
            //           }
            //       }},
            //       { icon: 'âž•', label: 'New Proposal', action: () => { try { openSalesEntryForm(); } catch(_){} } },
            //       { icon: 'â†»', label: 'Refresh Proposals', action: () => { try { loadOpenProposals(); } catch(_){} } }
            //     ];
            //     if (window.contextPanel && typeof window.contextPanel.show === 'function') window.contextPanel.show(actions);
            // } catch(_){}
            // Mount RouteScout once when Sales renders; scope data to currentUser
            try {
                const root = document.getElementById('sales-route-scout-root');
                if (root && !root.__routeScoutMounted && window.RouteScout && typeof window.RouteScout.mount === 'function') {
                    window.RouteScout.mount(root, { currentUser: window.currentUser });
                    root.__routeScoutMounted = true;
                }
            } catch (_) {}
            // Cleanup any prior grid/layout artifacts to restore default visuals
            try {
                document.querySelectorAll('.universal-grid, .fab-add-widget').forEach(el => el.remove());
                const styleEl = document.getElementById('dashboard-layout-styles');
                if (styleEl) styleEl.remove();
                document.getElementById('dashboardContent')?.classList.remove('layout-mode');
            } catch (_) {}
            // Initialize universal grid for Sales
            try { if (window.universalGridEnabled === true) initUniversalGrid('sales'); } catch(_) {}
            // Cache data for modal rendering and attach interactivity
            try { lastExecutiveData = data; } catch (_) {}
            try {
                const cards = document.querySelectorAll('#dashboardContent .kpi-card');
                const mapping = ['hoursSaved','dollarsSaved','adoptionRate','roi'];
                cards.forEach((el, i) => {
                    el.setAttribute('tabindex','0');
                    el.setAttribute('role','button');
                    el.addEventListener('click', () => openMetricModal(mapping[i]));
                    el.addEventListener('keydown', (e) => handleMetricCardKey(e, mapping[i]));
                });
                const getCardByHeading = (text) => {
                    const h = Array.from(document.querySelectorAll('#dashboardContent h3')).find(h => h.textContent.trim().startsWith(text));
                    return h ? h.closest('.bg-white') : null;
                };
                const c3 = getCardByHeading('3-Month Forecast');
                if (c3) { c3.setAttribute('tabindex','0'); c3.setAttribute('role','button'); c3.addEventListener('click', () => openMetricModal('roi','3')); c3.addEventListener('keydown', (e) => handleMetricCardKey(e,'roi','3')); }
                const c6 = getCardByHeading('6-Month Forecast');
                if (c6) { c6.setAttribute('tabindex','0'); c6.setAttribute('role','button'); c6.addEventListener('click', () => openMetricModal('roi','6')); c6.addEventListener('keydown', (e) => handleMetricCardKey(e,'roi','6')); }
                const c12 = getCardByHeading('12-Month Forecast');
                if (c12) { c12.setAttribute('tabindex','0'); c12.setAttribute('role','button'); c12.addEventListener('click', () => openMetricModal('roi','12')); c12.addEventListener('keydown', (e) => handleMetricCardKey(e,'roi','12')); }
            } catch (e) { /* noop */ }
            // Populate AE dropdown in Sales Entry form
            populateAeNameDropdown();
            
            // Wire Sales Entry buttons
            const statusEl = document.getElementById('salesEntryStatus');
            const getFormVals = () => ({
                customer: document.getElementById('saleCustomer')?.value?.trim() || '',
                pocEmail: document.getElementById('salePocEmail')?.value?.trim() || '',
                pocName: document.getElementById('salePocName')?.value?.trim() || '',
                pocPhone: document.getElementById('salePocPhone')?.value?.trim() || '',
                branch: document.getElementById('saleBranch')?.value?.trim() || '',
                annualValue: Number(document.getElementById('saleAnnualValue')?.value || 0),
                serviceAddress: document.getElementById('saleServiceAddress')?.value?.trim() || '',
                scope: document.getElementById('saleScope')?.value?.trim() || '',
                aeName: document.getElementById('saleAeName')?.value?.trim() || '',
                pnol: (document.getElementById('salePnol')?.value || 'no') === 'yes',
                logBook: (document.getElementById('saleLogBook')?.value || 'no') === 'yes'
            });
            const show = msg => { if (statusEl) statusEl.textContent = msg; };

            const onSaveProposal = () => {
                const e = getFormVals();
                if (!e.customer) { show('Customer is required'); return; }
                if (!hasAppsScript()) {
                    show('Saved proposal (local preview).');
                    return;
                }
                google.script.run
                    .withSuccessHandler(() => show('Proposal saved.'))
                    .withFailureHandler(err => show('Error: ' + err.message))
                    .saveSalesEntry(e);
            };

            const onMarkSold = () => {
                const e = getFormVals();
                if (!e.customer) { show('Customer is required'); return; }
                if (!hasAppsScript()) {
                    show('Marked sold + queued ops (local preview).');
                    return;
                }
                google.script.run
                    .withSuccessHandler(() => { show('Sold recorded, ops queued, start packet created.'); refreshDashboard(); })
                    .withFailureHandler(err => show('Error: ' + err.message))
                    .markSaleAndQueueOps(e);
            };

            document.getElementById('btnSaveProposal')?.addEventListener('click', onSaveProposal);
            document.getElementById('btnMarkSold')?.addEventListener('click', onMarkSold);

            // Load proposals list
            loadOpenProposals();

            // Do not enable legacy drag+resize by default; preserve original layout
            if (presentationMode) animateCounters();
        }

        // Load and render open proposals for Sales dashboard
        function loadOpenProposals() {
            const root = document.getElementById('openProposalsList');
            if (!root) return;
            root.innerHTML = '<div class="text-sm text-gray-500">Loading proposals...</div>';
            if (!hasAppsScript()) {
                // Local preview mock
                const mock = [
                    { id:'LP-001', branch:'Branch A', customerName:'ABC Company', serviceDescription:'General Pest', annualValue:1800, salesRep:'Cody Lytle', logBookNeeded:'Yes' },
                    { id:'LP-002', branch:'Branch B', customerName:'XYZ Inc', serviceDescription:'Rodent + Sanitation', annualValue:5400, salesRep:'Jane AE', logBookNeeded:'No' }
                ];
                renderOpenProposals(mock);
                return;
            }
            google.script.run
                .withSuccessHandler(list => renderOpenProposals(list || []))
                .withFailureHandler(err => { root.innerHTML = '<div class="text-sm text-red-600">Error: ' + (err && err.message ? err.message : err) + '</div>'; })
                .getOpenProposals();
        }

        function renderOpenProposals(list) {
            const root = document.getElementById('openProposalsList');
            if (!root) return;
            if (!Array.isArray(list) || list.length === 0) {
                root.innerHTML = '<div class="text-sm text-gray-500">No open proposals.</div>';
                return;
            }
            const rows = list.map(p => `
                <tr class="list-item border-b cursor-pointer hover:bg-gray-50" onclick="onProposalFillForm('${encodeURIComponent(JSON.stringify(p))}')">
                    <td class="px-3 py-2">
                        <input type="checkbox" class="proposal-select" onclick="event.stopPropagation();" data-prop="${encodeURIComponent(JSON.stringify(p))}">
                    </td>
                    <td class="px-3 py-2">${escapeHtml(p.customerName)}</td>
                    <td class="px-3 py-2">${escapeHtml(p.branch)}</td>
                    <td class="px-3 py-2">${escapeHtml(p.serviceDescription)}</td>
                    <td class="px-3 py-2 text-right">$${Number(p.annualValue||0).toLocaleString()}</td>
                    <td class="px-3 py-2">${escapeHtml(p.salesRep || '')}</td>
                    <td class="px-3 py-2">${escapeHtml(p.logBookNeeded || 'No')}</td>
                    <td class="px-3 py-2 text-right space-x-2">
                        <button class="px-2 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded" onclick="event.stopPropagation(); onProposalFillForm('${encodeURIComponent(JSON.stringify(p))}')">Fill Form</button>
                        <button class="px-2 py-1 text-sm bg-green-600 text-white hover:bg-green-700 rounded" onclick="event.stopPropagation(); onProposalMarkSold('${encodeURIComponent(JSON.stringify(p))}')">Mark Sold â†’ Queue Ops</button>
                    </td>
                </tr>
            `).join('');
            root.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-2 text-left"><input type="checkbox" id="selectAllProposals" onclick="onToggleSelectAllProposals(this)"></th>
                                <th class="px-3 py-2 text-left">Customer</th>
                                <th class="px-3 py-2 text-left">Branch</th>
                                <th class="px-3 py-2 text-left">Scope</th>
                                <th class="px-3 py-2 text-right">Annual Value</th>
                                <th class="px-3 py-2 text-left">AE</th>
                                <th class="px-3 py-2 text-left">Log Book</th>
                                <th class="px-3 py-2 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
                <div class="mt-3 flex items-center gap-2">
                    <button class="px-3 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700" onclick="onBulkMarkSold()">Mark Selected Sold â†’ Queue Ops</button>
                    <span class="text-xs text-gray-500">Selected: <span id="selectedProposalCount">0</span></span>
                </div>
            `;
            try { if (window.enableBulkSelect) window.enableBulkSelect('#openProposalsList'); } catch(_){}
            // Track selection count
            root.querySelectorAll('.proposal-select').forEach(chk => {
                chk.addEventListener('change', updateSelectedProposalCount);
            });
        }

        function onProposalFillForm(p) {
            try { p = (typeof p === 'string') ? JSON.parse(decodeURIComponent(p)) : p; } catch(_) {}
            const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
            setVal('saleCustomer', p.customerName || '');
            setVal('saleBranch', p.branch || '');
            setVal('saleScope', p.serviceDescription || '');
            setVal('saleAnnualValue', Number(p.annualValue || 0));
            setVal('saleAeName', p.salesRep || '');
            setVal('saleLogBook', (String(p.logBookNeeded || 'No').toLowerCase() === 'yes') ? 'yes' : 'no');
            setVal('saleServiceAddress', p.serviceAddress || '');
            setVal('salePocName', p.pocName || '');
            setVal('salePocPhone', p.pocPhone || '');
        }

        function onProposalMarkSold(p) {
            try { p = (typeof p === 'string') ? JSON.parse(decodeURIComponent(p)) : p; } catch(_) {}
            const e = {
                customer: p.customerName || '',
                pocEmail: '',
                pocName: p.pocName || '',
                pocPhone: p.pocPhone || '',
                branch: p.branch || '',
                annualValue: Number(p.annualValue || 0),
                scope: p.serviceDescription || '',
                serviceAddress: p.serviceAddress || '',
                aeName: p.salesRep || '',
                pnol: false,
                logBook: String(p.logBookNeeded || 'No').toLowerCase() === 'yes'
            };
            const root = document.getElementById('openProposalsList');
            const showInline = msg => { if (root) root.insertAdjacentHTML('afterbegin', `<div class="text-xs text-gray-500 mb-2">${escapeHtml(msg)}</div>`); };
            if (!hasAppsScript()) { showInline('Marked sold + queued ops (local preview).'); return; }
            google.script.run
                .withSuccessHandler(() => { showInline('Sold recorded, ops queued, start packet created.'); refreshDashboard(); })
                .withFailureHandler(err => showInline('Error: ' + (err && err.message ? err.message : err)))
                .markSaleAndQueueOps(e);
        }

        function onToggleSelectAllProposals(master) {
            const root = document.getElementById('openProposalsList');
            const checks = root ? root.querySelectorAll('.proposal-select') : [];
            checks.forEach(chk => { chk.checked = master.checked; });
            updateSelectedProposalCount();
        }

        function updateSelectedProposalCount() {
            const root = document.getElementById('openProposalsList');
            const count = root ? Array.from(root.querySelectorAll('.proposal-select')).filter(chk => chk.checked).length : 0;
            const el = document.getElementById('selectedProposalCount');
            if (el) el.textContent = String(count);
        }

        function onBulkMarkSold() {
            const root = document.getElementById('openProposalsList');
            if (!root) return;
            const selected = Array.from(root.querySelectorAll('.proposal-select'))
                .filter(chk => chk.checked)
                .map(chk => {
                    try { return JSON.parse(decodeURIComponent(chk.getAttribute('data-prop'))); } catch(_) { return null; }
                })
                .filter(Boolean);
            if (selected.length === 0) {
                root.insertAdjacentHTML('afterbegin', '<div class="text-xs text-yellow-700 mb-2">No proposals selected.</div>');
                return;
            }
            if (!hasAppsScript()) {
                root.insertAdjacentHTML('afterbegin', `<div class="text-xs text-gray-500 mb-2">Bulk marked sold (${selected.length}) (local preview).</div>`);
                return;
            }
            // Sequentially process to ensure Apps Script calls succeed
            const processNext = (i) => {
                if (i >= selected.length) { root.insertAdjacentHTML('afterbegin', `<div class="text-xs text-green-700 mb-2">Completed bulk sold for ${selected.length}.</div>`); refreshDashboard(); return; }
                const p = selected[i];
                const e = {
                    customer: p.customerName || '',
                    pocEmail: '',
                    pocName: p.pocName || '',
                    pocPhone: p.pocPhone || '',
                    branch: p.branch || '',
                    annualValue: Number(p.annualValue || 0),
                    scope: p.serviceDescription || '',
                    serviceAddress: p.serviceAddress || '',
                    aeName: p.salesRep || '',
                    pnol: false,
                    logBook: String(p.logBookNeeded || 'No').toLowerCase() === 'yes'
                };
                google.script.run
                    .withSuccessHandler(() => processNext(i+1))
                    .withFailureHandler(err => { root.insertAdjacentHTML('afterbegin', `<div class=\"text-xs text-red-700 mb-2\">Error on ${escapeHtml(p.customerName||'')} : ${(err && err.message) ? err.message : err}</div>`); processNext(i+1); })
                    .markSaleAndQueueOps(e);
            };
            processNext(0);
        }

        function populateAeNameDropdown() {
            const select = document.getElementById('saleAeName');
            if (!select) return;
            select.innerHTML = '<option value="">Select AE</option>';
            const names = Object.values(AE_MAP || {});
            const unique = Array.from(new Set(names));
            unique.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
            if (typeof currentUser !== 'undefined') {
                const email = (currentUser.email || '').toLowerCase();
                const mapped = (AE_MAP || {})[email];
                if (mapped && unique.includes(mapped)) {
                    select.value = mapped;
                }
            }
        }

        // Render Operations Dashboard
        function renderOperationsDashboard(data) {
            const content = `
                <div class="dashboard-layout grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up cursor-pointer" onclick="openPendingInstallsModal()" title="Click to view pending installs">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Pending Installs</h3>
                        <p class="text-3xl font-bold text-brand">${data.kpis.pendingInstalls}</p>
                        <p class="text-sm text-red-600 mt-1">â†‘ 2 from yesterday</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up cursor-pointer" onclick="openOverduePacketsModal()" title="Click to view overdue packets">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Overdue Packets</h3>
                        <p class="text-3xl font-bold text-red-600">${data.kpis.overduePackets}</p>
                        <p class="text-sm text-red-600 mt-1">Needs attention</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2 flex items-center gap-2">Data Quality <span class="text-gray-400 text-sm" title="Percent of required fields complete, deduped records, and validated contacts">â„¹ï¸</span></h3>
                        <p class="text-3xl font-bold text-green-600">${data.kpis.hygieneScore}%</p>
                        <p class="text-sm text-green-600 mt-1">â†‘ 5% from last week</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Avg Completion</h3>
                        <p class="text-3xl font-bold text-rentokil-blue">${data.kpis.avgCompletionTime}d</p>
                        <p class="text-sm text-green-600 mt-1">â†“ 1 day from target</p>
                    </div>
                </div>
                ${renderAiAssistantCard()}
                
                <div class="dashboard-layout grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Service Operations</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg cursor-pointer" onclick="openPendingInstallsModal()" title="Click to view scheduled installs">
                                <span class="text-gray-700">Scheduled Services</span>
                                <span class="font-bold text-brand">24</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg cursor-pointer" onclick="openCompletedTodayModal()" title="Click to view completed today">
                                <span class="text-gray-700">Completed Today</span>
                                <span class="font-bold text-green-600">18</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg cursor-pointer" onclick="openIssuesReportedModal()" title="Click to view reported issues">
                                <span class="text-gray-700">Issues Reported</span>
                                <span class="font-bold text-red-600">3</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg" data-layout-fixed="true" data-fixed-col-span="2">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                        
                        <details class="border border-gray-200 rounded-lg mb-3">
                            <summary class="cursor-pointer px-3 py-2 font-medium text-gray-800 bg-gray-50 rounded-lg">Operations</summary>
                            <div class="p-3 space-y-3">
                                <button onclick="generateCadenceReport()" class="w-full px-4 py-3 bg-rentokil-blue text-white rounded-lg hover:bg-opacity-90 transition-colors duration-200">Generate Cadence Report</button>
                                <button onclick="updateInstallStatus()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">Update Install Status</button>
                                <button onclick="openPendingInstallsModal()" class="w-full px-4 py-3 bg-brand text-white rounded-lg hover:bg-brand-color-light transition-colors duration-200">View All Pending Installs</button>
                                <button onclick="openOverduePacketsModal()" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200">View All Overdue Packets</button>
                                <button onclick="openJobAssignmentModal('all')" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors duration-200">Assign Technician to Jobs</button>
                            </div>
                        </details>
                        <details class="border border-gray-200 rounded-lg">
                            <summary class="cursor-pointer px-3 py-2 font-medium text-gray-800 bg-gray-50 rounded-lg">Utilities</summary>
                            <div class="p-3 space-y-3">
                                <button onclick="testBackendConnection()" class="w-full px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">Test Backend Connection</button>
                                <button onclick="openCadenceImportModal()" class="w-full px-4 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition-colors duration-200">Paste Cadence Rows (Import)</button>
                            </div>
                        </details>
                    </div>
                </div>
            `;
            
            document.getElementById('dashboardContent').innerHTML = content;
            // Cleanup any prior grid/layout artifacts to restore default visuals
            try {
                document.querySelectorAll('.universal-grid, .fab-add-widget').forEach(el => el.remove());
                const styleEl = document.getElementById('dashboard-layout-styles');
                if (styleEl) styleEl.remove();
                document.getElementById('dashboardContent')?.classList.remove('layout-mode');
            } catch (_) {}
            // Initialize universal grid for Operations
            try { if (window.universalGridEnabled === true) initUniversalGrid('operations'); } catch(_) {}
            
            // Load unified tracker view under Ops dashboard
            loadUnifiedTracker();

            // Do not enable legacy drag+resize by default; preserve original layout
            if (presentationMode) {
                animateCounters();
            }
        }

        // --- Dashboard Drag + Resize (grid-based) ---
        function injectDashboardLayoutStyles() {
            if (document.getElementById('dashboard-layout-styles')) return;
            const style = document.createElement('style');
            style.id = 'dashboard-layout-styles';
            style.textContent = `
                .dashboard-layout { grid-auto-flow: dense; grid-auto-rows: var(--rowHeight, 16px); position: relative; }
                .draggable-card { position: relative; user-select: none; }
                .draggable-card:hover { outline: 1px dashed rgba(0,0,0,0.1); }
                .draggable-card.dragging {
                    opacity: 0.98;
                    outline: 2px solid var(--brand-color);
                    box-shadow: 0 0 0 2px var(--brand-color), 0 0 16px rgba(59,130,246,0.5);
                    transition: box-shadow 60ms ease, outline 60ms ease;
                }
                /* Handles hidden by default; shown only in layout mode */
                .card-resize-handle,
                .card-row-resize-handle,
                .card-drag-handle { display: none; }
                .card-resize-handle { position: absolute; right: 6px; bottom: 6px; width: 12px; height: 12px; border-radius: 3px; background: rgba(0,0,0,0.08); cursor: nwse-resize; }
                .card-resize-handle:hover { background: rgba(0,0,0,0.15); }
                .card-row-resize-handle { position: absolute; left: 50%; bottom: 2px; transform: translateX(-50%); width: 20px; height: 6px; border-radius: 3px; background: rgba(0,0,0,0.08); cursor: ns-resize; }
                .card-row-resize-handle:hover { background: rgba(0,0,0,0.15); }
                .card-drag-handle { position: absolute; top: 6px; right: 6px; width: 16px; height: 16px; border-radius: 3px; background: rgba(0,0,0,0.08); cursor: grab; align-items: center; justify-content: center; }
                .card-drag-handle::before { content: 'â‹®'; font-size: 12px; color: rgba(0,0,0,0.5); line-height: 1; }
                /* Scope drag target indicators to layout mode */
                #dashboardContent.layout-mode .draggable-card.drag-target-before { box-shadow: inset 0 3px 0 0 rgba(59,130,246,0.7); }
                #dashboardContent.layout-mode .draggable-card.drag-target-after  { box-shadow: inset 0 -3px 0 0 rgba(59,130,246,0.7); }
                .resize-tooltip { position: absolute; bottom: 8px; right: 24px; padding: 2px 6px; font-size: 12px; border-radius: 4px; background: rgba(17,24,39,0.85); color: #fff; pointer-events: none; }

                /* Collision preview */
                .collision-target { box-shadow: 0 0 0 2px rgba(59,130,246,0.55) inset, 0 0 18px rgba(59,130,246,0.35) inset; position: relative; pointer-events: none; }
                .collision-target::after { content: ''; }

                /* Ghost drop placeholder */
                .ghost-placeholder {
                    outline: none;
                    box-shadow: 0 0 0 2px rgba(59,130,246,0.55), 0 0 24px rgba(59,130,246,0.28);
                    background: rgba(59,130,246,0.06);
                    border-radius: 8px;
                    min-height: 24px;
                    pointer-events: none;
                    transition: box-shadow 80ms ease;
                }

                /* Layout mode overlays */
                #dashboardContent.layout-mode .dashboard-layout {
                    --cols: 4;
                    background: none;
                    position: relative;
                }
                #dashboardContent.layout-mode .dashboard-layout::before {
                    content: '';
                    position: absolute; inset: 0;
                    pointer-events: none;
                    border-radius: 12px;
                    box-shadow: inset 0 0 0 2px rgba(59,130,246,0.18), inset 0 0 42px rgba(59,130,246,0.12);
                }
                #dashboardContent.layout-mode .card-drag-handle,
                #dashboardContent.layout-mode .card-resize-handle,
                #dashboardContent.layout-mode .card-row-resize-handle { background: rgba(59,130,246,0.25); display: flex; }
                #dashboardContent.layout-mode .card-resize-handle { display: block; }
                #dashboardContent.layout-mode .card-drag-handle { display: flex; }
            `;
            document.head.appendChild(style);
        }

        // Developer flag: allow instant rollback to previous build layout
        window.usePreviousBuildLayout = false;

        // Simple debounce helper for persistence
        function _debounce(fn, ms){ let id=null; return (...args)=>{ if(id) clearTimeout(id); id=setTimeout(()=>fn.apply(null,args), ms); }; }

        function enableDashboardLayout() {
            injectDashboardLayoutStyles();
            injectLayoutControls();
            const containers = Array.from(document.querySelectorAll('#dashboardContent .dashboard-layout'));
            containers.forEach((container, ci) => initDashboardContainer(container, ci));
            // Update overlay grid cols for layout mode
            containers.forEach(c => c.style.setProperty('--cols', String(getContainerCols(c))));
            // Enforce fixed spans for cards with explicit fixed settings
            containers.forEach(c => enforceFixedSpans(c));
            // Do not auto-load saved layouts; keep default sizes unless user opts in via Layout mode
            window.addEventListener('resize', () => containers.forEach(c => clampCardSpans(c)));
            window.addEventListener('resize', () => containers.forEach(c => c.style.setProperty('--cols', String(getContainerCols(c)))));
            window.addEventListener('resize', () => containers.forEach(c => enforceFixedSpans(c)));
            // Clean up drag indicators when leaving container area
            containers.forEach(c => {
                c.addEventListener('dragleave', () => {
                    const sibs = Array.from(c.children);
                    sibs.forEach(el => el.classList.remove('drag-target-before','drag-target-after','collision-target'));
                });
            });
        }

        function initDashboardContainer(container, ci) {
            container.style.setProperty('--rowHeight', '16px');
            container.style.gridAutoFlow = 'dense';
            container.style.gridAutoRows = 'var(--rowHeight)';
            const childCards = Array.from(container.children).filter(el => el.classList.contains('bg-white'));
            childCards.forEach((card, idx) => {
                const isFixed = (card.dataset.layoutFixed === 'true');
                if (!isFixed) {
                    card.classList.add('draggable-card');
                }
                if (!card.id) card.id = `dash-card-${Date.now()}-${ci}-${idx}`;
                if (!card.dataset.colSpan) card.dataset.colSpan = '1';
                const span = Math.max(1, parseInt(card.dataset.colSpan, 10));
                card.style.gridColumn = `span ${span}`;
                // Pointer-based drag anywhere and edge/corner resize; no overlays
                if (!isFixed) { bindCardPointerInteractions(card, container); }
                // Autosize rows to prevent overlap
                updateCardRowSpan(card, container);
                // Attach observers so row-span follows content changes
                try { attachAutosizeObserver(card, container); } catch(_) {}
            });
            // After initial layout, ensure row spans account for actual heights
            setTimeout(() => childCards.forEach(c => { try { attachAutosizeObserver(c, container); } catch(_) {} updateCardRowSpan(c, container); }), 0);
            // Capture default layout (once per tab)
            try { captureDefaultLayout(currentDashboard); } catch(_) {}

            // Build widget registry from live DOM (no duplication rule)
            try {
                if (!window.widgetRegistry) window.widgetRegistry = new Map();
                childCards.forEach(card => window.widgetRegistry.set(card.id, card));
            } catch(_) {}
        }

        function getContainerCols(container) {
            const style = getComputedStyle(container);
            const cols = style.gridTemplateColumns.split(' ').filter(Boolean).length;
            return Math.max(1, cols);
        }

        function getContainerGap(container) {
            const style = getComputedStyle(container);
            const gapVal = (style.columnGap || style.gap || '0').toString();
            const gap = parseFloat(gapVal);
            return isNaN(gap) ? 0 : gap;
        }

        function clampCardSpans(container) {
            const cols = getContainerCols(container);
            Array.from(container.children).forEach(card => {
                if (!card.classList.contains('draggable-card')) return;
                let span = parseInt(card.dataset.colSpan || '1', 10);
                if (span > cols) span = cols;
                span = Math.max(1, span);
                card.dataset.colSpan = String(span);
                card.style.gridColumn = `span ${span}`;
                updateCardRowSpan(card, container);
            });
        }

        // Ensure fixed cards respect pinned column spans across viewports
        function enforceFixedSpans(container) {
            const cols = getContainerCols(container);
            Array.from(container.children).forEach(card => {
                const fixed = card.dataset.layoutFixed === 'true';
                const fixedSpan = parseInt(card.dataset.fixedColSpan || '0', 10);
                if (!fixed || !fixedSpan) return;
                const span = Math.min(Math.max(1, fixedSpan), cols);
                card.dataset.colSpan = String(span);
                card.style.gridColumn = `span ${span}`;
                updateCardRowSpan(card, container);
            });
        }

        function getRowHeight(container) {
            const cs = getComputedStyle(container);
            const varVal = cs.getPropertyValue('--rowHeight') || '16px';
            const rh = parseFloat(varVal);
            return isNaN(rh) ? 16 : rh;
        }

        function updateCardRowSpan(card, container) {
            const rowHeight = getRowHeight(container);
            const gap = getContainerGap(container);
            const height = card.getBoundingClientRect().height;
            const minSpan = Math.max(1, Math.ceil((height + gap) / (rowHeight + gap)));
            const manual = parseInt(card.dataset.rowSpanManual || '0', 10) || 0;
            const span = Math.max(minSpan, manual);
            card.style.gridRow = `span ${span}`;
        }
        // Observe card size and content changes to keep row-span in sync
        function attachAutosizeObserver(card, container) {
            if (card.__autosizeObserverAttached) return;
            card.__autosizeObserverAttached = true;
            let rafId = null;
            let lastHeight = -1;
            const scheduleUpdate = () => {
                if (rafId) return;
                rafId = requestAnimationFrame(() => {
                    rafId = null;
                    const h = card.getBoundingClientRect().height;
                    if (Math.abs(h - lastHeight) > 0.5) {
                        lastHeight = h;
                        updateCardRowSpan(card, container);
                    }
                });
            };
            try {
                const ro = new ResizeObserver(scheduleUpdate);
                ro.observe(card);
                card.__ro = ro;
            } catch (_) {}
            try {
                const mo = new MutationObserver(scheduleUpdate);
                mo.observe(card, { childList: true, subtree: true, characterData: true });
                card.__mo = mo;
            } catch (_) {}
            // Initial fit
            updateCardRowSpan(card, container);
        }

        function addCardResizeHandle(card, container) {
            if (card.querySelector('.card-resize-handle')) return;
            const handle = document.createElement('div');
            handle.className = 'card-resize-handle';
            card.appendChild(handle);
            const tip = document.createElement('div');
            tip.className = 'resize-tooltip';
            tip.style.display = 'none';
            card.appendChild(tip);
            let startX = 0, startWidth = 0;
            const onMove = (e) => {
                const cols = getContainerCols(container);
                const gap = getContainerGap(container);
                const containerWidth = container.getBoundingClientRect().width;
                const colWidth = (containerWidth - gap * (cols - 1)) / cols;
                const newWidth = Math.max(220, startWidth + (e.clientX - startX));
                let span = Math.round(newWidth / colWidth);
                span = Math.min(Math.max(1, span), cols);
                card.dataset.colSpan = String(span);
                card.style.gridColumn = `span ${span}`;
                updateCardRowSpan(card, container);
                tip.textContent = `Width: ${span}/${cols} cols` + (span === 1 ? ' (min)' : (span === cols ? ' (max)' : ''));
                tip.style.display = 'block';
            };
            const onUp = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                tip.style.display = 'none';
                try { persistLayout(currentDashboard); } catch(_) {}
            };
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                startX = e.clientX;
                startWidth = card.getBoundingClientRect().width;
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
            // Prevent accidental click triggering parent card actions
            handle.addEventListener('click', (e) => { e.stopPropagation(); });
        }

        // Pointer interactions: drag anywhere, resize from all edges/corners
        function bindCardPointerInteractions(card, container){
            let mode = null; // 'drag' | 'resize'
            let startX = 0, startY = 0;
            let startCol = 1, startRow = 1;
            let edge = null; // 'left','right','top','bottom','tl','tr','bl','br'
            const raf = (cb) => requestAnimationFrame(cb);
            const cols = () => getContainerCols(container);
            const gap = () => getContainerGap(container);
            const colWidth = () => {
                const cRect = container.getBoundingClientRect();
                return (cRect.width - gap() * (cols() - 1)) / cols();
            };
            const rowHeight = () => getRowHeight(container);
            const saveDebounced = _debounce(() => { try { persistLayout(currentDashboard); } catch(_) {} }, 500);

            function detectEdge(x, y){
                const r = card.getBoundingClientRect();
                const px = 10; // hit area
                const nearLeft = Math.abs(x - r.left) <= px;
                const nearRight = Math.abs(x - r.right) <= px;
                const nearTop = Math.abs(y - r.top) <= px;
                const nearBottom = Math.abs(y - r.bottom) <= px;
                if (nearLeft && nearTop) return 'tl';
                if (nearRight && nearTop) return 'tr';
                if (nearLeft && nearBottom) return 'bl';
                if (nearRight && nearBottom) return 'br';
                if (nearLeft) return 'left';
                if (nearRight) return 'right';
                if (nearTop) return 'top';
                if (nearBottom) return 'bottom';
                return null;
            }

            function setCursor(e){
                const edgeNow = detectEdge(e.clientX, e.clientY);
                const map = { left:'ew-resize', right:'ew-resize', top:'ns-resize', bottom:'ns-resize', tl:'nwse-resize', tr:'nesw-resize', bl:'nesw-resize', br:'nwse-resize' };
                card.style.cursor = map[edgeNow] || 'grab';
            }

            function onDown(e){
                if (!document.getElementById('dashboardContent')?.classList.contains('layout-mode')) return;
                startX = e.clientX; startY = e.clientY;
                const mCol = parseInt(card.dataset.colSpan || '1', 10);
                const mRow = parseInt(card.dataset.rowSpanManual || '1', 10);
                startCol = isNaN(mCol) ? 1 : mCol;
                startRow = isNaN(mRow) ? 1 : mRow;
                edge = detectEdge(e.clientX, e.clientY);
                mode = edge ? 'resize' : 'drag';
                card.classList.add('drag-active');
                card.style.boxShadow = '0 0 0 2px #ff2d55, 0 12px 28px rgba(0,0,0,0.45)';
                card.setPointerCapture(e.pointerId);
            }
            function onMove(e){
                if (!mode) { setCursor(e); return; }
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                if (mode === 'drag'){
                    raf(() => { card.style.transform = `translate3d(${dx}px, ${dy}px, 0)`; });
                    return;
                }
                // Resize: update spans based on edge
                const cw = colWidth(); const rh = rowHeight();
                let col = startCol; let row = startRow;
                const dCols = Math.round(dx / cw);
                const dRows = Math.round(dy / rh);
                switch(edge){
                    case 'right': col = Math.min(Math.max(1, startCol + dCols), cols()); break;
                    case 'left': col = Math.min(Math.max(1, startCol - dCols), cols()); break;
                    case 'bottom': row = Math.max(1, startRow + dRows); break;
                    case 'top': row = Math.max(1, startRow - dRows); break;
                    case 'br': col = Math.min(Math.max(1, startCol + dCols), cols()); row = Math.max(1, startRow + dRows); break;
                    case 'bl': col = Math.min(Math.max(1, startCol - dCols), cols()); row = Math.max(1, startRow + dRows); break;
                    case 'tr': col = Math.min(Math.max(1, startCol + dCols), cols()); row = Math.max(1, startRow - dRows); break;
                    case 'tl': col = Math.min(Math.max(1, startCol - dCols), cols()); row = Math.max(1, startRow - dRows); break;
                }
                card.dataset.colSpan = String(col);
                card.style.gridColumn = `span ${col}`;
                card.dataset.rowSpanManual = String(row);
                card.style.gridRow = `span ${row}`;
                updateCardRowSpan(card, container);
            }
            function onUp(e){
                if (!mode) return;
                card.releasePointerCapture(e.pointerId);
                card.style.transform = '';
                card.classList.remove('drag-active');
                card.style.boxShadow = '';
                // On drag, snap by reordering to nearest sibling based on vertical center
                if (mode === 'drag'){
                    const siblings = Array.from(container.children).filter(el => el !== card);
                    const cy = card.getBoundingClientRect().top + card.getBoundingClientRect().height / 2;
                    let target = null; let before = true; let minDist = Infinity;
                    siblings.forEach(el => {
                        const r = el.getBoundingClientRect();
                        const mid = r.top + r.height / 2;
                        const dist = Math.abs(cy - mid);
                        if (dist < minDist){ minDist = dist; target = el; before = cy < mid; }
                    });
                    if (target){ container.insertBefore(card, before ? target : target.nextSibling); }
                    Array.from(container.children).forEach(el => updateCardRowSpan(el, container));
                }
                saveDebounced();
                mode = null; edge = null;
            }
            card.addEventListener('pointerdown', onDown);
            card.addEventListener('pointermove', onMove);
            card.addEventListener('pointerup', onUp);
            card.addEventListener('pointerleave', (e)=>{ if(!mode) setCursor(e); });
        }

        function addCardRowResizeHandle(card, container) {
            if (card.querySelector('.card-row-resize-handle')) return;
            const handle = document.createElement('div');
            handle.className = 'card-row-resize-handle';
            card.appendChild(handle);
            let startY = 0;
            let startSpan = 0;
            let baseMinSpan = 1;
            const onMove = (e) => {
                const rowHeight = getRowHeight(container);
                const gap = getContainerGap(container);
                const deltaY = (e.clientY - startY);
                const step = (rowHeight + gap);
                let newSpan = Math.max(1, Math.round(startSpan + (deltaY / step)));
                // Respect content minimum based on intrinsic content height, not current box height
                const minSpan = baseMinSpan;
                if (newSpan < minSpan) newSpan = minSpan;
                card.dataset.rowSpanManual = String(newSpan);
                card.style.gridRow = `span ${newSpan}`;
            };
            const onUp = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                // Recompute autosize after manual change
                try { updateCardRowSpan(card, container); } catch(_) {}
                try { persistLayout(currentDashboard); } catch(_) {}
            };
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                startY = e.clientY;
                // Use current assigned span (gridRow) if present, else compute
                const m = (card.style.gridRow || '').match(/span\s+(\d+)/);
                startSpan = m ? parseInt(m[1], 10) : 1;
                // Compute content-based minimum once at drag start (so oversizing doesn't lock out shrinking)
                const rowHeight = getRowHeight(container);
                const gap = getContainerGap(container);
                const step = (rowHeight + gap);
                const contentHeight = Math.max(card.scrollHeight || 0, card.querySelector('.card-inner')?.scrollHeight || 0);
                baseMinSpan = Math.max(1, Math.ceil((contentHeight + gap) / step));
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
            handle.addEventListener('click', (e) => { e.stopPropagation(); });
        }

        let dragSourceId = null;
        let ghostNode = null;
        function ensureGhost(container) {
            if (!ghostNode) {
                ghostNode = document.createElement('div');
                ghostNode.id = 'dashboard-ghost';
                ghostNode.className = 'ghost-placeholder';
            }
            if (ghostNode.parentElement !== container) container.appendChild(ghostNode);
            return ghostNode;
        }
        function removeGhost() {
            if (ghostNode && ghostNode.parentElement) ghostNode.parentElement.removeChild(ghostNode);
            ghostNode = null;
        }
        function getCardRowSpanForGhost(card, container) {
            const styleRow = (card.style.gridRow || '').match(/span\s+(\d+)/);
            const manual = parseInt(card.dataset.rowSpanManual || '0', 10) || 0;
            const current = styleRow ? parseInt(styleRow[1], 10) : manual || 1;
            return Math.max(1, current);
        }
        function addCardDragHandle(card) {
            if (card.querySelector('.card-drag-handle')) return;
            const handle = document.createElement('div');
            handle.className = 'card-drag-handle';
            handle.setAttribute('draggable', 'true');
            handle.title = 'Drag to move';
            card.appendChild(handle);
            handle.addEventListener('dragstart', (e) => {
                e.stopPropagation();
                dragSourceId = card.id;
                card.classList.add('dragging');
                e.dataTransfer.setData('text/plain', dragSourceId);
            });
            handle.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                // Clear any indicators
                const sibs = Array.from(card.parentElement.children);
                sibs.forEach(el => el.classList.remove('drag-target-before','drag-target-after'));
                removeGhost();
            });
            handle.addEventListener('click', (e) => { e.stopPropagation(); });
        }
        let lastDragTargetEl = null;
        let lastDragBefore = null;
        function handleCardDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const target = e.currentTarget;
            const container = target.parentElement;
            const rect = target.getBoundingClientRect();
            const before = (e.clientY || 0) < (rect.top + rect.height / 2);
            // visual indicator (optimized): only update when target/position changes
            if (lastDragTargetEl && lastDragTargetEl !== target) {
                lastDragTargetEl.classList.remove('drag-target-before','drag-target-after');
            }
            if (!lastDragTargetEl || lastDragTargetEl !== target || lastDragBefore !== before) {
                target.classList.remove('drag-target-before','drag-target-after');
                target.classList.add(before ? 'drag-target-before' : 'drag-target-after');
                lastDragTargetEl = target;
                lastDragBefore = before;
            }

            // collision and preview sizing
            const siblings = Array.from(container.children);
            siblings.forEach(el => el.classList.remove('collision-target'));
            const src = document.getElementById(dragSourceId);
            if (src && src !== target) {
                const cols = getContainerCols(container);
                const srcSpan = Math.max(1, parseInt(src.dataset.colSpan || '1', 10));
                const tgtSpan = Math.max(1, parseInt(target.dataset.colSpan || '1', 10));
                let preview = tgtSpan;
                let action = 'none';
                if (srcSpan + tgtSpan > cols) {
                    const remaining = Math.max(1, cols - srcSpan);
                    if (remaining >= 1) {
                        preview = remaining; // shrink to fit
                        action = 'shrink';
                    } else {
                        action = 'move'; // cannot fit; target will move
                    }
                }
                target.dataset.previewColspan = String(preview);
                target.dataset.previewAction = action;
                target.classList.add('collision-target');
                // Ghost preview footprint of the dragged card at the potential drop spot
                const ghost = ensureGhost(container);
                const finalSrcSpan = Math.min(srcSpan, cols);
                const finalRowSpan = getCardRowSpanForGhost(src, container);
                ghost.style.gridColumn = `span ${finalSrcSpan}`;
                ghost.style.gridRow = `span ${finalRowSpan}`;
                const rect2 = target.getBoundingClientRect();
                const before2 = (e.clientY || 0) < (rect2.top + rect2.height / 2);
                // Only move ghost if its position would change
                const desiredNode = before2 ? target : target.nextSibling;
                if (ghost.nextSibling !== desiredNode) {
                    container.insertBefore(ghost, desiredNode);
                }
            }
        }
        function handleCardDrop(e) {
            e.preventDefault();
            const srcId = e.dataTransfer.getData('text/plain') || dragSourceId;
            const target = e.currentTarget;
            const src = document.getElementById(srcId);
            if (!src || src === target) return;
            const container = target.parentElement;
            const targetRect = target.getBoundingClientRect();
            const insertBefore = (e.clientY || 0) < (targetRect.top + targetRect.height / 2);
            container.insertBefore(src, insertBefore ? target : target.nextSibling);
            // Clear indicators
            const siblings = Array.from(container.children);
            siblings.forEach(el => el.classList.remove('drag-target-before','drag-target-after'));
            // Apply snap fitment: shrink or move target if needed
            const cols = getContainerCols(container);
            const srcSpan = Math.max(1, parseInt(src.dataset.colSpan || '1', 10));
            const tgtSpan = Math.max(1, parseInt(target.dataset.colSpan || '1', 10));
            const action = target.dataset.previewAction || 'none';
            if (action === 'shrink') {
                const remaining = Math.max(1, cols - srcSpan);
                const newSpan = Math.min(tgtSpan, remaining);
                target.dataset.colSpan = String(newSpan);
                target.style.gridColumn = `span ${newSpan}`;
            } else if (action === 'move') {
                // push target after src to next position
                container.insertBefore(target, src.nextSibling);
            }
            target.classList.remove('collision-target');
            target.dataset.previewColspan = '';
            target.dataset.previewAction = '';
            // Recompute row spans post-drop
            siblings.forEach(el => updateCardRowSpan(el, container));
            try { persistLayout(currentDashboard); } catch(_) {}
            removeGhost();
        }

        // ---- Layout persistence and controls ----
        function getLayoutKey(tab) { return `dashboardLayout:${tab || currentDashboard || 'sales'}`; }
        function getDefaultKey(tab) { return `dashboardLayoutDefault:${tab || currentDashboard || 'sales'}`; }

        function serializeLayout() {
            const containers = Array.from(document.querySelectorAll('#dashboardContent .dashboard-layout'));
            return containers.map(c => {
                const cards = Array.from(c.children).filter(el => el.classList.contains('draggable-card'));
                return cards.map(el => ({
                    id: el.id,
                    col: parseInt(el.dataset.colSpan || '1', 10),
                    row: parseInt(((el.style.gridRow || '').match(/span\s+(\d+)/) || [,'1'])[1], 10),
                }));
            });
        }

        function applyLayout(saved) {
            if (!Array.isArray(saved)) return;
            const containers = Array.from(document.querySelectorAll('#dashboardContent .dashboard-layout'));
            containers.forEach((c, ci) => {
                const arr = saved[ci] || [];
                const byId = new Map(arr.map(x => [x.id, x]));
                const cards = Array.from(c.children).filter(el => el.classList.contains('draggable-card'));
                // Reorder by saved order
                arr.forEach(x => {
                    const el = document.getElementById(x.id);
                    if (el && el.parentElement === c) c.appendChild(el); // move to end following order
                });
                // Apply spans
                cards.forEach(el => {
                    const x = byId.get(el.id);
                    if (!x) return;
                    const colsCount = getContainerCols(c);
                    const col = Math.min(Math.max(1, parseInt(x.col || 1, 10)), colsCount);
                    el.dataset.colSpan = String(col);
                    el.style.gridColumn = `span ${col}`;
                    const row = Math.max(1, parseInt(x.row || 1, 10));
                    el.dataset.rowSpanManual = String(row);
                    el.style.gridRow = `span ${el.dataset.rowSpanManual}`;
                    updateCardRowSpan(el, c);
                });
            });
        }

        function persistLayout(tab) {
            const snapshot = serializeLayout();
            try { localStorage.setItem(getLayoutKey(tab), JSON.stringify(snapshot)); } catch(_) {}
            // Save to backend (Apps Script) with debounce
            try {
                if (window.google && google.script && google.script.run && typeof google.script.run.saveUserLayout === 'function') {
                    google.script.run.saveUserLayout((window.currentUser?.email)||'guest@local', tab, JSON.stringify(snapshot));
                }
            } catch(_) {}
        }

        function loadLayout(tab) {
            try {
                const usePrev = !!window.usePreviousBuildLayout;
                const key = usePrev ? `dashboardLayoutPrev:${tab}` : getLayoutKey(tab);
                const raw = localStorage.getItem(key);
                if (!raw) return;
                const saved = JSON.parse(raw);
                applyLayout(saved);
            } catch(_) {}
            // Attempt backend load to override local snapshot if available
            try {
                if (window.google && google.script && google.script.run && typeof google.script.run.getUserLayout === 'function') {
                    const email = (window.currentUser?.email)||'guest@local';
                    google.script.run.withSuccessHandler(function(serverRaw){
                        if (serverRaw && typeof serverRaw === 'string' && serverRaw.length) {
                            try {
                                localStorage.setItem(getLayoutKey(tab), serverRaw);
                                const snap = JSON.parse(serverRaw);
                                applyLayout(snap);
                            } catch(e) {}
                        }
                    }).getUserLayout(email, tab);
                }
            } catch(_) {}
        }

        function captureDefaultLayout(tab) {
            try {
                const defKey = getDefaultKey(tab);
                if (localStorage.getItem(defKey)) return; // already captured
                localStorage.setItem(defKey, JSON.stringify(serializeLayout()));
            } catch(_) {}
        }

        function resetLayoutToDefault(tab) {
            try {
                const def = localStorage.getItem(getDefaultKey(tab));
                if (def) {
                    localStorage.setItem(getLayoutKey(tab), def);
                } else {
                    localStorage.removeItem(getLayoutKey(tab));
                }
                // Backup current layout as previous build snapshot
                localStorage.setItem(`dashboardLayoutPrev:${tab}`, def || JSON.stringify(serializeLayout()));
            } catch(_) {}
        }

        function revertToPreviousBuild(tab){
            try {
                const raw = localStorage.getItem(`dashboardLayoutPrev:${tab}`);
                if (raw) {
                    localStorage.setItem(getLayoutKey(tab), raw);
                    applyLayout(JSON.parse(raw));
                }
            } catch(_) {}
        }

        // Force baseline default (pre-layout-changes) for tabs that need to be restored
        function forceBaselineDefaultLayout(tab) {
            const root = document.getElementById('dashboardContent');
            if (!root) return;
            const containers = Array.from(root.querySelectorAll('.dashboard-layout'));
            containers.forEach(container => {
                const cols = getContainerCols(container);
                Array.from(container.children).forEach(card => {
                    const fixed = card.dataset.layoutFixed === 'true';
                    const fixedSpan = parseInt(card.dataset.fixedColSpan || '0', 10);
                    const span = fixed && fixedSpan ? Math.min(Math.max(1, fixedSpan), cols) : 1;
                    card.dataset.colSpan = String(span);
                    card.style.gridColumn = `span ${span}`;
                    delete card.dataset.rowSpanManual;
                    card.style.removeProperty('gridRow');
                    try { updateCardRowSpan(card, container); } catch(_) {}
                });
            });
            const snapshot = serializeLayout();
            try {
                localStorage.setItem(getDefaultKey(tab), JSON.stringify(snapshot));
                localStorage.setItem(getLayoutKey(tab), JSON.stringify(snapshot));
            } catch(_) {}
        }

        function injectLayoutControls() {
            const root = document.getElementById('dashboardContent');
            if (!root || document.getElementById('layoutControls')) return;
            const bar = document.createElement('div');
            bar.id = 'layoutControls';
            bar.className = 'flex items-center gap-3 mb-3';
            bar.innerHTML = `
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    <input id="layoutModeToggle" type="checkbox" class="rounded border-gray-300"> Layout mode
                </label>
                <button id="resetLayoutBtn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded">Reset layout</button>
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    <input id="idleFunToggle" type="checkbox" class="rounded border-gray-300"> Idle fun mode
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    <input id="emojiIconToggle" type="checkbox" class="rounded border-gray-300"> Emoji icons
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    Idle mode
                    <select id="idleModeSelect" class="border border-gray-300 rounded px-2 py-1 text-sm">
                        <option value="float">Float sprites</option>
                        <option value="chew">Chew damage</option>
                    </select>
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    Idle delay
                    <select id="idleDelaySelect" class="border border-gray-300 rounded px-2 py-1 text-sm">
                        <option value="5000">5s</option>
                        <option value="15000">15s</option>
                        <option value="60000">1m</option>
                        <option value="300000">5m</option>
                    </select>
                </label>
                <button id="idleStartNowBtn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded">Start idle now</button>
                <button id="idleStopBtn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded">Stop idle</button>
                <button id="resetDamageBtn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded">Reset damage</button>
            `;
            root.prepend(bar);
            const toggle = document.getElementById('layoutModeToggle');
            const resetBtn = document.getElementById('resetLayoutBtn');
            if (toggle) toggle.addEventListener('change', (e) => setLayoutMode(e.target.checked));
            if (resetBtn) resetBtn.addEventListener('click', () => {
                try {
                    // Reset to captured defaults for this tab
                    resetLayoutToDefault(currentDashboard);
                    loadLayout(currentDashboard);
                } catch(_) {}
            });
            // Add revert control
            const revertBtn = document.createElement('button');
            revertBtn.className = 'px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded';
            revertBtn.textContent = 'Revert to Previous Build';
            revertBtn.addEventListener('click', () => { try { revertToPreviousBuild(currentDashboard); } catch(_) {} });
            bar.appendChild(revertBtn);

            // Initialize Idle Fun Mode toggle from settings
            try {
                const idleToggle = document.getElementById('idleFunToggle');
                if (idleToggle) {
                    const enabled = (localStorage.getItem('idleFun.enabled') || 'true') === 'true';
                    idleToggle.checked = enabled;
                    idleToggle.addEventListener('change', (e) => {
                        const val = !!e.target.checked;
                        try { localStorage.setItem('idleFun.enabled', String(val)); } catch(_) {}
                        if (val) { try { scheduleIdleFun(); } catch(_) {} } else { try { stopIdleFunMode(); } catch(_) {} }
                    });
                }
            } catch(_) {}

            // Initialize Emoji Icons preference toggle
            try {
                const emojiToggle = document.getElementById('emojiIconToggle');
                if (emojiToggle) {
                    const preferEmoji = (localStorage.getItem('icons.useEmoji') || 'true') === 'true';
                    emojiToggle.checked = preferEmoji;
                    emojiToggle.addEventListener('change', (e) => {
                        const val = !!e.target.checked;
                        try { localStorage.setItem('icons.useEmoji', String(val)); } catch(_) {}
                        try { updateDashboardTitleIcon(currentDashboard); } catch(_) {}
                    });
                }
            } catch(_) {}
            // Initialize Idle mode selector
            try {
                const modeSel = document.getElementById('idleModeSelect');
                if (modeSel) {
                    const current = (localStorage.getItem('idleFun.mode') || 'float');
                    modeSel.value = (current === 'chew') ? 'chew' : 'float';
                    modeSel.addEventListener('change', (e) => {
                        const val = String(e.target.value);
                        try { localStorage.setItem('idleFun.mode', val); } catch(_) {}
                        try {
                            // Restart idle fun if currently running
                            stopIdleFunMode();
                            stopChewMode();
                            scheduleIdleFun();
                        } catch(_) {}
                    });
                }
            } catch(_) {}
            // Initialize Idle delay selector
            try {
                const delaySel = document.getElementById('idleDelaySelect');
                if (delaySel) {
                    const current = Number(localStorage.getItem('idleFun.timeoutMs') || '300000');
                    const allowed = [5000,15000,60000,300000];
                    delaySel.value = String(allowed.includes(current) ? current : 300000);
                    delaySel.addEventListener('change', (e) => {
                        const val = Number(e.target.value);
                        try { localStorage.setItem('idleFun.timeoutMs', String(val)); } catch(_) {}
                        try { scheduleIdleFun(); } catch(_) {}
                    });
                }
            } catch(_) {}

            // Start/Stop buttons for demoing idle fun mode
            try {
                const startBtn = document.getElementById('idleStartNowBtn');
                const stopBtn = document.getElementById('idleStopBtn');
                if (startBtn) startBtn.addEventListener('click', () => {
                    try {
                        const mode = (localStorage.getItem('idleFun.mode') || 'float');
                        if (mode === 'chew') { startChewMode(); } else { startIdleFunMode(); }
                    } catch(_) {}
                });
                if (stopBtn) stopBtn.addEventListener('click', () => {
                    try {
                        stopIdleFunMode();
                        stopChewMode();
                        window._idleFun.lastActivity = Date.now();
                        scheduleIdleFun();
                    } catch(_) {}
                });
                const resetDamageBtn = document.getElementById('resetDamageBtn');
                if (resetDamageBtn) resetDamageBtn.addEventListener('click', () => { try { clearChewDamage(); } catch(_) {} });
            } catch(_) {}
        }

        function setLayoutMode(enabled) {
            const root = document.getElementById('dashboardContent');
            if (!root) return;
            root.classList.toggle('layout-mode', !!enabled);
            try { window.dashboardEngine?.layoutMode(!!enabled); } catch(_) {}
            // Ensure overlay uses current cols
            Array.from(root.querySelectorAll('.dashboard-layout')).forEach(c => c.style.setProperty('--cols', String(getContainerCols(c))));
            // When entering layout mode, default to captured base layout
            if (enabled) {
                try {
                    const raw = localStorage.getItem(getDefaultKey(currentDashboard));
                    if (raw) applyLayout(JSON.parse(raw));
                } catch (_) {}
                // Also enforce fixed spans immediately
                Array.from(root.querySelectorAll('.dashboard-layout')).forEach(c => enforceFixedSpans(c));
            } else {
                // For Sales and Operations, force restore to baseline default
                if (currentDashboard === 'sales' || currentDashboard === 'operations') {
                    try { forceBaselineDefaultLayout(currentDashboard); } catch(_) {}
                }
                // Leaving layout mode: restore default layout for current tab without full reset
                try {
                    const raw = localStorage.getItem(getDefaultKey(currentDashboard));
                    if (raw) applyLayout(JSON.parse(raw));
                } catch (_) {}
                // Strip residual handles and layout-only classes for a clean default state
                Array.from(root.querySelectorAll('.dashboard-layout')).forEach(container => {
                    container.querySelectorAll('.card-resize-handle, .card-row-resize-handle, .card-drag-handle').forEach(h => h.remove());
                    container.querySelectorAll('.draggable-card').forEach(card => {
                        card.classList.remove('draggable-card','dragging','drag-target-before','drag-target-after','collision-target');
                        // Remove inline grid span styles applied during layout mode; keep dataset spans for defaults
                        card.style.removeProperty('gridColumn');
                        card.style.removeProperty('gridRow');
                    });
                    // Recompute autosize so content fits naturally
                    Array.from(container.children).forEach(card => { try { updateCardRowSpan(card, container); } catch(_) {} });
                });
            }
        }

        // --- Idle Fun Mode ---
        function injectIdleFunStyles() {
            if (document.getElementById('idle-fun-styles')) return;
            const style = document.createElement('style');
            style.id = 'idle-fun-styles';
            style.textContent = `
                .idle-fun-layer { position: fixed; inset: 0; pointer-events: none; z-index: 9999; contain: paint; }
                .idle-sprite { position: absolute; will-change: transform, opacity; }
                .idle-sprite img { display: block; width: 48px; height: 48px; image-rendering: auto; will-change: transform, opacity; }
                @keyframes idle-wiggle { 0% { transform: translate3d(0,0,0) rotate(0deg) } 25% { transform: translate3d(4px,-2px,0) rotate(2deg) } 50% { transform: translate3d(0,-4px,0) rotate(-2deg) } 75% { transform: translate3d(-3px,2px,0) rotate(2deg) } 100% { transform: translate3d(0,0,0) rotate(0deg) } }
                @keyframes idle-drift { 0% { transform: translate3d(0,0,0) } 50% { transform: translate3d(12px,6px,0) } 100% { transform: translate3d(0,0,0) } }
                .idle-sprite .anim { animation: idle-wiggle 4s ease-in-out infinite; }
                .idle-sprite .drift { animation: idle-drift 10s ease-in-out infinite; }
                @media (prefers-reduced-motion: reduce) { .idle-sprite .anim, .idle-sprite .drift { animation: none !important; } }
                /* Chew Mode visuals */
                .chew-rat { position: fixed; width: 56px; height: 56px; pointer-events: none; z-index: 10000; will-change: transform; }
                .chew-rat img { width: 56px; height: 56px; display: block; }
                @keyframes chew-bob { 0% { transform: translate3d(0,0,0) scale(1) } 50% { transform: translate3d(0,-2px,0) scale(1.03) } 100% { transform: translate3d(0,0,0) scale(1) } }
                .chew-rat .bob { animation: chew-bob 0.6s ease-in-out infinite; }
                .crumb { position: fixed; width: 6px; height: 6px; background: #b08b5a; border-radius: 50%; opacity: 0.9; z-index: 9998; pointer-events: none; }
                @keyframes crumb-fall { 0% { transform: translate3d(0,0,0); opacity: 0.9 } 100% { transform: translate3d(4px,18px,0); opacity: 0 } }
                .crumb.anim { animation: crumb-fall 800ms ease-in forwards; }
            `;
            document.head.appendChild(style);
        }

        function ensureIdleFunLayer() {
            let layer = document.getElementById('idleFunLayer');
            if (!layer) {
                layer = document.createElement('div');
                layer.id = 'idleFunLayer';
                layer.className = 'idle-fun-layer';
                document.body.appendChild(layer);
            }
            return layer;
        }

        function _chooseIdleIcon() {
            const pool = ['Mouse.png','Rat.png','Bee.png','Fire Ant.png','Hornet.png','Termite.png'];
            return pool[Math.floor(Math.random()*pool.length)];
        }

        function _rand(min, max) { return Math.random()*(max-min)+min; }

        function createIdleSprite() {
            const layer = ensureIdleFunLayer();
            const wrap = document.createElement('div');
            wrap.className = 'idle-sprite';
            const baseX = _rand(0, window.innerWidth - 64);
            const baseY = _rand(0, window.innerHeight - 64);
            wrap.style.transform = `translate3d(${Math.round(baseX)}px, ${Math.round(baseY)}px, 0)`;
            const img = document.createElement('img');
            img.src = `Icons/${_chooseIdleIcon()}`;
            img.alt = '';
            img.className = 'anim';
            const drift = document.createElement('div');
            drift.className = 'drift';
            drift.appendChild(img);
            wrap.appendChild(drift);
            layer.appendChild(wrap);
            return wrap;
        }

        window._idleFun = { running:false, timer:null, sprites:[], lastActivity: Date.now(), chew:{ running:false, rat:null, loop:null, bites:[] } };

        function startIdleFunMode() {
            try {
                const enabled = (localStorage.getItem('idleFun.enabled') || 'true') === 'true';
                const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                if (!enabled || reduce || document.hidden) return;
                injectIdleFunStyles();
                const layer = ensureIdleFunLayer();
                layer.style.display = 'block';
                const count = Math.min(10, Math.max(3, Number(localStorage.getItem('idleFun.maxSprites')||'6')));
                window._idleFun.sprites.forEach(s => s.remove());
                window._idleFun.sprites = [];
                for (let i=0; i<count; i++) { window._idleFun.sprites.push(createIdleSprite()); }
                window._idleFun.running = true;
            } catch(_) {}
        }

        function stopIdleFunMode() {
            try {
                const layer = document.getElementById('idleFunLayer');
                if (layer) layer.style.display = 'none';
                window._idleFun.running = false;
                window._idleFun.sprites.forEach(s => s.remove());
                window._idleFun.sprites = [];
            } catch(_) {}
        }

        // --- Chew Mode ---
        function _getChewTarget() { return document.getElementById('dashboardContent'); }
        function _buildMask(bites, rect) {
            if (!bites.length) return '';
            const parts = bites.map(b => `radial-gradient(circle ${b.r}px at ${Math.round(b.x - rect.left)}px ${Math.round(b.y - rect.top)}px, transparent 95%, black 96%)`);
            return parts.join(', ');
        }
        function applyChewMask() {
            try {
                const target = _getChewTarget(); if (!target) return;
                const rect = target.getBoundingClientRect();
                const mask = _buildMask(window._idleFun.chew.bites, rect);
                target.style.maskImage = mask;
                target.style.webkitMaskImage = mask;
                target.style.maskRepeat = 'no-repeat';
                target.style.webkitMaskRepeat = 'no-repeat';
            } catch(_) {}
        }
        function clearChewDamage() {
            try {
                const target = _getChewTarget(); if (!target) return;
                window._idleFun.chew.bites = [];
                target.style.maskImage = '';
                target.style.webkitMaskImage = '';
                target.style.maskRepeat = '';
                target.style.webkitMaskRepeat = '';
            } catch(_) {}
        }
        function addBite(x, y, r=28) {
            window._idleFun.chew.bites.push({ x, y, r });
            applyChewMask();
            // crumbs
            try {
                const c = document.createElement('div');
                c.className = 'crumb anim';
                c.style.left = `${Math.round(x)}px`;
                c.style.top = `${Math.round(y)}px`;
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 1000);
            } catch(_) {}
        }
        function ensureChewRat() {
            let rat = window._idleFun.chew.rat;
            if (!rat) {
                const layer = ensureIdleFunLayer();
                rat = document.createElement('div');
                rat.className = 'chew-rat';
                const img = document.createElement('img');
                img.src = 'Icons/Rat.png';
                img.alt = '';
                img.className = 'bob';
                rat.appendChild(img);
                layer.appendChild(rat);
                window._idleFun.chew.rat = rat;
            }
            return rat;
        }
        function startChewMode() {
            try {
                const enabled = (localStorage.getItem('idleFun.enabled') || 'true') === 'true';
                const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                if (!enabled || reduce || document.hidden) return;
                injectIdleFunStyles();
                ensureIdleFunLayer().style.display = 'block';
                const rat = ensureChewRat();
                window._idleFun.chew.running = true;
                const step = () => {
                    if (!window._idleFun.chew.running) return;
                    const target = _getChewTarget(); if (!target) return;
                    const rect = target.getBoundingClientRect();
                    const x = Math.round(rect.left + Math.random()*rect.width);
                    const y = Math.round(rect.top + Math.random()*rect.height);
                    rat.style.transform = `translate3d(${x-28}px, ${y-28}px, 0)`;
                    addBite(x, y, 28 + Math.round(Math.random()*8));
                    window._idleFun.chew.loop = setTimeout(step, 800 + Math.round(Math.random()*1200));
                };
                step();
            } catch(_) {}
        }
        function stopChewMode() {
            try {
                window._idleFun.chew.running = false;
                if (window._idleFun.chew.loop) { clearTimeout(window._idleFun.chew.loop); window._idleFun.chew.loop = null; }
                const rat = window._idleFun.chew.rat; if (rat) rat.remove(); window._idleFun.chew.rat = null;
                const layer = document.getElementById('idleFunLayer'); if (layer) layer.style.display = 'none';
            } catch(_) {}
        }

        function _getIdleTimeoutMs() {
            const raw = Number(localStorage.getItem('idleFun.timeoutMs')||'300000');
            return isNaN(raw) ? 300000 : Math.max(2000, raw);
        }

        function scheduleIdleFun() {
            try { if (window._idleFun.timer) clearTimeout(window._idleFun.timer); } catch(_) {}
            const now = Date.now();
            const wait = _getIdleTimeoutMs();
            const remaining = Math.max(0, (window._idleFun.lastActivity + wait) - now);
            window._idleFun.timer = setTimeout(() => {
                if (!document.hidden && (Date.now() - window._idleFun.lastActivity) >= _getIdleTimeoutMs()) {
                    const mode = (localStorage.getItem('idleFun.mode') || 'float');
                    if (mode === 'chew') { startChewMode(); } else { startIdleFunMode(); }
                }
            }, remaining);
        }

        function resetIdleTimer() {
            window._idleFun.lastActivity = Date.now();
            if (window._idleFun.running) stopIdleFunMode();
            scheduleIdleFun();
        }

        function setupIdleFunLifecycle() {
            try {
                ['pointermove','mousedown','keydown','scroll','touchstart'].forEach(evt => {
                    window.addEventListener(evt, resetIdleTimer, { passive: true });
                });
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) { stopIdleFunMode(); stopChewMode(); } else { scheduleIdleFun(); }
                });
                scheduleIdleFun();
            } catch(_) {}
        }

        try { setupIdleFunLifecycle(); } catch(_) {}

        // Render Branch Manager Dashboard
        function renderBranchManagerDashboard(data) {
            const showCharts = (typeof dashboardViewPref === 'string') ? (dashboardViewPref === 'charts') : true;
            let content = `
                <div class=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8\">
                    <div class=\"kpi-card bg-white p-6 rounded-lg shadow-lg count-up\">
                        <h3 class=\"text-lg font-semibold text-gray-600 mb-2\">Proposals</h3>
                        <p class=\"text-3xl font-bold text-brand\">${data.kpis.branchProposals ?? data.kpis.proposals ?? 0}</p>
                        <p class=\"text-sm text-gray-600 mt-1\">This month</p>
                    </div>
                    <div class=\"kpi-card bg-white p-6 rounded-lg shadow-lg count-up\">
                        <h3 class=\"text-lg font-semibold text-gray-600 mb-2\">Sold</h3>
                        <p class=\"text-3xl font-bold text-green-600\">${data.kpis.branchSales ?? data.kpis.sold ?? 0}</p>
                        <p class=\"text-sm text-gray-600 mt-1\">This month</p>
                    </div>
                    <div class=\"kpi-card bg-white p-6 rounded-lg shadow-lg count-up\">
                        <h3 class=\"text-lg font-semibold text-gray-600 mb-2\">Conversion Rate</h3>
                        <p class=\"text-3xl font-bold text-brand\">${data.kpis.branchConversionRate ?? data.kpis.conversionRate ?? 0}%</p>
                        <p class=\"text-sm text-gray-600 mt-1\">Branch</p>
                    </div>
                </div>`;
                content += `${renderAiAssistantCard()}`;
                content += `
                <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8\">\n                    <div class=\"bg-white p-6 rounded-lg shadow-lg\">\n                        <div class=\"flex items-center justify-between mb-4\">\n                            <h3 class=\"text-lg font-semibold text-gray-800\">Cadence Trend</h3>\n                            <div class=\"flex items-center space-x-2\">\n                                <label for=\"trendMetricSelect\" class=\"text-sm text-gray-600\">Metric</label>\n                                <select id=\"trendMetricSelect\" class=\"px-2 py-1 border border-gray-300 rounded-md\">\n                                    <option value=\"nextDayConf\">Next Day CONF</option>\n                                    <option value=\"tapLeads\">TAP Leads</option>\n                                    <option value=\"inspPrp\">INSP PRP</option>\n                                    <option value=\"lobsPrp\">LOBs PRP</option>\n                                    <option value=\"lobsSold\">LOBs Sold</option>\n                                    <option value=\"dollarsSld\">Dollars SLD</option>\n                                    <option value=\"pcNoTcConversions\">PC NO TC Conversions</option>\n                                    <option value=\"nextDayApps\">Next Day Apps</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div id=\"cadenceTrendChart\" class=\"w-full h-64\"></div>\n                    </div>\n                    <div class=\"bg-white p-6 rounded-lg shadow-lg\">\n                        <div class=\"flex items-center justify-between mb-4\">\n                            <h3 class=\"text-lg font-semibold text-gray-800\">Cadence Comparison (Stacked)</h3>\n                            <div class=\"flex items-center space-x-2\">\n                                <label for=\"stackedMetricASelect\" class=\"text-sm text-gray-600\">A</label>\n                                <select id=\"stackedMetricASelect\" class=\"px-2 py-1 border border-gray-300 rounded-md\">\n                                    <option value=\"lobsPrp\">LOBs PRP</option>\n                                    <option value=\"lobsSold\">LOBs Sold</option>\n                                    <option value=\"tapLeads\">TAP Leads</option>\n                                    <option value=\"inspPrp\">INSP PRP</option>\n                                    <option value=\"dollarsSld\">Dollars SLD</option>\n                                    <option value=\"nextDayConf\">Next Day CONF</option>\n                                    <option value=\"pcNoTcConversions\">PC NO TC Conversions</option>\n                                    <option value=\"nextDayApps\">Next Day Apps</option>\n                                </select>\n                                <label for=\"stackedMetricBSelect\" class=\"text-sm text-gray-600\">B</label>\n                                <select id=\"stackedMetricBSelect\" class=\"px-2 py-1 border border-gray-300 rounded-md\">\n                                    <option value=\"lobsSold\">LOBs Sold</option>\n                                    <option value=\"lobsPrp\">LOBs PRP</option>\n                                    <option value=\"tapLeads\">TAP Leads</option>\n                                    <option value=\"inspPrp\">INSP PRP</option>\n                                    <option value=\"dollarsSld\">Dollars SLD</option>\n                                    <option value=\"nextDayConf\">Next Day CONF</option>\n                                    <option value=\"pcNoTcConversions\">PC NO TC Conversions</option>\n                                    <option value=\"nextDayApps\">Next Day Apps</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div id=\"cadenceStackedChart\" class=\"w-full h-64\"></div>\n                    </div>\n                </div>`;

            if (showCharts) {
                content += `
                <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8\">
                    <div class=\"bg-white p-6 rounded-lg shadow-lg\">
                        <h3 class=\"text-lg font-semibold text-gray-800 mb-4\">7-Day Performance</h3>
                        <div id=\"sevenDayChart\" class=\"w-full h-64\"></div>
                    </div>
                    <div class=\"bg-white p-6 rounded-lg shadow-lg\">
                        <h3 class=\"text-lg font-semibold text-gray-800 mb-4\">30-Day Performance</h3>
                        <div id=\"thirtyDayChart\" class=\"w-full h-64\"></div>
                    </div>
                </div>`;
            } else {
                content += `
                <div class=\"bg-white p-6 rounded-lg shadow-lg mb-8\">
                    <h3 class=\"text-lg font-semibold text-gray-800 mb-4\">Cadence Metrics (Last 7 Days)</h3>
                    <div class=\"overflow-x-auto\">
                        <table class=\"min-w-full divide-y divide-gray-200\">
                            <thead class=\"bg-gray-50\">
                                <tr>
                                    <th class=\"px-4 py-2 text-left text-xs font-medium text-gray-500\">Metric</th>
                                    <th class=\"px-4 py-2 text-left text-xs font-medium text-gray-500\">Total</th>
                                </tr>
                            </thead>
                            <tbody class=\"divide-y divide-gray-200\">
                                <tr><td class=\"px-4 py-2\">TAP Leads</td><td class=\"px-4 py-2 font-semibold\">${data.cadenceSummary?.last7?.tapLeads ?? 0}</td></tr>
                                <tr><td class=\"px-4 py-2\">INSP PRP</td><td class=\"px-4 py-2 font-semibold\">${data.cadenceSummary?.last7?.inspPrp ?? 0}</td></tr>
                                <tr><td class=\"px-4 py-2\">LOBs PRP</td><td class=\"px-4 py-2 font-semibold\">${data.cadenceSummary?.last7?.lobsPrp ?? 0}</td></tr>
                                <tr><td class=\"px-4 py-2\">LOBs Sold</td><td class=\"px-4 py-2 font-semibold\">${data.cadenceSummary?.last7?.lobsSold ?? 0}</td></tr>
                                <tr><td class=\"px-4 py-2\">Dollars SLD</td><td class=\"px-4 py-2 font-semibold\">$${data.cadenceSummary?.last7?.dollarsSld ?? 0}</td></tr>
                                <tr><td class=\"px-4 py-2\">Next Day CONF</td><td class=\"px-4 py-2 font-semibold\">${data.cadenceSummary?.last7?.nextDayConf ?? 0}</td></tr>
                                <tr><td class=\"px-4 py-2\">PC NO TC Conversions</td><td class=\"px-4 py-2 font-semibold\">${data.cadenceSummary?.last7?.pcNoTcConversions ?? 0}</td></tr>
                                <tr><td class=\"px-4 py-2\">Next Day Apps</td><td class=\"px-4 py-2 font-semibold\">${data.cadenceSummary?.last7?.nextDayApps ?? 0}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
            }

            content += `
                <div class=\"grid grid-cols-1 md:grid-cols-2 gap-6\">
                    <div class=\"bg-white p-6 rounded-lg shadow-lg\">
                        <h3 class=\"text-lg font-semibold text-gray-800 mb-4\">Branch Metrics</h3>
                        <div class=\"space-y-3\">
                            <div class=\"flex justify-between items-center p-3 bg-gray-50 rounded-lg\">
                                <span class=\"text-gray-700\">Dead Leads</span>
                                <span class=\"font-bold text-red-600\">${data.kpis.dead ?? 0}</span>
                            </div>
                            <div class=\"flex justify-between items-center p-3 bg-gray-50 rounded-lg\">
                                <span class=\"text-gray-700\">Confirmation Rate</span>
                                <span class=\"font-bold text-green-600\">${data.kpis.confRate ?? 0}%</span>
                            </div>
                            <div class=\"flex justify-between items-center p-3 bg-gray-50 rounded-lg\">
                                <span class=\"text-gray-700\">LOBs PRP</span>
                                <span class=\"font-bold text-brand\">${data.kpis.lobsPRP ?? 0}</span>
                            </div>
                        </div>
                    </div>
                    <div class=\"bg-white p-6 rounded-lg shadow-lg\">
                        <h3 class=\"text-lg font-semibold text-gray-800 mb-4\">Team Performance</h3>
                        <div class=\"space-y-3\">
                            <div class=\"flex justify-between items-center p-3 bg-gray-50 rounded-lg\">
                                <span class=\"text-gray-700\">Top Performer</span>
                                <span class=\"font-bold text-green-600\">${(data.teamPerformance?.topPerformerName || 'â€”')} - ${(data.teamPerformance?.topPerformerAttainmentPct ?? 0)}%</span>
                            </div>
                            <div class=\"flex justify-between items-center p-3 bg-gray-50 rounded-lg\">
                                <span class=\"text-gray-700\">Team Average</span>
                                <span class=\"font-bold text-brand\">${(data.teamPerformance?.teamAveragePct ?? 0)}%</span>
                            </div>
                            <div class=\"flex justify-between items-center p-3 bg-gray-50 rounded-lg\">
                                <span class=\"text-gray-700\">Needs Coaching</span>
                                <span class=\"font-bold text-orange-600\">${(data.teamPerformance?.needsCoachingCount ?? 0)} reps</span>
                            </div>
                        </div>
                    </div>
                </div>`;

            // Append Branch Manager KPIs section within Branch Manager dashboard
            content += `
              <section id=\"branch-manager-kpis\" class=\"bg-white p-6 rounded-lg shadow-lg mt-6\">
                <div class=\"flex items-center justify-between mb-3\">
                  <div>
                    <h3 class=\"text-lg font-semibold text-gray-800\">Branch Manager KPIs</h3>
                    <p class=\"text-xs text-gray-500\">Summary + AE/Ops/Tech columns</p>
                  </div>
                  <div class=\"flex items-center gap-2\">
                    <label class=\"text-sm text-gray-600\">Branch <input id=\"bm-branch\" class=\"border rounded px-2 py-1 text-sm\" value=\"${escapeHtml(currentUser?.branch || 'HOU')}\"/></label>
                    <label class=\"text-sm text-gray-600\">From <input id=\"bm-from\" type=\"date\" class=\"border rounded px-2 py-1 text-sm\"/></label>
                    <label class=\"text-sm text-gray-600\">To <input id=\"bm-to\" type=\"date\" class=\"border rounded px-2 py-1 text-sm\"/></label>
                    <label class=\"text-sm text-gray-600\"><input id=\"bm-only-red\" type=\"checkbox\"/> Only Red</label>
                    <button id=\"bm-refresh\" class=\"px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded\">Refresh</button>
                  </div>
                </div>
                <div id=\"bm-summary\" class=\"flex flex-wrap gap-2\"></div>
                <div id=\"bm-columns\" class=\"grid grid-cols-1 md:grid-cols-3 gap-3 mt-3\"></div>
              </section>
              <div id=\"bm-drilldown\" class=\"fixed inset-0 hidden bg-black bg-opacity-50\">
                <div class=\"bg-gray-900 text-white w-11/12 max-w-5xl mx-auto mt-10 rounded-lg\">
                  <div class=\"flex items-center justify-between p-4 border-b border-gray-700\">
                    <h3 id=\"bm-drill-title\" class=\"text-lg font-semibold\">Drill-down</h3>
                    <div class=\"flex items-center gap-2\">
                      <button id=\"bm-download\" class=\"px-2 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded\">Download CSV</button>
                      <button id=\"bm-close\" class=\"px-2 py-1 text-sm bg-red-600 hover:bg-red-500 rounded\">Close</button>
                    </div>
                  </div>
                  <div class=\"p-3 max-h-[60vh] overflow-auto\">
                    <table id=\"bm-table\" class=\"min-w-full text-sm\"></table>
                  </div>
                </div>
              </div>`;

            document.getElementById('dashboardContent').innerHTML = content;
            // Wire Branch Manager KPIs defaults + interactions
            try {
              const today = new Date();
              const start = new Date(today.getFullYear(), today.getMonth(), 1);
              const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
              const fromEl = document.getElementById('bm-from');
              const toEl = document.getElementById('bm-to');
              if (fromEl) fromEl.value = start.toISOString().slice(0, 10);
              if (toEl) toEl.value = end.toISOString().slice(0, 10);
              document.getElementById('bm-refresh')?.addEventListener('click', async () => { await loadBranchManagerKpisUI(); });
              loadBranchManagerKpisUI();
            } catch (e) { console.warn('BM KPIs init failed (Presto-X)', e); }
            // Initialize universal grid for Branch Manager
            try { if (window.universalGridEnabled === true) initUniversalGrid('branch'); } catch(_) {}

            // Load unified tracker view under Branch dashboard (filtered by branch if available)
            const branchKey = (currentUser && currentUser.branch) ? currentUser.branch : null;
            loadUnifiedTracker({ branch: branchKey });
            if (showCharts) {
                drawPerformanceCharts(data.charts);
                const trendSel = document.getElementById('trendMetricSelect');
                const stackedASel = document.getElementById('stackedMetricASelect');
                const stackedBSel = document.getElementById('stackedMetricBSelect');
                if (trendSel) trendSel.value = 'nextDayConf';
                if (stackedASel) stackedASel.value = 'lobsPrp';
                if (stackedBSel) stackedBSel.value = 'lobsSold';
                const ts = data.cadenceTimeseries;
                const drawAll = () => drawSelectedCadenceCharts(ts);
                if (trendSel) trendSel.addEventListener('change', drawAll);
                if (stackedASel) stackedASel.addEventListener('change', drawAll);
                if (stackedBSel) stackedBSel.addEventListener('change', drawAll);
                drawAll();
            }
            if (presentationMode) animateCounters();
        }

        // Unified Tracker: loader and renderer
        function loadUnifiedTracker(opts) {
            const container = document.createElement('div');
            container.id = 'unifiedTrackerPanel';
            container.className = 'mt-8';
            container.innerHTML = `
              <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <h3 class="text-xl font-semibold text-gray-800">Unified Tracker</h3>
                    <button type="button" id="hideUnifiedTrackerBtn" class="text-xs px-2 py-1 border rounded text-gray-600 hover:bg-gray-50">Hide</button>
                    <button type="button" id="filtersPanelBtn" class="text-xs px-2 py-1 border rounded text-gray-600 hover:bg-gray-50">Filters</button>
                  </div>
                </div>
                ${currentDashboard === 'executive' || currentDashboard === 'operations' ? `
                <div id="unifiedTrackerFilters" class="flex flex-wrap items-center gap-3 mb-3">
                  <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-600">Market</label>
                    <select id="marketSelect" class="text-sm border rounded px-2 py-1"></select>
                    <button id="setDefaultMarketBtn" class="text-xs px-2 py-1 bg-gray-100 border rounded">Set default</button>
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-600">Branch</label>
                    <select id="branchSelect" class="text-sm border rounded px-2 py-1"><option value="">All</option></select>
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-600">Colleague</label>
                    <select id="colleagueSelect" class="text-sm border rounded px-2 py-1"><option value="">All</option></select>
                    <select id="colleagueRoleSelect" class="text-sm border rounded px-2 py-1">
                      <option value="">All Roles</option>
                      <option value="Ops">Ops</option>
                      <option value="Branch Managers">Branch Managers</option>
                      <option value="Sales">Sales</option>
                    </select>
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-600">Search</label>
                    <input id="trackerSearch" type="search" class="text-sm border rounded px-2 py-1" placeholder="Customer or address" />
                  </div>
                </div>
                ` : ''}
                <div id="activeFilters" class="flex flex-wrap gap-2 mb-2"></div>
                <div id="unifiedTrackerTable"></div>
                ${currentDashboard === 'operations' ? `<div class="mt-6" id="unifiedKanbanBoard"></div>` : ''}
              </div>
            `;
            const root = document.getElementById('dashboardContent');
            if (root) root.appendChild(container);

            const loadData = function(rows){ 
              window._unifiedRows = rows || [];
              renderActiveFilters();
              renderUnifiedTracker(window._unifiedRows);
              if (currentDashboard === 'operations') renderMiniKanban(window._unifiedRows);
              try { updateQuickActionsCounts(); } catch (e) {}
            };
            // Hook up Hide action and respect dashboard visibility prefs
            const hideBtn = container.querySelector('#hideUnifiedTrackerBtn');
            if (hideBtn) {
              hideBtn.addEventListener('click', () => {
                const prefs = loadDashboardPrefs();
                prefs.unifiedTrackerVisible = false;
                saveDashboardPrefs(prefs);
                applyDashboardVisibility();
              });
            }
            // Wire Filters button to left slide-out (fallback scroll into view)
            const filtersBtn = container.querySelector('#filtersPanelBtn');
            if (filtersBtn) {
              const openFilters = function(){
                const id = 'unifiedTrackerFilters';
                if (window.SlideOutPanel && typeof SlideOutPanel.openFromElement === 'function') {
                  SlideOutPanel.openFromElement(id, { title: 'Filters', position: 'left' });
                } else {
                  const el = document.getElementById(id);
                  if (el) { try { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(_) {} }
                }
              };
              if (window.EventRegistry && typeof EventRegistry.addEventListener === 'function') {
                EventRegistry.addEventListener(filtersBtn, 'click', openFilters);
              } else {
                filtersBtn.addEventListener('click', openFilters);
              }
            }
            // Apply visibility on insert
            applyDashboardVisibility();
            if (!hasAppsScript()) {
                // Local preview mock
                const mock = [
                  { id:'001', branch:'Branch A', customer:'ABC Company', serviceAddress:'123 Main St', serviceDescription:'Pest Control', annualValue:1800, status:'Sold', startPacketSent:false, dateInstallScheduled:'', installComplete:false, logBookNeeded:true, materialsOrdered:false, operationsManager:'Jane Doe', assignedSpecialist:'Mike Wilson', nextActions:['Send Start Packet','Order Materials','Prepare Log Book','Schedule Install'] },
                  { id:'002', branch:'Branch B', customer:'XYZ Corp', serviceAddress:'456 Oak Ave', serviceDescription:'Termite', annualValue:2400, status:'Sold', startPacketSent:true, dateInstallScheduled:'02/15/2024', installComplete:false, logBookNeeded:false, materialsOrdered:true, operationsManager:'Tom Davis', assignedSpecialist:'Lisa Garcia', nextActions:['Perform Install'] }
                ];
                // Mock markets/branches for local preview
                const ms = document.getElementById('marketSelect');
                const bs = document.getElementById('branchSelect');
                const cs = document.getElementById('colleagueSelect');
                const crs = document.getElementById('colleagueRoleSelect');
                if (ms) { ms.innerHTML = `<option value="">All</option><option>Midwest</option><option>Texas</option>`; ms.value = (opts && opts.market) ? opts.market : ''; ms.onchange = function(){ if (bs) { bs.innerHTML = `<option value="">All</option><option>Branch A</option><option>Branch B</option>`; } loadData(mock); }; }
                if (bs) { bs.onchange = function(){ loadData(mock); }; }
                // Mock colleagues with roles
                window._colleagues = [
                  { name:'Jane Doe', role:'Ops', branch:'Branch A' },
                  { name:'Tom Davis', role:'Ops', branch:'Branch B' },
                  { name:'Mike Wilson', role:'Ops', branch:'Branch A' },
                  { name:'Lisa Garcia', role:'Ops', branch:'Branch B' },
                  { name:'Branch Manager A', role:'Branch Manager', branch:'Branch A' },
                  { name:'Sales User', role:'Sales', branch:'Branch A' }
                ];
                const updateColleagueOptions = function(group){
                  const list = (window._colleagues||[]).filter(function(u){
                    if (!group) return true;
                    if (group === 'Ops') return u.role === 'Ops' || u.role === 'Technician' || u.role === 'Specialist';
                    if (group === 'Branch Managers') return u.role === 'Branch Manager' || u.role === 'Branch';
                    if (group === 'Sales') return u.role === 'Sales';
                    return true;
                  });
                  const opts = ['<option value="">All</option>'].concat(list.map(function(u){ return `<option>${escapeHtml(u.name)}</option>`; }));
                  if (cs) cs.innerHTML = opts.join('');
                };
                updateColleagueOptions('');
                if (cs) { cs.onchange = function(){ loadData(mock); }; }
                if (crs) { crs.onchange = function(){ updateColleagueOptions(crs.value || ''); loadData(mock); }; }
                const search = document.getElementById('trackerSearch');
                if (search) { search.addEventListener('input', function(){ renderActiveFilters(); renderUnifiedTracker(window._unifiedRows); }); }
                window._technicians = [ {email:'mike@brancha.com',name:'Mike Wilson',branch:'Branch A'}, {email:'lisa@branchb.com',name:'Lisa Garcia',branch:'Branch B'} ];
                loadData(mock);
                return;
            }
            // Populate market dropdown if present
            const ms = document.getElementById('marketSelect');
            if (ms) {
              google.script.run
                .withSuccessHandler(function(markets){
                  const optsHtml = ['<option value="">All</option>'].concat((markets||[]).map(m => `<option>${escapeHtml(m)}</option>`)).join('');
                  ms.innerHTML = optsHtml;
                  // Prefer user defaultMarket, else provided opts.market
                  google.script.run
                    .withSuccessHandler(function(prefs){
                      const def = prefs && prefs.defaultMarket ? prefs.defaultMarket : (opts && opts.market ? opts.market : '');
                      if (def) ms.value = def;
                      const bs = document.getElementById('branchSelect');
                      const cs = document.getElementById('colleagueSelect');
                      const crs = document.getElementById('colleagueRoleSelect');
                      const setDefaultBtn = document.getElementById('setDefaultMarketBtn');
                      const refreshWithFilters = function(){
                        const m = ms.value || '';
                        const b = bs ? (bs.value || '') : '';
                        const c = cs ? (cs.value || '') : '';
                        const params = {};
                        if (m) params.market = m;
                        if (b) params.branch = b;
                        if (c) params.colleague = c;
                        google.script.run
                          .withSuccessHandler(loadData)
                          .withFailureHandler(function(err){ console.error('getUnifiedTrackerView failed:', err); loadData([]); })
                          .getUnifiedTrackerView(params);
                        renderActiveFilters();
                      };
                      ms.onchange = function(){
                        const m = ms.value || '';
                        if (bs) {
                          if (m) {
                            google.script.run
                              .withSuccessHandler(function(branches){
                                bs.innerHTML = ['<option value="">All</option>'].concat((branches||[]).map(b => `<option>${escapeHtml(b)}</option>`)).join('');
                                bs.value = '';
                                refreshWithFilters();
                              })
                              .withFailureHandler(function(){ bs.innerHTML = '<option value="">All</option>'; bs.value=''; refreshWithFilters(); })
                              .getBranchesForMarket(m);
                          } else {
                            bs.innerHTML = '<option value="">All</option>';
                            bs.value = '';
                            refreshWithFilters();
                          }
                        } else {
                          refreshWithFilters();
                        }
                      };
                      if (bs) {
                        const m = ms.value || '';
                        if (m) {
                          google.script.run
                            .withSuccessHandler(function(branches){
                              bs.innerHTML = ['<option value="">All</option>'].concat((branches||[]).map(b => `<option>${escapeHtml(b)}</option>`)).join('');
                              bs.onchange = refreshWithFilters;
                              bs.value = '';
                              refreshWithFilters();
                            })
                            .withFailureHandler(function(){ bs.innerHTML = '<option value="">All</option>'; bs.onchange = refreshWithFilters; refreshWithFilters(); })
                            .getBranchesForMarket(m);
                        } else {
                          bs.innerHTML = '<option value="">All</option>';
                          bs.onchange = refreshWithFilters;
                          refreshWithFilters();
                        }
                        if (cs) {
                          google.script.run
                            .withSuccessHandler(function(list){
                              window._colleagues = list || [];
                              const updateColleagueOptions = function(group){
                                const filtered = (window._colleagues||[]).filter(function(u){
                                  if (!group) return true;
                                  if (group === 'Ops') return u.role === 'Ops' || u.role === 'Technician' || u.role === 'Specialist';
                                  if (group === 'Branch Managers') return u.role === 'Branch Manager' || u.role === 'Branch';
                                  if (group === 'Sales') return u.role === 'Sales';
                                  return true;
                                });
                                const opts = ['<option value="">All</option>'].concat(filtered.map(u => `<option>${escapeHtml(u.name)}</option>`));
                                cs.innerHTML = opts.join('');
                              };
                              updateColleagueOptions('');
                              cs.onchange = refreshWithFilters;
                              if (crs) {
                                crs.onchange = function(){ updateColleagueOptions(crs.value || ''); refreshWithFilters(); };
                              }
                            })
                            .withFailureHandler(function(err){ console.warn('getColleagues failed:', err); cs.innerHTML = '<option value="">All</option>'; cs.onchange = refreshWithFilters; })
                            .getColleagues();
                        }
                        const search = document.getElementById('trackerSearch');
                        if (search) { search.addEventListener('input', function(){ renderActiveFilters(); renderUnifiedTracker(window._unifiedRows); }); }
                      } else {
                        refreshWithFilters();
                      }
                      if (setDefaultBtn) {
                        setDefaultBtn.onclick = function(){
                          const m = ms.value || '';
                          if (!m) { alert('Select a market to set as default'); return; }
                          google.script.run
                            .withSuccessHandler(function(){ toast('Default market saved'); })
                            .withFailureHandler(function(err){ console.error('saveUserPreference failed:', err); alert('Could not save preference'); })
                            .saveUserPreference('defaultMarket', m);
                        };
                      }
                    })
                    .withFailureHandler(function(){
                      google.script.run
                        .withSuccessHandler(loadData)
                        .withFailureHandler(function(err){ console.error('getUnifiedTrackerView failed:', err); loadData([]); })
                        .getUnifiedTrackerView(opts || {});
                    })
                    .getUserPreferences();
                })
                .withFailureHandler(function(err){ console.warn('getMarkets failed:', err); ms.innerHTML = `<option value="">All</option>`; })
                .getMarkets();
              // Preload technicians for inline assignment
              google.script.run
                .withSuccessHandler(function(list){ window._technicians = list || []; })
                .withFailureHandler(function(err){ console.warn('getTechnicians failed:', err); window._technicians = []; })
                .getTechnicians();
            }
            google.script.run
              .withSuccessHandler(loadData)
              .withFailureHandler(function(err){ console.error('getUnifiedTrackerView failed:', err); loadData([]); })
              .getUnifiedTrackerView(opts || {});
        }

        function renderUnifiedTracker(rows) {
            const el = document.getElementById('unifiedTrackerTable');
            if (!el) return;
            // Client-side search filter
            const q = (document.getElementById('trackerSearch')?.value || '').trim().toLowerCase();
            const filtered = q ? (rows||[]).filter(function(r){
              const c = String(r.customer || '').toLowerCase();
              const a = String(r.serviceAddress || '').toLowerCase();
              return c.includes(q) || a.includes(q);
            }) : (rows || []);
            if (!filtered.length) { el.innerHTML = '<p class="text-gray-500">No tracker entries found.</p>'; return; }
            const header = `
              <div class="grid grid-cols-12 gap-2 px-2 py-2 border-b text-xs font-semibold text-gray-500">
                <div class="col-span-2">Customer</div>
                <div class="col-span-2">Service</div>
                <div class="col-span-1">Branch</div>
                <div class="col-span-1">Annual</div>
                <div class="col-span-2">Status</div>
                <div class="col-span-2">Next Actions</div>
                <div class="col-span-2">Quick Ops / Assign</div>
              </div>`;
            const rowsHtml = filtered.map(r => {
              const actions = (r.nextActions || []).map(a => `<button class=\"inline-block px-2 py-1 text-xs rounded mr-1 ${getActionClass(a)}\" onclick=\"openRowLogicModal('${r.id}', '${escapeHtml(a)}')\"><span class=\"mr-1\">${getActionIcon(a)}</span>${escapeHtml(a)}</button>`).join('');
              const techOptions = (window._technicians||[]).map(t => `<option value=\"${escapeHtml(t.email)}\">${escapeHtml(t.name)} (${escapeHtml(t.branch)})</option>`).join('');
              const techSelect = `<select class=\"text-xs border rounded px-2 py-1\" onchange=\"onTrackerAssignSpecialist('${r.id}', this.value)\"><option value=\"\">Assign Specialist</option>${techOptions}</select>`;
              const omInputId = `omInput-${r.id}`;
              return `
                <div class="grid grid-cols-12 gap-2 items-center px-2 py-2 border-b text-sm">
                  <div class="col-span-2">
                    <div class="font-medium">${escapeHtml(r.customer || '')}</div>
                    <div class="text-xs text-gray-500">${escapeHtml(r.serviceAddress || '')}</div>
                  </div>
                  <div class="col-span-2">${escapeHtml(r.serviceDescription || '')}</div>
                  <div class="col-span-1">${escapeHtml(r.branch || '')}</div>
                  <div class="col-span-1">$${Number(r.annualValue||0).toLocaleString()}</div>
                  <div class="col-span-2">
                    <div>${escapeHtml(r.status||'')}</div>
                    <div class="text-xs text-gray-500">Packet: ${r.startPacketSent?'Sent':'Pending'} Â· Install: ${r.dateInstallScheduled?escapeHtml(r.dateInstallScheduled):'â€”'}</div>
                  </div>
                  <div class="col-span-2">${actions}</div>
                  <div class="col-span-2 flex flex-wrap gap-2 items-center">
                    <button class="px-3 py-1 bg-brand text-white rounded" onclick="onTrackerSendPacket('${r.id}')">Packet</button>
                    <button class="px-3 py-1 bg-blue-600 text-white rounded" onclick="onTrackerScheduleInstall('${r.id}')">Schedule</button>
                    <button class="px-3 py-1 bg-gray-700 text-white rounded" onclick="onTrackerOrderMaterials('${r.id}')">Materials</button>
                    ${techSelect}
                    <input id="${omInputId}" class="text-xs border rounded px-2 py-1" placeholder="${escapeHtml(r.operationsManager||'Set OM')}" />
                    <button class="text-xs px-2 py-1 bg-gray-100 border rounded" onclick="onTrackerSetOM('${r.id}', '${omInputId}')">Save OM</button>
                  </div>
                </div>`;
            }).join('');
            el.innerHTML = header + rowsHtml;
            // Update Actions menu badges with visible counts
            try {
              const actionsCount = filtered.reduce((sum, r) => sum + ((r.nextActions||[]).length), 0);
              updateDisplayBadges(filtered.length, actionsCount);
            } catch (e) { /* noop */ }
        }

        function renderActiveFilters(){
            const el = document.getElementById('activeFilters');
            if (!el) return;
            const ms = document.getElementById('marketSelect');
            const bs = document.getElementById('branchSelect');
            const cs = document.getElementById('colleagueSelect');
            const crs = document.getElementById('colleagueRoleSelect');
            const search = document.getElementById('trackerSearch');
            const chips = [];
            const addChip = function(label, value, clear){
              if (!value) return;
              chips.push(`<span class=\"inline-flex items-center gap-1 px-2 py-1 text-xs rounded-full bg-gray-100 border\">${escapeHtml(label)}: ${escapeHtml(value)} <button class=\"text-gray-500\" onclick=\"(${clear})()\">Ã—</button></span>`);
            };
            addChip('Market', ms?.value || '', function(){ const m=document.getElementById('marketSelect'); if(m){ m.value=''; m.dispatchEvent(new Event('change')); } });
            addChip('Branch', bs?.value || '', function(){ const b=document.getElementById('branchSelect'); if(b){ b.value=''; b.dispatchEvent(new Event('change')); } });
            addChip('Colleague', cs?.value || '', function(){ const c=document.getElementById('colleagueSelect'); if(c){ c.value=''; c.dispatchEvent(new Event('change')); } });
            addChip('Role', crs?.value || '', function(){ const r=document.getElementById('colleagueRoleSelect'); if(r){ r.value=''; r.dispatchEvent(new Event('change')); } });
            addChip('Search', search?.value || '', function(){ const s=document.getElementById('trackerSearch'); if(s){ s.value=''; renderActiveFilters(); renderUnifiedTracker(window._unifiedRows); } });
            el.innerHTML = chips.join('');
        }

        function onTrackerSendPacket(id) {
            if (!id) return;
            if (!hasAppsScript()) { alert('Local: would send start packet for '+id); return; }
            // Fetch latest unified view for the single item to build packet
            google.script.run
              .withSuccessHandler(function(rows){
                const r = (rows||[]).find(x => String(x.id) === String(id));
                if (!r) { alert('Entry not found'); return; }
                const e = {
                  saleCustomer: r.customer,
                  salePocEmail: '',
                  saleAnnualValue: r.annualValue,
                  saleScope: r.serviceDescription,
                  operationsManager: r.operationsManager,
                  assignedSpecialist: r.assignedSpecialist,
                  logBookNeeded: r.logBookNeeded ? 'Yes' : 'No'
                };
                google.script.run
                  .withSuccessHandler(function(){
                    google.script.run.updateTrackerEntry(id, { StartPacket_Sent: true });
                    toast('Start packet sent');
                    refreshDashboard();
                  })
                  .withFailureHandler(function(err){ console.error('generateStartPacketFromSales failed:', err); alert('Error sending packet'); })
                  .generateStartPacketFromSales(e);
              })
              .withFailureHandler(function(err){ console.error('getUnifiedTrackerView failed:', err); })
              .getUnifiedTrackerView({});
        }

        function onTrackerScheduleInstall(id) {
            const dateStr = prompt('Enter install date (MM/DD/YYYY)');
            if (!dateStr) return;
            if (!hasAppsScript()) { alert('Local: would schedule install '+dateStr+' for '+id); return; }
            google.script.run
              .withSuccessHandler(function(){ toast('Install scheduled'); refreshDashboard(); })
              .withFailureHandler(function(err){ console.error('updateTrackerEntry failed:', err); alert('Error scheduling install'); })
              .updateTrackerEntry(id, { Date_Install_Scheduled: dateStr });
        }

        function onTrackerOrderMaterials(id) {
            if (!id) return;
            if (!hasAppsScript()) { alert('Local: would mark materials ordered for '+id); return; }
            google.script.run
              .withSuccessHandler(function(){ toast('Materials marked as ordered'); refreshDashboard(); })
              .withFailureHandler(function(err){ console.error('updateTrackerEntry failed:', err); alert('Error updating materials'); })
              .updateTrackerEntry(id, { Materials_Ordered: true });
        }

        function onTrackerAssignSpecialist(id, email) {
            if (!id || !email) return;
            if (!hasAppsScript()) { alert('Local: would assign '+email+' to '+id); return; }
            google.script.run
              .withSuccessHandler(function(){ toast('Specialist assigned'); refreshDashboard(); })
              .withFailureHandler(function(err){ console.error('assignTechnician failed:', err); alert('Error assigning specialist'); })
              .assignTechnician(id, email);
        }

        function onTrackerSetOM(id, inputId) {
            const el = document.getElementById(inputId);
            if (!id || !el) return;
            const val = String(el.value || '').trim();
            if (!val) { alert('Enter an Operations Manager'); return; }
            if (!hasAppsScript()) { alert('Local: would set OM '+val+' for '+id); return; }
            google.script.run
              .withSuccessHandler(function(){ toast('OM updated'); refreshDashboard(); })
              .withFailureHandler(function(err){ console.error('updateTrackerEntry failed:', err); alert('Error updating OM'); })
              .updateTrackerEntry(id, { Operations_Manager: val });
        }

        // Mini Kanban for Ops: shows work-in-progress by stage
        function renderMiniKanban(rows) {
            const el = document.getElementById('unifiedKanbanBoard');
            if (!el) return;
            const groups = {
              packet: [], // Sold, packet not sent
              materials: [], // Materials not ordered
              schedule: [], // Packet sent, not scheduled
              inprogress: [], // Scheduled, not complete
              complete: [] // Install complete
            };
            (rows||[]).forEach(r => {
              if (r.installComplete) { groups.complete.push(r); return; }
              if (r.dateInstallScheduled) { groups.inprogress.push(r); return; }
              if (r.startPacketSent) { groups.schedule.push(r); return; }
              if (!r.materialsOrdered) { groups.materials.push(r); return; }
              if (String(r.status) === 'Sold' && !r.startPacketSent) { groups.packet.push(r); return; }
            });
            const col = (title, arr, color) => `
              <div class="bg-white rounded-lg border">
                <button class="w-full text-left px-3 py-2 border-b ${color} text-white text-sm font-semibold rounded-t-lg cursor-pointer" onclick="onKanbanHeaderClick('${title}')">${title} (${arr.length})</button>
                <div class="p-3 space-y-2 max-h-80 overflow-y-auto">
                  ${arr.map(r => `
                    <div class="p-2 bg-gray-50 rounded">
                      <div class="text-sm font-medium">${escapeHtml(r.customer||'')}</div>
                      <div class="text-xs text-gray-500">${escapeHtml(r.branch||'')} Â· $${Number(r.annualValue||0).toLocaleString()}</div>
                      <div class="mt-1 flex flex-wrap gap-1">${(r.nextActions||[]).slice(0,3).map(a => {
                        const cls = getActionClass(a);
                        return `<button class=\"px-2 py-0.5 text-xs rounded ${cls}\" onclick=\"openRowLogicModal('${r.id}', '${escapeHtml(a)}')\"><span class=\"mr-1\">${getActionIcon(a)}</span>${escapeHtml(a)}</button>`;
                      }).join('')}</div>
                    </div>
                  `).join('')}
                </div>
              </div>`;
            el.innerHTML = `
              <h4 class="text-lg font-semibold text-gray-800 mb-3">Work in Progress</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                ${col('Packet Pending', groups.packet, 'bg-red-600')}
                ${col('Materials Pending', groups.materials, 'bg-yellow-600')}
                ${col('Schedule', groups.schedule, 'bg-blue-600')}
                ${col('Install In Progress', groups.inprogress, 'bg-indigo-600')}
                ${col('Completed', groups.complete, 'bg-green-600')}
              </div>`;
        }

        // Render Executive Dashboard
        function renderExecutiveDashboard(data) {
            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Hours Saved</h3>
                        <p class="text-3xl font-bold text-brand">${data.kpis.hoursSaved.toLocaleString()}</p>
                        <p class="text-sm text-green-600 mt-1">â†‘ 18% this quarter</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Dollars Saved</h3>
                        <p class="text-3xl font-bold text-green-600">$${parseFloat(data.kpis.dollarsSaved).toLocaleString()}</p>
                        <p class="text-sm text-green-600 mt-1">â†‘ 22% this quarter</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Adoption Rate</h3>
                        <p class="text-3xl font-bold text-rentokil-blue">${data.kpis.adoptionRate}%</p>
                        <p class="text-sm text-green-600 mt-1">â†‘ 8% this quarter</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">ROI</h3>
                        <p class="text-3xl font-bold text-green-600">${data.kpis.roiPercentage}%</p>
                        <p class="text-sm text-green-600 mt-1">Exceeding target</p>
                    </div>
                </div>
                ${renderRolloutOverviewMini()}
                ${renderAiAssistantCard()}
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">3-Month Forecast</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Projected Savings</span>
                                <span class="font-bold text-green-600">$${parseFloat(data.forecast.threeMonth.savings).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Adoption Target</span>
                                <span class="font-bold text-brand">${data.forecast.threeMonth.adoption}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">6-Month Forecast</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Projected Savings</span>
                                <span class="font-bold text-green-600">$${parseFloat(data.forecast.sixMonth.savings).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Adoption Target</span>
                                <span class="font-bold text-brand">${data.forecast.sixMonth.adoption}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">12-Month Forecast</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Projected Savings</span>
                                <span class="font-bold text-green-600">$${parseFloat(data.forecast.twelveMonth.savings).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Adoption Target</span>
                                <span class="font-bold text-brand">${data.forecast.twelveMonth.adoption}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Automation Coverage</h3>
                        <div id="automationChart" class="w-full h-64"></div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Audit Log</h3>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${data.auditLog.slice(0, 10).map(log => `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded text-sm">
                                    <div>
                                        <p class="font-medium text-gray-800">${log.action}</p>
                                        <p class="text-gray-600">${log.userEmail}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-gray-500">${new Date(log.timestamp).toLocaleDateString()}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('dashboardContent').innerHTML = content;
            // Add unified tracker overview for leadership/market director
            // Prefer user defaultMarket from Preferences; fallback to branchâ†’market mapping
            if (hasAppsScript()) {
              google.script.run
                .withSuccessHandler(function(prefs){
                  const def = prefs && prefs.defaultMarket ? prefs.defaultMarket : '';
                  if (def) { loadUnifiedTracker({ market: def }); }
                  else {
                    google.script.run
                      .withSuccessHandler(function(market){ loadUnifiedTracker(market ? { market } : {}); })
                      .withFailureHandler(function(){ loadUnifiedTracker(); })
                      .getMarketForBranch(currentUser && currentUser.branch ? currentUser.branch : '');
                  }
                })
                .withFailureHandler(function(){ loadUnifiedTracker(); })
                .getUserPreferences();
            } else {
              loadUnifiedTracker();
            }
            
            // Draw automation chart
            drawAutomationChart(data.automationCoverage);
            
            if (presentationMode) {
                animateCounters();
            }
        }

        // Chart functions
        function getBrandColorHex() {
            const v = getComputedStyle(document.documentElement).getPropertyValue('--brand-color');
            const hex = (v || '').toString().trim();
            // Basic validation: hex starts with '#'
            return hex && hex.startsWith('#') ? hex : '#334E68';
        }
        function drawPerformanceCharts(charts) {
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(function() {
                const isDark = document.documentElement.classList.contains('theme-dark') || document.body.classList.contains('theme-dark');
                const bgColor = isDark ? '#0f172a' : '#ffffff';
                const textColor = isDark ? '#e5e7eb' : '#374151';
                const gridColor = isDark ? '#334155' : '#e5e7eb';
                const brand = getBrandColorHex();
                // Seven day chart
                const sevenDayData = new google.visualization.DataTable();
                sevenDayData.addColumn('string', 'Day');
                sevenDayData.addColumn('number', 'Proposals');
                sevenDayData.addColumn('number', 'Sold');
                sevenDayData.addRows([
                    ['Day 1', 12, 8],
                    ['Day 2', 15, 10],
                    ['Day 3', 18, 12],
                    ['Day 4', 14, 9],
                    ['Day 5', 20, 15],
                    ['Day 6', 16, 11],
                    ['Day 7', 22, 16]
                ]);
                
                const sevenDayOptions = {
                    title: '7-Day Performance Trend',
                    backgroundColor: bgColor,
                    chartArea: { backgroundColor: 'transparent' },
                    titleTextStyle: { color: textColor, fontSize: 14 },
                    curveType: 'function',
                    legend: { position: 'bottom', textStyle: { color: textColor } },
                    hAxis: { textStyle: { color: textColor }, gridlines: { color: gridColor }, baselineColor: gridColor },
                    vAxis: { textStyle: { color: textColor }, gridlines: { color: gridColor }, baselineColor: gridColor },
                    colors: [brand, '#4a6b2d']
                };
                
                const sevenDayChart = new google.visualization.LineChart(document.getElementById('sevenDayChart'));
                sevenDayChart.draw(sevenDayData, sevenDayOptions);
                
                // Thirty day chart
                const thirtyDayData = new google.visualization.DataTable();
                thirtyDayData.addColumn('string', 'Week');
                thirtyDayData.addColumn('number', 'Proposals');
                thirtyDayData.addColumn('number', 'Sold');
                thirtyDayData.addRows([
                    ['Week 1', 85, 62],
                    ['Week 2', 92, 68],
                    ['Week 3', 78, 55],
                    ['Week 4', 105, 78]
                ]);
                
                const thirtyDayOptions = {
                    title: '30-Day Performance Summary',
                    backgroundColor: bgColor,
                    chartArea: { backgroundColor: 'transparent' },
                    titleTextStyle: { color: textColor, fontSize: 14 },
                    legend: { position: 'bottom', textStyle: { color: textColor } },
                    hAxis: { textStyle: { color: textColor }, gridlines: { color: gridColor }, baselineColor: gridColor },
                    vAxis: { textStyle: { color: textColor }, gridlines: { color: gridColor }, baselineColor: gridColor },
                    colors: [brand, '#4a6b2d']
                };
                
                const thirtyDayChart = new google.visualization.ColumnChart(document.getElementById('thirtyDayChart'));
                thirtyDayChart.draw(thirtyDayData, thirtyDayOptions);
            });
        }

        function getMetricLabel(key) {
            const map = {
                tapLeads: 'TAP Leads',
                inspPrp: 'INSP PRP',
                lobsPrp: 'LOBs PRP',
                lobsSold: 'LOBs Sold',
                dollarsSld: 'Dollars SLD',
                nextDayConf: 'Next Day CONF',
                pcNoTcConversions: 'PC NO TC Conversions',
                nextDayApps: 'Next Day Apps'
            };
            return map[key] || key;
        }

        function drawSelectedCadenceCharts(timeseries) {
            // Fallback mock timeseries if none provided (local preview)
            if (!timeseries || !Array.isArray(timeseries.labels)) {
                const days = Array.from({ length: 14 }).map((_, i) => {
                    const d = new Date(Date.now() - (13 - i) * 86400000);
                    return `${d.getMonth()+1}/${d.getDate()}`;
                });
                timeseries = {
                    labels: days,
                    data: {
                        tapLeads: days.map((_, i) => 10 + (i % 5)),
                        inspPrp: days.map((_, i) => 8 + ((i*2) % 6)),
                        lobsPrp: days.map((_, i) => 6 + ((i*3) % 5)),
                        lobsSold: days.map((_, i) => 4 + ((i*2) % 4)),
                        dollarsSld: days.map((_, i) => 500 + i * 25),
                        nextDayConf: days.map((_, i) => 7 + ((i*3) % 7)),
                        pcNoTcConversions: days.map((_, i) => 2 + (i % 3)),
                        nextDayApps: days.map((_, i) => 3 + ((i*2) % 4))
                    }
                };
            }

            const trendSel = document.getElementById('trendMetricSelect');
            const stackedASel = document.getElementById('stackedMetricASelect');
            const stackedBSel = document.getElementById('stackedMetricBSelect');
            const trendKey = trendSel ? trendSel.value : 'nextDayConf';
            const aKey = stackedASel ? stackedASel.value : 'lobsPrp';
            const bKey = stackedBSel ? stackedBSel.value : 'lobsSold';

            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(function() {
                const brand = getBrandColorHex();
                const isDark = document.documentElement.classList.contains('theme-dark') || document.body.classList.contains('theme-dark');
                const bgColor = isDark ? '#0f172a' : '#ffffff';
                const textColor = isDark ? '#e5e7eb' : '#374151';
                const gridColor = isDark ? '#334155' : '#e5e7eb';
                // Trend Line
                const lineData = new google.visualization.DataTable();
                lineData.addColumn('string', 'Day');
                lineData.addColumn('number', getMetricLabel(trendKey));
                const lineRows = timeseries.labels.map((d, i) => [d, Number(timeseries.data[trendKey]?.[i] || 0)]);
                lineData.addRows(lineRows);
                const lineOptions = {
                    title: `${getMetricLabel(trendKey)} Trend`,
                    curveType: 'function',
                    backgroundColor: bgColor,
                    chartArea: { backgroundColor: 'transparent' },
                    legend: { position: 'bottom', textStyle: { color: textColor } },
                    hAxis: { textStyle: { color: textColor }, gridlines: { color: gridColor }, baselineColor: gridColor },
                    vAxis: { textStyle: { color: textColor }, gridlines: { color: gridColor }, baselineColor: gridColor },
                    titleTextStyle: { color: textColor, fontSize: 14 },
                    colors: [brand]
                };
                const lineChart = new google.visualization.LineChart(document.getElementById('cadenceTrendChart'));
                lineChart.draw(lineData, lineOptions);

                // Stacked Comparison
                const stackedData = new google.visualization.DataTable();
                stackedData.addColumn('string', 'Day');
                stackedData.addColumn('number', getMetricLabel(aKey));
                stackedData.addColumn('number', getMetricLabel(bKey));
                const stackedRows = timeseries.labels.map((d, i) => [
                    d,
                    Number(timeseries.data[aKey]?.[i] || 0),
                    Number(timeseries.data[bKey]?.[i] || 0)
                ]);
                stackedData.addRows(stackedRows);
                const stackedOptions = {
                    title: `${getMetricLabel(aKey)} vs ${getMetricLabel(bKey)}`,
                    isStacked: true,
                    backgroundColor: bgColor,
                    chartArea: { backgroundColor: 'transparent' },
                    legend: { position: 'bottom', textStyle: { color: textColor } },
                    hAxis: { textStyle: { color: textColor }, gridlines: { color: gridColor }, baselineColor: gridColor },
                    vAxis: { textStyle: { color: textColor }, gridlines: { color: gridColor }, baselineColor: gridColor },
                    titleTextStyle: { color: textColor, fontSize: 14 },
                    colors: [brand, '#4a6b2d']
                };
                const stackedChart = new google.visualization.ColumnChart(document.getElementById('cadenceStackedChart'));
                stackedChart.draw(stackedData, stackedOptions);
            });
        }

        function drawAutomationChart(coverage) {
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(function() {
                const data = new google.visualization.DataTable();
                data.addColumn('string', 'Type');
                data.addColumn('number', 'Percentage');
                data.addRows([
                    ['Automated', coverage],
                    ['Manual', 100 - coverage]
                ]);
                const isDark = document.documentElement.classList.contains('theme-dark') || document.body.classList.contains('theme-dark');
                const bgColor = isDark ? '#0f172a' : '#ffffff';
                const textColor = isDark ? '#e5e7eb' : '#374151';
                const options = {
                    title: 'Automation Coverage',
                    pieHole: 0.4,
                    backgroundColor: bgColor,
                    chartArea: { backgroundColor: 'transparent' },
                    legend: { position: 'bottom', textStyle: { color: textColor } },
                    titleTextStyle: { color: textColor, fontSize: 14 },
                    pieSliceTextStyle: { color: textColor },
                    colors: ['#4a6b2d', '#d1d5db']
                };
                
                const chart = new google.visualization.PieChart(document.getElementById('automationChart'));
                chart.draw(data, options);
            });
        }

        // Utility functions
        function hasAppsScript() {
            return typeof google !== 'undefined' && google.script && google.script.run;
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return String(value)
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
        }

        function getStatusColor(status) {
            switch(status.toLowerCase()) {
                case 'closed': return 'bg-green-100 text-green-800';
                case 'proposal': return 'bg-blue-100 text-blue-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'dead': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Branch Manager KPI helpers and data providers
        async function loadEnvConfig() {
            try {
                const res = await fetch('/settings/env.json');
                if (!res.ok) throw new Error('env not found');
                return await res.json();
            } catch (_) {
                return { mode: 'demo', dataSources: { sheets: { enabled: false }, bigQuery: { enabled: false } } };
            }
        }

        async function loadThresholds() {
            try {
                const res = await fetch('/settings/thresholds.json');
                if (!res.ok) throw new Error('thresholds missing');
                return await res.json();
            } catch (_) {
                return {
                    winRate: { green: 0.6, yellow: 0.4 },
                    onTimePct: { green: 0.9, yellow: 0.8 },
                    callbackPct: { green: 0.05, yellow: 0.1 },
                    scanCompliancePct: { green: 0.95, yellow: 0.85 },
                    startPacketSlaPct: { green: 0.9, yellow: 0.8 }
                };
            }
        }

        function badgeColor(value, thresholds, higherIsBetter = true) {
            const t = thresholds || { green: 1, yellow: 0.5 };
            if (higherIsBetter) {
                if (value >= t.green) return 'green';
                if (value >= t.yellow) return 'yellow';
                return 'red';
            } else {
                if (value <= t.green) return 'green';
                if (value <= t.yellow) return 'yellow';
                return 'red';
            }
        }

        function pct(n, d) { return d === 0 ? 0 : (n / d); }
        function minutesLate(appt) {
            const sched = new Date(appt.ScheduledStart).getTime();
            const actual = new Date(appt.ActualStart).getTime();
            return Math.max(0, Math.round((actual - sched) / 60000));
        }
        function withinDays(dateA, dateB, days) {
            const a = new Date(dateA).getTime();
            const b = new Date(dateB).getTime();
            return Math.abs(a - b) <= days * 24 * 60 * 60 * 1000;
        }

        class JsonFixturesProvider {
            async loadUsers() { return (await (await fetch('/demo/data/users.json')).json()); }
            async loadOpportunities(from, to, branch) { return (await (await fetch('/demo/data/opportunities.json')).json()); }
            async loadActivities(from, to, branch) { return (await (await fetch('/demo/data/activities.json')).json()); }
            async loadAppointments(from, to, branch) { return (await (await fetch('/demo/data/appointments.json')).json()); }
            async loadWorkOrders(from, to, branch) { return (await (await fetch('/demo/data/work_orders.json')).json()); }
            async loadScans(from, to, branch) { return (await (await fetch('/demo/data/scans.json')).json()); }
            async loadStartPackets(from, to, branch) { return (await (await fetch('/demo/data/start_packets.json')).json()); }
            async loadLabor(from, to, branch) { return (await (await fetch('/demo/data/labor.json')).json()); }
        }

        async function aggregateBranchManagerKpi(provider, params) {
            const { branch, from, to } = params;
            const [users, opps, acts, appts, wos, scans, packets] = await Promise.all([
                provider.loadUsers(),
                provider.loadOpportunities(from, to, branch),
                provider.loadActivities(from, to, branch),
                provider.loadAppointments(from, to, branch),
                provider.loadWorkOrders(from, to, branch),
                provider.loadScans(from, to, branch),
                provider.loadStartPackets(from, to, branch)
            ]);
            const branchUsers = users.filter(u => u.Branch === branch && u.Active);
            const aeUsers = branchUsers.filter(u => u.Role === 'AE');
            const opsUsers = branchUsers.filter(u => u.Role === 'Ops');
            const techUsers = branchUsers.filter(u => u.Role === 'Tech');

            const won = opps.filter(o => o.ClosedWonAt);
            const lost = opps.filter(o => o.ClosedLostAt);
            const winRate = pct(won.length, won.length + lost.length);

            const completedAppts = appts.filter(a => a.Status === 'Completed');
            const onTimeNumerator = completedAppts.filter(a => minutesLate(a) <= 15).length;
            const onTimePct = pct(onTimeNumerator, completedAppts.length);

            const callbacks = wos.filter(w => w.IsCallback && withinDays(w.CallbackDate || w.OriginalServiceDate, w.OriginalServiceDate, 14));
            const callbackPct = pct(callbacks.length, wos.length);

            const expectedTotal = scans.reduce((sum, s) => sum + (s.ExpectedCount || 0), 0);
            const scannedTotal = scans.reduce((sum, s) => sum + (s.ScannedCount || 0), 0);
            const scanCompliancePct = pct(scannedTotal, expectedTotal);

            const packetDenom = packets.length;
            const packetGood = packets.filter(p => p.ApprovedAt && new Date(p.ApprovedAt) <= new Date(p.FirstServiceDate)).length;
            const startPacketSlaPct = pct(packetGood, packetDenom);

            return {
                source: 'demo',
                summary: [
                    { key: 'winRate', label: 'AE Win Rate', value: winRate, numerator: won.length, denominator: won.length + lost.length },
                    { key: 'onTimePct', label: 'Ops On-Time %', value: onTimePct, numerator: onTimeNumerator, denominator: completedAppts.length },
                    { key: 'callbackPct', label: 'Callback %', value: callbackPct, numerator: callbacks.length, denominator: wos.length },
                    { key: 'scanCompliancePct', label: 'Scan Compliance %', value: scanCompliancePct, numerator: scannedTotal, denominator: expectedTotal },
                    { key: 'startPacketSlaPct', label: 'Start Packet SLA %', value: startPacketSlaPct, numerator: packetGood, denominator: packetDenom }
                ],
                drilldowns: {
                    winRate: { rows: opps },
                    onTimePct: { rows: completedAppts.map(a => ({ ApptID: a.ApptID, ScheduledStart: a.ScheduledStart, ActualStart: a.ActualStart, MinutesLate: minutesLate(a) })) },
                    callbackPct: { rows: wos },
                    scanCompliancePct: { rows: scans },
                    startPacketSlaPct: { rows: packets }
                },
                users: { AE: aeUsers, Ops: opsUsers, Tech: techUsers }
            };
        }

        async function loadBranchManagerKpisUI() {
            const env = await loadEnvConfig();
            const thresholdsMap = await loadThresholds();
            const branch = document.getElementById('bm-branch')?.value || 'HOU';
            const from = document.getElementById('bm-from')?.value || new Date().toISOString().slice(0,10);
            const to = document.getElementById('bm-to')?.value || new Date().toISOString().slice(0,10);
            const onlyRed = document.getElementById('bm-only-red')?.checked || false;
            const params = { branch, from, to, onlyRed };
            let payload;
            const t0 = performance.now();
            try {
                if (hasAppsScript() && env.mode === 'prod') {
                    payload = await new Promise((resolve, reject) => {
                        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getBranchManagerKpi(params);
                    });
                } else {
                    const provider = new JsonFixturesProvider();
                    payload = await aggregateBranchManagerKpi(provider, params);
                }
            } catch (e) {
                console.warn('KPI load failed, falling back to fixtures', e);
                const provider = new JsonFixturesProvider();
                payload = await aggregateBranchManagerKpi(provider, params);
                payload.source = 'demo_fallback';
            }
            const t1 = performance.now();
            console.log(`BM KPI aggregation time: ${(t1 - t0).toFixed(1)}ms`, { source: payload.source });

            const summaryEl = document.getElementById('bm-summary');
            if (summaryEl) summaryEl.innerHTML = '';
            (payload.summary || []).forEach(item => {
                const thresholdsKey = item.key;
                const color = badgeColor(item.value, thresholdsMap[thresholdsKey], thresholdsKey !== 'callbackPct');
                if (onlyRed && color !== 'red') return;
                const badge = document.createElement('div');
                badge.className = `px-2 py-1 rounded text-white text-sm`;
                badge.style.background = color === 'green' ? '#164' : color === 'yellow' ? '#664' : '#641';
                const pctFmt = (item.value * 100).toFixed(0) + '%';
                badge.innerHTML = `<strong>${item.label}</strong>: ${pctFmt}`;
                badge.title = `${item.label}: ${item.numerator} / ${item.denominator} (${params.from} â†’ ${params.to})`;
                badge.style.cursor = 'pointer';
                badge.addEventListener('click', () => openBmDrilldown(item.key, item.label, payload));
                summaryEl?.appendChild(badge);
            });

            const colsEl = document.getElementById('bm-columns');
            if (colsEl) {
                colsEl.innerHTML = '';
                const columns = [
                    { title: 'AEs', list: payload.users?.AE || [] },
                    { title: 'Ops Managers', list: payload.users?.Ops || [] },
                    { title: 'Technicians', list: payload.users?.Tech || [] }
                ];
                columns.forEach(col => {
                    const card = document.createElement('div');
                    card.className = 'border rounded-lg p-3 bg-white';
                    card.innerHTML = `<div class=\"font-semibold mb-2\">${col.title}</div><div class=\"space-y-1\">${col.list.map(u => `<div>${u.Name}</div>`).join('')}</div>`;
                    colsEl.appendChild(card);
                });
            }
        }

        function openBmDrilldown(key, label, payload) {
            const modal = document.getElementById('bm-drilldown');
            const title = document.getElementById('bm-drill-title');
            const tooltip = document.getElementById('bm-tooltip');
            const table = document.getElementById('bm-table');
            const summaryItem = (payload.summary || []).find(s => s.key === key) || { numerator: 0, denominator: 0 };
            if (title) title.textContent = label;
            if (tooltip) tooltip.textContent = `Numerator: ${summaryItem.numerator}, Denominator: ${summaryItem.denominator}`;
            const rows = payload.drilldowns?.[key]?.rows || [];
            if (table) table.innerHTML = renderTable(rows);
            modal?.classList.remove('hidden');
            document.getElementById('bm-close')?.addEventListener('click', () => { modal?.classList.add('hidden'); }, { once: true });
            document.getElementById('bm-download')?.addEventListener('click', () => downloadCsv(rows, `${key}.csv`), { once: true });
        }

        function renderTable(rows) {
            if (!rows || rows.length === 0) return '<em>No rows</em>';
            const cols = Object.keys(rows[0]);
            const head = `<thead><tr>${cols.map(c => `<th class=\"text-left px-2 py-1\">${c}</th>`).join('')}</tr></thead>`;
            const body = `<tbody>${rows.map(r => `<tr>${cols.map(c => `<td class=\"px-2 py-1\">${escapeHtml(String(r[c] ?? ''))}</td>`).join('')}</tr>`).join('')}</tbody>`;
            return `${head}${body}`;
        }

        function downloadCsv(rows, filename) {
            if (!rows || rows.length === 0) return;
            const cols = Object.keys(rows[0]);
            const lines = [cols.join(',')].concat(rows.map(r => cols.map(c => JSON.stringify(r[c] ?? '')).join(',')));
            const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function checkCadenceStatus() {
            const cadenceBtn = document.getElementById('cadenceBtn');
            if (!hasAppsScript()) {
                if (cadenceBtn) {
                    cadenceBtn.classList.remove('pulse-red', 'bg-red-600');
                    cadenceBtn.classList.add('bg-brand');
                }
                return;
            }
            google.script.run
                .withSuccessHandler(function(isReady) {
                    if (!cadenceBtn) return;
                    if (!isReady) {
                        cadenceBtn.classList.add('pulse-red', 'bg-red-600');
                        cadenceBtn.classList.remove('bg-brand');
                    } else {
                        cadenceBtn.classList.remove('pulse-red', 'bg-red-600');
                        cadenceBtn.classList.add('bg-brand');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error checking cadence status:', error);
                })
                .isCadenceReady();
        }

        function generateCadenceReport() {
            const btn = document.getElementById('cadenceBtn');
            if (!btn) return;
            btn.disabled = true;
            btn.textContent = 'Generating...';
            
            if (!hasAppsScript()) {
                setTimeout(() => {
                    alert('Cadence report generated (local preview mock).');
                    btn.disabled = false;
                    btn.textContent = 'ðŸ“Š Generate Cadence';
                    if (window.applyIconToElement) window.applyIconToElement(btn, 'ðŸ“Š', 'Generate Cadence');
                    checkCadenceStatus();
                }, 600);
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    alert('Cadence report generated successfully!');
                    btn.disabled = false;
                    btn.textContent = 'ðŸ“Š Generate Cadence';
                    if (window.applyIconToElement) window.applyIconToElement(btn, 'ðŸ“Š', 'Generate Cadence');
                    checkCadenceStatus();
                })
                .withFailureHandler(function(error) {
                    alert('Error generating cadence report: ' + error.message);
                    btn.disabled = false;
                    btn.textContent = 'ðŸ“Š Generate Cadence';
                    if (window.applyIconToElement) window.applyIconToElement(btn, 'ðŸ“Š', 'Generate Cadence');
                })
                .generateCadenceReport();
        }

        function generateStartPacket() {
            // Check if we have a selected customer or need to prompt for one
            const customerName = prompt('Enter customer name for start packet:');
            if (!customerName) return;

            // Show loading state
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Generating...';
            button.disabled = true;

            if (!hasAppsScript()) {
                setTimeout(() => {
                    alert('Start packet generated (local preview mock).');
                    button.textContent = originalText;
                    button.disabled = false;
                    refreshDashboard();
                }, 800);
                return;
            }

            google.script.run
                .withSuccessHandler(function(response) {
                    alert('Start packet generated successfully! Check your email for the PDF.');
                    button.textContent = originalText;
                    button.disabled = false;
                    refreshDashboard();
                })
                .withFailureHandler(function(error) {
                    alert('Error generating start packet: ' + error.message);
                    button.textContent = originalText;
                    button.disabled = false;
                })
                .generateStartPacketFromSales(customerName);
        }

        // Quote PDF upload and parsing
        async function openQuoteUploadModal() {
            const modal = document.getElementById('quoteUploadModal');
            if (modal) modal.classList.remove('hidden');
            setModalDefaultSize('quoteUploadModal');
            enableModalDrag('quoteUploadModal');
            enableModalResize('quoteUploadModal');
            // Check parser availability and update UI
            const available = await ensurePdfJs();
            const statusEl = document.getElementById('quoteParseStatus');
            const fileInput = modal.querySelector('input[type="file"]');
            if (available) {
                if (statusEl) statusEl.textContent = 'Waiting for file...';
                if (fileInput) fileInput.disabled = false;
            } else {
                if (statusEl) statusEl.innerHTML = 'PDF parsing disabled. Add <code>/pdfjs/pdf.min.js</code> and <code>/pdfjs/pdf.worker.min.js</code> locally, then reopen.';
                if (fileInput) fileInput.disabled = true;
            }
        }

        function closeQuoteUploadModal() {
            const modal = document.getElementById('quoteUploadModal');
            if (modal) modal.classList.add('hidden');
            resetModalPosition('quoteUploadModal');
        }

        // Daily Sales Performance Form
        const AE_MAP = {
            'cody.lytle@prestox.com': 'Cody Lytle',
            'april.shane@prestox.com': 'April Wilton',
            'blair.sloat@rentokil-terminix.com': 'Blair Sloat',
            'aacevedo2@rentokil-terminix.com': 'Anthony Acevedo',
            'christopher.horner@rentokil-terminix.com': 'Chris Horner'
        };

        function updateAeSelectionFromEmail() {
            const emailEl = document.getElementById('dspEmail');
            const aeEl = document.getElementById('dspAeName');
            if (!emailEl || !aeEl) return;
            const email = (emailEl.value || '').trim().toLowerCase();
            const mapped = AE_MAP[email];
            if (mapped) {
                aeEl.value = mapped;
            }
        }

        function openDailyPerformanceForm() {
            const modal = document.getElementById('dailyPerformanceModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            setModalDefaultSize('dailyPerformanceModal');
            enableModalDrag('dailyPerformanceModal');
            enableModalResize('dailyPerformanceModal');
            // Prefill email from currentUser if available
            const emailEl = document.getElementById('dspEmail');
            if (emailEl && typeof currentUser !== 'undefined') {
                emailEl.value = currentUser.email || currentUser.name || '';
            }
            // Try to auto-select AE from email
            updateAeSelectionFromEmail();
        }

        function closeDailyPerformanceForm() {
            const modal = document.getElementById('dailyPerformanceModal');
            if (modal) modal.classList.add('hidden');
            resetModalPosition('dailyPerformanceModal');
        }

        function getNumberValue(id) {
            const el = document.getElementById(id);
            const v = el ? parseFloat(el.value) : 0;
            return isNaN(v) ? 0 : v;
        }

        // --- Branch Cadence Entry (Brad's metrics) ---
        function openBranchCadenceModal() {
            const modal = document.getElementById('branchCadenceModal');
            if (modal) modal.classList.remove('hidden');
            setModalDefaultSize('branchCadenceModal');
            enableModalDrag('branchCadenceModal');
            enableModalResize('branchCadenceModal');
        }

        function closeBranchCadenceModal() {
            const modal = document.getElementById('branchCadenceModal');
            if (modal) modal.classList.add('hidden');
            resetModalPosition('branchCadenceModal');
        }

        function valNum(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            const raw = (el.value || '').toString().trim();
            if (raw === '') return 0;
            const parsed = Number(raw.replace(/[^0-9.-]/g, ''));
            return Number.isFinite(parsed) ? parsed : 0;
        }

        // --- Cadence Import Helper ---
        function openCadenceImportModal() {
            const modal = document.getElementById('cadenceImportModal');
            if (modal) modal.classList.remove('hidden');
            setModalDefaultSize('cadenceImportModal');
            enableModalDrag('cadenceImportModal');
            enableModalResize('cadenceImportModal');
            const status = document.getElementById('cadenceImportStatus');
            if (status) status.textContent = '';
        }

        function closeCadenceImportModal() {
            const modal = document.getElementById('cadenceImportModal');
            if (modal) modal.classList.add('hidden');
            resetModalPosition('cadenceImportModal');
        }

        function normalizeMetricToken(tok) {
            const s = String(tok || '').trim();
            if (!s) return 0;
            const lower = s.toLowerCase();
            if (lower === 'yes') return 1;
            if (lower === 'no') return 0;
            const n = Number(s.replace(/[$,]/g, ''));
            return Number.isFinite(n) ? n : 0;
        }

        function importCadenceRows() {
            const ta = document.getElementById('cadenceImportText');
            const status = document.getElementById('cadenceImportStatus');
            if (!ta) return;
            const raw = ta.value || '';
            const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
            if (!lines.length) { alert('Paste rows first.'); return; }

            let imported = 0;
            const entries = [];
            for (const line of lines) {
                const cells = line.split(/\t+/);
                if (cells.length < 6) continue; // require at least base fields
                const branchName = (cells[2] || '').trim();
                if (!branchName || branchName.toLowerCase().includes('total')) continue; // skip totals
                const entry = {
                    region: (cells[0] || '').trim(),
                    code: (cells[1] || '').trim(),
                    branchName: branchName,
                    branchManager: (cells[3] || '').trim(),
                    phone: (cells[4] || '').trim(),
                    branch: branchName,
                    tapLeads: normalizeMetricToken(cells[5] || 0),
                    inspPrp: normalizeMetricToken(cells[6] || 0),
                    lobsPrp: normalizeMetricToken(cells[7] || 0),
                    lobsSold: normalizeMetricToken(cells[8] || 0),
                    dollarsSld: normalizeMetricToken(cells[9] || 0),
                    nextDayConf: normalizeMetricToken(cells[10] || 0),
                    pcNoTcConversions: normalizeMetricToken(cells[11] || 0),
                    nextDayApps: normalizeMetricToken(cells[12] || 0),
                    notes: ''
                };
                entries.push(entry);
            }

            if (!entries.length) { alert('No valid data rows found. Ensure tab-separated format.'); return; }

            const saveLocal = !hasAppsScript();
            if (saveLocal) {
                const list = JSON.parse(localStorage.getItem('cadenceDaily') || '[]');
                for (const e of entries) { list.push({ ...e, savedAt: new Date().toISOString() }); imported++; }
                localStorage.setItem('cadenceDaily', JSON.stringify(list));
                if (status) status.textContent = `Imported ${imported} rows locally.`;
                alert(`Imported ${imported} rows locally.`);
                return;
            }

            let completed = 0, failed = 0;
            entries.forEach(e => {
                try {
                    google.script.run
                        .withSuccessHandler(function(){ completed++; if (status) status.textContent = `Imported ${completed}/${entries.length} (failed ${failed}).`; })
                        .withFailureHandler(function(err){ console.error('Import row failed', err); failed++; if (status) status.textContent = `Imported ${completed}/${entries.length} (failed ${failed}).`; })
                        .saveCadenceDailyEntry(e);
                } catch (err) {
                    console.error('Import execution error', err);
                    failed++;
                }
            });
        }

        function submitBranchCadenceEntry() {
            const entry = {
                entryDate: (document.getElementById('cadEntryDate')?.value || '').trim(),
                region: (document.getElementById('cadRegion')?.value || '').trim(),
                code: (document.getElementById('cadCode')?.value || '').trim(),
                branchName: (document.getElementById('cadBranchName')?.value || '').trim(),
                branchManager: (document.getElementById('cadBranchManager')?.value || '').trim(),
                phone: (document.getElementById('cadPhone')?.value || '').trim(),
                pccInField: valNum('cadPccInField'),
                branch: (document.getElementById('cadBranch')?.value || '').trim(),
                tapGoal: valNum('cadTapGoal'),
                tapActual: valNum('cadTapActual'),
                coachingRides: valNum('cadCoachingRides'),
                tapFromCoaching: valNum('cadTapFromCoaching'),
                tapPartTmx70: valNum('cadTapPartTmx'),
                tapPartRna70: valNum('cadTapPartRna'),
                tapSold25Yoy: valNum('cadTapSoldYoy'),
                rawSalesNeed: valNum('cadRawSalesNeed'),
                rawSalesActual20Yoy: valNum('cadRawSalesActual'),
                revenueDailyGoalFcst18d: valNum('cadRevenueDailyGoal'),
                revenueScheduledTomorrow: valNum('cadRevenueScheduledTomorrow'),
                tmxMissedStopPct10: valNum('cadTmxMissedStopPct'),
                rnaMissedStopPct15: valNum('cadRnaMissedStopPct'),
                backlogTomorrow20: valNum('cadBacklogTomorrow'),
                repReqDailyGoal: valNum('cadRepReqDailyGoal'),
                dailyActualReqReviews: valNum('cadDailyActualReqReviews'),
                otPctStdHrsForecast: valNum('cadOtPctStdHrs'),
                initialsDate: (document.getElementById('cadInitialsDate')?.value || '').trim(),
                tapLeads: valNum('cadTapLeads'),
                inspPrp: valNum('cadInspPrp'),
                lobsPrp: valNum('cadLobsPrp'),
                lobsSold: valNum('cadLobsSold'),
                dollarsSld: valNum('cadDollarsSld'),
                nextDayConf: valNum('cadNextDayConf'),
                pcNoTcConversions: valNum('cadPcNoTcConversions'),
                nextDayApps: valNum('cadNextDayApps'),
                notes: (document.getElementById('cadNotes')?.value || '').trim(),
                submittedBy: typeof currentUser !== 'undefined' ? (currentUser.email || currentUser.name || '') : ''
            };

            if (!entry.branch) {
                alert('Please enter Branch.');
                return;
            }

            if (!hasAppsScript()) {
                const list = JSON.parse(localStorage.getItem('cadenceDaily') || '[]');
                list.push({ ...entry, savedAt: new Date().toISOString() });
                localStorage.setItem('cadenceDaily', JSON.stringify(list));
                alert('Saved locally (preview).');
                closeBranchCadenceModal();
                return;
            }

            try {
                google.script.run
                    .withSuccessHandler(function() {
                        alert('Cadence entry saved.');
                        closeBranchCadenceModal();
                    })
                    .withFailureHandler(function(err) {
                        alert('Error saving cadence entry: ' + (err && err.message ? err.message : err));
                    })
                    .saveCadenceDailyEntry(entry);
            } catch (e) {
                alert('Apps Script unavailable: ' + e.message);
            }
        }

        function submitDailyPerformanceForm(e) {
            e.preventDefault();
            const status = document.getElementById('dailyPerformanceStatus');
            const btn = document.getElementById('submitDailyPerformance');

            const entry = {
                timestamp: new Date().toISOString(),
                email: document.getElementById('dspEmail').value.trim(),
                aeName: document.getElementById('dspAeName').value,
                proposalsDelivered: getNumberValue('dspProposalsDelivered'),
                lobsIncludedCount: getNumberValue('dspLobsIncludedCount'),
                lobsSoldCount: getNumberValue('dspLobsSoldCount'),
                dollarsSold: getNumberValue('dspDollarsSold'),
                nextDayConf: getNumberValue('dspNextDayConf'),
                dollarsProposed: getNumberValue('dspDollarsProposed'),
                eventsFirstAppt: getNumberValue('dspEventsFirstAppt'),
                eventsSiteAssessment: getNumberValue('dspEventsSiteAssessment'),
                eventsProposals: getNumberValue('dspEventsProposals'),
                eventsInPerson: getNumberValue('dspEventsInPerson'),
                notes: (document.getElementById('dspNotes').value || '').trim()
            };

            if (!entry.email || !entry.aeName) {
                status.textContent = 'Please complete required fields (Email, AE Name).';
                return;
            }

            btn.disabled = true;
            status.textContent = 'Submitting...';

            if (!hasAppsScript()) {
                // Local preview: store in memory and confirm
                try {
                    const list = JSON.parse(localStorage.getItem('dailyPerformance') || '[]');
                    list.push(entry);
                    localStorage.setItem('dailyPerformance', JSON.stringify(list));
                    status.textContent = 'Saved locally (preview).';
                    btn.disabled = false;
                    setTimeout(() => closeDailyPerformanceForm(), 500);
                } catch (err) {
                    console.error('Local save error', err);
                    status.textContent = 'Failed to save locally.';
                    btn.disabled = false;
                }
                return;
            }

            google.script.run
                .withSuccessHandler(function() {
                    status.textContent = 'Submitted successfully.';
                    btn.disabled = false;
                    setTimeout(() => closeDailyPerformanceForm(), 500);
                })
                .withFailureHandler(function(err) {
                    console.error('saveDailySalesPerformance error', err);
                    status.textContent = 'Error submitting: ' + (err && err.message ? err.message : err);
                    btn.disabled = false;
                })
                .saveDailySalesPerformance(entry);
        }
        async function extractTextFromPDF(file) {
            try {
                if (!window['pdfjsLib']) {
                    const ok = await ensurePdfJs();
                    if (!ok) throw new Error('PDF.js not loaded');
                }
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let text = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const strings = content.items.map(it => it.str);
                    text += strings.join(' ') + '\n';
                }
                return text;
            } catch (e) {
                console.error('Failed to read PDF:', e);
                throw e;
            }
        }

        function parseQuoteText(text) {
            const find = (re) => {
                const m = text.match(re);
                return m ? m[1].trim() : '';
            };
            const currency = (s) => {
                const v = (s || '').replace(/[^0-9.]/g, '');
                return v ? parseFloat(v) : 0;
            };
            const parsed = {
                customer: find(/(?:Customer|Client|Account)[:\s]+(.+?)(?:\n|$)/i),
                serviceType: find(/(?:Service|Program)[:\s]+(.+?)(?:\n|$)/i),
                frequency: find(/(?:Frequency|Service Interval)[:\s]+(.+?)(?:\n|$)/i),
                initialFeeRaw: find(/(?:Initial|Setup)[^$]*\$?([\d,]+(?:\.\d{2})?)/i),
                monthlyFeeRaw: find(/(?:Monthly|Recurring)[^$]*\$?([\d,]+(?:\.\d{2})?)/i),
                startDate: find(/(?:Start Date|Service Start)[:\s]+([0-9/.-]+)/i),
                contactEmail: find(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i),
                contactPhone: find(/(\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})/),
            };
            parsed.initialFee = currency(parsed.initialFeeRaw);
            parsed.monthlyFee = currency(parsed.monthlyFeeRaw);
            parsed.annualValue = computeAnnualValue(parsed.monthlyFee, parsed.frequency);
            return parsed;
        }

        function computeAnnualValue(monthlyFee, frequency) {
            const mf = monthlyFee || 0;
            const f = (frequency || '').toLowerCase();
            if (f.includes('monthly')) return mf * 12;
            if (f.includes('weekly')) return mf * 52;
            if (f.includes('bi-week')) return mf * 26;
            if (f.includes('quarter')) return mf * 4;
            if (f.includes('semi')) return mf * 2;
            if (f.includes('annual')) return mf;
            return mf * 12; // default
        }

        async function handleQuoteFileSelected(input) {
            const file = input.files && input.files[0];
            if (!file) return;
            const statusEl = document.getElementById('quoteParseStatus');
            const resultEl = document.getElementById('quoteParsedResult');
            statusEl.textContent = 'Parsing PDF...';
            resultEl.textContent = '';
            try {
                const text = await extractTextFromPDF(file);
                const parsed = parseQuoteText(text);
                window.__lastParsedQuote = parsed;
                statusEl.textContent = 'PDF parsed successfully.';
                updateParsedQuoteUI(parsed);
            } catch (e) {
                statusEl.innerHTML = 'Failed to parse PDF. If running locally, install PDF.js under <code>/pdfjs/</code> and retry.';
                console.error(e);
            }
        }

        async function parseQuoteFromUrl(urlRaw) {
            const statusEl = document.getElementById('quoteParseStatus');
            const resultEl = document.getElementById('quoteParsedResult');
            const url = (urlRaw || '').trim();
            if (!url) {
                statusEl.textContent = 'Please enter a PDF URL.';
                return;
            }
            try {
                statusEl.textContent = 'Fetching PDF from URL...';
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const blob = await resp.blob();
                statusEl.textContent = 'Parsing PDF...';
                const text = await extractTextFromPDF(blob);
                const parsed = parseQuoteText(text);
                window.__lastParsedQuote = parsed;
                statusEl.textContent = 'PDF parsed successfully.';
                updateParsedQuoteUI(parsed);
            } catch (e) {
                statusEl.textContent = 'Failed to fetch/parse PDF from URL.';
                console.error(e);
            }
        }

        function updateParsedQuoteUI(parsed) {
            const resultEl = document.getElementById('quoteParsedResult');
            if (!resultEl) return;
            resultEl.innerHTML = `
                <div class="space-y-1 text-sm">
                    <div><span class="font-semibold">Customer:</span> ${parsed.customer || 'â€”'}</div>
                    <div><span class="font-semibold">Service Type:</span> ${parsed.serviceType || 'â€”'}</div>
                    <div><span class="font-semibold">Frequency:</span> ${parsed.frequency || 'â€”'}</div>
                    <div><span class="font-semibold">Initial Fee:</span> $${(parsed.initialFee || 0).toLocaleString()}</div>
                    <div><span class="font-semibold">Monthly Fee:</span> $${(parsed.monthlyFee || 0).toLocaleString()}</div>
                    <div><span class="font-semibold">Annual Value:</span> $${(parsed.annualValue || 0).toLocaleString()}</div>
                    <div><span class="font-semibold">Contact Email:</span> ${parsed.contactEmail || 'â€”'}</div>
                    <div><span class="font-semibold">Contact Phone:</span> ${parsed.contactPhone || 'â€”'}</div>
                </div>
            `;
        }

        function generateStartPacketFromParsed() {
            const parsed = window.__lastParsedQuote || {};
            const button = document.getElementById('generateStartPacketFromParsedBtn');
            if (!button) return;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Generating...';
            if (!hasAppsScript()) {
                setTimeout(() => {
                    alert('Start packet generated from parsed quote (local preview mock).');
                    button.textContent = originalText;
                    button.disabled = false;
                }, 800);
                return;
            }
            // Try a rich method first, then fallback to existing
            google.script.run
                .withSuccessHandler(function() {
                    alert('Start packet generated successfully!');
                    button.textContent = originalText;
                    button.disabled = false;
                })
                .withFailureHandler(function() {
                    google.script.run
                        .withSuccessHandler(function() {
                            alert('Start packet generated successfully (fallback).');
                            button.textContent = originalText;
                            button.disabled = false;
                        })
                        .withFailureHandler(function(err2) {
                            alert('Error generating start packet: ' + err2.message);
                            button.textContent = originalText;
                            button.disabled = false;
                        })
                        .generateStartPacketFromSales(parsed.customer || '');
                })
                .generateStartPacketFromQuote(parsed);
        }

function composeOnboardingEmail() {
  const p = window.__lastParsedQuote || {};
  const subject = `Onboarding: ${p.customer || 'New Customer'}`;
  const body = `Hello,\n\nPlease find onboarding details below:\n\nCustomer: ${p.customer || ''}\nService: ${p.serviceType || ''}\nFrequency: ${p.frequency || ''}\nMonthly: $${(p.monthlyFee||0).toLocaleString()}\nInitial: $${(p.initialFee||0).toLocaleString()}\nAnnual: $${(p.annualValue||0).toLocaleString()}\nContact: ${p.contactEmail || ''} ${p.contactPhone ? '('+p.contactPhone+')' : ''}\n\nThanks.`;
  const link = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = link;
}

</script>
<style>
  /* Theme-aware scrollbar styling */
  /* WebKit-based browsers (Chrome, Edge, Safari) */
  /* Document-level scrollbars (page) */
  html.theme-dark::-webkit-scrollbar,
  body.theme-dark::-webkit-scrollbar,
  .theme-dark ::-webkit-scrollbar { width: 10px; height: 10px; }
  html.theme-dark::-webkit-scrollbar-track,
  body.theme-dark::-webkit-scrollbar-track,
  .theme-dark ::-webkit-scrollbar-track { background: #0f172a; }
  html.theme-dark::-webkit-scrollbar-thumb,
  body.theme-dark::-webkit-scrollbar-thumb,
  .theme-dark ::-webkit-scrollbar-thumb {
    background-color: var(--brand-color);
    border-radius: 8px;
    border: 2px solid #0f172a;
  }
  html.theme-dark::-webkit-scrollbar-thumb:hover,
  body.theme-dark::-webkit-scrollbar-thumb:hover,
  .theme-dark ::-webkit-scrollbar-thumb:hover { background-color: var(--brand-color-dark); }
  /* Ensure page-level scrollbars are themed */
  html.theme-dark::-webkit-scrollbar { width: 10px; height: 10px; }
  html.theme-dark::-webkit-scrollbar-track { background: #0f172a; }
  html.theme-dark::-webkit-scrollbar-thumb { background-color: var(--brand-color); border-radius: 8px; border: 2px solid #0f172a; }
  html.theme-dark::-webkit-scrollbar-thumb:hover { background-color: var(--brand-color-dark); }

  /* Brand theme scrollbars */
  html.theme-brand::-webkit-scrollbar,
  body.theme-brand::-webkit-scrollbar,
  .theme-brand ::-webkit-scrollbar { width: 10px; height: 10px; }
  html.theme-brand::-webkit-scrollbar-track,
  body.theme-brand::-webkit-scrollbar-track,
  .theme-brand ::-webkit-scrollbar-track { background: #0f172a; }
  html.theme-brand::-webkit-scrollbar-thumb,
  body.theme-brand::-webkit-scrollbar-thumb,
  .theme-brand ::-webkit-scrollbar-thumb {
    background-color: var(--brand-color);
    border-radius: 8px;
    border: 2px solid #0f172a;
  }
  html.theme-brand::-webkit-scrollbar-thumb:hover,
  body.theme-brand::-webkit-scrollbar-thumb:hover,
  .theme-brand ::-webkit-scrollbar-thumb:hover { background-color: var(--brand-color-dark); }

  html.theme-light::-webkit-scrollbar,
  body.theme-light::-webkit-scrollbar,
  .theme-light ::-webkit-scrollbar { width: 10px; height: 10px; }
  html.theme-light::-webkit-scrollbar-track,
  body.theme-light::-webkit-scrollbar-track,
  .theme-light ::-webkit-scrollbar-track { background: #f3f4f6; }
  html.theme-light::-webkit-scrollbar-thumb,
  body.theme-light::-webkit-scrollbar-thumb,
  .theme-light ::-webkit-scrollbar-thumb {
    background-color: var(--brand-color);
    border-radius: 8px;
    border: 2px solid #f3f4f6;
  }
  html.theme-light::-webkit-scrollbar-thumb:hover,
  body.theme-light::-webkit-scrollbar-thumb:hover,
  .theme-light ::-webkit-scrollbar-thumb:hover { background-color: var(--brand-color-dark); }

  /* Firefox */
  /* Firefox document-level + inner containers */
  html.theme-dark, body.theme-dark, .theme-dark, .theme-dark * { scrollbar-color: var(--brand-color) #0f172a; scrollbar-width: thin; }
  html.theme-light, body.theme-light, .theme-light, .theme-light * { scrollbar-color: var(--brand-color) #f3f4f6; scrollbar-width: thin; }
  html.theme-brand, body.theme-brand, .theme-brand, .theme-brand * { scrollbar-color: var(--brand-color) #0f172a; scrollbar-width: thin; }
</style>
<style>
  /* Settings modal background should respect dark/brand themes */
  .theme-dark #settingsModal > div,
  .theme-brand #settingsModal > div { background-color: #0f172a !important; color: #e5e7eb; }
  .theme-dark #settingsFooter,
  .theme-brand #settingsFooter { background-color: #0f172a !important; border-color: #334155 !important; }
  /* Improve readability of text and inputs inside Settings modal for dark/brand themes */
  .theme-dark #settingsModal .text-gray-800,
  .theme-brand #settingsModal .text-gray-800 { color: #e5e7eb !important; }
  .theme-dark #settingsModal .text-gray-700,
  .theme-brand #settingsModal .text-gray-700 { color: #cbd5e1 !important; }
  .theme-dark #settingsModal .text-gray-600,
  .theme-brand #settingsModal .text-gray-600 { color: #94a3b8 !important; }
  .theme-dark #settingsModal .text-gray-500,
  .theme-brand #settingsModal .text-gray-500 { color: #64748b !important; }
  .theme-dark #settingsModal summary,
  .theme-brand #settingsModal summary { color: #e5e7eb !important; }
  .theme-dark #settingsModal input[type="text"],
  .theme-dark #settingsModal input[type="url"],
  .theme-dark #settingsModal input[type="color"],
  .theme-dark #settingsModal input[type="range"],
  .theme-dark #settingsModal select,
  .theme-brand #settingsModal input[type="text"],
  .theme-brand #settingsModal input[type="url"],
  .theme-brand #settingsModal input[type="color"],
  .theme-brand #settingsModal input[type="range"],
  .theme-brand #settingsModal select { background-color: #0b1220 !important; color: #e5e7eb !important; border-color: #334155 !important; }
  .theme-dark #settingsModal .border,
  .theme-brand #settingsModal .border { border-color: #334155 !important; }
  /* Sidebar icon preview thumbnails next to selects */
  .sidebar-icon-preview {
    width: 38px;
    height: 38px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 6px;
    line-height: 0;
  }
  .sidebar-icon-preview img,
  .sidebar-icon-preview svg {
    width: 100%;
    height: 100%;
  }
  /* Chat drawer dark theme */
  .theme-dark #chatDrawer { background-color: #0f172a; color: #e5e7eb; border-color: #334155; }
  .theme-dark #chatDrawer .border-b, .theme-dark #chatDrawer .border-t { border-color: #334155; }
  .theme-dark #chatDrawer select, .theme-dark #chatDrawer input { background-color: #0b1220; color: #e5e7eb; border-color: #334155; }
  /* Hide stray standalone checkboxes across dashboard tabs */
  #dashboardContent > input[type="checkbox"] { display: none !important; }
  #dashboardContent input[type="checkbox"] { display: none !important; }
  /* Allow valid checkboxes inside common UI containers */
  #dashboardContent table input[type="checkbox"],
  #dashboardContent form input[type="checkbox"],
  #dashboardContent label input[type="checkbox"],
  #dashboardContent .table input[type="checkbox"],
  #dashboardContent .form-control input[type="checkbox"],
  #dashboardContent .grid input[type="checkbox"],
  #dashboardContent .flex input[type="checkbox"],
  #dashboardContent .peer[type="checkbox"],
  #dashboardContent .checkbox[type="checkbox"] {
    display: inline-block !important;
  }

  /* Attention glow animations and chat FAB hover contrast */
  @keyframes b360-glow-red {
    0% { box-shadow: 0 0 0 0 rgba(227,6,19,0.50), 0 0 2px rgba(227,6,19,0.30); }
    50% { box-shadow: 0 0 0 6px rgba(227,6,19,0.12), 0 0 14px 2px rgba(227,6,19,0.55); }
    100% { box-shadow: 0 0 0 0 rgba(227,6,19,0.25), 0 0 2px rgba(227,6,19,0.30); }
  }
  .glow-red { animation: b360-glow-red 1.6s ease-in-out infinite; }

  @keyframes b360-glow-green {
    0% { box-shadow: 0 0 0 0 rgba(22,163,74,0.40), 0 0 2px rgba(22,163,74,0.30); }
    50% { box-shadow: 0 0 0 6px rgba(22,163,74,0.12), 0 0 14px 2px rgba(22,163,74,0.50); }
    100% { box-shadow: 0 0 0 0 rgba(22,163,74,0.25), 0 0 2px rgba(22,163,74,0.30); }
  }
  .glow-green { animation: b360-glow-green 1.6s ease-in-out infinite; }

  /* Hover white for chat button for stronger contrast */
  #openChatButton .chat-fab-bg { transition: background-color .2s ease, box-shadow .2s ease, border-color .2s ease; }
  #openChatButton:hover .chat-fab-bg { background: #ffffff !important; border-color: rgba(0,0,0,0.08); box-shadow: 0 8px 24px rgba(0,0,0,0.35), inset 0 2px 8px rgba(0,0,0,0.08); }
  #openChatButton:hover .chat-fab-icon { color: var(--brand-color) !important; }

  /* Final scrollbar track unification to match left sidebar in dark/brand */
  html.theme-dark::-webkit-scrollbar-track, body.theme-dark::-webkit-scrollbar-track { background: #0f172a !important; }
  html.theme-brand::-webkit-scrollbar-track, body.theme-brand::-webkit-scrollbar-track { background: #0f172a !important; }
</style>
<script>

        function prefillSalesFormFromQuote() {
  const p = window.__lastParsedQuote || {};
  const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };
  setVal('saleCustomer', p.customer || '');
  setVal('salePocEmail', p.contactEmail || '');
  setVal('saleAnnualValue', (p.annualValue || 0));
  const scope = [p.serviceType || '', p.frequency ? `(${p.frequency})` : ''].filter(Boolean).join(' ');
  setVal('saleScope', scope);
  const statusEl = document.getElementById('salesEntryStatus');
  if (statusEl) statusEl.textContent = 'Prefilled from Quote.';
  closeQuoteUploadModal();
}
        
        // --- Quote Upload Modal UI ---
        // Placed near end of body; ensure modal container exists in DOM

        function populateSalesRepDropdown() {
            const select = document.getElementById('salesRep');
            if (!select) return;
            // Reset options
            select.innerHTML = '<option value="">Select AE</option>';
            // Build unique AE list from AE_MAP
            const names = Object.values(AE_MAP || {});
            const unique = Array.from(new Set(names));
            unique.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
            // Auto-select based on current user email mapping when available
            if (typeof currentUser !== 'undefined') {
                const email = (currentUser.email || '').toLowerCase();
                const mapped = (AE_MAP || {})[email];
                if (mapped) {
                    select.value = mapped;
                } else if (currentUser.name && unique.includes(currentUser.name)) {
                    select.value = currentUser.name;
                } else {
                    // Leave as default placeholder for non-listed users
                    select.value = '';
                }
            }
        }

        function openSalesEntryForm() {
            const modal = document.getElementById('salesEntryModal');
            modal.classList.remove('hidden');
            setModalDefaultSize('salesEntryModal');
            enableModalDrag('salesEntryModal');
            
            // Populate AE dropdown and auto-select if current user is recognized
            populateSalesRepDropdown();
            document.getElementById('branch').value = currentUser?.branch || '';
            document.getElementById('dateProposal').value = new Date().toISOString().split('T')[0];
        }

        function closeSalesEntryForm() {
            document.getElementById('salesEntryModal').classList.add('hidden');
            document.getElementById('salesEntryForm').reset();
            resetModalPosition('salesEntryModal');
        }

        function submitSalesEntry() {
            const formData = {
                status: document.getElementById('status').value,
                salesRep: document.getElementById('salesRep').value,
                branch: document.getElementById('branch').value,
                customerName: document.getElementById('customerName').value,
                serviceAddress: document.getElementById('serviceAddress').value,
                pocName: document.getElementById('pocName').value,
                pocPhone: document.getElementById('pocPhone').value,
                dateProposal: document.getElementById('dateProposal').value,
                dateSold: document.getElementById('dateSold').value || null,
                dateDead: document.getElementById('dateDead').value || null,
                dateInstallScheduled: document.getElementById('dateInstallScheduled').value || null,
                source: document.getElementById('source').value,
                saleType: document.getElementById('saleType').value,
                serviceDescription: document.getElementById('serviceDescription').value,
                initialFee: parseFloat(document.getElementById('initialFee').value) || 0,
                monthlyFee: parseFloat(document.getElementById('monthlyFee').value) || 0,
                frequency: document.getElementById('frequency').value,
                annualValue: parseFloat(document.getElementById('annualValue').value) || 0,
                operationsManager: document.getElementById('operationsManager').value,
                assignedSpecialist: document.getElementById('assignedSpecialist').value,
                logBookNeeded: document.getElementById('logBookNeeded').checked ? 'Yes' : 'No',
                materialsOrdered: document.getElementById('materialsOrdered').checked ? 'Yes' : 'No',
                notes: document.getElementById('notes').value
            };

            // Validate required fields
            if (!formData.customerName || !formData.serviceAddress || !formData.pocName) {
                alert('Please fill in Customer Name, Service Address, and POC Name');
                return;
            }

            // Show loading state
            const submitBtn = document.getElementById('submitSalesEntry');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Submitting...';
            submitBtn.disabled = true;

            google.script.run
                .withSuccessHandler(function(response) {
                    alert('Sales entry recorded successfully!');
                    closeSalesEntryForm();
                    refreshDashboard();
                    
                    // Reset button state
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                })
                .withFailureHandler(function(error) {
                    alert('Error recording sales entry: ' + error.message);
                    
                    // Reset button state
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                })
                .recordSalesEntry(formData);
        }

        function calculateAnnualValue() {
            const monthlyFee = parseFloat(document.getElementById('monthlyFee').value) || 0;
            const frequency = document.getElementById('frequency').value;
            
            let multiplier = 12; // Default to monthly
            switch(frequency) {
                case 'Weekly': multiplier = 52; break;
                case 'Bi-Weekly': multiplier = 26; break;
                case 'Monthly': multiplier = 12; break;
                case 'Quarterly': multiplier = 4; break;
                case 'Semi-Annual': multiplier = 2; break;
                case 'Annual': multiplier = 1; break;
            }
            
            const annualValue = monthlyFee * multiplier;
            document.getElementById('annualValue').value = annualValue.toFixed(2);
        }

        function updateInstallStatus() {
            alert('Install status update would be implemented here');
        }

        function togglePresentationMode() {
            presentationMode = !presentationMode;
            const body = document.body;
            
            if (presentationMode) {
                body.classList.add('presentation-mode');
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('ml-64');
                document.getElementById('mainContent').classList.add('ml-0');
                
                // Request fullscreen
                if (body.requestFullscreen) {
                    body.requestFullscreen();
                }
                
                // Start auto-refresh
                startAutoRefresh();
                
                animateCounters();
            } else {
                body.classList.remove('presentation-mode');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('mainContent').classList.remove('ml-0');
                document.getElementById('mainContent').classList.add('ml-64');
                
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
                
                // Stop auto-refresh
                stopAutoRefresh();
            }
        }

        function toggleSidebar() {
            try {
                const sidebar = document.getElementById('sidebar');
                const mc = document.getElementById('mainContent');
                const label = document.getElementById('sidebarToggleLabel');
                if (!sidebar || !mc || !label) return;
                const isHidden = sidebar.classList.contains('hidden');
                if (isHidden) {
                    sidebar.classList.remove('hidden');
                    mc.classList.remove('ml-0');
                    mc.classList.add('ml-64');
                    label.textContent = 'Hide Sidebar';
                } else {
                    sidebar.classList.add('hidden');
                    mc.classList.remove('ml-64');
                    mc.classList.add('ml-0');
                    label.textContent = 'Show Sidebar';
                }
            } catch(e) { /* noop */ }
        }

        let autoRefreshInterval;

        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing interval
            autoRefreshInterval = EventRegistry.setInterval(() => {
                refreshDashboard();
                animateCounters();
            }, refreshInterval);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function updateRefreshInterval(newIntervalSeconds) {
            const seconds = parseInt(newIntervalSeconds || document.getElementById('refreshInterval')?.value || '30', 10);
            refreshInterval = seconds * 1000;
            localStorage.setItem('refreshInterval', String(seconds));
            if (presentationMode) {
                stopAutoRefresh();
                startAutoRefresh(); // Restart with new interval
            }
            alert('Refresh interval updated to ' + seconds + ' seconds');
        }

        function animateCounters() {
            const counters = document.querySelectorAll('.kpi-card p');
            counters.forEach(counter => {
                counter.classList.add('count-up');
                setTimeout(() => counter.classList.remove('count-up'), 1000);
            });
        }

        function refreshDashboard() {
            switch(currentDashboard) {
                case 'sales':
                    loadSalesDashboard();
                    break;
                case 'operations':
                    loadOperationsDashboard();
                    break;
                case 'branch':
                    loadBranchManagerDashboard();
                    break;
                case 'executive':
                    loadExecutiveDashboard();
                    break;
                case 'area':
                    loadAreaDashboard();
                    break;
                case 'region':
                    loadRegionDashboard();
                    break;
                case 'market':
                    loadMarketDashboard();
                    break;
                case 'director':
                    loadDirectorPanel();
                    break;
                case 'drive':
                    loadDrivePanel();
                    break;
                case 'calendar':
                    loadCalendarPanel();
                    break;
                case 'gmail':
                    loadGmailPanel();
                    break;
                default:
                    loadSalesDashboard();
            }
        }

        function changeTheme(theme) {
            // Only allow 'light' or 'dark'; fallback others to 'light'
            const next = (theme === 'dark') ? 'dark' : 'light';
            localStorage.setItem('streamlineTheme', next);
            // Apply to BOTH html and body so root scrollbars pick up the theme
            const htmlEl = document.documentElement;
            const bodyEl = document.body;
            // Remove ONLY theme-dark/theme-light to avoid stripping other theme-* classes (e.g., theme-brand)
            htmlEl.className = htmlEl.className.replace(/\btheme-(?:dark|light)\b/g, '').replace(/\s{2,}/g, ' ').trim();
            bodyEl.className = bodyEl.className.replace(/\btheme-(?:dark|light)\b/g, '').replace(/\s{2,}/g, ' ').trim();
            htmlEl.classList.add(`theme-${next}`);
            bodyEl.classList.add(`theme-${next}`);
        }

        function loadTheme() {
            // Demo default to dark if no saved preference
            let savedTheme = localStorage.getItem('streamlineTheme');
            if (!savedTheme) savedTheme = 'dark';
            // Only support 'light' or 'dark'; normalize anything else to 'dark'
            if (savedTheme !== 'dark' && savedTheme !== 'light') savedTheme = 'dark';
            // Sync all UI controls
            const actionSelector = document.getElementById('actionMenuThemeSelector');
            if (actionSelector) actionSelector.value = savedTheme;
            const themeSelector = document.getElementById('themeSelector');
            if (themeSelector) themeSelector.value = savedTheme;
            const darkToggle = document.getElementById('darkModeToggle');
            if (darkToggle) darkToggle.checked = (savedTheme === 'dark');
            // Persist normalized choice and apply
            localStorage.setItem('streamlineTheme', savedTheme);
            changeTheme(savedTheme);
        }

        // Role hierarchy and permissions
        const ROLE_LEVELS = {
            // Ops hierarchy
            'Market Vice President': { group: 'ops', level: 3 },
            'Region Director': { group: 'ops', level: 2 },
            'Area District Manager': { group: 'ops', level: 1 },
            'Branch Manager': { group: 'ops', level: 0 },
            // Sales hierarchy
            'Market Sales Director': { group: 'sales', level: 3 },
            'Regional Sales Manager': { group: 'sales', level: 2 },
            'Area Sales Manager': { group: 'sales', level: 1 },
            'Sales': { group: 'sales', level: 0 },
            // Executive (super role)
            'Executive': { group: 'exec', level: 4 },
            'Admin': { group: 'exec', level: 4 }
        };
        const VIEW_MIN_LEVEL = {
            area: 1,
            region: 2,
            market: 3,
            branch: 0 // Branch view available to branch-level and up
        };
        function getRoleInfo() {
            const roleRaw = (currentUser && currentUser.role) ? currentUser.role : 'Sales';
            const role = String(roleRaw).trim();
            if (ROLE_LEVELS[role]) return ROLE_LEVELS[role];
            const n = role.toLowerCase();
            // Grant full access for Market Director variants
            if (n.includes('market') && n.includes('director')) {
                return { group: 'exec', level: 4 };
            }
            // Executive and Admin synonyms
            if (n.includes('executive') || n.includes('admin')) return { group: 'exec', level: 4 };
            // VP / Vice President
            if (n.includes('vice president') || n.includes('vp')) return { group: n.includes('sales') ? 'sales' : 'ops', level: 3 };
            // Director
            if (n.includes('director')) return { group: n.includes('sales') ? 'sales' : 'ops', level: 2 };
            // Manager
            if (n.includes('manager')) return { group: n.includes('sales') ? 'sales' : 'ops', level: 1 };
            // Fallback
            return { group: n.includes('ops') ? 'ops' : 'sales', level: 0 };
        }
        function canViewDashboard(view) {
            // Sales and Ops dashboards are always visible cross-functionally
            if (view === 'sales' || view === 'operations' || view === 'drive' || view === 'calendar' || view === 'gmail' || view === 'insights' || view === 'quality' || view === 'fieldtools') return true;
            // Branch Manager should not be visible to all; restrict to Ops or Exec
            if (view === 'branch') {
                const info = getRoleInfo();
                if (info.group === 'exec') return true;
                return info.group === 'ops' && info.level >= 0;
            }
            // Executive-only view
            if (view === 'executive') {
                // Executive tab is disabled per requirement
                return false;
            }
            // Director rollout view (executive-level only)
            if (view === 'director') {
                // Only the designated Market Sales Enablement & Efficiency Director should see this tab
                const owner = String(localStorage.getItem('marketDirectorOwnerEmail') || '').toLowerCase();
                const email = (currentUser && currentUser.email) ? String(currentUser.email).toLowerCase() : '';
                return owner && email && email === owner;
            }
            // Hierarchical management views
            const info = getRoleInfo();
            const min = VIEW_MIN_LEVEL[view];
            if (typeof min !== 'number') return false;
            // Both ops and sales hierarchies can view management dashboards at or below their level
            return info.level >= min;
        }
        function applyDashboardVisibility() {
            const views = ['sales','operations','branch','area','region','market','director']; // executive removed
            views.forEach(v => {
                const btn = document.querySelector(`.nav-btn[data-view="${v}"]`);
                if (!btn) return;
                btn.style.display = canViewDashboard(v) ? 'block' : 'none';
            });
        }

        // Management dashboards
        function loadAreaDashboard() {
            const root = document.getElementById('dashboardContent');
            renderManagementMetrics('area', root);
        }
        function loadRegionDashboard() {
            const root = document.getElementById('dashboardContent');
            renderManagementMetrics('region', root);
        }
        function loadMarketDashboard() {
            const root = document.getElementById('dashboardContent');
            renderManagementMetrics('market', root);
        }

        // Cadence tracker parsing and management metrics
        let midmarketCadence = null;
        async function loadMidmarketCadenceData(){
            if (midmarketCadence) return midmarketCadence;
            try {
                await ensureSheetJs();
                const res = await fetch('Midwest Daily Sales Cadence Tracker.xlsx');
                if (!res.ok) throw new Error('Failed to fetch cadence tracker: ' + res.status);
                const buf = await res.arrayBuffer();
                const wb = XLSX.read(buf, { type: 'array' });
                const sheetName = wb.SheetNames[0];
                const ws = wb.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(ws, { defval: null });
                midmarketCadence = buildCadenceMetrics(rows);
            } catch (e) {
                console.warn('Unable to load cadence tracker. Ensure local preview allows XLSX fetch.', e);
                midmarketCadence = { rows: [], byArea: {}, byRegion: {}, byMarket: {}, totals: {} };
            }
            return midmarketCadence;
        }

        function normalizeKey(k){ return String(k || '').trim().toLowerCase(); }
        function buildCadenceMetrics(rows){
            const out = { rows, byArea: {}, byRegion: {}, byMarket: {}, totals: {} };
            if (!Array.isArray(rows) || rows.length === 0) return out;
            const keys = Object.keys(rows[0] || {});
            const keyMap = keys.reduce((acc, k) => { acc[normalizeKey(k)] = k; return acc; }, {});
            const areaKey = keyMap['area'] || keyMap['territory'] || keyMap['district'] || null;
            const regionKey = keyMap['region'] || keyMap['zone'] || null;
            const marketKey = keyMap['market'] || keyMap['market name'] || keyMap['market_name'] || null;
            const isMetric = (k) => {
                const nk = normalizeKey(k);
                if (nk.includes('date') || nk.includes('name') || nk.includes('rep') || nk.includes('salesperson') || nk.includes('notes')) return false;
                if (nk === normalizeKey(areaKey) || nk === normalizeKey(regionKey) || nk === normalizeKey(marketKey)) return false;
                return true;
            };
            const metricKeys = keys.filter(isMetric);
            const addTo = (bucket, key, row) => {
                if (!key) key = 'Unknown';
                const id = String(key || 'Unknown');
                if (!bucket[id]) bucket[id] = { id, count: 0 };
                bucket[id].count += 1;
                metricKeys.forEach(mk => {
                    const v = Number(row[mk]);
                    if (!isFinite(v)) return;
                    bucket[id][mk] = (bucket[id][mk] || 0) + v;
                });
            };
            rows.forEach(r => {
                addTo(out.totals, 'All', r);
                if (areaKey) addTo(out.byArea, r[areaKey], r);
                if (regionKey) addTo(out.byRegion, r[regionKey], r);
                if (marketKey) addTo(out.byMarket, r[marketKey], r);
            });
            out.dimensions = { areaKey, regionKey, marketKey, metricKeys };
            return out;
        }

        function fmtNum(n){ return isFinite(n) ? Number(n).toLocaleString() : '-'; }
        function renderMetricCards(scopeLabel, data, metricKeys){
            const cards = metricKeys.slice(0,3).map((mk, i) => {
                const v = data[mk];
                const title = mk.replaceAll('_',' ').replace(/\b\w/g, c => c.toUpperCase());
                const accent = i===0 ? 'text-brand' : 'text-green-600';
                return `<div class="p-4 bg-white border rounded"><div class="text-sm text-gray-600">${scopeLabel}</div><div class="text-xl font-semibold ${accent}">${fmtNum(v || 0)}</div><div class="text-xs text-gray-500">${title}</div></div>`;
            }).join('');
            return `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">${cards}</div>`;
        }

        async function renderManagementMetrics(scope, root){
            root = root || document.getElementById('dashboardContent');
            root.innerHTML = `<div class="p-4"><div class="text-sm text-gray-600">Loading ${scope} metrics from Midmarket Daily Sales Cadence Tracker...</div></div>`;
            const cadence = await loadMidmarketCadenceData();
            const dims = cadence.dimensions || {};
            const metricKeys = Array.isArray(dims.metricKeys) && dims.metricKeys.length ? dims.metricKeys : [];
            let bucket = null, idLabel = '';
            if (scope === 'area') { bucket = cadence.byArea; idLabel = dims.areaKey || 'Area'; }
            else if (scope === 'region') { bucket = cadence.byRegion; idLabel = dims.regionKey || 'Region'; }
            else { bucket = cadence.byMarket; idLabel = dims.marketKey || 'Market'; }
            const scopeKey = (function(){
                if (!currentUser) return null;
                if (scope === 'area') return currentUser.area || currentUser.branch || null;
                if (scope === 'region') return currentUser.region || null;
                return currentUser.market || null;
            })();

            const entries = Object.values(bucket || {});
            let selected = null;
            if (scopeKey && bucket && bucket[scopeKey]) selected = bucket[scopeKey];
            if (!selected && entries.length) selected = entries.sort((a,b)=> (b.count||0)-(a.count||0))[0];
            if (!selected) {
                root.innerHTML = `<div class="p-4"><div class="text-sm text-gray-600">No ${scope} data found in the tracker. Please confirm column headers include "${idLabel}" and numeric metric columns.</div></div>`;
                return;
            }

            const header = `<div class="p-4"><div class="text-sm text-gray-600">${idLabel}: <span class="font-medium text-brand">${selected.id || scopeKey || 'Unknown'}</span></div></div>`;
            const cards = renderMetricCards(`${scope.charAt(0).toUpperCase()+scope.slice(1)} Totals`, selected, metricKeys);
            let subTable = '';
            if (scope !== 'market') {
                const related = entries.slice(0).sort((a,b)=> (b.count||0)-(a.count||0)).slice(0,10);
                const cols = metricKeys.slice(0,3);
                const th = cols.map(c => `<th class="px-3 py-2 text-xs text-gray-500">${c.replaceAll('_',' ').replace(/\b\w/g, s=>s.toUpperCase())}</th>`).join('');
                const rowsHtml = related.map(r => `<tr class="border-t"><td class="px-3 py-2 text-xs">${r.id}</td>${cols.map(c=>`<td class="px-3 py-2 text-xs text-right">${fmtNum(r[c]||0)}</td>`).join('')}</tr>`).join('');
                subTable = `<div class="p-4"><div class="text-sm font-medium text-gray-800 mb-2">Top Groups</div><table class="w-full text-left text-xs"><thead><tr><th class="px-3 py-2 text-xs text-gray-500">${idLabel}</th>${th}</tr></thead><tbody>${rowsHtml}</tbody></table></div>`;
            }
            root.innerHTML = header + cards + subTable;
        }

        // Explore: Insights
        function loadInsightsDashboard() {
            const root = document.getElementById('dashboardContent');
            const content = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Trend: Close Rate</h3>
                        <p class="text-3xl font-bold text-green-600">+3.1%</p>
                        <p class="text-sm text-gray-600 mt-1">Last 30 days</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Forecast: Next Week</h3>
                        <p class="text-3xl font-bold text-brand">$124k</p>
                        <p class="text-sm text-gray-600 mt-1">Based on current cadence</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Outliers Detected</h3>
                        <p class="text-3xl font-bold text-rentokil-blue">5</p>
                        <p class="text-sm text-gray-600 mt-1">Need review</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Quick Diagnostics</h3>
                        <button class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded" onclick="refreshInsights()">â†» Refresh</button>
                    </div>
                    <ul class="space-y-3">
                        <li class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><span>Proposal volume vs. staffing</span><span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Balanced</span></li>
                        <li class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><span>Install lead time</span><span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">Watch</span></li>
                        <li class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><span>Dead lead ratio</span><span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700">High</span></li>
                    </ul>
                </div>`;
            root.innerHTML = content;
        }
        function refreshInsights() {
            try { toast('Insights refreshed'); } catch(e) {}
            loadInsightsDashboard();
        }

        // Explore: Quality
        function loadQualityDashboard() {
            const root = document.getElementById('dashboardContent');
            const content = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">QA Compliance</h3>
                        <p class="text-3xl font-bold text-green-600">96%</p>
                        <p class="text-sm text-gray-600 mt-1">Last audit</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Defects Open</h3>
                        <p class="text-3xl font-bold text-brand">12</p>
                        <p class="text-sm text-gray-600 mt-1">Across branches</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">MTTR</h3>
                        <p class="text-3xl font-bold text-rentokil-blue">2.3d</p>
                        <p class="text-sm text-gray-600 mt-1">Mean time to resolve</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Defect Tracking</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Title</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr><td class="px-4 py-2">Q-104</td><td class="px-4 py-2">Install checklist missing</td><td class="px-4 py-2"><span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">In Progress</span></td></tr>
                                <tr><td class="px-4 py-2">Q-97</td><td class="px-4 py-2">Incorrect proposal tag</td><td class="px-4 py-2"><span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Resolved</span></td></tr>
                                <tr><td class="px-4 py-2">Q-88</td><td class="px-4 py-2">Calendar sync issue</td><td class="px-4 py-2"><span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700">Blocked</span></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
            root.innerHTML = content;
        }

        // Explore: Field Tools
        function loadFieldToolsDashboard() {
            const root = document.getElementById('dashboardContent');
            const content = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Quick Calculator</h3>
                        <div class="flex items-center gap-2">
                            <input id="ftCalcA" type="number" class="w-24 px-2 py-1 border rounded" placeholder="A" />
                            <span class="text-gray-500">Ã—</span>
                            <input id="ftCalcB" type="number" class="w-24 px-2 py-1 border rounded" placeholder="B" />
                            <button class="px-2 py-1 text-xs rounded bg-brand text-tagline" onclick="ftCalcMultiply()">Calc</button>
                        </div>
                        <div id="ftCalcResult" class="mt-2 text-sm text-gray-700">Result: â€”</div>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Route Planner</h3>
                        <button class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200" onclick="openRoutePlanner()">Open Maps</button>
                        <p class="text-xs text-gray-500 mt-2">Plan multi-stop routes quickly.</p>
                    </div>
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-lg count-up">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">QR Generator</h3>
                        <div class="flex items-center gap-2">
                            <input id="ftQrText" type="text" class="w-full px-2 py-1 border rounded" placeholder="Enter text or URL" />
                            <button class="px-2 py-1 text-xs rounded bg-brand text-tagline" onclick="generateFtQr()">Make</button>
                        </div>
                        <canvas id="ftQrCanvas" class="mt-2"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Links</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <a class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm" href="https://docs.google.com" target="_blank">Google Docs</a>
                        <a class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm" href="https://drive.google.com" target="_blank">Google Drive</a>
                        <a class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm" href="https://calendar.google.com" target="_blank">Google Calendar</a>
                    </div>
                </div>`;
            root.innerHTML = content;
        }
        function ftCalcMultiply() {
            const a = parseFloat(document.getElementById('ftCalcA').value || '0');
            const b = parseFloat(document.getElementById('ftCalcB').value || '0');
            document.getElementById('ftCalcResult').textContent = `Result: ${isFinite(a*b) ? a*b : 'â€”'}`;
        }
        function openRoutePlanner() { window.open('https://www.google.com/maps', '_blank'); }
        function generateFtQr() {
            // Simple placeholder QR: draw text onto canvas
            try {
                const canvas = document.getElementById('ftQrCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 200; canvas.height = 200;
                ctx.fillStyle = '#fff'; ctx.fillRect(0,0,200,200);
                ctx.fillStyle = '#000';
                ctx.font = '12px sans-serif';
                const txt = document.getElementById('ftQrText').value || 'QR';
                ctx.fillText(`QR: ${txt.substring(0,16)}`, 10, 100);
            } catch(e) { console.warn('QR placeholder failed', e); }
        }

        // Leadership: Director Rollout
        function loadDirectorPanel() {
            const root = document.getElementById('dashboardContent');
            root.innerHTML = '<div class="p-4"><div class="text-sm text-gray-600">Loading rollout overviewâ€¦</div></div>';
            if (!hasAppsScript()) {
                renderDirectorPanel(getMockDirectorRolloutData());
                return;
            }
            try {
                google.script.run
                    .withSuccessHandler(function(data){ renderDirectorPanel(data); })
                    .withFailureHandler(function(err){ console.error('Error loading rollout overview:', err); renderDirectorPanel(getMockDirectorRolloutData()); })
                    .getRolloutOverview();
            } catch(e) {
                console.warn('Apps Script unavailable, using mock data', e);
                renderDirectorPanel(getMockDirectorRolloutData());
            }
        }
        function renderDirectorPanel(data) {
            const root = document.getElementById('dashboardContent');
            const d = data || {};
            const totals = d.totals || { branches: { onboarded: 0, total: 0 }, areas: { onboarded: 0, total: 0 }, regions: { onboarded: 0, total: 0 }, markets: { onboarded: 0, total: 0 } };
            const pct = (a,b) => {
                const t = Number(b)||0; const o = Number(a)||0;
                return t > 0 ? Math.round((o/t)*100) : 0;
            };
            const cards = [
                { key: 'branches', label: 'Branches Onboarded', val: `${totals.branches.onboarded}/${totals.branches.total}`, progress: pct(totals.branches.onboarded, totals.branches.total) },
                { key: 'areas', label: 'Areas Onboarded', val: `${totals.areas.onboarded}/${totals.areas.total}`, progress: pct(totals.areas.onboarded, totals.areas.total) },
                { key: 'regions', label: 'Regions Onboarded', val: `${totals.regions.onboarded}/${totals.regions.total}`, progress: pct(totals.regions.onboarded, totals.regions.total) },
                { key: 'markets', label: 'Markets Onboarded', val: `${totals.markets.onboarded}/${totals.markets.total}`, progress: pct(totals.markets.onboarded, totals.markets.total) }
            ];
            const status = d.status || { pipeline: 'Initializing', blockers: [], nextActions: [] };
            const rows = (d.rows || []).map(r => `
                <tr class="border-b border-gray-200">
                    <td class="px-3 py-2 text-sm">${escapeHtml(r.market || '')}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(r.region || '')}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(r.area || '')}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(r.branch || '')}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(r.owner || '')}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(r.phase || '')}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(r.adoption || '')}%</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(r.notes || '')}</td>
                </tr>
            `).join('');

            const header = `
                <div class="flex items-center justify-between p-4 border-b border-gray-200">
                    <div>
                        <div class="text-lg font-semibold text-brand">Rollout Overview</div>
                        <div class="text-xs text-gray-500">Track deployment and adoption across all levels</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="px-3 py-1 text-sm bg-brand text-tagline rounded" onclick="refreshDashboard()">Refresh</button>
                        <button class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded" onclick="exportRolloutCsv()">Export CSV</button>
                    </div>
                </div>`;

            const directorMenu = `
                <div class="p-3 bg-gray-50 border-b border-gray-200">
                    <div class="flex flex-wrap gap-2">
                        <button class="px-3 py-1 text-xs sm:text-sm bg-white border border-gray-200 rounded hover:bg-gray-100" onclick="openCohortsManager()">Cohorts</button>
                        <button class="px-3 py-1 text-xs sm:text-sm bg-white border border-gray-200 rounded hover:bg-gray-100" onclick="openTrainingScheduler()">Training Scheduler</button>
                        <button class="px-3 py-1 text-xs sm:text-sm bg-white border border-gray-200 rounded hover:bg-gray-100" onclick="openAdoptionTargets()">Adoption Targets</button>
                        <button class="px-3 py-1 text-xs sm:text-sm bg-white border border-gray-200 rounded hover:bg-gray-100" onclick="openBlockersPanel()">Blockers</button>
                        <button class="px-3 py-1 text-xs sm:text-sm bg-white border border-gray-200 rounded hover:bg-gray-100" onclick="openCommsPanel()">Team Broadcast</button>
                        <button class="px-3 py-1 text-xs sm:text-sm bg-white border border-gray-200 rounded hover:bg-gray-100" onclick="generateDirectorReport()">Generate Report</button>
                        <button class="px-3 py-1 text-xs sm:text-sm bg-white border border-gray-200 rounded hover:bg-gray-100" onclick="openDirectorSettings()">Settings</button>
                    </div>
                </div>`;

            const metrics = `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-4">
                    ${cards.map(c => `
                        <div class="kpi-card p-4 bg-white rounded-lg shadow-sm border border-gray-200 cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand" role="button" tabindex="0" aria-label="${c.label} details" data-scope="${c.key}">
                            <div class="text-sm text-gray-500">${c.label}</div>
                            <div class="mt-1 text-2xl font-semibold text-brand">${c.val}</div>
                            <div class="mt-3 h-2 w-full bg-gray-100 rounded">
                                <div class="h-2 bg-brand rounded" style="width:${c.progress}%"></div>
                            </div>
                            <div class="mt-1 text-xs text-gray-500">${c.progress}%</div>
                        </div>
                    `).join('')}
                </div>`;

            const statusPanel = `
                <div class="p-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="text-sm font-medium text-gray-700">Pipeline Status</div>
                        <div class="mt-2 text-sm text-gray-600">${escapeHtml(status.pipeline)}</div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="text-sm font-medium text-gray-700">Top Blockers</div>
                        <ul class="mt-2 list-disc list-inside text-sm text-gray-600">${(status.blockers||[]).map(b=>`<li>${escapeHtml(b)}</li>`).join('') || '<li>None reported</li>'}</ul>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="text-sm font-medium text-gray-700">Next Actions</div>
                        <ul class="mt-2 list-disc list-inside text-sm text-gray-600">${(status.nextActions||[]).map(a=>`<li>${escapeHtml(a)}</li>`).join('') || '<li>Define next cohort</li>'}</ul>
                    </div>
                </div>`;

            const table = `
                <div class="p-4">
                    <div class="text-sm text-gray-700 mb-2">Cohort Progress</div>
                    <div class="overflow-auto border border-gray-200 rounded-lg">
                        <table class="min-w-full text-left">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-xs text-gray-500">Market</th>
                                    <th class="px-3 py-2 text-xs text-gray-500">Region</th>
                                    <th class="px-3 py-2 text-xs text-gray-500">Area</th>
                                    <th class="px-3 py-2 text-xs text-gray-500">Branch</th>
                                    <th class="px-3 py-2 text-xs text-gray-500">Owner</th>
                                    <th class="px-3 py-2 text-xs text-gray-500">Phase</th>
                                    <th class="px-3 py-2 text-xs text-gray-500">Adoption</th>
                                    <th class="px-3 py-2 text-xs text-gray-500">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white">${rows || ''}</tbody>
                        </table>
                    </div>
                </div>`;

            root.innerHTML = header + directorMenu + metrics + statusPanel + table;
            // Cleanup any prior grid/layout artifacts to restore default visuals
            try {
                document.querySelectorAll('.universal-grid, .fab-add-widget').forEach(el => el.remove());
                const styleEl = document.getElementById('dashboard-layout-styles');
                if (styleEl) styleEl.remove();
                document.getElementById('dashboardContent')?.classList.remove('layout-mode');
            } catch (_) {}
            // Initialize universal grid for Director and inject layout controls
            try { if (window.universalGridEnabled === true) initUniversalGrid('director'); } catch(_) {}
            try { injectLayoutControls(); } catch(_) {}
            // Cache director dataset for modal drilldowns
            try { window.lastDirectorData = d; } catch(e) { /* noop */ }
            // Attach interactive handlers to KPI cards
            try {
                const kpis = Array.from(root.querySelectorAll('.kpi-card[data-scope]'));
                kpis.forEach(function(el){
                    const scope = el.getAttribute('data-scope');
                    el.addEventListener('click', function(){ openMetricModal('rollout', scope); });
                    el.addEventListener('keydown', function(ev){ handleMetricCardKey(ev, 'rollout', scope); });
                });
            } catch (e) { console.warn('Director KPI interactivity failed:', e); }
        }
        // Director menu actions (stubs)
        function openCohortsManager(){
            const m = document.getElementById('cohortsModal');
            if (m) { m.classList.remove('hidden'); renderCohortsTable(); }
        }
        function closeCohortsManager(){ const m = document.getElementById('cohortsModal'); if (m) m.classList.add('hidden'); }
        function cohortsStorage(){ return 'director.cohorts'; }
        function renderCohortsTable(){
            const body = document.getElementById('cohortsTableBody');
            if (!body) return;
            const items = JSON.parse(localStorage.getItem(cohortsStorage()) || '[]');
            body.innerHTML = items.map((c, idx) => `
                <tr>
                    <td class="px-3 py-2 text-sm">${escapeHtml(c.name)}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(c.level)}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(c.owner)}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(c.status)}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(c.notes||'')}</td>
                    <td class="px-3 py-2 text-sm">
                        <button class="text-xs text-brand" onclick="editCohort(${idx})">Edit</button>
                        <button class="ml-2 text-xs text-red-600" onclick="deleteCohort(${idx})">Delete</button>
                    </td>
                </tr>`).join('');
        }
        function resetCohortForm(){
            ['cohortName','cohortLevel','cohortOwner','cohortStatus','cohortNotes'].forEach(id => { const el = document.getElementById(id); if (el) el.value = (id==='cohortLevel'?'branch':(id==='cohortStatus'?'planning':'')); });
            localStorage.removeItem('cohort.editIndex');
        }
        function saveCohort(){
            const name = document.getElementById('cohortName').value.trim();
            const level = document.getElementById('cohortLevel').value;
            const owner = document.getElementById('cohortOwner').value.trim();
            const status = document.getElementById('cohortStatus').value;
            const notes = document.getElementById('cohortNotes').value.trim();
            if (!name) { alert('Name is required'); return; }
            const items = JSON.parse(localStorage.getItem(cohortsStorage()) || '[]');
            const editIdx = localStorage.getItem('cohort.editIndex');
            const entry = { name, level, owner, status, notes };
            if (editIdx !== null && editIdx !== undefined && editIdx !== '') {
                items[Number(editIdx)] = entry;
            } else {
                items.push(entry);
            }
            localStorage.setItem(cohortsStorage(), JSON.stringify(items));
            resetCohortForm();
            renderCohortsTable();
        }
        function editCohort(idx){
            const items = JSON.parse(localStorage.getItem(cohortsStorage()) || '[]');
            const c = items[idx]; if (!c) return;
            document.getElementById('cohortName').value = c.name;
            document.getElementById('cohortLevel').value = c.level;
            document.getElementById('cohortOwner').value = c.owner;
            document.getElementById('cohortStatus').value = c.status;
            document.getElementById('cohortNotes').value = c.notes || '';
            localStorage.setItem('cohort.editIndex', String(idx));
        }
        function deleteCohort(idx){
            if (!confirm('Delete this cohort?')) return;
            const items = JSON.parse(localStorage.getItem(cohortsStorage()) || '[]');
            items.splice(idx,1);
            localStorage.setItem(cohortsStorage(), JSON.stringify(items));
            renderCohortsTable();
        }

        function openTrainingScheduler(){ const m = document.getElementById('trainingModal'); if (m) { m.classList.remove('hidden'); renderTrainingTable(); } }
        function closeTrainingScheduler(){ const m = document.getElementById('trainingModal'); if (m) m.classList.add('hidden'); }
        function trainingsStorage(){ return 'director.trainings'; }
        function renderTrainingTable(){
            const body = document.getElementById('trainingTableBody'); if (!body) return;
            const items = JSON.parse(localStorage.getItem(trainingsStorage()) || '[]');
            body.innerHTML = items.map((t, idx) => `
                <tr>
                    <td class="px-3 py-2 text-sm">${escapeHtml(t.title)}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(t.date)}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(t.time)}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(t.audience||'')}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(t.location||'')}</td>
                    <td class="px-3 py-2 text-sm">
                        <button class="text-xs text-brand" onclick="editTraining(${idx})">Edit</button>
                        <button class="ml-2 text-xs text-red-600" onclick="deleteTraining(${idx})">Delete</button>
                    </td>
                </tr>`).join('');
        }
        function resetTrainingForm(){
            ['trainingTitle','trainingDate','trainingTime','trainingAudience','trainingLocation','trainingNotes'].forEach(id => { const el = document.getElementById(id); if (el) el.value=''; });
            localStorage.removeItem('training.editIndex');
        }
        function saveTrainingSession(){
            const title = document.getElementById('trainingTitle').value.trim();
            const date = document.getElementById('trainingDate').value;
            const time = document.getElementById('trainingTime').value;
            const audience = document.getElementById('trainingAudience').value.trim();
            const location = document.getElementById('trainingLocation').value.trim();
            const notes = document.getElementById('trainingNotes').value.trim();
            if (!title || !date) { alert('Title and date are required'); return; }
            const items = JSON.parse(localStorage.getItem(trainingsStorage()) || '[]');
            const editIdx = localStorage.getItem('training.editIndex');
            const entry = { title, date, time, audience, location, notes };
            if (editIdx) { items[Number(editIdx)] = entry; } else { items.push(entry); }
            localStorage.setItem(trainingsStorage(), JSON.stringify(items));
            resetTrainingForm(); renderTrainingTable();
        }
        function editTraining(idx){
            const items = JSON.parse(localStorage.getItem(trainingsStorage()) || '[]'); const t = items[idx]; if (!t) return;
            document.getElementById('trainingTitle').value = t.title;
            document.getElementById('trainingDate').value = t.date;
            document.getElementById('trainingTime').value = t.time || '';
            document.getElementById('trainingAudience').value = t.audience || '';
            document.getElementById('trainingLocation').value = t.location || '';
            document.getElementById('trainingNotes').value = t.notes || '';
            localStorage.setItem('training.editIndex', String(idx));
        }
        function deleteTraining(idx){ if (!confirm('Delete this session?')) return; const items = JSON.parse(localStorage.getItem(trainingsStorage()) || '[]'); items.splice(idx,1); localStorage.setItem(trainingsStorage(), JSON.stringify(items)); renderTrainingTable(); }

        function openAdoptionTargets(){ const m = document.getElementById('targetsModal'); if (m) { m.classList.remove('hidden'); renderTargetsTable(); } }
        function closeAdoptionTargets(){ const m = document.getElementById('targetsModal'); if (m) m.classList.add('hidden'); }
        function targetsStorage(){ return 'director.targets'; }
        function renderTargetsTable(){
            const body = document.getElementById('targetsTableBody'); if (!body) return;
            const items = JSON.parse(localStorage.getItem(targetsStorage()) || '[]');
            body.innerHTML = items.map((t, idx) => `
                <tr>
                    <td class="px-3 py-2 text-sm">${escapeHtml(t.level)}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(t.name)}</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(String(t.target||''))}%</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(String(t.current||''))}%</td>
                    <td class="px-3 py-2 text-sm">${escapeHtml(t.notes||'')}</td>
                    <td class="px-3 py-2 text-sm">
                        <button class="text-xs text-brand" onclick="editTarget(${idx})">Edit</button>
                        <button class="ml-2 text-xs text-red-600" onclick="deleteTarget(${idx})">Delete</button>
                    </td>
                </tr>`).join('');
        }
        function resetTargetForm(){ ['targetLevel','targetName','targetPercent','currentPercent','targetNotes'].forEach(id => { const el = document.getElementById(id); if (el) el.value = (id==='targetLevel'?'branch':''); }); localStorage.removeItem('targets.editIndex'); }
        function saveAdoptionTarget(){
            const level = document.getElementById('targetLevel').value;
            const name = document.getElementById('targetName').value.trim();
            const target = Number(document.getElementById('targetPercent').value||0);
            const current = Number(document.getElementById('currentPercent').value||0);
            const notes = document.getElementById('targetNotes').value.trim();
            if (!name) { alert('Name is required'); return; }
            const items = JSON.parse(localStorage.getItem(targetsStorage()) || '[]');
            const idx = localStorage.getItem('targets.editIndex');
            const entry = { level, name, target, current, notes };
            if (idx) { items[Number(idx)] = entry; } else { items.push(entry); }
            localStorage.setItem(targetsStorage(), JSON.stringify(items));
            resetTargetForm(); renderTargetsTable();
        }
        function editTarget(idx){
            const items = JSON.parse(localStorage.getItem(targetsStorage()) || '[]'); const t = items[idx]; if (!t) return;
            document.getElementById('targetLevel').value = t.level;
            document.getElementById('targetName').value = t.name;
            document.getElementById('targetPercent').value = t.target;
            document.getElementById('currentPercent').value = t.current;
            document.getElementById('targetNotes').value = t.notes || '';
            localStorage.setItem('targets.editIndex', String(idx));
        }
        function deleteTarget(idx){ if (!confirm('Delete this target?')) return; const items = JSON.parse(localStorage.getItem(targetsStorage()) || '[]'); items.splice(idx,1); localStorage.setItem(targetsStorage(), JSON.stringify(items)); renderTargetsTable(); }

        function openCommsPanel(){ const m = document.getElementById('commsModal'); if (m) m.classList.remove('hidden'); }
        function closeCommsPanel(){ const m = document.getElementById('commsModal'); if (m) m.classList.add('hidden'); }
        function clearCommunicationsForm(){ ['commsRecipients','commsSubject','commsBody'].forEach(id => { const el=document.getElementById(id); if (el) el.value=''; }); document.getElementById('commsStatus').textContent=''; }
        function sendCommunications(){
            const recipients = (document.getElementById('commsRecipients').value||'').split(',').map(s=>s.trim()).filter(Boolean);
            const subject = (document.getElementById('commsSubject').value||'').trim();
            const body = (document.getElementById('commsBody').value||'').trim();
            const status = document.getElementById('commsStatus');
            if (!recipients.length || !subject || !body) { alert('Recipients, subject, and body are required'); return; }
            // Post to Market board chat
            try {
                const key = storageKey('market');
                const items = JSON.parse(localStorage.getItem(key) || '[]');
                items.push({ text: `[Comms] ${subject}: ${body}`, category: 'general', by: currentUser?.name || '', at: new Date().toISOString() });
                localStorage.setItem(key, JSON.stringify(items));
            } catch (e) { /* noop */ }
            // Send emails via backend if available
            if (hasAppsScript()) {
                try {
                    google.script.run
                        .withSuccessHandler(function(){ status.textContent = 'Email sent successfully.'; })
                        .withFailureHandler(function(err){ status.textContent = 'Email failed: ' + err; })
                        .sendCommunicationEmail(recipients, subject, body);
                } catch(e){ status.textContent = 'Backend error'; }
            } else {
                status.textContent = 'Local preview: email not sent; message posted to Market chat.';
            }
        }

        function generateDirectorReport(){
            // Export CSVs: cohorts, trainings, targets, rollout
            try {
                const cohorts = JSON.parse(localStorage.getItem(cohortsStorage())||'[]');
                const trainings = JSON.parse(localStorage.getItem(trainingsStorage())||'[]');
                const targets = JSON.parse(localStorage.getItem(targetsStorage())||'[]');
                const makeCsv = (header, rows) => [header].concat(rows).map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
                const dl = (name, text) => { const blob = new Blob([text], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000); };
                dl('cohorts.csv', makeCsv(['Name','Level','Owner','Status','Notes'], cohorts.map(c=>[c.name,c.level,c.owner,c.status,c.notes||''])));
                dl('trainings.csv', makeCsv(['Title','Date','Time','Audience','Location','Notes'], trainings.map(t=>[t.title,t.date,t.time||'',t.audience||'',t.location||'',t.notes||''])));
                dl('targets.csv', makeCsv(['Level','Name','Target','Current','Notes'], targets.map(t=>[t.level,t.name,String(t.target||''),String(t.current||''),t.notes||''])));
                // Rollout CSV via existing function if table present
                try { exportRolloutCsv(); } catch(e) { /* noop */ }
                // Optional broadcast per Director preference
                try {
                    const raw = localStorage.getItem('director.settings');
                    const s = raw ? JSON.parse(raw) : null;
                    if (s && s.broadcastOnReport) {
                        const key = storageKey('market');
                        const items = JSON.parse(localStorage.getItem(key) || '[]');
                        items.push({ text: '[Broadcast] Director report generated', category: 'general', by: (currentUser?.name || ''), at: new Date().toISOString() });
                        localStorage.setItem(key, JSON.stringify(items));
                    }
                } catch(e) { /* noop */ }
            } catch (e) { alert('CSV export failed'); }
            // PDF summary (preview): open printable window
            try {
                const w = window.open('', 'report');
                const cohorts = JSON.parse(localStorage.getItem(cohortsStorage())||'[]');
                const trainings = JSON.parse(localStorage.getItem(trainingsStorage())||'[]');
                const targets = JSON.parse(localStorage.getItem(targetsStorage())||'[]');
                const d = window.lastDirectorData || {};
                const html = `<!doctype html><html><head><meta charset="utf-8"><title>Director Report</title><style>body{font-family:sans-serif;padding:16px}h2{margin-top:24px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ccc;padding:6px;font-size:12px}th{background:#f9f9f9}</style></head><body>
                <h1>Market Sales & Operations Systems Director Report</h1>
                    <p>Date: ${new Date().toLocaleString()}</p>
                    <h2>Cohorts</h2>
                    <table><thead><tr><th>Name</th><th>Level</th><th>Owner</th><th>Status</th><th>Notes</th></tr></thead><tbody>
                        ${cohorts.map(c=>`<tr><td>${escapeHtml(c.name)}</td><td>${escapeHtml(c.level)}</td><td>${escapeHtml(c.owner)}</td><td>${escapeHtml(c.status)}</td><td>${escapeHtml(c.notes||'')}</td></tr>`).join('')}
                    </tbody></table>
                    <h2>Training Sessions</h2>
                    <table><thead><tr><th>Title</th><th>Date</th><th>Time</th><th>Audience</th><th>Location</th><th>Notes</th></tr></thead><tbody>
                        ${trainings.map(t=>`<tr><td>${escapeHtml(t.title)}</td><td>${escapeHtml(t.date)}</td><td>${escapeHtml(t.time||'')}</td><td>${escapeHtml(t.audience||'')}</td><td>${escapeHtml(t.location||'')}</td><td>${escapeHtml(t.notes||'')}</td></tr>`).join('')}
                    </tbody></table>
                    <h2>Adoption Targets</h2>
                    <table><thead><tr><th>Level</th><th>Name</th><th>Target</th><th>Current</th><th>Notes</th></tr></thead><tbody>
                        ${targets.map(t=>`<tr><td>${escapeHtml(t.level)}</td><td>${escapeHtml(t.name)}</td><td>${escapeHtml(String(t.target||''))}%</td><td>${escapeHtml(String(t.current||''))}%</td><td>${escapeHtml(t.notes||'')}</td></tr>`).join('')}
                    </tbody></table>
                    <h2>Rollout Summary</h2>
                    <p>${escapeHtml(JSON.stringify(d.totals||{}))}</p>
                    </body></html>`;
                w.document.write(html); w.document.close(); w.focus();
                // Instruct user to Save as PDF via print dialog
                setTimeout(()=>{ try { w.print(); } catch(e){} }, 500);
            } catch(e) { alert('PDF summary failed to open'); }
        }
        function getMockDirectorRolloutData() {
            return {
                totals: {
                    branches: { onboarded: 12, total: 20 },
                    areas: { onboarded: 4, total: 6 },
                    regions: { onboarded: 2, total: 4 },
                    markets: { onboarded: 1, total: 3 }
                },
                status: {
                    pipeline: 'Cohort 2 scheduling, training materials updated',
                    blockers: ['Branch packet backlog in NE', 'Calendar invites pending for SE area'],
                    nextActions: ['Finalize Region West training dates', 'Confirm owners for 3 remaining branches']
                },
                rows: [
                    { market: 'North', region: 'West', area: 'Bay Area', branch: 'San Jose', owner: 'A. Lee', phase: 'Training', adoption: 75, notes: 'Great momentum' },
                    { market: 'North', region: 'West', area: 'Bay Area', branch: 'Oakland', owner: 'B. Kim', phase: 'Onboarding', adoption: 40, notes: 'Packet prep' },
                    { market: 'North', region: 'Central', area: 'Dallas Metro', branch: 'Plano', owner: 'C. Diaz', phase: 'Live', adoption: 95, notes: 'Fully adopted' },
                    { market: 'South', region: 'SE', area: 'Atlanta Metro', branch: 'Decatur', owner: 'D. Patel', phase: 'Scheduling', adoption: 10, notes: 'Awaiting dates' }
                ]
            };
        }
        function exportRolloutCsv() {
            try {
                const root = document.getElementById('dashboardContent');
                const rows = Array.from(root.querySelectorAll('tbody tr')).map(tr => Array.from(tr.querySelectorAll('td')).map(td => td.textContent));
                const header = ['Market','Region','Area','Branch','Owner','Phase','Adoption','Notes'];
                const csv = [header].concat(rows).map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'rollout_overview.csv'; a.click();
                setTimeout(()=>URL.revokeObjectURL(url), 2000);
            } catch(e) {
                console.warn('CSV export failed', e);
                alert('Export failed');
            }
        }

        // Dashboard view preference
        let dashboardViewPref = 'charts';
        let lastExecutiveData = null;
        function loadDashboardViewPreference() {
            const saved = localStorage.getItem('dashboardView') || 'charts';
            dashboardViewPref = saved;
            const sel = document.getElementById('dashboardViewSelector');
            if (sel) sel.value = saved;
            // Load from backend if available
            if (hasAppsScript()) {
                try {
                    google.script.run
                        .withSuccessHandler(function(prefs){
                            if (prefs && prefs.dashboardView) {
                                dashboardViewPref = prefs.dashboardView;
                                if (sel) sel.value = prefs.dashboardView;
                            }
                        })
                        .withFailureHandler(function(err){ console.warn('Pref load failed:', err); })
                        .getUserPreferences();
                } catch(e) { console.warn('Pref load error:', e); }
            }
        }
        function setDashboardViewPreference(val) {
            dashboardViewPref = val || 'charts';
            localStorage.setItem('dashboardView', dashboardViewPref);
            if (hasAppsScript()) {
                try {
                    google.script.run
                        .withFailureHandler(function(err){ console.warn('Pref save failed:', err); })
                        .saveUserPreference('dashboardView', dashboardViewPref);
                } catch(e) { console.warn('Pref save error:', e); }
            }
            // Re-render current dashboard with new preference
            if (typeof currentDashboard !== 'string') return;
            if (currentDashboard === 'branch') {
                loadBranchManagerDashboard();
            } else if (currentDashboard === 'sales') {
                loadSalesDashboard();
            } else if (currentDashboard === 'operations') {
                loadOperationsDashboard();
            } else if (currentDashboard === 'executive') {
                loadExecutiveDashboard();
            }
        }

        // Action menu controls
        function toggleActionMenu() {
            const panel = document.getElementById('actionMenuPanel');
            if (!panel) return;
            const toggleBtn = document.querySelector('button[aria-controls="actionMenuPanel"]');
            const isHidden = panel.classList.contains('hidden');
            if (isHidden) {
                panel.classList.remove('hidden');
                if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'true');
                // Update display badges on open
                try { updateDisplayBadges(); } catch (e) { /* noop */ }
            } else {
                panel.classList.add('hidden');
                if (toggleBtn) {
                    toggleBtn.setAttribute('aria-expanded', 'false');
                    toggleBtn.focus();
                }
            }
        }

        function closeActionMenu() {
            const panel = document.getElementById('actionMenuPanel');
            if (panel) panel.classList.add('hidden');
            const toggleBtn = document.querySelector('button[aria-controls="actionMenuPanel"]');
            if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'false');
            if (toggleBtn) toggleBtn.focus();
        }

        function handleGlobalClickForActionMenu(e) {
            const panel = document.getElementById('actionMenuPanel');
            if (!panel || panel.classList.contains('hidden')) return;
            const button = e.target.closest('button');
            const inMenu = e.target.closest('#actionMenuPanel');
            const isToggle = button && button.getAttribute('aria-controls') === 'actionMenuPanel';
            if (!inMenu && !isToggle) closeActionMenu();
        }

        // Quick Actions drawer controls
        function openQuickActions() {
            const overlay = document.getElementById('quickActionsOverlay');
            const drawer = document.getElementById('quickActionsDrawer');
            if (!overlay || !drawer) return;
            overlay.classList.remove('hidden');
            drawer.classList.remove('translate-x-full');
            try { updateQuickActionsCounts(); } catch (e) { console.warn('updateQuickActionsCounts failed:', e); }
        }

        function closeQuickActions() {
            const overlay = document.getElementById('quickActionsOverlay');
            const drawer = document.getElementById('quickActionsDrawer');
            if (!overlay || !drawer) return;
            drawer.classList.add('translate-x-full');
            overlay.classList.add('hidden');
        }

        // Global listeners for menu accessibility
        document.addEventListener('click', handleGlobalClickForActionMenu);
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeActionMenu();
        });

        // Escape exits Presentation Mode if active
        document.addEventListener('keydown', function(e) {
            try {
                if (e.key === 'Escape' && presentationMode) {
                    togglePresentationMode();
                }
            } catch (err) { /* noop */ }
        });

        // Settings Panel Functions

        // Utility: compute default modal size to show content within viewport
        function setModalDefaultSize(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                const box = modal.querySelector('.modal-window');
                if (!box) return;
                const content = box.querySelector('.p-6, .p-4, .space-y-4, .modal-body-scroll') || box;
                const header = box.querySelector('.border-b, .modal-header');
                const footer = box.querySelector('#settingsFooter, #jobAssignmentFooter, .modal-footer');
                const headerH = header ? header.offsetHeight : 0;
                const footerH = footer ? footer.offsetHeight : 0;
                const desiredH = content.scrollHeight + headerH + footerH + 16;
                const desiredW = Math.max(content.scrollWidth + 32, 600);
                const height = Math.min(Math.max(desiredH, 480), Math.floor(window.innerHeight * 0.9));
                const width = Math.min(Math.max(desiredW, 640), Math.floor(window.innerWidth * 0.9));
                box.style.setProperty('--modal-height', height + 'px');
                box.style.setProperty('--modal-width', width + 'px');
                // Ensure explicit size for resize operations
                box.style.height = height + 'px';
                box.style.width = width + 'px';
                box.style.maxWidth = Math.floor(window.innerWidth * 0.95) + 'px';
                box.style.maxHeight = Math.floor(window.innerHeight * 0.95) + 'px';
            } catch (err) { /* noop */ }
        }

        // Enable drag-to-move for modal windows. Allows drag from any non-input area.
        function enableModalDrag(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                const box = modal.querySelector('.modal-window');
                if (!box) return;
                if (box.__dragInit) return; // prevent double-binding
                // Prefer a header area for cursor style, but bind drag on entire box
                let headerHandle = box.querySelector('.border-b');
                if (!headerHandle) {
                    const h = box.querySelector('h2, h3');
                    headerHandle = h ? h.parentElement : null;
                }
                if (headerHandle) headerHandle.style.cursor = 'move';
                let dragging = false;
                let startX = 0, startY = 0, origLeft = 0, origTop = 0, boxW = 0, boxH = 0;
                const onDown = (e) => {
                    const target = e.target;
                    const tag = (target && target.tagName) ? target.tagName.toUpperCase() : '';
                    if (['INPUT','TEXTAREA','SELECT','BUTTON','A','LABEL'].includes(tag)) return; // don't drag from interactive controls
                    const isLeftButton = (e.button === 0 || e.buttons === 1 || e.type === 'touchstart');
                    if (!isLeftButton) return;
                    dragging = true;
                    const rect = box.getBoundingClientRect();
                    boxW = rect.width; boxH = rect.height;
                    startX = (e.touches ? e.touches[0].clientX : e.clientX);
                    startY = (e.touches ? e.touches[0].clientY : e.clientY);
                    origLeft = rect.left; origTop = rect.top;
                    box.style.position = 'fixed';
                    box.style.margin = '0';
                    e.preventDefault();
                };
                const onMove = (e) => {
                    if (!dragging) return;
                    const x = (e.touches ? e.touches[0].clientX : e.clientX);
                    const y = (e.touches ? e.touches[0].clientY : e.clientY);
                    let left = origLeft + (x - startX);
                    let top = origTop + (y - startY);
                    const maxL = Math.max(0, window.innerWidth - boxW);
                    const maxT = Math.max(0, window.innerHeight - boxH);
                    if (left < 0) left = 0; if (top < 0) top = 0;
                    if (left > maxL) left = maxL; if (top > maxT) top = maxT;
                    box.style.left = left + 'px';
                    box.style.top = top + 'px';
                };
                const onUp = () => { dragging = false; };
                box.addEventListener('mousedown', onDown);
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
                box.addEventListener('touchstart', onDown, { passive: false });
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', onUp);
                box.__dragInit = true;
            } catch (err) { /* noop */ }
        }

        // Reset modal inline position to allow re-centering by overlay flex
        function resetModalPosition(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                const box = modal.querySelector('.modal-window');
                if (!box) return;
                box.style.position = '';
                box.style.top = '';
                box.style.left = '';
                box.style.margin = '';
                box.style.width = '';
                box.style.height = '';
            } catch (err) { /* noop */ }
        }

        // Enable resize from all edges and corners with larger hit areas.
        function enableModalResize(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                const box = modal.querySelector('.modal-window');
                if (!box) return;
                if (box.__resizeInit) return;
                box.style.position = box.style.position || 'relative';

                const dirs = ['n','s','e','w','ne','nw','se','sw'];
                const minW = 480, minH = 360;
                const edge = 12;       // edge handle thickness (px)
                const corner = 18;     // corner handle size (px)
                let resizing = false;
                let activeDir = null;
                let startX=0, startY=0, startW=0, startH=0, startLeft=0, startTop=0;

                const makeHandle = (dir) => {
                    const h = document.createElement('div');
                    h.className = 'modal-resize-handle modal-resize-' + dir;
                    h.style.position = 'absolute';
                    h.style.background = 'transparent';
                    h.style.touchAction = 'none';
                    h.style.zIndex = '60';
                    if (dir === 'n') { h.style.top='0'; h.style.left='0'; h.style.right='0'; h.style.height=edge+'px'; h.style.cursor='ns-resize'; }
                    if (dir === 's') { h.style.bottom='0'; h.style.left='0'; h.style.right='0'; h.style.height=edge+'px'; h.style.cursor='ns-resize'; }
                    if (dir === 'e') { h.style.right='0'; h.style.top='0'; h.style.bottom='0'; h.style.width=edge+'px'; h.style.cursor='ew-resize'; }
                    if (dir === 'w') { h.style.left='0'; h.style.top='0'; h.style.bottom='0'; h.style.width=edge+'px'; h.style.cursor='ew-resize'; }
                    if (dir === 'ne') { h.style.top='0'; h.style.right='0'; h.style.width=corner+'px'; h.style.height=corner+'px'; h.style.cursor='nesw-resize'; }
                    if (dir === 'nw') { h.style.top='0'; h.style.left='0'; h.style.width=corner+'px'; h.style.height=corner+'px'; h.style.cursor='nwse-resize'; }
                    if (dir === 'se') { h.style.bottom='0'; h.style.right='0'; h.style.width=corner+'px'; h.style.height=corner+'px'; h.style.cursor='nwse-resize'; }
                    if (dir === 'sw') { h.style.bottom='0'; h.style.left='0'; h.style.width=corner+'px'; h.style.height=corner+'px'; h.style.cursor='nesw-resize'; }

                    // Add a thin brand-colored glow line flush to the edge
                    const glow = document.createElement('div');
                    glow.className = 'modal-resize-glow';
                    if (dir === 'n') { glow.style.top='0'; glow.style.left='0'; glow.style.right='0'; glow.style.height='1px'; }
                    if (dir === 's') { glow.style.bottom='0'; glow.style.left='0'; glow.style.right='0'; glow.style.height='1px'; }
                    if (dir === 'e') { glow.style.right='0'; glow.style.top='0'; glow.style.bottom='0'; glow.style.width='1px'; }
                    if (dir === 'w') { glow.style.left='0'; glow.style.top='0'; glow.style.bottom='0'; glow.style.width='1px'; }
                    if (dir === 'ne') { /* show both adjacent edges */
                        const v = document.createElement('div'); v.className='modal-resize-glow'; v.style.top='0'; v.style.right='0'; v.style.height='1px'; v.style.left='0';
                        const u = document.createElement('div'); u.className='modal-resize-glow'; u.style.top='0'; u.style.right='0'; u.style.width='1px'; u.style.bottom='0'; u.style.top='0';
                        h.appendChild(v); h.appendChild(u);
                    }
                    if (dir === 'nw') {
                        const v = document.createElement('div'); v.className='modal-resize-glow'; v.style.top='0'; v.style.left='0'; v.style.height='1px'; v.style.right='0';
                        const u = document.createElement('div'); u.className='modal-resize-glow'; u.style.top='0'; u.style.left='0'; u.style.width='1px'; u.style.bottom='0'; u.style.top='0';
                        h.appendChild(v); h.appendChild(u);
                    }
                    if (dir === 'se') {
                        const v = document.createElement('div'); v.className='modal-resize-glow'; v.style.bottom='0'; v.style.left='0'; v.style.height='1px'; v.style.right='0';
                        const u = document.createElement('div'); u.className='modal-resize-glow'; u.style.bottom='0'; u.style.right='0'; u.style.width='1px'; u.style.top='0'; u.style.bottom='0';
                        h.appendChild(v); h.appendChild(u);
                    }
                    if (dir === 'sw') {
                        const v = document.createElement('div'); v.className='modal-resize-glow'; v.style.bottom='0'; v.style.left='0'; v.style.height='1px'; v.style.right='0';
                        const u = document.createElement('div'); u.className='modal-resize-glow'; u.style.bottom='0'; u.style.left='0'; u.style.width='1px'; u.style.top='0'; u.style.bottom='0';
                        h.appendChild(v); h.appendChild(u);
                    }
                    if (['n','s','e','w'].includes(dir)) h.appendChild(glow);

                    const onDown = (e) => {
                        resizing = true; activeDir = dir;
                        startX = e.touches ? e.touches[0].clientX : e.clientX;
                        startY = e.touches ? e.touches[0].clientY : e.clientY;
                        const rect = box.getBoundingClientRect();
                        startW = rect.width; startH = rect.height;
                        startLeft = parseFloat(box.style.left || '0');
                        startTop = parseFloat(box.style.top || '0');
                        e.preventDefault();
                    };
                    h.addEventListener('mousedown', onDown);
                    h.addEventListener('touchstart', onDown, { passive: false });
                    box.appendChild(h);
                };

                dirs.forEach(makeHandle);

                const clamp = (val, min, max) => Math.max(min, Math.min(max, val));

                const onMove = (e) => {
                    if (!resizing || !activeDir) return;
                    const x = e.touches ? e.touches[0].clientX : e.clientX;
                    const y = e.touches ? e.touches[0].clientY : e.clientY;
                    const dx = x - startX;
                    const dy = y - startY;
                    let w = startW;
                    let h = startH;
                    let left = startLeft;
                    let top = startTop;
                    const maxW = Math.floor(window.innerWidth * 0.95);
                    const maxH = Math.floor(window.innerHeight * 0.95);

                    if (activeDir.includes('e')) { w = startW + dx; }
                    if (activeDir.includes('s')) { h = startH + dy; }
                    if (activeDir.includes('w')) { w = startW - dx; left = startLeft + dx; }
                    if (activeDir.includes('n')) { h = startH - dy; top = startTop + dy; }

                    w = clamp(w, minW, maxW);
                    h = clamp(h, minH, maxH);
                    left = Math.max(0, Math.min(left, window.innerWidth - w));
                    top = Math.max(0, Math.min(top, window.innerHeight - h));

                    box.style.width = w + 'px';
                    box.style.height = h + 'px';
                    box.style.left = left + 'px';
                    box.style.top = top + 'px';
                    box.style.setProperty('--modal-width', w + 'px');
                    box.style.setProperty('--modal-height', h + 'px');
                };
                const onUp = () => { resizing = false; activeDir = null; };
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', onUp);
                box.__resizeInit = true;
            } catch (err) { /* noop */ }
        }

        // New Settings Modal (dark) helpers
        function openSettingsModal() {
            try { closeActionMenu(); } catch(_) { /* noop */ }
            const overlay = document.getElementById('dashboardSettingsModal');
            const modalEl = document.getElementById('settingsModalContainer');
            if (!overlay || !modalEl) return;
            overlay.classList.remove('hidden');
            try { document.body.style.overflow = 'hidden'; } catch(_) { /* noop */ }
            switchSettingsTab('widgets');
            try { populateWidgetLibraryGrid(); } catch(_) { /* noop */ }
            // Initialize corrected drag & resize logic once
            try {
                if (!window._settingsDragInit) {
                    makeModalDraggableAndResizable('settingsModalContainer', 'settingsModalHeader', 'settingsResizeHandle');
                    window._settingsDragInit = true;
                }
            } catch(_) { /* noop */ }
        }

        function closeSettingsModal() {
            const overlay = document.getElementById('dashboardSettingsModal');
            if (!overlay) return;
            overlay.classList.add('hidden');
            try { document.body.style.overflow = ''; } catch(_) { /* noop */ }
        }

        // Dashboard Customizer modal helpers (renamed from Settings)
        function openDashboardCustomizer() {
            try { closeActionMenu(); } catch(_) { /* noop */ }
            const overlay = document.getElementById('dashboardCustomizerModal');
            const modalEl = document.getElementById('dashboardCustomizerContainer');
            if (!overlay || !modalEl) return;
            overlay.classList.remove('hidden');
            try { document.body.style.overflow = 'hidden'; } catch(_) { /* noop */ }
            try { switchSettingsTab('widgets'); } catch(_) { /* noop */ }
            try {
                if (!window._settingsDragInit) {
                    makeModalDraggableAndResizable('dashboardCustomizerContainer', 'dashboardCustomizerHeader', 'dashboardCustomizerResizeHandle');
                    window._settingsDragInit = true;
                }
            } catch(_) { /* noop */ }
        }

        function closeDashboardCustomizer() {
            const overlay = document.getElementById('dashboardCustomizerModal');
            if (!overlay) return;
            overlay.classList.add('hidden');
            try { document.body.style.overflow = ''; } catch(_) { /* noop */ }
        }

        // Corrected drag & resize behavior for Settings modal
        function makeModalDraggableAndResizable(modalId, headerId, resizeHandleId) {
          const modal = document.getElementById(modalId);
          const header = document.getElementById(headerId);
          const resizeHandle = document.getElementById(resizeHandleId);

          if (!modal || !header) return;

          // --- DRAGGING LOGIC (FIXED) ---
          let isDragging = false;
          let dragStartX = 0;
          let dragStartY = 0;
          let modalStartX = 0;
          let modalStartY = 0;

          header.addEventListener('mousedown', (e) => {
            // Don't drag when clicking buttons, inputs, or selects
            if (e.target.closest('button') || e.target.closest('input') || e.target.closest('select')) {
              return;
            }

            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;

            // Get current position (handle both centered and positioned modals)
            const rect = modal.getBoundingClientRect();
            modalStartX = rect.left;
            modalStartY = rect.top;

            // Remove transitions and transform during drag
            modal.style.transition = 'none';
            modal.style.transform = 'none';

            // Change cursor
            header.style.cursor = 'grabbing';

            // Prevent text selection
            e.preventDefault();
          });

          document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            e.preventDefault(); // Prevent any default behavior

            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;

            const newLeft = modalStartX + deltaX;
            const newTop = modalStartY + deltaY;

            // Keep modal within viewport bounds
            const maxX = window.innerWidth - modal.offsetWidth;
            const maxY = window.innerHeight - modal.offsetHeight;

            modal.style.left = Math.max(0, Math.min(newLeft, maxX)) + 'px';
            modal.style.top = Math.max(0, Math.min(newTop, maxY)) + 'px';
          });

          document.addEventListener('mouseup', () => {
            if (isDragging) {
              isDragging = false;
              header.style.cursor = 'move';
              // Don't add transition back - keep it smooth
            }
          });

          // --- RESIZING LOGIC (FIXED) ---
          if (!resizeHandle) return;

          let isResizing = false;
          let resizeStartX = 0;
          let resizeStartY = 0;
          let startWidth = 0;
          let startHeight = 0;

          resizeHandle.addEventListener('mousedown', (e) => {
            e.stopPropagation(); // Critical: don't trigger drag
            e.preventDefault();

            isResizing = true;
            resizeStartX = e.clientX;
            resizeStartY = e.clientY;
            startWidth = modal.offsetWidth;
            startHeight = modal.offsetHeight;

            // Prevent any transitions during resize
            modal.style.transition = 'none';
          });

          document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            e.preventDefault();
            e.stopPropagation();

            const deltaX = e.clientX - resizeStartX;
            const deltaY = e.clientY - resizeStartY;

            // Calculate new dimensions with min/max constraints
            const minWidth = parseInt(modal.style.minWidth) || 600;
            const minHeight = parseInt(modal.style.minHeight) || 400;
            const maxWidth = window.innerWidth - 40;
            const maxHeight = window.innerHeight - 40;

            const newWidth = Math.max(minWidth, Math.min(startWidth + deltaX, maxWidth));
            const newHeight = Math.max(minHeight, Math.min(startHeight + deltaY, maxHeight));

            modal.style.width = newWidth + 'px';
            modal.style.height = newHeight + 'px';
          });

          document.addEventListener('mouseup', (e) => {
            if (isResizing) {
              isResizing = false;
              e.preventDefault();
              e.stopPropagation();
              // Don't close modal on resize release
            }
          });

          // Prevent click events from bubbling during resize
          resizeHandle.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
          });
        }

        function openSettingsPanel() {
            // Restore legacy Settings sidebar/panel behavior
            try { closeActionMenu(); } catch(_) { /* noop */ }
            const legacy = document.getElementById('settingsModal');
            if (legacy) {
                legacy.classList.remove('hidden');
                try { document.body.style.overflow = 'hidden'; } catch(_) { /* noop */ }
                try { setModalDefaultSize('settingsModal'); } catch(_) { /* noop */ }
                try { enableModalDrag('settingsModal'); } catch(_) { /* noop */ }
                try { if (typeof loadCurrentSettings === 'function') loadCurrentSettings(); } catch(_) { /* noop */ }
            }
        }

        function closeSettingsPanel() {
            // Close legacy Settings sidebar/panel
            const legacy = document.getElementById('settingsModal');
            if (legacy) {
                legacy.classList.add('hidden');
                try { document.body.style.overflow = ''; } catch(e) { /* noop */ }
                try { resetModalPosition('settingsModal'); } catch(_) { /* noop */ }
            }
        }

        // Sidebar Icon Settings
        const SIDEBAR_ICON_KEYS = ['sales','operations','branch','area','region','market','director','drive','calendar','gmail'];
        const SIDEBAR_ALLOW_DUPLICATES = true; // Allow using the same icon across multiple sidebar entries
        const ICON_CHOICES = [
            { name: 'Beetle', emoji: 'ðŸª²' },
            { name: 'Cricket', emoji: 'ðŸ¦—' },
            { name: 'Cockroach', emoji: 'ðŸª³' },
            { name: 'Ladybug', emoji: 'ðŸž' },
            { name: 'Spider', emoji: 'ðŸ•·ï¸' },
            { name: 'Bug', emoji: 'ðŸ›' },
            { name: 'Ant', emoji: 'ðŸœ' },
            { name: 'Termite', emoji: 'ðŸ›' },
            { name: 'Fire Ant (image)', pestName: 'fireAnt', emoji: 'ðŸœ' },
            { name: 'Termite (image)', pestName: 'termite', emoji: 'ðŸ›' },
            { name: 'Mosquito', emoji: 'ðŸ¦Ÿ' },
            { name: 'Butterfly', emoji: 'ðŸ¦‹' },
            { name: 'Bee / Wasp', emoji: 'ðŸ' },
            { name: 'Bee (image)', pestName: 'bee', emoji: 'ðŸ' },
            { name: 'Wasp', emoji: 'ðŸ' },
            { name: 'Wasp (image)', pestName: 'hornet', emoji: 'ðŸ' },
            { name: 'Bait Station (image)', pestName: 'baitStation', emoji: 'ðŸª¤' },
            { name: 'Fly', emoji: 'ðŸª°' },
            { name: 'Worm', emoji: 'ðŸª±' },
            { name: 'Scorpion', emoji: 'ðŸ¦‚' },
            { name: 'Snake', emoji: 'ðŸ' },
            { name: 'Lizard', emoji: 'ðŸ¦Ž' },
            { name: 'Mantis (approx.)', emoji: 'ðŸ¦—' },
            { name: 'Bait Station', emoji: 'ðŸª¤' }
        ];

        function getSidebarIconConfig() {
            try {
                const raw = localStorage.getItem('sidebarIconConfig');
                return raw ? JSON.parse(raw) : {};
            } catch (e) { return {}; }
        }

        function setSidebarIconConfig(cfg) {
            try { localStorage.setItem('sidebarIconConfig', JSON.stringify(cfg)); } catch (e) { /* noop */ }
        }

        // Sidebar/Dashboard icon size settings
        function getSidebarIconSizeSetting(){
            try {
                const v = parseInt(localStorage.getItem('icons.sidebar.size'), 10);
                return Number.isFinite(v) && v > 0 ? v : 32;
            } catch(_) { return 32; }
        }
        function setSidebarIconSizeSetting(px){
            const clamped = Math.max(20, Math.min(64, parseInt(px,10) || 32));
            try { localStorage.setItem('icons.sidebar.size', String(clamped)); } catch(_) { /* noop */ }
            try { applySidebarIcons(); } catch(_) { /* noop */ }
            try {
                SIDEBAR_ICON_KEYS.forEach(key => {
                    const select = document.getElementById('sidebarIcon-' + key);
                    const val = select ? select.value : undefined;
                    renderSidebarIconPreview(key, val);
                });
            } catch(_) { /* noop */ }
        }
        function getDashboardIconSizeSetting(){
            try {
                const v = parseInt(localStorage.getItem('icons.dashboard.size'), 10);
                return Number.isFinite(v) && v > 0 ? v : 48;
            } catch(_) { return 48; }
        }
        function setDashboardIconSizeSetting(px){
            const clamped = Math.max(28, Math.min(96, parseInt(px,10) || 48));
            try { localStorage.setItem('icons.dashboard.size', String(clamped)); } catch(_) { /* noop */ }
            try {
                const sel = document.getElementById('dashboardIconOverride');
                if (sel) renderDashboardIconPreview(sel.value);
            } catch(_) { /* noop */ }
            try { if (typeof currentDashboard === 'string') updateDashboardTitleIcon(currentDashboard); } catch(_) { /* noop */ }
            try { applyDashboardIconSizeToSlot(); } catch(_) { /* noop */ }
        }

        // Enforce configured size on the live dashboard title icon slot
        function applyDashboardIconSizeToSlot(){
            const size = getDashboardIconSizeSetting();
            const slot = document.getElementById('dashboardTitleIcon');
            if (!slot) return;
            // Brand PNG
            const brandImg = slot.querySelector('.brand-icon img');
            if (brandImg) {
                brandImg.style.width = size + 'px';
                brandImg.style.height = size + 'px';
                const wrapper = brandImg.closest('.brand-icon');
                if (wrapper) wrapper.style.setProperty('--icon-size', size + 'px');
            }
            // Pest SVG
            const pestEl = slot.querySelector('[data-icon-name], .brand-icon-container');
            if (pestEl) {
                pestEl.style.width = size + 'px';
                pestEl.style.height = size + 'px';
            }
            // Emoji fallback
            const emojiSpan = slot.querySelector('span.text-2xl, span.text-xl, span');
            if (emojiSpan && !brandImg && !pestEl) {
                emojiSpan.style.fontSize = Math.round(size * 0.9) + 'px';
                emojiSpan.style.lineHeight = '1';
            }
        }

        // Observe icon changes in the dashboard slot and re-apply size
        function ensureDashboardIconSizeObserver(){
            const slot = document.getElementById('dashboardTitleIcon');
            if (!slot) return;
            if (slot.__sizeObserverInstalled) return;
            const mo = new MutationObserver(() => {
                try { applyDashboardIconSizeToSlot(); } catch(_) { /* noop */ }
            });
            mo.observe(slot, { childList: true, subtree: true });
            slot.__sizeObserverInstalled = true;
        }

        // Apply configured size across sidebar icon previews in settings modal
        function applySidebarPreviewSizes(){
            const size = getSidebarIconSizeSetting();
            try {
                SIDEBAR_ICON_KEYS.forEach(key => {
                    const holder = document.getElementById('sidebarIconPreview-' + key);
                    if (!holder) return;
                    const brandImg = holder.querySelector('.brand-icon img');
                    if (brandImg) {
                        brandImg.style.width = size + 'px';
                        brandImg.style.height = size + 'px';
                        const wrapper = brandImg.closest('.brand-icon');
                        if (wrapper) wrapper.style.setProperty('--icon-size', size + 'px');
                    }
                    const pestEl = holder.querySelector('[data-icon-name], .brand-icon-container');
                    if (pestEl) {
                        pestEl.style.width = size + 'px';
                        pestEl.style.height = size + 'px';
                    }
                    const emojiSpan = holder.querySelector('span.text-2xl, span.text-xl, span');
                    if (emojiSpan && !brandImg && !pestEl) {
                        emojiSpan.style.fontSize = Math.round(size * 0.9) + 'px';
                        emojiSpan.style.lineHeight = '1';
                    }
                });
            } catch(_) { /* noop */ }
        }

        // Prefill sidebar defaults for Drive, Calendar, and Gmail to use new image icons
        function ensureSidebarDefaultsWithPestIcons() {
            try {
                const cfg = getSidebarIconConfig();
                let changed = false;
                const defaults = [
                    ['drive','pest:drive'],
                    ['calendar','pest:calendar'],
                    ['gmail','pest:gmail']
                ];
                defaults.forEach(([key, val]) => {
                    if (!cfg[key]) { cfg[key] = val; changed = true; }
                });
                if (changed) {
                    setSidebarIconConfig(cfg);
                    try { applySidebarIcons(); } catch(e) { /* noop */ }
                    try { loadSidebarIconSettings(); } catch(e) { /* noop */ }
                }
            } catch(e) { /* noop */ }
        }

        function populateIconSelect(select) {
            if (!select) return;
            select.innerHTML = '';
            const added = new Set();
            const byValue = new Map();
            ICON_CHOICES.forEach(choice => {
                const opt = document.createElement('option');
                opt.value = choice.pestName ? ('pest:' + choice.pestName) : choice.emoji;
                opt.textContent = `${choice.emoji} ${choice.name}`;
                select.appendChild(opt);
                added.add(opt.value);
                byValue.set(opt.value, opt);
            });
            // Also add any registered image icons so they are always available
            try {
                const icons = window.pestIcons || {};
                Object.entries(icons).forEach(([name, spec]) => {
                    if (spec && spec.type === 'img') {
                        const val = 'pest:' + name;
                        // Avoid duplicating the "(image)" suffix if displayName already includes it
                        const base = spec.displayName ? spec.displayName : toTitleWithSpaces(name) + ' (image)';
                        const text = `ðŸ–¼ï¸ ${base}`;
                        if (!added.has(val)) {
                            const opt = document.createElement('option');
                            opt.value = val;
                            opt.textContent = text;
                            select.appendChild(opt);
                            added.add(val);
                            byValue.set(val, opt);
                        } else {
                            // If an existing choice was a generic label, update it to reflect the registered image name
                            const existingOpt = byValue.get(val);
                            if (existingOpt) existingOpt.textContent = text;
                        }
                    }
                });
            } catch(e) { /* noop */ }
        }

        function currentEmojiForNav(key) {
            const btn = document.getElementById('nav-' + key);
            if (!btn) return 'ðŸª²';
            // Support both original and enlarged emoji classes
            const emojiEl = btn.querySelector('.inline-flex > span.text-xl, .inline-flex > span.text-2xl');
            if (emojiEl) return (emojiEl.textContent || 'ðŸª²').trim();
            // Fallback to any previously stored emoji value
            if (btn.dataset && btn.dataset.iconEmoji) return (btn.dataset.iconEmoji || 'ðŸª²').trim();
            // If SVG exists, default to beetle for conversion
            return 'ðŸª²';
        }

        function loadSidebarIconSettings() {
            const cfg = getSidebarIconConfig();
            SIDEBAR_ICON_KEYS.forEach(key => {
                const select = document.getElementById('sidebarIcon-' + key);
                populateIconSelect(select);
                const val = cfg[key] || currentEmojiForNav(key);
                if (select) select.value = val;
                try { renderSidebarIconPreview(key, select ? select.value : val); } catch(e) { /* noop */ }
            });
            try { enforceUniqueSidebarIcons(); } catch(e) { /* noop */ }
            try {
                const input = document.getElementById('sidebarIconSize');
                const label = document.getElementById('sidebarIconSizeValue');
                if (input) {
                    const sz = getSidebarIconSizeSetting();
                    input.value = sz;
                    if (label) label.textContent = sz + 'px';
                    input.addEventListener('input', function(){
                        const v = parseInt(this.value, 10) || 32;
                        if (label) label.textContent = v + 'px';
                        setSidebarIconSizeSetting(v);
                    });
                }
            } catch(_) { /* noop */ }
            try { applySidebarPreviewSizes(); } catch(_) { /* noop */ }
        }

        function applySidebarIcons() {
            const cfg = getSidebarIconConfig();
            const domKeys = Array.from(document.querySelectorAll('#sidebarNav button[id^="nav-"], nav#sidebarNav button[id^="nav-"], [id^="nav-"]'))
                .map(btn => String(btn.id || '').replace(/^nav-/, ''))
                .filter(Boolean);
            const keys = Array.isArray(SIDEBAR_ICON_KEYS) ? SIDEBAR_ICON_KEYS : [];
            const allKeys = Array.from(new Set([].concat(keys, domKeys)));
            allKeys.forEach(key => {
                const btn = document.getElementById('nav-' + key);
                if (!btn) return;
                let val = cfg[key];
                if (!val) val = currentEmojiForNav(key);
                if (!val || String(val).trim() === '' || String(val).trim() === 'undefined') val = 'ðŸª²';
                // Remove any existing icons inside the visual group to avoid duplicates
                const group = btn.querySelector('.inline-flex') || btn;
                // Remove any previously injected icons, including enlarged emoji variants and native emoji glyphs
                group.querySelectorAll('span.text-xl, span.text-2xl, span[aria-hidden="true"], span[data-render="emoji"], svg, [data-icon-name], .icon, .brand-icon, .brand-icon-container').forEach(el => el.remove());
                const isPest = String(val).startsWith('pest:');
                const sizePx = getSidebarIconSizeSetting();
                if (isPest) {
                    const pestName = String(val).slice(5);
                    const spec = (window.pestIcons || {})[pestName];
                    if (spec) {
                        const brandEl = getPestIconElement(pestName, { size: sizePx, variant: 'primary', fixedColors: true });
                        brandEl.setAttribute('data-icon-name', pestName);
                        group.insertBefore(brandEl, group.firstChild);
                        btn.dataset.iconName = pestName;
                        delete btn.dataset.iconEmoji;
                    } else {
                        // Fallback to emoji if image not yet registered
                        const fallback = 'ðŸœ';
                        const span = document.createElement('span');
                        span.className = 'text-2xl';
                        span.setAttribute('aria-hidden', 'true');
                        span.textContent = fallback;
                        group.insertBefore(span, group.firstChild);
                        btn.dataset.iconEmoji = fallback;
                        delete btn.dataset.iconName;
                    }
                } else {
                    // Prefer registered pest/app image; otherwise render native emoji glyph
                    const pestName = (typeof window.getPestNameFromEmoji === 'function') ? window.getPestNameFromEmoji(val) : null;
                    const hasRegistered = pestName && (window.pestIcons || {})[pestName];
                    if (hasRegistered) {
                        const brandEl = getPestIconElement(pestName, { size: sizePx, variant: 'primary', fixedColors: true });
                        group.insertBefore(brandEl, group.firstChild);
                        btn.dataset.iconName = pestName;
                        delete btn.dataset.iconEmoji;
                    } else {
                        const span = document.createElement('span');
                        span.setAttribute('aria-hidden', 'true');
                        span.setAttribute('data-render', 'emoji');
                        span.textContent = String(val);
                        span.style.fontSize = sizePx + 'px';
                        span.style.lineHeight = 1;
                        group.insertBefore(span, group.firstChild);
                        btn.dataset.iconEmoji = String(val);
                        delete btn.dataset.iconName;
                    }
                }
            });
        }

        function saveSidebarIconSettings() {
            const cfg = {};
            SIDEBAR_ICON_KEYS.forEach(key => {
                const select = document.getElementById('sidebarIcon-' + key);
                if (select) cfg[key] = select.value;
            });
            setSidebarIconConfig(cfg);
            applySidebarIcons();
            try { enforceUniqueSidebarIcons(); } catch(e) { /* noop */ }
        }

        // --- Dashboard Title Icon Override ---
        function getDashboardIconOverride(){
            try { return localStorage.getItem('dashboardIconOverride') || 'inherit'; } catch(e){ return 'inherit'; }
        }

        function setDashboardIconOverride(val){
            try { localStorage.setItem('dashboardIconOverride', String(val || 'inherit')); } catch(e) { /* noop */ }
        }

        function renderDashboardIconPreview(value){
            try {
                const holder = document.getElementById('dashboardIconPreview');
                if (!holder) return;
                holder.innerHTML = '';
                const groupVal = String(value || '').trim();
                if (!groupVal || groupVal === 'inherit') {
                    const msg = document.createElement('span');
                    msg.className = 'text-xs text-gray-500';
                    msg.textContent = 'Inherits active sidebar icon';
                    holder.appendChild(msg);
                    return;
                }
                const size = getDashboardIconSizeSetting();
                if (groupVal.startsWith('pest:')) {
                    const pestName = groupVal.slice(5);
                    const spec = (window.pestIcons || {})[pestName];
                    if (spec) {
                        const el = getPestIconElement(pestName, { size, fixedColors: true });
                        holder.appendChild(el);
                        return;
                    }
                }
                // Non-pest override: render native emoji glyph
                const span = document.createElement('span');
                span.textContent = groupVal;
                span.style.fontSize = size + 'px';
                span.style.lineHeight = 1;
                holder.appendChild(span);
            } catch(e) { /* noop */ }
        }

        function loadDashboardIconOverrideSetting(){
            const select = document.getElementById('dashboardIconOverride');
            if (!select) return;
            // Populate choices: special inherit option plus the same icon choices as sidebar
            select.innerHTML = '';
            const inheritOpt = document.createElement('option');
            inheritOpt.value = 'inherit';
            inheritOpt.textContent = 'â†ªï¸ Same as sidebar (default)';
            select.appendChild(inheritOpt);
            populateIconSelect(select);
            const saved = getDashboardIconOverride();
            select.value = saved;
            try { renderDashboardIconPreview(saved); } catch(e) { /* noop */ }
            select.addEventListener('change', function(){
                try { renderDashboardIconPreview(this.value); } catch(e) { /* noop */ }
            });
        }

        function saveDashboardIconOverride(){
            const select = document.getElementById('dashboardIconOverride');
            if (!select) return;
            setDashboardIconOverride(select.value);
            try { renderDashboardIconPreview(select.value); } catch(e) { /* noop */ }
            try { if (typeof currentDashboard === 'string') updateDashboardTitleIcon(currentDashboard); } catch(e) { /* noop */ }
        }

        // Apply saved icons and populate selects on load
        document.addEventListener('DOMContentLoaded', function() {
            try { applySidebarIcons(); } catch(e) { /* noop */ }
            try { loadSidebarIconSettings(); } catch(e) { /* noop */ }
            try { loadDashboardIconOverrideSetting(); } catch(e) { /* noop */ }
            try {
                const input = document.getElementById('dashboardIconSize');
                const label = document.getElementById('dashboardIconSizeValue');
                if (input) {
                    const sz = getDashboardIconSizeSetting();
                    input.value = sz;
                    if (label) label.textContent = sz + 'px';
                    input.addEventListener('input', function(){
                        const v = parseInt(this.value, 10) || 48;
                        if (label) label.textContent = v + 'px';
                        setDashboardIconSizeSetting(v);
                    });
                }
            } catch(_) { /* noop */ }
            // Enforce uniqueness and react to user changes
            try {
                SIDEBAR_ICON_KEYS.forEach(key => {
                    const select = document.getElementById('sidebarIcon-' + key);
                if (!select) return;
                select.addEventListener('change', () => {
                    try { enforceUniqueSidebarIcons(select); } catch(e) { /* noop */ }
                    try { saveSidebarIconSettings(); } catch(e) { /* noop */ }
                    try { renderSidebarIconPreview(key, select.value); } catch(e) { /* noop */ }
                    try { applySidebarPreviewSizes(); } catch(_) { /* noop */ }
                });
                });
            } catch(e) { /* noop */ }
            try { initPestIconManager(); } catch(e) { /* noop */ }
        });

        // Refresh settings choices when brand assets update (e.g., new image icons registered)
        window.addEventListener('brand:updated', function() {
            try { ensureSidebarDefaultsWithPestIcons(); } catch(e) { /* noop */ }
            try { loadSidebarIconSettings(); } catch(e) { /* noop */ }
            try { enforceUniqueSidebarIcons(); } catch(e) { /* noop */ }
            try { initPestIconManager(); } catch(e) { /* noop */ }
        });

        function renderSidebarIconPreview(key, value){
            try {
                const holder = document.getElementById('sidebarIconPreview-' + key);
                if (!holder) return;
                holder.innerHTML = '';
                const groupVal = String(value || '').trim();
                if (!groupVal) return;
                const size = 34;
                if (groupVal.startsWith('pest:')) {
                    const pestName = groupVal.slice(5);
                    const spec = (window.pestIcons || {})[pestName];
                    if (spec) {
                        const el = getPestIconElement(pestName, { size, fixedColors: true });
                        holder.appendChild(el);
                        return;
                    }
                }
                // Prefer registered pest/app image; otherwise render native emoji glyph
                const pestName = (typeof window.getPestNameFromEmoji === 'function') ? window.getPestNameFromEmoji(groupVal) : null;
                const hasRegistered = pestName && (window.pestIcons || {})[pestName];
                if (hasRegistered) {
                    const el = getPestIconElement(pestName, { size, fixedColors: true });
                    holder.appendChild(el);
                    return;
                }
                const span = document.createElement('span');
                span.textContent = groupVal;
                span.style.fontSize = size + 'px';
                span.style.lineHeight = 1;
                holder.appendChild(span);
            } catch(e) { /* noop */ }
        }

        // Ensure no two sidebar icons repeat; disable duplicates and auto-adjust
        function enforceUniqueSidebarIcons(lastChangedSelect) {
            if (SIDEBAR_ALLOW_DUPLICATES) {
                // Ensure all options are enabled; do not auto-adjust selections
                const selects = SIDEBAR_ICON_KEYS
                    .map(key => document.getElementById('sidebarIcon-' + key))
                    .filter(Boolean);
                selects.forEach(sel => {
                    Array.from(sel.options).forEach(opt => { opt.disabled = false; });
                });
                return;
            }
            const selects = SIDEBAR_ICON_KEYS
                .map(key => document.getElementById('sidebarIcon-' + key))
                .filter(Boolean);
            const used = new Map();
            selects.forEach(sel => {
                const v = sel.value;
                if (!used.has(v)) used.set(v, []);
                used.get(v).push(sel);
            });
            // Disable options already chosen elsewhere
            const chosenValues = Array.from(used.keys());
            selects.forEach(sel => {
                Array.from(sel.options).forEach(opt => {
                    opt.disabled = chosenValues.includes(opt.value) && opt.value !== sel.value;
                });
            });
            // Auto-fix any duplicates except the last changed one
            used.forEach((list, value) => {
                if (list.length > 1) {
                    // Keep the lastChangedSelect (if provided) or the first select; adjust others
                    const keep = lastChangedSelect && list.includes(lastChangedSelect) ? lastChangedSelect : list[0];
                    list.forEach(sel => {
                        if (sel === keep) return;
                        const next = Array.from(sel.options).find(opt => !opt.disabled);
                        if (next && next.value !== sel.value) {
                            sel.value = next.value;
                        }
                    });
                }
            });
        }

        // Reset Layout: unhide sidebar, exit presentation/mail focus, close overlays, clear UI prefs
        function resetLayout() {
            try {
                // Exit presentation mode if active
                if (presentationMode) {
                    togglePresentationMode();
                } else {
                    document.body.classList.remove('presentation-mode');
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) sidebar.classList.remove('hidden');
                    const mc = document.getElementById('mainContent');
                    if (mc) {
                        mc.classList.remove('ml-0');
                        mc.classList.add('ml-64');
                    }
                    try { if (document.exitFullscreen) document.exitFullscreen(); } catch(e) { /* noop */ }
                    try { if (typeof stopAutoRefresh === 'function') stopAutoRefresh(); } catch(e) { /* noop */ }
                }
            } catch(e) { /* noop */ }
            try {
                // Restore menus and overlays to a known state
                if (typeof closeActionMenu === 'function') closeActionMenu();
                if (typeof closeQuickActions === 'function') closeQuickActions();
                if (typeof closeSettingsPanel === 'function') closeSettingsPanel();
            } catch(e) { /* noop */ }
            try {
                // Reset Mail view overlay and list width
                document.body.classList.remove('focus-mail');
                const mailView = document.getElementById('mail-view');
                if (mailView) {
                    mailView.style.setProperty('--mail-list-width', '360px');
                    mailView.classList.remove('mail-zoom');
                }
                const leb = document.getElementById('mail-list-expand');
                if (leb) leb.textContent = 'Expand List';
            } catch(e) { /* noop */ }
            try {
                // Clear common UI preferences
                localStorage.removeItem('dashboardView');
            } catch(e) { /* noop */ }
            try {
                // Ensure settings modal overlay is closed
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal) settingsModal.classList.add('hidden');
                const qaDrawer = document.getElementById('quickActionsDrawer');
                const qaOverlay = document.getElementById('quickActionsOverlay');
                if (qaDrawer) qaDrawer.classList.add('translate-x-full');
                if (qaOverlay) qaOverlay.classList.add('hidden');
            } catch(e) { /* noop */ }
            try {
                // Restore dashboard widgets to default positions without re-rendering DOM
                if (window.dashboardEngine && typeof window.dashboardEngine.resetToDefaults === 'function') {
                    window.dashboardEngine.resetToDefaults();
                } else if (typeof refreshDashboard === 'function') {
                    // Fallback: re-render dashboard if engine is unavailable
                    refreshDashboard();
                }
            } catch(e) { /* noop */ }
        }

        // Close modal when clicking on the dimmed overlay outside the content
        function settingsOverlayClick(event){
            try {
                if (event.target && event.target.id === 'settingsModal') {
                    closeSettingsPanel();
                }
            } catch(e) { /* noop */ }
        }
        
        /* duplicate Director Settings helpers removed */

        // Director Settings helpers
        function directorSettingsStorageKey(){ return 'director.settings'; }
        function openDirectorSettings(){
            try {
// openSettingsPanel(); // Removed auto-open on load; modal opens only by user action
                const section = document.getElementById('directorSettingsSection');
                if (section) {
                    const details = section.querySelector('details');
                    if (details) details.open = true;
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    const sel = document.getElementById('directorDefaultView');
                    if (sel) sel.focus();
                }
            } catch(e) { console.warn('Open Director Settings failed', e); }
        }
        function loadDirectorSettings(){
            try {
                const raw = localStorage.getItem(directorSettingsStorageKey());
                const s = raw ? JSON.parse(raw) : {};
                const dv = document.getElementById('directorDefaultView'); if (dv) dv.value = s.defaultView || 'overview';
                const sa = document.getElementById('directorShowAdvanced'); if (sa) sa.checked = !!s.showAdvanced;
                const im = document.getElementById('directorIconMotion'); if (im) im.value = s.iconMotion || 'normal';
                const br = document.getElementById('directorBroadcastOnReport'); if (br) br.checked = !!s.broadcastOnReport;
                // Apply immediate tweaks
                document.documentElement.setAttribute('data-icon-motion', s.iconMotion || 'normal');
                try { initIconMotion(); } catch(e) { /* noop */ }
            } catch(e) { console.warn('Load Director Settings failed', e); }
        }
        function saveDirectorSettings() {
            try {
                const s = {
                    defaultView: document.getElementById('directorDefaultView')?.value || 'overview',
                    showAdvanced: !!document.getElementById('directorShowAdvanced')?.checked,
                    iconMotion: document.getElementById('directorIconMotion')?.value || 'normal',
                    broadcastOnReport: !!document.getElementById('directorBroadcastOnReport')?.checked
                };
                localStorage.setItem(directorSettingsStorageKey(), JSON.stringify(s));
                document.documentElement.setAttribute('data-icon-motion', s.iconMotion);
                try { initIconMotion(); } catch(e) { /* noop */ }
                showToast('Director settings saved.', 'success');
            } catch(e) { console.warn('Save Director Settings failed', e); showToast('Director settings not saved.', 'error'); }
        }

        // Dashboard visibility preferences
        function dashboardPrefsStorageKey(){ return 'dashboard.prefs'; }
        function loadDashboardPrefs(){
            try {
                const raw = localStorage.getItem(dashboardPrefsStorageKey());
                const def = { unifiedTrackerVisible: true };
                return raw ? Object.assign(def, JSON.parse(raw)) : def;
            } catch(e) { return { unifiedTrackerVisible: true }; }
        }
        function saveDashboardPrefs(prefs){
            try { localStorage.setItem(dashboardPrefsStorageKey(), JSON.stringify(prefs)); showToast('Dashboard preferences saved.', 'success'); }
            catch(e){ console.warn('Save dashboard prefs failed', e); showToast('Preferences not saved.', 'error'); }
        }
        function applyDashboardVisibility(){
            const prefs = loadDashboardPrefs();
            const ut = document.getElementById('unifiedTrackerPanel');
            if (ut) ut.style.display = prefs.unifiedTrackerVisible ? '' : 'none';
        }
        function initDashboardPrefsUI(){
            const prefs = loadDashboardPrefs();
            const cb = document.getElementById('prefsUnifiedTrackerVisible');
            if (cb) cb.checked = !!prefs.unifiedTrackerVisible;
            const btn = document.getElementById('saveDashboardPrefsBtn');
            if (btn) btn.onclick = function(){
                const next = { unifiedTrackerVisible: !!document.getElementById('prefsUnifiedTrackerVisible')?.checked };
                saveDashboardPrefs(next);
                applyDashboardVisibility();
            };
        }

        function showToast(message = 'Settings saved.', variant = 'success') {
            const toast = document.getElementById('appToast');
            const toastInner = document.getElementById('appToastInner');
            const msgEl = document.getElementById('appToastMessage');
            if (!toast || !toastInner || !msgEl) return;
            msgEl.textContent = message;
            // Variant styles
            const base = 'px-4 py-2 rounded-md shadow-lg text-white text-sm';
            const bg = variant === 'error' ? 'bg-red-600' : variant === 'warning' ? 'bg-amber-600' : 'bg-green-600';
            toastInner.className = `${base} ${bg}`;
            toast.classList.remove('hidden');
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => {
                toast.classList.add('hidden');
            }, 2500);
        }

        function updateSystemInfo() {
            if (currentUser) {
                document.getElementById('currentUserInfo').textContent = currentUser.name || 'Unknown';
                document.getElementById('currentUserRole').textContent = currentUser.role || 'Unknown';
                document.getElementById('currentUserBranch').textContent = currentUser.branch || 'Unknown';
            }
            
            // Update dates
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleDateString();
            document.getElementById('buildDate').textContent = '2024-01-15';
        }

        function loadCurrentSettings() {
            // Load saved settings or use defaults
            const savedBrandColor = localStorage.getItem('brandColor') || '#E30613';
            const savedCompanyName = localStorage.getItem('companyName') || 'Branch360';
            const savedSystemType = localStorage.getItem('systemType') || 'Branch360';
            const savedLogoUrl = localStorage.getItem('logoUrl') || '';
            const savedUseWordmark = localStorage.getItem('useWordmark') === 'true';
            const savedTaglineColor = localStorage.getItem('taglineColor') || '#6D6E71';
            const savedContrastTextColor = localStorage.getItem('contrastTextColor') || '#2B2B2B';
            const savedBodyTextColor = localStorage.getItem('bodyTextColor') || '#374151';
            const savedFontFamily = localStorage.getItem('fontFamily') || 'system';
            
            document.getElementById('settingsBrandColor').value = savedBrandColor;
            document.getElementById('settingsCompanyName').value = savedCompanyName;
            document.getElementById('settingsSystemType').value = savedSystemType;
            const logoInput = document.getElementById('settingsLogoUrl');
            if (logoInput) logoInput.value = savedLogoUrl;
            const useWordmarkCb = document.getElementById('settingsUseWordmark');
            if (useWordmarkCb) useWordmarkCb.checked = !!savedUseWordmark;
            const taglineInput = document.getElementById('settingsTaglineColor');
            if (taglineInput) taglineInput.value = savedTaglineColor;
            const contrastInput = document.getElementById('settingsContrastTextColor');
            if (contrastInput) contrastInput.value = savedContrastTextColor;
            const bodyTextInput = document.getElementById('settingsBodyTextColor');
            if (bodyTextInput) bodyTextInput.value = savedBodyTextColor;
            const fontSel = document.getElementById('settingsFontFamily');
            if (fontSel) fontSel.value = savedFontFamily;
            
            // Load theme preference
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            document.getElementById('darkModeToggle').checked = isDarkMode;
            
            // Load refresh interval
            const savedInterval = localStorage.getItem('refreshInterval') || '30';
            document.getElementById('refreshInterval').value = savedInterval;
            refreshInterval = parseInt(savedInterval) * 1000;

            // Apply text color variables immediately
            document.documentElement.style.setProperty('--brand-tagline-color', savedTaglineColor);
            document.documentElement.style.setProperty('--brand-contrast-text-color', savedContrastTextColor);
            document.documentElement.style.setProperty('--brand-body-text-color', savedBodyTextColor);
            // Apply brand color and font
            document.documentElement.style.setProperty('--brand-color', savedBrandColor);
            changeFontFamily(savedFontFamily);
            // Initialize swatch handlers
            setupBrandSwatches();

            // Apply logo vs wordmark preference immediately
            try {
                const logoEl = document.getElementById('brandLogo');
                const overlay = document.getElementById('logoTextOverlay');
                if (savedUseWordmark) {
                    if (logoEl) logoEl.style.display = 'none';
                    if (overlay) {
                        overlay.style.display = 'block';
                        overlay.textContent = savedCompanyName || 'Rentokil';
                        overlay.style.color = savedBrandColor;
                    }
                } else {
                    if (logoEl) logoEl.style.display = '';
                    if (overlay) overlay.style.display = '';
                    applyLogoBuilderToUI({ fallbackCompanyName: savedCompanyName, fallbackLogoUrl: savedLogoUrl });
                }
            } catch (e) { /* no-op */ }

            // Admin gating: Only admins see Demo Mode tab
            try {
                const admin = isAdminUser();
                const demoTabBtn = document.getElementById('settingsTabBtnDemo');
                const demoTabPanel = document.getElementById('settingsTabDemo');
                if (demoTabBtn) demoTabBtn.style.display = admin ? '' : 'none';
                if (demoTabPanel) demoTabPanel.style.display = admin ? '' : 'none';
            } catch(_) {}
        }

        function toggleDarkMode(enabled) {
            const next = enabled ? 'dark' : 'light';
            localStorage.setItem('darkMode', enabled ? 'true' : 'false');
            localStorage.setItem('streamlineTheme', next);
            // Keep selectors in sync
            const actionSelector = document.getElementById('actionMenuThemeSelector');
            if (actionSelector) actionSelector.value = next;
            const themeSelector = document.getElementById('themeSelector');
            if (themeSelector) themeSelector.value = next;
            changeTheme(next);
        }

        function saveBrandSettings() {
            const companyName = document.getElementById('settingsCompanyName').value;
            const brandColor = document.getElementById('settingsBrandColor').value;
            const systemType = document.getElementById('settingsSystemType').value;
            const logoUrl = document.getElementById('settingsLogoUrl').value;
            const useWordmark = !!document.getElementById('settingsUseWordmark')?.checked;
            const taglineColor = document.getElementById('settingsTaglineColor')?.value || '#6D6E71';
            const contrastTextColor = document.getElementById('settingsContrastTextColor')?.value || '#2B2B2B';
            const bodyTextColor = document.getElementById('settingsBodyTextColor')?.value || '#374151';
            const fontFamily = document.getElementById('settingsFontFamily')?.value || 'system';
            
            // Save to localStorage
            localStorage.setItem('companyName', companyName);
            localStorage.setItem('brandColor', brandColor);
            localStorage.setItem('systemType', systemType);
            localStorage.setItem('logoUrl', logoUrl);
            localStorage.setItem('useWordmark', useWordmark ? 'true' : 'false');
            localStorage.setItem('taglineColor', taglineColor);
            localStorage.setItem('contrastTextColor', contrastTextColor);
            localStorage.setItem('bodyTextColor', bodyTextColor);
            localStorage.setItem('fontFamily', fontFamily);
            
            // Apply immediately
            document.documentElement.style.setProperty('--brand-color', brandColor);
            document.documentElement.style.setProperty('--brand-accent', lighten(brandColor, 0.18));
            document.documentElement.style.setProperty('--brand-tagline-color', taglineColor);
            document.documentElement.style.setProperty('--brand-contrast-text-color', contrastTextColor);
            document.documentElement.style.setProperty('--brand-body-text-color', bodyTextColor);
            changeFontFamily(fontFamily);
            
            // Update UI
            const appTitle = document.getElementById('appTitle');
            const appSubtitle = document.getElementById('appSubtitle');
        // Keep UI title as product name; avoid repeating company name from logo
        if (appTitle) appTitle.textContent = 'Branch360';
        // Subtitle stays consistent across brands
        if (appSubtitle) appSubtitle.textContent = 'Streamlined Operations';
            // Prefer Logo Builder if enabled
            applyLogoBuilderToUI({ fallbackCompanyName: companyName, fallbackLogoUrl: logoUrl });
            // Hide inner tagline on settings save to avoid duplication when logo images include it
            const brandTaglineEl = document.getElementById('brandTaglineInner');
            if (brandTaglineEl) {
                brandTaglineEl.textContent = '';
                brandTaglineEl.classList.add('hidden');
            }
            // Apply logo vs wordmark preference
            try {
                const logoEl = document.getElementById('brandLogo');
                const overlay = document.getElementById('logoTextOverlay');
                if (useWordmark) {
                    if (logoEl) logoEl.style.display = 'none';
                    if (overlay) {
                        overlay.style.display = 'block';
                        overlay.textContent = companyName || 'Rentokil';
                        overlay.style.color = brandColor;
                    }
                } else {
                    if (logoEl) logoEl.style.display = '';
                    if (overlay) overlay.style.display = '';
                }
            } catch (e) { /* no-op */ }
            // Reinitialize icon motion to reflect updated brand accent/colors
            try { initIconMotion(); } catch (e) { console.warn('Icon motion refresh failed', e); }
            
            if (!arguments[0]) {
                closeSettingsPanel();
                showToast('Settings changed.', 'success');
            }
        }

        // Font selection helpers
        function ensureFontLink(fontName){
            const hrefMap = {
                'Inter': 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap',
                'Roboto': 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap',
                'Open Sans': 'https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap',
                'Source Sans 3': 'https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap'
            };
            const href = hrefMap[fontName];
            if (!href) return;
            const id = 'dynamic-font-' + fontName.replace(/\s+/g,'-');
            if (document.getElementById(id)) return;
            const link = document.createElement('link');
            link.id = id; link.rel = 'stylesheet'; link.href = href;
            document.head.appendChild(link);
        }
        function changeFontFamily(value){
            const isSystem = !value || value === 'system';
            const fam = isSystem ? 'ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif' : `'${value}', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif`;
            document.documentElement.style.setProperty('--app-font', fam);
            if (!isSystem) ensureFontLink(value);
        }

        // Brand color swatches + advanced picker toggle
        function setupBrandSwatches(){
            const root = document.getElementById('brandColorSwatches');
            if (!root) return;
            root.querySelectorAll('button[data-color]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const c = btn.getAttribute('data-color');
                    document.getElementById('settingsBrandColor').value = c;
                    document.documentElement.style.setProperty('--brand-color', c);
                    localStorage.setItem('brandColor', c);
                });
            });
        }
        function toggleAdvancedColor(show){
            const adv = document.getElementById('settingsBrandColorAdvanced');
            const closeBtn = document.getElementById('closeAdvancedColorButton');
            if (!adv || !closeBtn) return;
            if (show){
                adv.classList.remove('hidden');
                closeBtn.classList.remove('hidden');
            } else {
                adv.classList.add('hidden');
                closeBtn.classList.add('hidden');
            }
        }

        // Logo Builder helpers
        function initLogoBuilderSettings() {
            const enabled = localStorage.getItem('logoBuilderEnabled') === 'true';
            const initials = localStorage.getItem('logoInitials') || (localStorage.getItem('companyName') || 'B').charAt(0);
            const shape = localStorage.getItem('logoShape') || 'rounded';
            const bgColor = localStorage.getItem('logoBgColor') || 'transparent';
            const textColor = localStorage.getItem('logoTextColor') || getComputedStyle(document.documentElement).getPropertyValue('--brand-color') || '#334E68';
            const borderEnabled = localStorage.getItem('logoBorderEnabled') === 'true';
            const borderColor = localStorage.getItem('logoBorderColor') || getComputedStyle(document.documentElement).getPropertyValue('--brand-color') || '#334E68';
            const fontSize = parseInt(localStorage.getItem('logoFontSize') || '64', 10);
            const textShadowEnabled = localStorage.getItem('logoTextShadowEnabled') === 'true';
            const textShadowLevel = localStorage.getItem('logoTextShadowLevel') || 'subtle';

            const el = (id) => document.getElementById(id);
            if (el('useLogoBuilder')) el('useLogoBuilder').checked = enabled;
            if (el('logoInitialsInput')) el('logoInitialsInput').value = initials;
            if (el('logoShapeSelect')) el('logoShapeSelect').value = shape;
            if (el('logoBgColorInput')) el('logoBgColorInput').value = /^transparent$/i.test(bgColor) ? '#ffffff' : bgColor;
            if (el('logoTextColorInput')) el('logoTextColorInput').value = textColor.trim() || '#334E68';
            if (el('logoBorderToggle')) el('logoBorderToggle').checked = borderEnabled;
            if (el('logoBorderColorInput')) el('logoBorderColorInput').value = borderColor.trim() || '#334E68';
            if (el('logoFontSizeRange')) el('logoFontSizeRange').value = fontSize;
            if (el('logoTextShadowEnabled')) el('logoTextShadowEnabled').checked = textShadowEnabled;
            if (el('logoTextShadowLevel')) el('logoTextShadowLevel').value = textShadowLevel;

            updateLogoPreview();
            // Apply immediately if enabled
            if (enabled) applyLogoBuilderToUI();
            applyLogoTextShadow();
        }

        function toggleLogoBuilder(checked) {
            localStorage.setItem('logoBuilderEnabled', checked ? 'true' : 'false');
            applyLogoBuilderToUI();
        }

        function updateLogoPreview() {
            const initials = document.getElementById('logoInitialsInput').value || (localStorage.getItem('companyName') || 'B').charAt(0);
            const shape = document.getElementById('logoShapeSelect').value || 'rounded';
            const bgColor = document.getElementById('logoBgColorInput').value || 'transparent';
            const textColor = document.getElementById('logoTextColorInput').value || getComputedStyle(document.documentElement).getPropertyValue('--brand-color') || '#334E68';
            const borderEnabled = document.getElementById('logoBorderToggle').checked;
            const borderColor = document.getElementById('logoBorderColorInput').value || getComputedStyle(document.documentElement).getPropertyValue('--brand-color') || '#334E68';
            const fontSize = parseInt(document.getElementById('logoFontSizeRange').value || '64', 10);

            const preview = document.getElementById('logoBuilderPreview');
            const previewInitial = document.getElementById('logoBuilderInitial');
            if (preview) {
                preview.style.backgroundColor = bgColor;
                preview.style.borderRadius = shape === 'circle' ? '9999px' : shape === 'rounded' ? '0.75rem' : '0';
                preview.style.border = borderEnabled ? `2px solid ${borderColor}` : 'none';
            }
            if (previewInitial) {
                previewInitial.textContent = initials.toUpperCase();
                previewInitial.style.color = textColor;
                previewInitial.style.fontSize = `${fontSize}px`;
            }
        }

        function saveLogoBuilder() {
            const enabled = document.getElementById('useLogoBuilder').checked;
            const initials = document.getElementById('logoInitialsInput').value || (localStorage.getItem('companyName') || 'B').charAt(0);
            const shape = document.getElementById('logoShapeSelect').value || 'rounded';
            const bgColor = document.getElementById('logoBgColorInput').value || 'transparent';
            const textColor = document.getElementById('logoTextColorInput').value || getComputedStyle(document.documentElement).getPropertyValue('--brand-color') || '#334E68';
            const borderEnabled = document.getElementById('logoBorderToggle').checked;
            const borderColor = document.getElementById('logoBorderColorInput').value || getComputedStyle(document.documentElement).getPropertyValue('--brand-color') || '#334E68';
            const fontSize = parseInt(document.getElementById('logoFontSizeRange').value || '48', 10);
            const textShadowEnabled = document.getElementById('logoTextShadowEnabled').checked;
            const textShadowLevel = document.getElementById('logoTextShadowLevel').value || 'subtle';

            localStorage.setItem('logoBuilderEnabled', enabled ? 'true' : 'false');
            localStorage.setItem('logoInitials', initials.toUpperCase());
            localStorage.setItem('logoShape', shape);
            localStorage.setItem('logoBgColor', bgColor);
            localStorage.setItem('logoTextColor', textColor);
            localStorage.setItem('logoBorderEnabled', borderEnabled ? 'true' : 'false');
            localStorage.setItem('logoBorderColor', borderColor);
            localStorage.setItem('logoFontSize', String(fontSize));
            localStorage.setItem('logoTextShadowEnabled', textShadowEnabled ? 'true' : 'false');
            localStorage.setItem('logoTextShadowLevel', textShadowLevel);

            applyLogoBuilderToUI();
            applyLogoTextShadow();
            if (!arguments[0]) {
                closeSettingsPanel();
                showToast('Settings changed.', 'success');
            }
        }

        function saveAllSettings() {
            try { saveBrandSettings(true); } catch (e) { console.warn('Brand save failed', e); }
            try { saveLogoBuilder(true); } catch (e) { console.warn('Logo Builder save failed', e); }
            closeSettingsPanel();
            showToast('Settings changed.', 'success');
        }

        function applyLogoBuilderToUI(opts = {}) {
            const enabled = localStorage.getItem('logoBuilderEnabled') === 'true';
            const logoEl = document.getElementById('brandLogo');
            const initialEl = document.getElementById('brandInitial');
            const containerEl = document.getElementById('brandLogoContainer');
            const initials = localStorage.getItem('logoInitials') || (opts.fallbackCompanyName || localStorage.getItem('companyName') || 'B').charAt(0);
            const shape = localStorage.getItem('logoShape') || 'rounded';
            const bgColor = localStorage.getItem('logoBgColor') || 'transparent';
            const textColor = localStorage.getItem('logoTextColor') || getComputedStyle(document.documentElement).getPropertyValue('--brand-color') || '#334E68';
            const borderEnabled = localStorage.getItem('logoBorderEnabled') === 'true';
            const borderColor = localStorage.getItem('logoBorderColor') || getComputedStyle(document.documentElement).getPropertyValue('--brand-color') || '#334E68';
            const fontSize = parseInt(localStorage.getItem('logoFontSize') || '64', 10);
            const fallbackLogoUrl = opts.fallbackLogoUrl || localStorage.getItem('logoUrl') || '';

            if (!logoEl || !initialEl || !containerEl) return;

            if (enabled) {
                // Render builder-based logo
                containerEl.style.backgroundColor = bgColor;
                containerEl.style.borderRadius = shape === 'circle' ? '9999px' : shape === 'rounded' ? '0.75rem' : '0';
                containerEl.style.border = borderEnabled ? `2px solid ${borderColor}` : 'none';
                initialEl.textContent = initials.toUpperCase();
                initialEl.style.color = textColor;
                initialEl.style.fontSize = `${fontSize}px`;
                initialEl.style.display = 'block';
                logoEl.style.display = 'none';
            } else {
                // Use image logo or fallback initial
                containerEl.style.backgroundColor = 'transparent';
                containerEl.style.border = 'none';
                if (fallbackLogoUrl) {
                    logoEl.src = fallbackLogoUrl;
                    logoEl.alt = (localStorage.getItem('companyName') || 'Branch360') + ' Logo';
                    logoEl.style.display = 'block';
                    initialEl.style.display = 'none';
                } else {
                    initialEl.textContent = (localStorage.getItem('companyName') || 'B').charAt(0);
                    initialEl.style.display = 'block';
                    logoEl.style.display = 'none';
                }
            }

            // Ensure overlay text shadow reflects current settings
            applyLogoTextShadow();
        }

        function applyLogoTextShadow() {
            const enabled = localStorage.getItem('logoTextShadowEnabled') === 'true';
            const level = localStorage.getItem('logoTextShadowLevel') || 'subtle';
            const appTitle = document.getElementById('appTitle');
            const appSubtitle = document.getElementById('appSubtitle');
            const levels = {
                subtle: 'logo-text-shadow-subtle',
                medium: 'logo-text-shadow-medium',
                strong: 'logo-text-shadow-strong'
            };
            const classes = Object.values(levels);
            [appTitle, appSubtitle].forEach((el) => {
                if (!el) return;
                classes.forEach((c) => el.classList.remove(c));
                if (enabled) {
                    el.classList.add(levels[level] || levels.subtle);
                }
            });
        }

        function toggleLogoTextShadow(enabled) {
            localStorage.setItem('logoTextShadowEnabled', enabled ? 'true' : 'false');
            applyLogoTextShadow();
        }

        function changeLogoTextShadowLevel(level) {
            localStorage.setItem('logoTextShadowLevel', level || 'subtle');
            applyLogoTextShadow();
        }

        function applyBrandPreset(key) {
            const presets = {
                'Presto-X': {
                    name: 'Presto-X',
                    // Presto-X red unified with dashboard/glow (#E30613)
                    colorPrimary: '#E30613',
                    background: '#FDF2F2',
                    logo: 'https://ik.imagekit.io/9cyexhymf/Presto-X%20Logo-ARentokilCompany.png?updatedAt=1762540113819'
                },
                'BugOut': {
                    name: 'BugOut',
                    colorPrimary: '#16A34A',
                    colorAccent: '#22C55E',
                    colorDark: '#14532D',
                    background: '#F0FDF4',
                    logo: ''
                },
                'Terminix': {
                    name: 'Terminix',
                    colorPrimary: '#15803D',
                    colorAccent: '#22C55E',
                    colorDark: '#166534',
                    background: '#ECFDF5',
                    logo: 'https://ik.imagekit.io/9cyexhymf/terminix_color_lg.png?updatedAt=1762622940808'
                },
                'Rentokil': {
                    name: 'Rentokil',
                    // Rentokil blue to match dashboard theme
                    colorPrimary: '#005AA7',
                    logo: 'https://ik.imagekit.io/9cyexhymf/Rentokil%20Logo.png?updatedAt=1762651397519'
                }
            };
            const preset = presets[key];
            if (!preset) return;
            // Persist local settings
            localStorage.setItem('companyName', preset.name);
            localStorage.setItem('brandColor', preset.colorPrimary);
            localStorage.setItem('systemType', 'Branch360');
            localStorage.setItem('logoUrl', preset.logo);
            // Reflect in form fields
            document.getElementById('settingsCompanyName').value = preset.name;
            document.getElementById('settingsBrandColor').value = preset.colorPrimary;
            document.getElementById('settingsSystemType').value = 'Branch360';
            document.getElementById('settingsLogoUrl').value = preset.logo;
            // Apply immediately
            applyBrandInfo(preset);
        }

        function resetBrandSettings() {
            const keys = [
                'companyName','brandColor','systemType','logoUrl','useWordmark',
                'taglineColor','contrastTextColor','bodyTextColor','fontFamily',
                'streamlineTheme','darkMode'
            ];
            keys.forEach(k => localStorage.removeItem(k));
            // Clear fields
            const fields = ['settingsCompanyName','settingsBrandColor','settingsSystemType','settingsLogoUrl'];
            fields.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            // Re-apply default branding and theme
            applyBranding('');
            alert('Brand settings reset. Use Brand Presets to pick a company.');
        }

        function exportData() {
            if (confirm('Export all system data? This will download a JSON file with all your data.')) {
                // Get data from localStorage and current state
                const exportData = {
                    timestamp: new Date().toISOString(),
                    version: '2.0.0',
                    settings: {
                        brandColor: localStorage.getItem('brandColor'),
                        companyName: localStorage.getItem('companyName'),
                        systemType: localStorage.getItem('systemType'),
                        darkMode: localStorage.getItem('darkMode'),
                        refreshInterval: localStorage.getItem('refreshInterval'),
                        theme: localStorage.getItem('streamlineTheme')
                    },
                    userData: currentUser,
                    dashboardData: chartData
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `branch360-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                alert('Data exported successfully!');
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importData = JSON.parse(e.target.result);
                            
                            if (confirm('This will overwrite your current settings. Continue?')) {
                                // Import settings
                                if (importData.settings) {
                                    Object.keys(importData.settings).forEach(key => {
                                        if (importData.settings[key] !== null) {
                                            localStorage.setItem(key, importData.settings[key]);
                                        }
                                    });
                                }
                                
                                alert('Data imported successfully! Please refresh the page to apply changes.');
                                location.reload();
                            }
                        } catch (error) {
                            alert('Error importing data: Invalid file format');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearCache() {
            if (confirm('Clear all cached data? This will remove saved preferences but not your actual data.')) {
                // Clear specific cache items
                const itemsToKeep = ['companyName', 'brandColor', 'systemType', 'darkMode', 'refreshInterval', 'streamlineTheme'];
                const allKeys = Object.keys(localStorage);
                
                allKeys.forEach(key => {
                    if (!itemsToKeep.includes(key)) {
                        localStorage.removeItem(key);
                    }
                });
                
                alert('Cache cleared successfully!');
                location.reload();
            }
        }

        function resetSystem() {
            if (confirm('âš ï¸ WARNING: This will reset all system settings to defaults. This cannot be undone. Continue?')) {
                if (confirm('Are you absolutely sure? All custom settings will be lost.')) {
                    // Clear all localStorage
                    localStorage.clear();
                    
                    alert('System reset complete! The page will now refresh.');
                    location.reload();
                }
            }
        }

        function addUser() {
            alert('User management would be implemented here. This feature requires backend integration.');
        }

        function manageRoles() {
            alert('Role management would be implemented here. This feature requires backend integration.');
        }

        // Mock data functions (fallback when backend fails)
        function getMockSalesData() {
            return {
                role: 'Sales',
                kpis: {
                    proposalVolume: 45,
                    closeRate: 68.5,
                    avgDealSize: 12500,
                    timeSaved: 124
                },
                quickActions: ['Generate Start Packet', 'Upload Quote PDF'],
                recentActivity: [
                    { date: new Date(), customer: 'ABC Corp', status: 'Closed', amount: 15000 },
                    { date: new Date(), customer: 'XYZ Inc', status: 'Proposal', amount: 8500 },
                    { date: new Date(), customer: 'Tech Solutions', status: 'Closed', amount: 22000 }
                ]
            };
        }

        function getMockOperationsData() {
            return {
                role: 'Operations',
                kpis: {
                    pendingInstalls: 12,
                    overduePackets: 3,
                    hygieneScore: 94,
                    avgCompletionTime: 5
                },
                cadenceStatus: { generatedToday: false },
                quickActions: ['Generate Cadence', 'Update Install Status']
            };
        }

        function getMockBranchData() {
            return {
                role: 'Branch Manager',
                branch: 'Branch 1',
                kpis: {
                    proposals: 28,
                    sold: 19,
                    dead: 4,
                    tapLeads: 15,
                    confRate: 87.3,
                    lobsPRP: 8
                },
                charts: {
                    sevenDay: { proposals: 28, sold: 19 },
                    thirtyDay: { proposals: 112, sold: 76 }
                },
                cadenceSummary: {
                    last7: {
                        tapLeads: 54, inspPrp: 38, lobsPrp: 29, lobsSold: 21,
                        dollarsSld: 4450, nextDayConf: 36, pcNoTcConversions: 9, nextDayApps: 12
                    },
                    last30: {
                        tapLeads: 210, inspPrp: 165, lobsPrp: 122, lobsSold: 96,
                        dollarsSld: 18250, nextDayConf: 144, pcNoTcConversions: 33, nextDayApps: 48
                    }
                },
                cadenceTimeseries: (function(){
                    const labels = Array.from({ length: 14 }).map((_, i) => {
                        const d = new Date(Date.now() - (13 - i) * 86400000);
                        return `${d.getMonth()+1}/${d.getDate()}`;
                    });
                    const make = (fn) => labels.map((_, i) => fn(i));
                    return {
                        labels,
                        data: {
                            tapLeads: make(i => 10 + (i % 5)),
                            inspPrp: make(i => 8 + ((i*2) % 6)),
                            lobsPrp: make(i => 6 + ((i*3) % 5)),
                            lobsSold: make(i => 4 + ((i*2) % 4)),
                            dollarsSld: make(i => 500 + i * 25),
                            nextDayConf: make(i => 7 + ((i*3) % 7)),
                            pcNoTcConversions: make(i => 2 + (i % 3)),
                            nextDayApps: make(i => 3 + ((i*2) % 4))
                        }
                    };
                })()
            };
        }

        function getMockExecutiveData() {
            return {
                role: 'Executive',
                kpis: {
                    hoursSaved: 2847,
                    dollarsSaved: 213525,
                    adoptionRate: 78.5,
                    roiPercentage: 427.1
                },
                forecast: {
                    threeMonth: { savings: 245000, adoption: 86.4 },
                    sixMonth: { savings: 288000, adoption: 98.1 },
                    twelveMonth: { savings: 373000, adoption: 100.0 }
                },
                auditLog: Array(10).fill(null).map((_, i) => ({
                    timestamp: new Date(Date.now() - i * 86400000),
                    userEmail: 'user@company.com',
                    action: 'System Login',
                    details: 'User logged into system'
                })),
                automationCoverage: 65
            };
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - starting Branch360');
            initializeApp();
        });

        // --- Ops/Branch: Job Assignment & Lists ---
        function openPendingInstallsModal() {
            openJobAssignmentModal('pendingInstalls');
        }

        function openOverduePacketsModal() {
            openJobAssignmentModal('overduePackets');
        }

        // --- Service Ops: Completed Today & Issues ---
        async function openCompletedTodayModal() {
            const modal = document.getElementById('completedTodayModal');
            const status = document.getElementById('completedTodayStatus');
            const list = document.getElementById('completedTodayList');
            list.innerHTML = '';
            status.textContent = 'Loading completed services...';
            modal.classList.remove('hidden');
            setModalDefaultSize('completedTodayModal');
            enableModalDrag('completedTodayModal');
            enableModalResize('completedTodayModal');

            let items = [];
            const hasAppsScript = typeof google !== 'undefined' && google.script && google.script.run;
            if (hasAppsScript && google.script.run.getRecentInstalls) {
                try {
                    items = await new Promise((resolve) => {
                        google.script.run.withSuccessHandler(resolve).withFailureHandler(() => resolve([])).getRecentInstalls();
                    });
                } catch (e) { items = []; }
            } else {
                // Fallback for local preview
                items = [
                    { customer: 'Acme Foods', date: new Date().toISOString().slice(0,10), specialist: 'J. Doe' },
                    { customer: 'City Hospital', date: new Date().toISOString().slice(0,10), specialist: 'A. Smith' }
                ];
            }

            if (!items || !items.length) {
                status.textContent = 'No completed services found.';
                return;
            }
            status.textContent = `${items.length} completed today`;
            list.innerHTML = items.map(item => `
                <li class="flex justify-between py-1">
                    <span class="text-gray-800">${item.customer}</span>
                    <span class="text-gray-600">${item.date || ''}</span>
                    <span class="text-green-700">${item.specialist || ''}</span>
                </li>
            `).join('');
        }

        function closeCompletedTodayModal() {
            document.getElementById('completedTodayModal').classList.add('hidden');
            resetModalPosition('completedTodayModal');
        }

        async function openIssuesReportedModal() {
            const modal = document.getElementById('issuesReportedModal');
            const status = document.getElementById('issuesReportedStatus');
            const list = document.getElementById('issuesReportedList');
            list.innerHTML = '';
            status.textContent = 'Loading reported issues...';
            modal.classList.remove('hidden');
            setModalDefaultSize('issuesReportedModal');
            enableModalDrag('issuesReportedModal');
            enableModalResize('issuesReportedModal');

            let issues = [];
            const hasAppsScript = typeof google !== 'undefined' && google.script && google.script.run;
            if (hasAppsScript && google.script.run.getIssuesReported) {
                try {
                    issues = await new Promise((resolve) => {
                        google.script.run.withSuccessHandler(resolve).withFailureHandler(() => resolve([])).getIssuesReported();
                    });
                } catch (e) { issues = []; }
            } else {
                // Fallback for local preview
                issues = [
                    { customer: 'Acme Foods', issue: 'Missed stop', severity: 'High' },
                    { customer: 'City Hospital', issue: 'Revisit requested', severity: 'Medium' }
                ];
            }

            if (!issues || !issues.length) {
                status.textContent = 'No issues reported.';
                return;
            }
            status.textContent = `${issues.length} issues reported`;
            list.innerHTML = issues.map(i => `
                <li class="py-1">
                    <span class="font-medium text-gray-800">${i.customer}</span>
                    <span class="ml-2 text-gray-700">${i.issue || ''}</span>
                    <span class="ml-2 text-red-700">${i.severity || ''}</span>
                </li>
            `).join('');
        }

        function closeIssuesReportedModal() {
            document.getElementById('issuesReportedModal').classList.add('hidden');
            resetModalPosition('issuesReportedModal');
        }

        async function openJobAssignmentModal(filter) {
            const modal = document.getElementById('jobAssignmentModal');
            const title = document.getElementById('jobAssignmentTitle');
            const status = document.getElementById('jobAssignmentStatus');
            const tbody = document.getElementById('jobAssignmentTableBody');
            const techSelect = document.getElementById('globalTechSelect');
            const omSelect = document.getElementById('globalOmSelect');
            const info = document.getElementById('jobAssignmentInfo');
            tbody.innerHTML = '';
            status.textContent = 'Loading jobs...';
            modal.classList.remove('hidden');
            setModalDefaultSize('jobAssignmentModal');
            enableModalDrag('jobAssignmentModal');
            enableModalResize('jobAssignmentModal');

            const [jobs, technicians] = await Promise.all([
                fetchJobs(filter),
                fetchTechnicians()
            ]);

            // Populate global selectors
            const optionsHtml = technicians.map(t => `<option value="${t.email}">${t.name} (${t.branch})</option>`).join('');
            techSelect.innerHTML = '<option value="">Select technician</option>' + optionsHtml;
            if (omSelect) omSelect.innerHTML = '<option value="">Select Ops Manager</option>' + optionsHtml;

            // Set title
            title.textContent = filter === 'pendingInstalls' ? 'Pending Installs' : (filter === 'overduePackets' ? 'Overdue Packets' : 'All Jobs');

            // Show source/logic info
            if (info) {
                if (filter === 'pendingInstalls') {
                    info.innerHTML = '<strong>Source:</strong> getPendingInstalls()<br><strong>Logic:</strong> Install date is set and completion status is not "Yes".<br><strong>Actions you can take:</strong> Assign a technician, schedule install, set Ops Manager.';
                    info.classList.remove('hidden');
                } else if (filter === 'overduePackets') {
                    info.innerHTML = '<strong>Source:</strong> getOverduePackets()<br><strong>Logic:</strong> Status is "Sold" and StartPacket_Sent is not "Yes".<br><strong>Actions you can take:</strong> Send start packet, assign Ops Manager or specialist.';
                    info.classList.remove('hidden');
                } else {
                    info.classList.add('hidden');
                }
            }

            if (!jobs.length) {
                status.textContent = 'No matching jobs found.';
                return;
            }
            status.textContent = `${jobs.length} jobs loaded`;
            tbody.innerHTML = jobs.map(job => `
                <tr class="border-t">
                    <td class="px-3 py-2"><input type="checkbox" id="jobchk-${job.id}" class="job-select"></td>
                    <td class="px-3 py-2">${job.id || ''}</td>
                    <td class="px-3 py-2">${job.customer || ''}</td>
                    <td class="px-3 py-2">${job.type || ''}</td>
                    <td class="px-3 py-2">${job.scheduled || ''}</td>
                    <td class="px-3 py-2">${job.assigned || ''}</td>
                    <td class="px-3 py-2">
                        <div class="flex items-center gap-2">
                            <select id="om-${job.id}" class="px-2 py-1 border rounded">
                                <option value="">Select Ops Manager</option>
                                ${optionsHtml}
                            </select>
                            <button class="px-2 py-1 text-xs bg-gray-100 border rounded" onclick="assignOMForJob('${job.id}')">Save OM</button>
                        </div>
                    </td>
                    <td class="px-3 py-2">
                        <select id="tech-${job.id}" class="px-2 py-1 border rounded">
                            <option value="">Select technician</option>
                            ${technicians.map(t => `<option value="${t.email}">${t.name} (${t.branch})</option>`).join('')}
                        </select>
                        <button class="ml-2 px-3 py-1 bg-brand text-white rounded hover:bg-brand-color-light" onclick="assignTechnicianForJob('${job.id}')">Assign</button>
                    </td>
                </tr>
            `).join('');
        }

        function closeJobAssignmentModal() {
            document.getElementById('jobAssignmentModal').classList.add('hidden');
            resetModalPosition('jobAssignmentModal');
        }

        // --- Start Log: Manual Entry ---
        function openStartLogModal(prefill) {
            const modal = document.getElementById('startLogModal');
            const form = document.getElementById('startLogForm');
            form.reset();
            if (prefill) {
                document.getElementById('slSoldDate').value = prefill.soldDate || '';
                document.getElementById('slAccountName').value = prefill.accountName || '';
                document.getElementById('slServiceAddress').value = prefill.serviceAddress || '';
                document.getElementById('slSalesReps').value = prefill.salesReps || '';
                document.getElementById('slInitialPrice').value = prefill.initialPrice || '';
                document.getElementById('slMaintenancePrice').value = prefill.maintenancePrice || '';
                document.getElementById('slType').value = prefill.type || '';
                document.getElementById('slFrequency').value = prefill.frequency || '';
                document.getElementById('slLogBookNeeded').value = prefill.logBookNeeded || '';
                document.getElementById('slTapLeadSpecialist').value = prefill.tapLeadOrSpecialist || '';
                document.getElementById('slPestPacLoc').value = prefill.pestPacLoc || '';
                document.getElementById('slStartMonth').value = prefill.customerRequestedStartMonth || '';
                document.getElementById('slOpsManager').value = prefill.operationsManager || '';
                document.getElementById('slAssignedSpecialist').value = prefill.assignedSpecialist || '';
                document.getElementById('slMaterialsOrdered').value = prefill.materialsOrdered || '';
                document.getElementById('slInstallStarted').value = prefill.installationStarted || '';
                document.getElementById('slPOC').value = prefill.pocNamePhone || '';
                document.getElementById('slConfirmedStartDate').value = prefill.confirmedStartDate || '';
                document.getElementById('slNotes').value = prefill.notes || '';
            }
            modal.classList.remove('hidden');
            setModalDefaultSize('startLogModal');
            enableModalDrag('startLogModal');
            enableModalResize('startLogModal');
        }

        function closeStartLogModal() {
            document.getElementById('startLogModal').classList.add('hidden');
            resetModalPosition('startLogModal');
        }

        async function submitStartLogForm() {
            const payload = {
                soldDate: document.getElementById('slSoldDate').value,
                accountName: document.getElementById('slAccountName').value,
                serviceAddress: document.getElementById('slServiceAddress').value,
                salesReps: document.getElementById('slSalesReps').value,
                initialJob1xPrice: document.getElementById('slInitialPrice').value,
                maintenancePrice: document.getElementById('slMaintenancePrice').value,
                type: document.getElementById('slType').value,
                frequencyAnnualVisits: document.getElementById('slFrequency').value,
                logBookNeeded: document.getElementById('slLogBookNeeded').value,
                tapLeadOrSpecialist: document.getElementById('slTapLeadSpecialist').value,
                pestPacLocId: document.getElementById('slPestPacLoc').value,
                customerRequestedStartMonth: document.getElementById('slStartMonth').value,
                operationsManager: document.getElementById('slOpsManager').value,
                assignedSpecialist: document.getElementById('slAssignedSpecialist').value,
                materialsOrdered: document.getElementById('slMaterialsOrdered').value,
                installationStarted: document.getElementById('slInstallStarted').value,
                pocNamePhone: document.getElementById('slPOC').value,
                confirmedStartDateWithPOC: document.getElementById('slConfirmedStartDate').value,
                specialNotes: document.getElementById('slNotes').value,
            };

            const statusEl = document.getElementById('startLogStatus');
            statusEl.textContent = 'Saving...';
            try {
                await new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).saveStartPacket(payload);
                });
                statusEl.textContent = 'Saved!';
                setTimeout(() => {
                    closeStartLogModal();
                    alert('Start Log saved to StartPackets');
                }, 300);
            } catch (err) {
                statusEl.textContent = 'Error saving';
                alert('Error: ' + err.message);
            }
        }

        // --- Ops: Quick Paste Start Logs ---
        function openStartLogPasteModal() {
            const id = 'startLogPasteModal';
            document.getElementById(id).classList.remove('hidden');
            setModalDefaultSize(id);
            enableModalDrag(id);
            enableModalResize(id);
        }
        function closeStartLogPasteModal() {
            document.getElementById('startLogPasteModal').classList.add('hidden');
            resetModalPosition('startLogPasteModal');
        }
        function parseStartLogRows() {
            const raw = document.getElementById('startLogPasteArea').value.trim();
            const lines = raw.split(/\r?\n/).filter(l => l.trim());
            if (!lines.length) return;
            const headerLine = lines[0];
            const dataLines = lines.slice(1);
            const headers = headerLine.split('\t');
            const results = [];
            dataLines.forEach(line => {
                const cols = line.split('\t');
                const get = (label) => {
                    const idx = headers.findIndex(h => h.trim().toLowerCase() === label.trim().toLowerCase());
                    return idx >= 0 ? (cols[idx] || '').trim() : '';
                };
                results.push({
                    soldDate: get('Sold Date'),
                    accountName: get('ACCOUNT NAME'),
                    serviceAddress: get('SERVICE ADDRESS'),
                    salesReps: get('Sales Rep(S) Involved'),
                    initialJob1xPrice: get('Initial / JOB 1X Price Including Merchandise'),
                    maintenancePrice: get('Maintenance (CONTRACT) Price'),
                    type: get('Type -                     Contract (Or) Job  1x') || get('Type - Contract (Or) Job  1x') || get('Type'),
                    frequencyAnnualVisits: get('Frequency (# Of Annual Visits)') || get('Frequency'),
                    logBookNeeded: get('Log Book Needed'),
                    tapLeadOrSpecialist: get('TAP LEAD -NO (OR) SPECIALIST NAME'),
                    pestPacLocId: get('Confirmed PestPac Entry w/ Loc #                        (copy past blue number from pp)') || get('Confirmed PestPac Entry w/ Loc #'),
                    customerRequestedStartMonth: get('Cutomer Requested Start Month') || get('Customer Requested Start Month'),
                    operationsManager: get('Operations Manager'),
                    assignedSpecialist: get('Assigned Specialist'),
                    materialsOrdered: get('Have Materials Been Ordered'),
                    installationStarted: get('Initial / Installation Service Started'),
                    pocNamePhone: get('POC Name/Phone#'),
                    confirmedStartDateWithPOC: get('Confirmed Start Date with POC'),
                    specialNotes: get('SPECIAL NOTES / Equipment Overview'),
                });
            });
            const preview = document.getElementById('startLogPastePreview');
            preview.innerHTML = results.map(r => `<li class="text-sm">${r.accountName} â€” ${r.serviceAddress} â€” ${r.type}</li>`).join('');
            preview.dataset.rows = JSON.stringify(results);
        }
        async function importStartLogRows() {
            const preview = document.getElementById('startLogPastePreview');
            const rows = JSON.parse(preview.dataset.rows || '[]');
            if (!rows.length) { alert('No rows to import'); return; }
            try {
                await new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).bulkImportStartPackets(rows);
                });
                alert(`Imported ${rows.length} start log entries`);
                closeStartLogPasteModal();
            } catch (err) {
                alert('Import error: ' + err.message);
            }
        }

        async function fetchJobs(filter) {
            if (!hasAppsScript()) {
                // Local preview mock data
                const today = new Date();
                const fmt = d => d ? new Date(d).toLocaleDateString() : '';
                const mock = [
                    { id: 'T-101', customer: 'CareNow', type: 'Install', scheduled: fmt(today), assigned: '' },
                    { id: 'T-102', customer: 'FM Kitchen', type: 'Install', scheduled: fmt(today), assigned: 'ops.user@prestox.com' },
                    { id: 'T-103', customer: 'Aban Persian', type: 'Packet', scheduled: '', assigned: '' }
                ];
                if (filter === 'pendingInstalls') return mock.filter(m => m.type === 'Install');
                if (filter === 'overduePackets') return mock.filter(m => m.type === 'Packet');
                return mock;
            }
            try {
                return await new Promise((resolve, reject) => {
                    const handler = list => resolve(list);
                    const fail = err => reject(err);
                    if (filter === 'pendingInstalls') {
                        google.script.run.withSuccessHandler(handler).withFailureHandler(fail).getPendingInstalls();
                    } else if (filter === 'overduePackets') {
                        google.script.run.withSuccessHandler(handler).withFailureHandler(fail).getOverduePackets();
                    } else {
                        // default: both lists merged
                        google.script.run.withSuccessHandler(handler).withFailureHandler(fail).getPendingInstalls();
                    }
                });
            } catch (e) {
                console.error('fetchJobs error', e);
                return [];
            }
        }

        async function fetchTechnicians() {
            if (!hasAppsScript()) {
                return [
                    { email: 'ops.user@prestox.com', name: 'Ops User', branch: 'Branch A' },
                    { email: 'tech.one@prestox.com', name: 'Tech One', branch: 'Branch A' },
                    { email: 'tech.two@prestox.com', name: 'Tech Two', branch: 'Branch B' }
                ];
            }
            try {
                return await new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getTechnicians();
                });
            } catch (e) {
                console.error('fetchTechnicians error', e);
                return [];
            }
        }

        function assignTechnicianForJob(id) {
            const select = document.getElementById(`tech-${id}`);
            const techEmail = select ? select.value : '';
            const status = document.getElementById('jobAssignmentStatus');
            if (!techEmail) {
                status.textContent = 'Please select a technician before assigning.';
                return;
            }
            if (!hasAppsScript()) {
                status.textContent = `Assigned ${techEmail} to job ${id} (local preview)`;
                return;
            }
            google.script.run
                .withSuccessHandler(() => {
                    status.textContent = `Assigned ${techEmail} to job ${id}`;
                })
                .withFailureHandler(err => {
                    console.error('assignTechnician error', err);
                    status.textContent = 'Assignment failed. Please try again.';
                })
                .assignTechnician(id, techEmail);
        }

        function getSelectedJobIds() {
            const checkboxes = Array.from(document.querySelectorAll('.job-select'));
            return checkboxes.filter(cb => cb.checked).map(cb => cb.id.replace('jobchk-',''));
        }

        function assignSelectedTech() {
            const techEmail = (document.getElementById('globalTechSelect') || {}).value || '';
            const status = document.getElementById('jobAssignmentStatus');
            const ids = getSelectedJobIds();
            if (!techEmail) { status.textContent = 'Select a technician before bulk assignment.'; return; }
            if (!ids.length) { status.textContent = 'Select at least one job to assign.'; return; }
            if (!hasAppsScript()) {
                status.textContent = `Assigned ${techEmail} to ${ids.length} jobs (local preview)`;
                return;
            }
            let done = 0, failed = 0;
            ids.forEach(id => {
                google.script.run
                  .withSuccessHandler(() => { done++; status.textContent = `Assigned ${techEmail} to ${done}/${ids.length} jobs`; })
                  .withFailureHandler(() => { failed++; status.textContent = `Some assignments failed (${failed})`; })
                  .assignTechnician(id, techEmail);
            });
        }

        function assignSelectedOM() {
            const omVal = (document.getElementById('globalOmSelect') || {}).value || '';
            const status = document.getElementById('jobAssignmentStatus');
            const ids = getSelectedJobIds();
            if (!omVal) { status.textContent = 'Select an Ops Manager before bulk assignment.'; return; }
            if (!ids.length) { status.textContent = 'Select at least one job to assign OM.'; return; }
            if (!hasAppsScript()) {
                status.textContent = `Set OM ${omVal} for ${ids.length} jobs (local preview)`;
                return;
            }
            let done = 0, failed = 0;
            ids.forEach(id => {
                google.script.run
                  .withSuccessHandler(() => { done++; status.textContent = `Set OM for ${done}/${ids.length} jobs`; })
                  .withFailureHandler(() => { failed++; status.textContent = `Some OM updates failed (${failed})`; })
                  .updateTrackerEntry(id, { Operations_Manager: omVal });
            });
        }

        // Save all selected assignments using current global selectors; mirrors Settings footer behavior
        function saveJobAssignments() {
            const status = document.getElementById('jobAssignmentStatus');
            const ids = getSelectedJobIds();
            const techEmail = (document.getElementById('globalTechSelect') || {}).value || '';
            const omVal = (document.getElementById('globalOmSelect') || {}).value || '';
            if (!ids.length) { status.textContent = 'Select at least one job to save changes.'; return; }
            let didAny = false;
            if (techEmail) { didAny = true; assignSelectedTech(); }
            if (omVal) { didAny = true; assignSelectedOM(); }
            if (!didAny) { status.textContent = 'Select a technician or Ops Manager to save.'; }
        }
        function onKanbanHeaderClick(title) {
            if (title === 'Packet Pending') {
                openOverduePacketsModal();
            } else if (title === 'Install In Progress' || title === 'Schedule') {
                openPendingInstallsModal();
            } else {
                openJobAssignmentModal();
            }
        }

        function openRowLogicModal(id, action) {
            const modal = document.getElementById('logicInfoModal');
            const titleEl = document.getElementById('logicInfoTitle');
            const body = document.getElementById('logicInfoBody');
            titleEl.textContent = `Why "${action}" for ${id}?`;
            const rows = window._unifiedRows || [];
            const row = rows.find(r => String(r.id) === String(id));
            let details = '';
            if (action === 'Send Start Packet') {
                details = '<strong>Source:</strong> Unified Tracker nextActions via getUnifiedTrackerView()<br><strong>Logic:</strong> Status is "Sold" and StartPacket_Sent is not "Yes".';
            } else if (action === 'Schedule Install') {
                details = '<strong>Source:</strong> Unified Tracker nextActions via getUnifiedTrackerView()<br><strong>Logic:</strong> Start Packet sent but install date is not set.';
            } else if (action === 'Order Materials') {
                details = '<strong>Source:</strong> Unified Tracker nextActions via getUnifiedTrackerView()<br><strong>Logic:</strong> Materials_Ordered not marked "Yes".';
            } else if (action === 'Perform Install') {
                details = '<strong>Source:</strong> Unified Tracker nextActions via getUnifiedTrackerView()<br><strong>Logic:</strong> Install date is set and completion status is not "Yes".';
            } else {
                details = '<strong>Source:</strong> Unified Tracker nextActions<br><strong>Logic:</strong> Derived from TrackerData fields.';
            }
            const current = row ? `
                <div class="mt-2 p-2 bg-gray-50 rounded">
                    <div class="text-sm"><strong>Status:</strong> ${escapeHtml(row.status||'')}</div>
                    <div class="text-sm"><strong>Packet:</strong> ${row.startPacketSent ? 'Sent' : 'Pending'}</div>
                    <div class="text-sm"><strong>Install Date:</strong> ${row.dateInstallScheduled ? escapeHtml(row.dateInstallScheduled) : 'â€”'}</div>
                    <div class="text-sm"><strong>Materials Ordered:</strong> ${row.materialsOrdered ? 'Yes' : 'No'}</div>
                    <div class="text-sm"><strong>Ops Manager:</strong> ${escapeHtml(row.operationsManager||'')}</div>
                    <div class="text-sm"><strong>Specialist:</strong> ${escapeHtml(row.assignedSpecialist||'')}</div>
                </div>
            ` : '';
            const techOptions = (window._technicians||[]).map(t => `<option value="${escapeHtml(t.email)}">${escapeHtml(t.name)} (${escapeHtml(t.branch)})</option>`).join('');
            const actionsHtml = `
                <div class="mt-3 space-y-2">
                    <div class="flex gap-2">
                        <button class="px-3 py-1 bg-brand text-white rounded" onclick="onTrackerSendPacket('${id}')">Send Packet</button>
                        <button class="px-3 py-1 bg-blue-600 text-white rounded" onclick="onTrackerScheduleInstall('${id}')">Schedule Install</button>
                        <button class="px-3 py-1 bg-gray-700 text-white rounded" onclick="onTrackerOrderMaterials('${id}')">Order Materials</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="logicTech-${id}" class="text-xs border rounded px-2 py-1"><option value="">Assign Specialist</option>${techOptions}</select>
                        <button class="text-xs px-2 py-1 bg-gray-100 border rounded" onclick="onTrackerAssignSpecialist('${id}', document.getElementById('logicTech-${id}').value)">Assign Specialist</button>
                        <input id="logicOm-${id}" class="text-xs border rounded px-2 py-1" placeholder="Set Ops Manager" />
                        <button class="text-xs px-2 py-1 bg-gray-100 border rounded" onclick="onTrackerSetOM('${id}', 'logicOm-${id}')">Save OM</button>
                    </div>
                </div>
            `;
            body.innerHTML = `${details}${current}${actionsHtml}`;
            modal.classList.remove('hidden');
            setModalDefaultSize('logicInfoModal');
            enableModalDrag('logicInfoModal');
            enableModalResize('logicInfoModal');
        }

        function closeLogicInfoModal() {
            document.getElementById('logicInfoModal').classList.add('hidden');
            resetModalPosition('logicInfoModal');
        }

        function assignOMForJob(id) {
            const input = document.getElementById(`om-${id}`);
            const value = input ? input.value : '';
            const status = document.getElementById('jobAssignmentStatus');
            if (!value) {
                status.textContent = 'Please enter an Ops Manager name/email.';
                return;
            }
            if (!hasAppsScript()) {
                status.textContent = `Set OM to ${value} for job ${id} (local preview)`;
                return;
            }
            google.script.run
              .withSuccessHandler(function(){ status.textContent = `Ops Manager set to ${value} for job ${id}`; })
              .withFailureHandler(function(err){ console.error('updateTrackerEntry failed:', err); status.textContent = 'Failed to set Ops Manager'; })
              .updateTrackerEntry(id, { Operations_Manager: value });
        }

        // --- AE: Quick Paste Import ---
        function openPasteImportModal() {
            const id = 'pasteImportModal';
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('pasteInput').value = '';
            document.getElementById('pasteParseStatus').textContent = 'Paste rows (tab-separated), one per line.';
            document.getElementById('pastePreviewBody').innerHTML = '';
            setModalDefaultSize(id);
            enableModalDrag(id);
            enableModalResize(id);
        }

        function closePasteImportModal() {
            document.getElementById('pasteImportModal').classList.add('hidden');
            resetModalPosition('pasteImportModal');
        }

        function parsePastedRows() {
            const raw = document.getElementById('pasteInput').value.trim();
            const status = document.getElementById('pasteParseStatus');
            const tbody = document.getElementById('pastePreviewBody');
            if (!raw) { status.textContent = 'Nothing to parse.'; return; }
            const lines = raw.split(/\n+/).map(l => l.trim()).filter(Boolean);
            const rows = lines.map(line => line.split(/\t+/));
            status.textContent = `Parsed ${rows.length} rows, ${rows[0]?.length || 0} columns.`;
            tbody.innerHTML = rows.map((cols, i) => `
                <tr class="border-t">
                    ${cols.map(c => `<td class="px-3 py-2">${c}</td>`).join('')}
                </tr>
            `).join('');
            window.__pasteParsedRows = rows;
        }

        function importParsedRows() {
            const rows = window.__pasteParsedRows || [];
            const status = document.getElementById('pasteParseStatus');
            if (!rows.length) { status.textContent = 'Parse rows first.'; return; }
            const entries = rows.map(cols => ({
                Date_Proposal: cols[0] || '',
                Customer_Name: cols[1] || '',
                Source: cols[2] || '',
                Sale_Type: cols[3] || '',
                Status: (cols[4] || '').toLowerCase().includes('contract') ? 'Proposal' : (cols[4] || ''),
                Monthly_Fee: (cols[7] || '').replace(/[^0-9.\-]/g, ''),
                Annual_Value: (cols[8] || '').replace(/[^0-9.\-]/g, ''),
            }));

            if (!hasAppsScript()) {
                status.textContent = `Prepared ${entries.length} entries (local preview).`;
                return;
            }
            google.script.run
                .withSuccessHandler(() => {
                    status.textContent = `Imported ${entries.length} entries to Tracker.`;
                })
                .withFailureHandler(err => {
                    console.error('bulk import error', err);
                    status.textContent = 'Import failed.';
                })
                .bulkImportTracker(entries);
        }
    </script>

    <!-- Sales Entry Form Modal -->
    <div id="salesEntryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 modal-window">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">New Sales Entry</h2>
                    <button onclick="closeSalesEntryForm()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="salesEntryForm" class="space-y-4">
                    <!-- Customer Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                            <input type="text" id="customerName" name="customerName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Person</label>
                            <input type="text" id="contactPerson" name="contactPerson" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" id="phone" name="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                        </div>
                    </div>

                    <!-- Address -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Service Address</label>
                        <textarea id="serviceAddress" name="serviceAddress" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"></textarea>
                    </div>

                    <!-- Proposal Details -->
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Proposal Details</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="status" name="status" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                                    <option value="">Select Status</option>
                                    <option value="Proposal">Proposal</option>
                                    <option value="Sold">Sold</option>
                                    <option value="Dead">Dead</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Sales Rep</label>
                                <select id="salesRep" name="salesRep" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                                    <option value="">Select AE</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Initial Fee</label>
                                <input type="number" id="initialFee" name="initialFee" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Fee</label>
                                <input type="number" id="monthlyFee" name="monthlyFee" step="0.01" min="0" onchange="calculateAnnualValue()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Service Frequency</label>
                                <select id="frequency" name="frequency" onchange="calculateAnnualValue()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                                    <option value="Monthly">Monthly</option>
                                    <option value="Weekly">Weekly</option>
                                    <option value="Bi-Weekly">Bi-Weekly</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Semi-Annual">Semi-Annual</option>
                                    <option value="Annual">Annual</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Annual Value</label>
                            <input type="number" id="annualValue" name="annualValue" step="0.01" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                        </div>
                    </div>

                    <!-- LOB Selection -->
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Lines of Business</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="flex items-center">
                                <input type="checkbox" name="lobs" value="Pest Control" class="mr-2 text-brand focus:ring-brand">
                                <span class="text-sm">Pest Control</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="lobs" value="Termite" class="mr-2 text-brand focus:ring-brand">
                                <span class="text-sm">Termite</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="lobs" value="Wildlife" class="mr-2 text-brand focus:ring-brand">
                                <span class="text-sm">Wildlife</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="lobs" value="Mosquito" class="mr-2 text-brand focus:ring-brand">
                                <span class="text-sm">Mosquito</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="lobs" value="Bed Bug" class="mr-2 text-brand focus:ring-brand">
                                <span class="text-sm">Bed Bug</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="lobs" value="Other" class="mr-2 text-brand focus:ring-brand">
                                <span class="text-sm">Other</span>
                            </label>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea id="notes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"></textarea>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeSalesEntryForm()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" id="submitSalesEntry" class="px-6 py-2 bg-brand text-white rounded-md hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2">
                            Submit Sales Entry
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Quote Upload Modal -->
    <div id="quoteUploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 modal-window">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Upload Quote PDF</h2>
                    <button onclick="closeQuoteUploadModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select PDF (or image)</label>
                        <input type="file" accept="application/pdf,image/*" onchange="handleQuoteFileSelected(this)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                    </div>

                    <div id="quoteParseStatus" class="text-sm text-gray-600">Waiting for file...</div>

                    <div class="border rounded-md p-4 bg-gray-50">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Parsed Details</h3>
                        <div id="quoteParsedResult" class="text-gray-800 text-sm">No data yet.</div>
                    </div>

                    <div class="border rounded-md p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Or load by URL</h3>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="quoteUrlInput" type="url" placeholder="http://localhost:8000/your-file.pdf" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                            <button type="button" onclick="parseQuoteFromUrl(document.getElementById('quoteUrlInput').value)" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Load from URL</button>
                        </div>
                        <div class="mt-2">
                            <button type="button" onclick="parseQuoteFromUrl(encodeURI('Quote 47232 from Presto-X (2).pdf'))" class="text-sm text-brand hover:underline">Load project sample: Quote 47232 from Presto-X (2).pdf</button>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" onclick="prefillSalesFormFromQuote()" class="px-4 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2">
                            Prefill Sales Form
                        </button>
                        <button type="button" id="generateStartPacketFromParsedBtn" onclick="generateStartPacketFromParsed()" class="px-4 py-2 bg-brand text-white rounded-md hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2">
                            Generate Start Packet
                        </button>
                        <button type="button" onclick="composeOnboardingEmail()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Compose Onboarding Email
                        </button>
                        <button type="button" onclick="closeQuoteUploadModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Sales Performance Modal -->
    <div id="dailyPerformanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 modal-window">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Daily Sales Performance Tracking</h2>
                    <button onclick="closeDailyPerformanceForm()" class="text-gray-500 hover:text-gray-700" aria-label="Close">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="dailyPerformanceForm" onsubmit="submitDailyPerformanceForm(event)">
                    <p class="text-sm text-red-600 mb-3">* Indicates required question</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-red-600">*</span></label>
                            <input id="dspEmail" type="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="your.email@domain.com" oninput="updateAeSelectionFromEmail()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">AE (Account Executive) Name <span class="text-red-600">*</span></label>
                            <select id="dspAeName" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="">Select AE</option>
                                <option>Cody Lytle</option>
                                <option>April Wilton</option>
                                <option>Blair Sloat</option>
                                <option>Anthony Acevedo</option>
                                <option>Chris Horner</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Proposals delivered today <span class="text-red-600">*</span></label>
                            <input id="dspProposalsDelivered" type="number" min="0" required class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PRP LOBs included on proposals delivered today (count)</label>
                            <input id="dspLobsIncludedCount" type="number" min="0" class="w-full px-3 py-2 border rounded-md">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PRP LOBs sold today (count)</label>
                            <input id="dspLobsSoldCount" type="number" min="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Total Dollars SLD (Sold) Amount today</label>
                            <input id="dspDollarsSold" type="number" min="0" step="0.01" class="w-full px-3 py-2 border rounded-md" placeholder="0.00">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Next Day CONF (Proposals to be delivered)</label>
                            <input id="dspNextDayConf" type="number" min="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Total Dollars Proposed Today</label>
                            <input id="dspDollarsProposed" type="number" min="0" step="0.01" class="w-full px-3 py-2 border rounded-md" placeholder="0.00">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Events: First-time appointment</label>
                            <input id="dspEventsFirstAppt" type="number" min="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Events: Site Assessment</label>
                            <input id="dspEventsSiteAssessment" type="number" min="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Events: Proposals</label>
                            <input id="dspEventsProposals" type="number" min="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Events: In-person Follow-up</label>
                            <input id="dspEventsInPerson" type="number" min="0" class="w-full px-3 py-2 border rounded-md">
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea id="dspNotes" rows="3" class="w-full px-3 py-2 border rounded-md"></textarea>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeDailyPerformanceForm()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" id="submitDailyPerformance" class="px-6 py-2 bg-brand text-white rounded-md hover:bg-opacity-90">Submit Daily Performance</button>
                    </div>
                    <div id="dailyPerformanceStatus" class="text-sm text-gray-600 mt-2"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Branch Cadence Entry Modal -->
    <div id="branchCadenceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 modal-window">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Branch Cadence Entry</h2>
                    <button onclick="closeBranchCadenceModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="branchCadenceForm" onsubmit="event.preventDefault(); submitBranchCadenceEntry()">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Entry Date</label>
                            <input id="cadEntryDate" type="date" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Region</label>
                            <input id="cadRegion" list="cadRegionList" class="w-full px-3 py-2 border rounded-md" placeholder="e.g., 16">
                            <datalist id="cadRegionList">
                                <option value="16"></option>
                                <option value="17"></option>
                                <option value="18"></option>
                                <option value="19"></option>
                                <option value="22"></option>
                            </datalist>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Code</label>
                            <input id="cadCode" type="text" class="w-full px-3 py-2 border rounded-md" placeholder="e.g., 83">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Branch Name</label>
                            <input id="cadBranchName" type="text" class="w-full px-3 py-2 border rounded-md" placeholder="e.g., Presto-X Kansas City">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Branch Manager</label>
                            <input id="cadBranchManager" type="text" class="w-full px-3 py-2 border rounded-md" placeholder="e.g., Jody Thomason">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input id="cadPhone" type="tel" class="w-full px-3 py-2 border rounded-md" placeholder="e.g., 417-268-5031">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1"># Of PCC's in the Field</label>
                            <input id="cadPccInField" type="number" step="0.5" class="w-full px-3 py-2 border rounded-md" placeholder="e.g., 2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Branch <span class="text-red-600">*</span></label>
                            <input id="cadBranch" list="cadBranchList" required class="w-full px-3 py-2 border rounded-md" placeholder="e.g., 77">
                            <datalist id="cadBranchList">
                                <option value="77"></option>
                                <option value="78"></option>
                                <option value="80"></option>
                                <option value="98"></option>
                                <option value="195"></option>
                                <option value="2470"></option>
                                <option value="2471"></option>
                                <option value="2513"></option>
                                <option value="2587"></option>
                                <option value="2531"></option>
                                <option value="2836"></option>
                                <option value="2780"></option>
                                <option value="R50"></option>
                            </datalist>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Daily TAP Goal</label>
                            <input id="cadTapGoal" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Daily TAP Actual</label>
                            <input id="cadTapActual" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Coaching Rides Today</label>
                            <input id="cadCoachingRides" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">TAP from Coaching Rides</label>
                            <input id="cadTapFromCoaching" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">TAP Part TMX (70%)</label>
                            <input id="cadTapPartTmx" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">TAP Part RNA (70%)</label>
                            <input id="cadTapPartRna" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">TAP SOLD (25% YOY)</label>
                            <input id="cadTapSoldYoy" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Daily Raw Sales Need</label>
                            <input id="cadRawSalesNeed" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Daily Raw Sales Actual (20% YOY)</label>
                            <input id="cadRawSalesActual" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Revenue Daily Goal (Fcst REV/18d)</label>
                            <input id="cadRevenueDailyGoal" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Rev. $'s Scheduled Tomorrow</label>
                            <input id="cadRevenueScheduledTomorrow" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">TMX Missed Stop % (10%)</label>
                            <input id="cadTmxMissedStopPct" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">RNA Missed Stop % (15%)</label>
                            <input id="cadRnaMissedStopPct" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Backlog Going Tomorrow (20%)</label>
                            <input id="cadBacklogTomorrow" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1"># Rep Req Daily Goal (2 per Tech)/Day</label>
                            <input id="cadRepReqDailyGoal" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1"># Daily Actual Request Reviews</label>
                            <input id="cadDailyActualReqReviews" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">OT % of Std Hrs Forecasted Hours</label>
                            <input id="cadOtPctStdHrs" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Initials/Date</label>
                            <input id="cadInitialsDate" type="text" class="w-full px-3 py-2 border rounded-md" placeholder="e.g., RW 11/07/25">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">TAP Leads</label>
                            <input id="cadTapLeads" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">INSP PRP</label>
                            <input id="cadInspPrp" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">LOBs PRP</label>
                            <input id="cadLobsPrp" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">LOBs Sold</label>
                            <input id="cadLobsSold" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dollars SLD</label>
                            <input id="cadDollarsSld" type="number" step="0.01" class="w-full px-3 py-2 border rounded-md" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Next Day CONF</label>
                            <input id="cadNextDayConf" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PC NO TC Conversions</label>
                            <input id="cadPcNoTcConversions" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Next Day Apps</label>
                            <input id="cadNextDayApps" type="number" step="1" class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Opportunities and Actions Being Taken</label>
                            <textarea id="cadNotes" rows="3" class="w-full px-3 py-2 border rounded-md" placeholder="Branch notes"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeBranchCadenceModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-brand text-white rounded-md hover:bg-opacity-90">Save Cadence Entry</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Cadence Import Modal -->
    <div id="cadenceImportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 modal-window">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Paste Cadence Rows</h2>
                    <button onclick="closeCadenceImportModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="space-y-4">
                    <p class="text-sm text-gray-600">Expected tab-separated columns: Region, Code, Branch Name, Branch Manager, Phone, TAP Leads, INSP PRP, LOBs PRP, LOBs Sold, Dollars SLD, Next Day CONF, PC NO TC Conversions, Next Day Apps. Totals rows are skipped.</p>
                    <textarea id="cadenceImportText" rows="10" class="w-full px-3 py-2 border rounded-md" placeholder="Paste rows here (TSV)"></textarea>
                    <div id="cadenceImportStatus" class="text-sm text-gray-500"></div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeCadenceImportModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="button" onclick="importCadenceRows()" class="px-6 py-2 bg-brand text-white rounded-md hover:bg-opacity-90">Import Rows</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Job Assignment Modal -->
    <div id="jobAssignmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 flex flex-col modal-window">
            <div class="p-6 flex-1 overflow-y-auto pb-24">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="jobAssignmentTitle" class="text-2xl font-bold text-gray-800">Job Assignment</h2>
                    <button onclick="closeJobAssignmentModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-3 items-center">
                    <div class="flex items-center gap-3">
                        <label class="text-sm text-gray-700">Assign selected tech to jobs:</label>
                        <select id="globalTechSelect" class="px-3 py-2 border rounded-md"></select>
                        <button class="px-3 py-2 bg-brand text-white rounded-md hover:bg-brand-color-light" onclick="assignSelectedTech()">Assign to Selected</button>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-sm text-gray-700">Assign selected Ops Manager:</label>
                        <select id="globalOmSelect" class="px-3 py-2 border rounded-md"></select>
                        <button class="px-3 py-2 bg-brand text-white rounded-md hover:bg-opacity-90" onclick="assignSelectedOM()">Set OM for Selected</button>
                    </div>
                </div>

                <div id="jobAssignmentInfo" class="mb-3 text-xs text-gray-700 bg-gray-50 rounded p-3 hidden"></div>

                <div id="jobAssignmentStatus" class="text-sm text-gray-600 mb-2">Loading jobs...</div>

                <div class="border rounded-md scroll-x">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left">Select</th>
                                <th class="px-3 py-2 text-left">ID</th>
                                <th class="px-3 py-2 text-left">Customer</th>
                                <th class="px-3 py-2 text-left">Type</th>
                                <th class="px-3 py-2 text-left">Scheduled</th>
                                <th class="px-3 py-2 text-left">Assigned Tech</th>
                                <th class="px-3 py-2 text-left">Ops Manager</th>
                                <th class="px-3 py-2 text-left">Action</th>
                            </tr>
                        </thead>
                        <tbody id="jobAssignmentTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div id="jobAssignmentFooter" class="bg-white border-t px-6 py-4 flex justify-end gap-3 z-10 flex-none sticky bottom-0">
                <button type="button" onclick="closeJobAssignmentModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Close</button>
                <button type="button" onclick="saveJobAssignments()" class="px-6 py-2 bg-brand text-white rounded-md hover:bg-opacity-90">Save Changes</button>
                <button type="button" onclick="(function(){ try { saveJobAssignments(); } catch(e){} closeJobAssignmentModal(); })()" class="px-6 py-2 bg-brand text-white rounded-md hover:bg-opacity-90">Save and Close</button>
            </div>
        </div>
    </div>

    <!-- New Settings Modal (Dashboard Settings, dark theme) -->
    <div id="dashboardCustomizerModal" class="fixed inset-0 hidden z-50">
        <div class="absolute inset-0 bg-black/60" onclick="closeDashboardCustomizer()" aria-hidden="true"></div>
        <div id="dashboardCustomizerContainer" 
             class="absolute bg-[#2d3748] rounded-xl shadow-2xl border-2 border-gray-600 flex flex-col overflow-hidden"
             style="width: 1100px; height: 700px; min-width: 900px; min-height: 600px; left: 50%; top: 50%; transform: translate(-50%, -50%);">
            <div id="dashboardCustomizerHeader" class="settings-modal-header flex items-center justify-between px-6 py-4 border-b" style="cursor: move;">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-brand" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317a1 1 0 011.35 0l.9.8a1 1 0 00.65.25h1.15a1 1 0 01.95.68l.42 1.22a1 1 0 00.29.44l.98.86a1 1 0 010 1.5l-.98.86a1 1 0 00-.29.44l-.42 1.22a1 1 0 01-.95.68h-1.15a1 1 0 00-.65.25l-.9.8a1 1 0 01-1.35 0l-.9-.8a1 1 0 00-.65-.25H7.6a1 1 0 01-.95-.68l-.42-1.22a1 1 0 00-.29-.44l-.98-.86a1 1 0 010-1.5l.98-.86a1 1 0 00.29-.44l.42-1.22a1 1 0 01.95-.68h1.15a1 1 0 00.65-.25l.9-.8z"></path>
                        <circle cx="12" cy="12" r="3" stroke-width="2"></circle>
                    </svg>
                    <h3 class="text-lg font-semibold">Dashboard Customization</h3>
                </div>
                <button onclick="closeDashboardCustomizer()" class="settings-close-btn" aria-label="Close">âœ•</button>
            </div>
            <div class="settings-modal-body">
                <div class="settings-tabs flex items-center gap-2 px-6 pt-4">
                    <button id="settingsTabBtnWidgets" class="settings-tab-btn active" onclick="switchSettingsTab('widgets')">Widget Library</button>
                    <button id="settingsTabBtnLayout" class="settings-tab-btn" onclick="switchSettingsTab('layout')">Layout</button>
                    <button id="settingsTabBtnDemo" class="settings-tab-btn" onclick="switchSettingsTab('demo')">Demo Mode</button>
                    <button id="settingsTabBtnTheme" class="settings-tab-btn" onclick="switchSettingsTab('theme')">Theme & Icons</button>
                    <button id="settingsTabBtnIdle" class="settings-tab-btn" onclick="switchSettingsTab('idle')">Idle Mode</button>
                </div>
                <div class="px-6 pb-6">
                    <!-- Widgets Tab -->
                    <section id="settingsTabWidgets" class="settings-tab-panel">
                        <div class="flex gap-2 mb-4">
                            <button onclick="filterWidgets('all', event)" class="widget-filter px-3 py-2 rounded-lg bg-gray-700 text-gray-200">All</button>
                            <button onclick="filterWidgets('sales', event)" class="widget-filter px-3 py-2 rounded-lg bg-gray-700 text-gray-200">Sales</button>
                            <button onclick="filterWidgets('operations', event)" class="widget-filter px-3 py-2 rounded-lg bg-gray-700 text-gray-200">Operations</button>
                            <button onclick="filterWidgets('executive', event)" class="widget-filter px-3 py-2 rounded-lg bg-gray-700 text-gray-200">Executive</button>
                        </div>
                        <div id="widgetLibraryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                    </section>
                    <!-- Layout Tab -->
                    <section id="settingsTabLayout" class="settings-tab-panel hidden">
                        <div class="flex flex-wrap items-center gap-2 mb-4">
                            <button id="layoutEditToggleBtn" onclick="toggleLayoutEditMode()" class="px-3 py-2 rounded-md">Enable Edit Mode</button>
                            <button onclick="resetLayoutConfig()" class="px-3 py-2 rounded-md">Reset Layout</button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Grid Columns: <span id="gridColumnsValue">3</span></label>
                                <input id="gridColumns" type="range" min="1" max="6" step="1" value="3" class="w-full" oninput="updateGridColumns(this.value)">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Widget Spacing (px): <span id="widgetSpacingValue">16</span></label>
                                <input id="widgetSpacing" type="range" min="0" max="48" step="2" value="16" class="w-full" oninput="updateWidgetSpacing(this.value)">
                            </div>
                        </div>
                        <div class="mt-4">
                            <h4 class="text-sm font-semibold mb-2">Layout Preview</h4>
                            <div id="layoutPreviewGrid" class="grid gap-4" style="grid-template-columns: repeat(3, minmax(0, 1fr));">
                                <div class="preview-card">Sales KPIs</div>
                                <div class="preview-card">Pipeline</div>
                                <div class="preview-card">Quality</div>
                                <div class="preview-card">Calendar</div>
                                <div class="preview-card">Gmail</div>
                                <div class="preview-card">Drive</div>
                            </div>
                        </div>
                        <p class="text-xs opacity-80 mt-3">Edit mode lets you move and resize widgets. Reset clears custom layout.</p>
                    </section>
                    <!-- Demo Tab -->
                    <section id="settingsTabDemo" class="settings-tab-panel hidden">
                        <div class="flex items-center gap-3 mb-3">
                            <label class="inline-flex items-center gap-2">
                                <input id="demoModeToggle" type="checkbox" />
                                <span>Enable Demo Mode</span>
                            </label>
                            <select id="demoPersonaSelect" class="px-3 py-2 rounded-md">
                                <option value="Sales">Sales</option>
                                <option value="Operations">Operations</option>
                                <option value="Branch Manager">Branch Manager</option>
                                <option value="Executive">Executive</option>
                                <option value="Admin">Admin</option>
                            </select>
                            <button onclick="(function(){ try{ saveDemoSettings(); showDemoBanner(); }catch(_){} })()" class="px-3 py-2 rounded-md">Apply</button>
                        </div>
                        <p class="text-xs opacity-80">Demo mode overrides the dashboard persona for previews and training.</p>
                    </section>
                    <!-- Theme & Icons Tab -->
                    <section id="settingsTabTheme" class="settings-tab-panel hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-sm font-semibold mb-2">Theme Mode</h4>
                                <div class="space-y-2">
                                    <label class="inline-flex items-center gap-2"><input type="radio" name="themeMode" value="light" onchange="applyThemeMode(this.value)"> <span>Light</span></label>
                                    <label class="inline-flex items-center gap-2"><input type="radio" name="themeMode" value="dark" onchange="applyThemeMode(this.value)"> <span>Dark</span></label>
                                    <label class="inline-flex items-center gap-2"><input type="radio" name="themeMode" value="auto" onchange="applyThemeMode(this.value)" checked> <span>Auto</span></label>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold mb-2">Icon Rendering Fixes</h4>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" id="iconRenderingFixesToggle" onchange="toggleIconRenderingFixes(this.checked)"> <span>Apply PNG icon rendering fixes</span></label>
                                <p class="text-xs opacity-70 mt-2">Ensures crisp rendering for registered PNG icons.</p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h4 class="text-sm font-semibold mb-2">PNG Icon Registration Status</h4>
                            <div id="iconRegistrationStatus" class="text-xs opacity-80">Loading...</div>
                        </div>
                        <div class="mt-4">
                            <h4 class="text-sm font-semibold mb-2">Icon Test Grid</h4>
                            <div id="iconTestGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
                        </div>
                    </section>

                    <!-- Idle Mode Tab -->
                    <section id="settingsTabIdle" class="settings-tab-panel hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="idleEnabled">
                                <label for="idleEnabled">Enable Idle Mode</label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Idle Animation</label>
                                <select id="idleModeSelect" class="px-3 py-2 rounded-md">
                                    <option value="floating">Floating Pests</option>
                                    <option value="rat">Walking Rat</option>
                                    <option value="spiders">Crawling Spiders</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Delay Before Start</label>
                                <input id="idleDelay" type="range" min="1" max="10" step="1" value="3" class="w-full" oninput="document.getElementById('idleDelayValue').textContent = this.value + ' min'">
                                <div class="text-xs opacity-80 mt-1">Delay: <span id="idleDelayValue">3 min</span></div>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button class="px-3 py-2 rounded-md" onclick="startIdleNow()">Start Idle Now</button>
                            <button class="px-3 py-2 rounded-md" onclick="stopIdle()">Stop Idle</button>
                            <button class="px-3 py-2 rounded-md" onclick="updateIdleSettings()">Save Idle Settings</button>
                        </div>
                        <p class="text-xs opacity-70 mt-2">Idle mode shows playful animations when the dashboard is inactive.</p>
                    </section>
                </div>
            </div>
            <div class="settings-modal-footer">
                <button onclick="closeDashboardCustomizer()" class="settings-close-btn-secondary">Close</button>
            </div>
            <div id="dashboardCustomizerResizeHandle" class="absolute bottom-2 right-2 w-6 h-6 cursor-nwse-resize bg-[var(--brand-color)] opacity-70 rounded-md" title="Resize"></div>
        </div>
        <style>
            .settings-modal-header { background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.0)); border-color: rgba(255,255,255,0.08); }
            .settings-close-btn { color: #9ca3af; padding: 6px 10px; border-radius: 8px; }
            .settings-close-btn:hover { background: rgba(255,255,255,0.08); color: #e5e7eb; }
            .settings-modal-body { height: calc(100% - 52px - 56px); overflow: auto; }
            .settings-tabs { border-bottom: 1px solid rgba(255,255,255,0.06); margin-bottom: 12px; }
            .settings-tab-btn { font-size: 0.875rem; padding: 8px 12px; border-radius: 10px; color: #d1d5db; border: 1px solid transparent; background: rgba(255,255,255,0.05); position: relative; }
            .settings-tab-btn:hover { background: rgba(255,255,255,0.08); color: #f3f4f6; }
            .settings-tab-btn.active { color: #fff; border-color: rgba(255,255,255,0.10); box-shadow: 0 0 0 2px rgba(255,255,255,0.04) inset; }
            .settings-tab-btn.active::after { content: ''; position: absolute; left: 0; right: 0; bottom: -2px; height: 2px; background: var(--brand-color, #E4002B); box-shadow: 0 0 10px var(--brand-color, #E4002B); }
            .settings-tab-panel { padding-top: 12px; }
            .settings-modal-footer { position: sticky; bottom: 0; background: rgba(17,24,39,0.98); border-top: 1px solid rgba(255,255,255,0.06); padding: 12px 16px; display: flex; justify-content: flex-end; }
            .settings-close-btn-secondary { background: linear-gradient(135deg, var(--brand-color, #10b981), var(--brand-color-dark, #0b7a58)); color: #fff; border: 1px solid rgba(255,255,255,0.10); padding: 8px 14px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.35); }
            .settings-close-btn-secondary:hover { filter: brightness(1.05); }
            /* Widget cards */
            .widget-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 8px; transform: scale(1); transition: all 0.2s ease; }
            .widget-card:hover { transform: scale(1.03); }
            .widget-card h4 { font-weight: 600; color: #fff; }
            .widget-card p { font-size: 0.8125rem; color: #cbd5e1; }
            .widget-card button { align-self: flex-start; padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.08); color: #fff; }
            .widget-card button:hover { background: rgba(255,255,255,0.12); }
            /* Layout preview mini-cards */
            .preview-card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 12px; text-align: center; color: #e5e7eb; }
            /* Custom scrollbar */
            .settings-modal-body::-webkit-scrollbar { width: 10px; }
            .settings-modal-body::-webkit-scrollbar-track { background: #1a202c; border-radius: 6px; }
            .settings-modal-body::-webkit-scrollbar-thumb { background: var(--brand-color, #E4002B); border-radius: 6px; }
            .settings-modal-body::-webkit-scrollbar-thumb:hover { background: var(--brand-color-dark, #B00024); box-shadow: 0 0 10px var(--brand-color, #E4002B); }
            /* Range slider styling */
            .settings-modal-body input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #374151; border-radius: 6px; outline: none; }
            .settings-modal-body input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--brand-color, #E4002B); box-shadow: 0 0 10px rgba(228, 0, 43, 0.6); cursor: pointer; }
            .settings-modal-body input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: var(--brand-color, #E4002B); box-shadow: 0 0 10px rgba(228, 0, 43, 0.6); cursor: pointer; }
            /* Notification toast */
            .notification-toast { position: fixed; top: 20px; right: 20px; background: rgba(17, 24, 39, 0.95); border: 1px solid rgba(255,255,255,0.12); color: #fff; padding: 12px 16px; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); z-index: 1000; animation: slideInRight 0.3s ease; }
            @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
            @keyframes slideOutRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(20px); } }
        </style>
    </div>

    <!-- Completed Today Modal -->
    <div id="completedTodayModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 modal-window">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">Completed Today</h3>
                <button onclick="closeCompletedTodayModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close">âœ•</button>
            </div>
            <div class="p-6">
                <div id="completedTodayStatus" class="text-sm text-gray-600 mb-2">Loading completed services...</div>
                <ul id="completedTodayList" class="divide-y"></ul>
            </div>
        </div>
    </div>

    <!-- Issues Reported Modal -->
    <div id="issuesReportedModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 modal-window">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">Issues Reported</h3>
                <button onclick="closeIssuesReportedModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close">âœ•</button>
            </div>
            <div class="p-6">
                <div id="issuesReportedStatus" class="text-sm text-gray-600 mb-2">Loading reported issues...</div>
                <ul id="issuesReportedList" class="divide-y"></ul>
            </div>
        </div>
    </div>

    <!-- Logic Info Modal -->
    <div id="logicInfoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 modal-window">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 id="logicInfoTitle" class="text-lg font-semibold">Logic & Source</h3>
                <button onclick="closeLogicInfoModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close">âœ•</button>
            </div>
            <div id="logicInfoBody" class="p-6 text-sm text-gray-800"></div>
        </div>
    </div>

    <!-- Start Log Form Modal -->
    <div id="startLogModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white w-full max-w-4xl mx-4 rounded-lg shadow-xl modal-window">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold">Start Log Entry (Sales â†’ OM)</h3>
                <button onclick="closeStartLogModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close">âœ•</button>
            </div>
            <div class="p-6">
                <p id="startLogStatus" class="text-sm text-gray-500 mb-3">Fill red (Sales) and yellow (OM) fields</p>
                <form id="startLogForm" onsubmit="event.preventDefault(); submitStartLogForm();">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 rounded-lg" style="background:#fde2e2">
                            <h4 class="font-semibold mb-2">Sales (Red)</h4>
                            <div class="space-y-2">
                                <input id="slSoldDate" type="date" class="w-full border rounded px-3 py-2" placeholder="Sold Date">
                                <input id="slAccountName" type="text" class="w-full border rounded px-3 py-2" placeholder="Account Name">
                                <input id="slServiceAddress" type="text" class="w-full border rounded px-3 py-2" placeholder="Service Address">
                                <input id="slSalesReps" type="text" class="w-full border rounded px-3 py-2" placeholder="Sales Rep(s)">
                                <input id="slInitialPrice" type="text" class="w-full border rounded px-3 py-2" placeholder="Initial/Job 1x Price">
                                <input id="slMaintenancePrice" type="text" class="w-full border rounded px-3 py-2" placeholder="Maintenance (Contract) Price">
                                <input id="slType" type="text" class="w-full border rounded px-3 py-2" placeholder="Type (Contract/Job 1x)">
                                <input id="slFrequency" type="text" class="w-full border rounded px-3 py-2" placeholder="Frequency (# Annual Visits)">
                                <input id="slLogBookNeeded" type="text" class="w-full border rounded px-3 py-2" placeholder="Log Book Needed (Y/N)">
                                <input id="slTapLeadSpecialist" type="text" class="w-full border rounded px-3 py-2" placeholder="TAP Lead or Specialist Name">
                                <input id="slPestPacLoc" type="text" class="w-full border rounded px-3 py-2" placeholder="PestPac Loc #">
                                <input id="slStartMonth" type="text" class="w-full border rounded px-3 py-2" placeholder="Customer Requested Start Month">
                            </div>
                        </div>
                        <div class="p-4 rounded-lg" style="background:#fef3c7">
                            <h4 class="font-semibold mb-2">Operations Manager (Yellow)</h4>
                            <div class="space-y-2">
                                <input id="slOpsManager" type="text" class="w-full border rounded px-3 py-2" placeholder="Operations Manager">
                                <input id="slAssignedSpecialist" type="text" class="w-full border rounded px-3 py-2" placeholder="Assigned Specialist">
                                <input id="slMaterialsOrdered" type="text" class="w-full border rounded px-3 py-2" placeholder="Materials Ordered (Y/N)">
                                <input id="slInstallStarted" type="date" class="w-full border rounded px-3 py-2" placeholder="Initial/Installation Started">
                                <input id="slPOC" type="text" class="w-full border rounded px-3 py-2" placeholder="POC Name/Phone#">
                                <input id="slConfirmedStartDate" type="date" class="w-full border rounded px-3 py-2" placeholder="Confirmed Start Date with POC">
                                <textarea id="slNotes" class="w-full border rounded px-3 py-2" rows="4" placeholder="Special Notes / Equipment Overview"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end gap-2">
                        <button type="button" onclick="closeStartLogModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-brand text-white rounded-md hover:bg-brand-color-light">Save to StartPackets</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Start Log Paste Import Modal -->
    <div id="startLogPasteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white w-full max-w-3xl mx-4 rounded-lg shadow-xl modal-window">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold">Quick Paste Start Logs</h3>
                <button onclick="closeStartLogPasteModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close">âœ•</button>
            </div>
            <div class="p-6 space-y-4">
                <textarea id="startLogPasteArea" class="w-full border rounded px-3 py-2 h-48" placeholder="Paste tab-separated rows including header..."></textarea>
                <div class="flex justify-between items-center">
                    <div>
                        <button onclick="parseStartLogRows()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Parse</button>
                        <button onclick="importStartLogRows()" class="ml-2 px-4 py-2 bg-brand text-white rounded hover:bg-brand-color-light">Import</button>
                    </div>
                    <span class="text-sm text-gray-500">Destination: StartPackets</span>
                </div>
                <ul id="startLogPastePreview" class="list-disc pl-6 text-gray-700"></ul>
            </div>
        </div>
    </div>

    <!-- Sales Paste Import Modal (Tracker â†’ Sales) -->
    <div id="pasteImportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white w-full max-w-3xl mx-4 rounded-lg shadow-xl modal-window">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold">Quick Paste Import (Tracker â†’ Sales)</h3>
                <button onclick="closePasteImportModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close">âœ•</button>
            </div>
            <div class="p-6 space-y-4">
                <textarea id="pasteImportArea" class="w-full border rounded px-3 py-2 h-48" placeholder="Paste tab-separated rows including header..."></textarea>
                <div class="flex justify-between items-center">
                    <div>
                        <button onclick="parsePastedRows()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Parse</button>
                        <button onclick="importParsedRows()" class="ml-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Import</button>
                    </div>
                    <span class="text-sm text-gray-500">Destination: TrackerData</span>
                </div>
                <ul id="pastePreviewList" class="list-disc pl-6 text-gray-700"></ul>
            </div>
        </div>
    </div>
  <!-- Mail view: Gmail-like list and reader -->
  <div id="mail-view" class="mail-view" style="display:none;">
    <h2 class="mail-title">Mail</h2>
    <div class="mail-toolbar">
      <button id="mail-refresh" class="btn">Refresh</button>
    </div>
    <div class="mail-container">
      <div class="mail-list" id="mail-list"></div>
      <div class="mail-resizer" id="mail-resizer" role="separator" aria-orientation="vertical" aria-label="Resize mail panes"></div>
      <div class="mail-detail" id="mail-detail">
        <div class="mail-detail-header">
          <div id="mail-subject" class="mail-subject"></div>
          <div id="mail-meta" class="mail-meta"></div>
          <div class="mail-actions action-menu">
            <button id="mail-actions-trigger" class="btn btn-sm" aria-haspopup="true" aria-expanded="false" aria-controls="mail-actions-panel">Actions â–¾</button>
            <div id="mail-actions-panel" class="mail-actions-panel" style="display:none;" role="menu" aria-label="Mail actions">
              <button id="mail-act-open" class="dropdown-item" role="menuitem">Open in Gmail</button>
              <button id="mail-act-respond" class="dropdown-item" role="menuitem">Respond</button>
            </div>
          </div>
        </div>
        
        <iframe id="mail-iframe" class="mail-iframe" sandbox="allow-same-origin allow-popups allow-forms" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>

  <!-- Reply Popout Modal -->
  <div id="mail-reply-modal" class="modal-overlay" style="display:none;">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="reply-modal-title">
      <div class="modal-header">
        <h3 id="reply-modal-title" class="modal-title">Respond</h3>
        <button id="reply-close" class="btn btn-sm" aria-label="Close">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="mail-reply">
          <div class="reply-row">
            <label for="reply-to">To</label>
            <input id="reply-to" type="email" class="reply-input" placeholder="recipient@example.com" />
          </div>
          <div class="reply-row">
            <label for="reply-subject">Subject</label>
            <input id="reply-subject" type="text" class="reply-input" placeholder="Subject" />
          </div>
          <div class="reply-row">
            <label for="reply-body">Message</label>
            <textarea id="reply-body" class="reply-textarea" rows="8" placeholder="Write your message..."></textarea>
          </div>
          <div class="reply-actions">
            <button id="reply-send" class="btn">Send</button>
            <button id="reply-cancel" class="btn">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .mail-view { padding: 0 16px 16px; }
    .mail-title { margin: 0 0 4px; font-size: 18px; color: #f2f6fb; font-weight: 600; }
    .mail-help { margin: 0 0 10px; font-size: 12px; color: #a9bdd3; }
    .mail-toolbar { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    /* Gmail panel header sticks to the top of the space */
    #gmail-header { background: #ffffff; z-index: 3; }
    /* Keep the toolbar anchored at the very top of the Mail View (which sits directly below the Gmail header) */
    .mail-view .mail-toolbar { position: sticky; top: 0; padding: 12px 16px; background: rgba(10, 20, 34, 0.95); border-bottom: 1px solid #364559; z-index: 2; }
    .mail-query { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #4a5b6d; background:#203043; color:#eef3f8; font-size:14px; }
    .btn { padding:8px 12px; border-radius:6px; border:1px solid #3a4a5a; background:#253244; color:#e8edf3; cursor:pointer; }
    .btn:hover { filter:brightness(1.1); }
    .btn-sm { padding:6px 10px; font-size:12px; }
    .mail-container { display:grid; grid-template-columns: var(--mail-list-width, 360px) var(--mail-resizer-width, 6px) 1fr; gap:14px; min-height: 65vh; }
    .mail-list { border:1px solid #4a5b6d; border-radius:10px; overflow:auto; background:#1c2735; }
    .mail-item { padding:12px 14px; border-bottom:1px solid #364559; cursor:pointer; display:grid; grid-template-columns: 1fr auto; gap:8px; }
    .mail-item:hover { background:#223244; }
    .mail-item.unread .mail-subject-line { font-weight:600; }
    .mail-from { color:#b1c6db; font-size:13px; }
    .mail-subject-line { color:#f2f6fb; font-size:15px; }
    .mail-snippet { color:#c5d3e0; font-size:12px; margin-top:4px; grid-column: 1 / span 2; }
    .mail-date { color:#b1c6db; font-size:12px; }
    .mail-detail { border:1px solid #4a5b6d; border-radius:10px; overflow:hidden; background:#0f1a2a; display:flex; flex-direction:column; }
    .mail-detail-header { padding:14px; border-bottom:1px solid #364559; }
    .mail-actions { margin-top:8px; display:flex; gap:8px; }
    .mail-subject { font-size:17px; color:#f2f6fb; font-weight:600; }
    .mail-meta { font-size:12px; color:#b1c6db; margin-top:4px; }
    .mail-iframe { flex:1; border:0; background:#0b1421; }
    .mail-reply { padding:12px; border-bottom:1px solid #364559; background:#122033; }
    .reply-row { display:grid; grid-template-columns: 80px 1fr; gap:8px; align-items:center; margin-bottom:8px; }
    .reply-input { width:100%; padding:8px 10px; border-radius:6px; border:1px solid #4a5b6d; background:#203043; color:#eef3f8; font-size:13px; }
    .reply-textarea { width:100%; padding:10px 12px; border-radius:6px; border:1px solid #4a5b6d; background:#203043; color:#eef3f8; font-size:13px; }
    .reply-actions { display:flex; gap:8px; }

    /* Header actions dropdown (dark theme) */
    .mail-actions { position: relative; }
    .mail-actions-panel { position: absolute; right: 0; top: calc(100% + 6px); min-width: 180px; border:1px solid #364559; border-radius:10px; background:#101b2c; box-shadow: 0 12px 28px rgba(0,0,0,0.35); padding:6px; z-index: 20; }
    .dropdown-item { display:block; width:100%; text-align:left; padding:8px 10px; border-radius:6px; background:transparent; color:#e8edf3; border:0; cursor:pointer; }
    .dropdown-item:hover { background:#1a2a40; }

    /* Modal popout styles */
    .modal-overlay { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal-dialog { width: min(720px, 100%); border-radius: 12px; border:1px solid #3a4a5a; background:#0f1a2a; box-shadow: 0 12px 28px rgba(0,0,0,0.45); }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding: 12px 16px; border-bottom:1px solid #364559; }
    .modal-title { margin: 0; font-size: 16px; color: #f2f6fb; font-weight: 600; }
    .modal-body { padding: 16px; }

    /* Draggable divider between list and reader */
    .mail-resizer { grid-column: 2; align-self: stretch; width: var(--mail-resizer-width, 6px); background: rgba(255,255,255,0.08); border-radius: 4px; cursor: col-resize; transition: background 0.15s ease-in-out; }
    .mail-resizer:hover { background: rgba(255,255,255,0.18); }

    /* Focus Mail: fullscreen overlay */
    body.focus-mail { overflow: hidden; }
    body.focus-mail #mail-view {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: #0a1422;
      padding: 16px;
    }
    body.focus-mail #mail-view .mail-toolbar {
      position: sticky;
      top: 0;
      padding: 12px 16px;
      background: rgba(10, 20, 34, 0.95);
      border-bottom: 1px solid #364559;
    }
    body.focus-mail #mail-view .mail-container {
      grid-template-columns: var(--mail-list-width, 420px) var(--mail-resizer-width, 6px) 1fr;
      min-height: calc(100vh - 120px);
    }

    /* Expanded list layout (focus-like look without overlay) */
    #mail-view.mail-zoom .mail-toolbar {
      position: sticky;
      top: 0;
      padding: 12px 16px;
      background: rgba(10, 20, 34, 0.95);
      border-bottom: 1px solid #364559;
      z-index: 2;
    }
    #mail-view.mail-zoom .mail-container {
      grid-template-columns: var(--mail-list-width, 520px) var(--mail-resizer-width, 6px) 1fr;
      min-height: 70vh;
    }
  </style>

  <script>
    // Dev: lightweight auto-reload for local preview (quiet + controllable)
    (function(){
      const KEY = 'autoReloadEnabled';
      const INTERVAL_KEY = 'autoReloadIntervalMs';
      const defaultOn = false; // opt-in by default to avoid dev console noise
      const stored = localStorage.getItem(KEY);
      let enabled = stored === null ? defaultOn : stored === '1';
      let lastTag = null;
      let inFlight = false;
      let controller = null;
      let reloading = false;
      let timerId = null;
      const target = new URL('index.html', window.location.href).toString();

      // Pause checks when any modal/dialog is open to avoid noisy network aborts
      const MODAL_IDS = [
        'settingsModal','aiAssistantModal','metricModal','cohortsModal','trainingModal','targetsModal','commsModal',
        'gmailThreadModal','quoteUploadModal','dailyPerformanceModal','branchCadenceModal','cadenceImportModal',
        'salesEntryModal','completedTodayModal','issuesReportedModal','jobAssignmentModal','startLogModal',
        'startLogPasteModal','pasteImportModal','mail-reply-modal','logicInfoModal'
      ];
      function anyModalOpen(){
        // mail-reply-modal uses inline style display:none; others toggle the 'hidden' class
        for (const id of MODAL_IDS){
          const el = document.getElementById(id);
          if (!el) continue;
          const isHiddenClass = el.classList && el.classList.contains('hidden');
          const styleDisplayNone = (el.style && el.style.display === 'none');
          if (!isHiddenClass && !styleDisplayNone) return true;
        }
        return false;
      }

      function getInterval(){
        const v = parseInt(localStorage.getItem(INTERVAL_KEY) || '2000', 10);
        return isFinite(v) && v >= 1000 ? v : 2000;
      }
      function startTimer(ms){
        stopTimer();
        timerId = EventRegistry.setInterval(() => { if (!document.hidden && !anyModalOpen()) check(); }, ms);
      }
      function stopTimer(){ if (timerId) { clearInterval(timerId); timerId = null; } }

      window.setAutoReload = function(on){
        enabled = !!on;
        try { localStorage.setItem(KEY, enabled ? '1' : '0'); } catch(_){ }
        if (enabled) startTimer(getInterval()); else stopTimer();
      };
      window.setAutoReloadInterval = function(ms){
        try { localStorage.setItem(INTERVAL_KEY, String(ms)); } catch(_){ }
        if (enabled) startTimer(getInterval());
      };
      window.addEventListener('beforeunload', () => { reloading = true; stopTimer(); try { controller?.abort(); } catch(_){} });
      window.addEventListener('pagehide', () => { stopTimer(); try { controller?.abort(); } catch(_){} });
      window.addEventListener('visibilitychange', () => {
        if (document.hidden) { stopTimer(); try { controller?.abort(); } catch(_){} }
        else if (enabled) { startTimer(getInterval()); }
      });
      if (!enabled) return;
      startTimer(getInterval());

      async function check(){
        if (reloading || inFlight || anyModalOpen()) return;
        inFlight = true;
        try {
          controller = new AbortController();
          const res = await fetch(target, { method:'HEAD', cache:'no-store', signal: controller.signal });
          const tag = res.headers.get('ETag') || res.headers.get('Last-Modified');
          if (!lastTag) { lastTag = tag; return; }
          if (tag && tag !== lastTag) { reloading = true; stopTimer(); try { controller?.abort(); } catch(_){} setTimeout(() => location.reload(), 10); }
        } catch(_) {
          // Quietly ignore network aborts during reload
        } finally {
          inFlight = false;
        }
      }
    })();
    (function() {
      const isAppsScript = (typeof google !== 'undefined' && google.script && google.script.run);
      let currentEmail = null; // track selected email for reply/open actions

      function formatDateTime(iso) {
        try {
          return new Date(iso).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
        } catch (e) { return iso; }
      }

      function sampleEmails() {
        const now = new Date();
        function iso(dOffsetMinutes) { return new Date(now.getTime() - dOffsetMinutes * 60000).toISOString(); }
        return [
          { messageId: 's1', threadId: 't1', subject: 'Welcome to Streamline Dashboard', from: 'team@streamline.example', to: 'you@example.com', date: iso(30), snippet: 'Thanks for trying the dashboard â€” here are a few tips...', unread: true },
          { messageId: 's2', threadId: 't2', subject: 'Daily Sales Report', from: 'reports@example.com', to: 'you@example.com', date: iso(180), snippet: 'Attached is the daily sales report. Highlights: Midwest +7%...', unread: false },
          { messageId: 's3', threadId: 't3', subject: 'Branch Manager Meeting Notes', from: 'ops@example.com', to: 'you@example.com', date: iso(1440), snippet: 'Action items: finalize calendar, quality checklist updates...', unread: true }
        ];
      }

      function renderMailList(items) {
        const list = document.getElementById('mail-list');
        list.innerHTML = '';
        items.forEach(item => {
          const el = document.createElement('div');
          el.className = 'mail-item' + (item.unread ? ' unread' : '');
          el.innerHTML = `
            <div>
              <div class=\"mail-from\">${item.from || ''}</div>
              <div class=\"mail-subject-line\">${item.subject || '(no subject)'}</div>
              <div class=\"mail-snippet\">${item.snippet || ''}</div>
            </div>
            <div class=\"mail-date\">${formatDateTime(item.date)}</div>
          `;
          el.addEventListener('click', () => openEmail(item));
          list.appendChild(el);
        });
      }

      function openEmail(item) {
        currentEmail = item;
        const subjectEl = document.getElementById('mail-subject');
        const metaEl = document.getElementById('mail-meta');
        const iframe = document.getElementById('mail-iframe');
        subjectEl.textContent = item.subject || '(no subject)';
        metaEl.textContent = `${item.from || ''} â€¢ ${formatDateTime(item.date)}`;

        if (isAppsScript) {
          google.script.run.withSuccessHandler(function(res) {
            iframe.srcdoc = res && res.html ? res.html : '<p>No content</p>';
          }).getEmailHtml(item.messageId);
        } else {
          // Sample content for local preview
          iframe.srcdoc = `<div style=\"font-family:system-ui, -apple-system, Segoe UI, Roboto; color:#e8edf3; background:#0d1522; padding:16px;\">\n            <p><strong>${item.subject || ''}</strong></p>\n            <p>This is a sample email body for preview. In the Apps Script web app, this will render the original HTML from Gmail in this reader pane.</p>\n            <p>From: ${item.from || ''}</p>\n            <p>Date: ${formatDateTime(item.date)}</p>\n          </div>`;
        }

        // Prefill reply form
        const replyTo = document.getElementById('reply-to');
        const replySubject = document.getElementById('reply-subject');
        const replyBody = document.getElementById('reply-body');
        if (replyTo) replyTo.value = (item.from || '').replace(/^.*<([^>]+)>.*/, '$1');
        if (replySubject) replySubject.value = `Re: ${item.subject || ''}`;
        if (replyBody) replyBody.value = '';

        // Update Open in Gmail action
        const gmailBtn = document.getElementById('mail-act-open') || document.getElementById('mail-open-gmail');
        if (gmailBtn) {
          const url = item.messageId ? `https://mail.google.com/mail/u/0/#search/rfc822msgid:${item.messageId}` : 'https://mail.google.com/';
          gmailBtn.onclick = () => window.open(url, '_blank');
        }

        // Ensure modal reply fields are visible and prefilled when an email opens
        const replyModal = document.getElementById('mail-reply-modal');
        if (replyModal && replyModal.style.display === 'flex') {
          const rb = document.getElementById('reply-body');
          if (rb) rb.focus();
        }
      }

      function loadEmails(query, max) {
        const q = (query && query.trim()) || 'in:inbox newer_than:7d';
        if (isAppsScript) {
          google.script.run.withSuccessHandler(renderMailList).listEmails(q, max || 25);
        } else {
          renderMailList(sampleEmails());
        }
      }

      function showMailView() {
        const view = document.getElementById('mail-view');
        if (!view) return;
        // Move the mail view into the dashboard content so it appears
        // at the top of the Gmail dashboard, fitting alongside the sidebar.
        // Insert at the very top of the dashboard content, directly under the global header
        const container = document.getElementById('dashboardContent');
        if (container && view.parentElement !== container) {
          try { container.insertAdjacentElement('afterbegin', view); } catch (_) { container.appendChild(view); }
        }
        view.style.display = 'block';
        // Ensure we start embedded (no overlay) with normal width
        document.body.classList.remove('focus-mail');
        view.classList.remove('mail-zoom');
        const leb = document.getElementById('mail-list-expand');
        if (leb) leb.textContent = 'Expand List';
        // Optional: scroll to the view
        view.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Keep it locked above the Gmail panel
        try { startMailViewLock(); } catch(_) {}
        // Load on first show
        if (!view.dataset.loaded) {
          view.dataset.loaded = '1';
          const input = document.getElementById('mail-query');
          loadEmails((input && input.value) || '');
        }
      }

      // Hook up toolbar and Mail nav
      document.addEventListener('DOMContentLoaded', function() {
        const refreshBtn = document.getElementById('mail-refresh');
        const queryInput = document.getElementById('mail-query');
        const listExpandBtn = document.getElementById('mail-list-expand');
        const mailView = document.getElementById('mail-view');
        const actionsTrigger = document.getElementById('mail-actions-trigger');
        const actionsPanel = document.getElementById('mail-actions-panel');
        const respondBtn = document.getElementById('mail-act-respond') || document.getElementById('mail-respond');
        const openGmailItem = document.getElementById('mail-act-open') || document.getElementById('mail-open-gmail');
        const replyModal = document.getElementById('mail-reply-modal');
        const replyCancel = document.getElementById('reply-cancel');
        const replyClose = document.getElementById('reply-close');
        const replySend = document.getElementById('reply-send');
        const replyTo = document.getElementById('reply-to');
        const replySubject = document.getElementById('reply-subject');
        const replyBody = document.getElementById('reply-body');
        if (refreshBtn) refreshBtn.addEventListener('click', () => {
          const q = (document.getElementById('mail-query') || {})?.value || '';
          loadEmails(q);
        });
        // Search input removed; skip keydown binding

        // Actions dropdown toggle
        function toggleActionsPanel() {
          if (!actionsPanel) return;
          const on = actionsPanel.style.display !== 'block';
          actionsPanel.style.display = on ? 'block' : 'none';
          if (actionsTrigger) actionsTrigger.setAttribute('aria-expanded', on ? 'true' : 'false');
        }
        if (actionsTrigger) actionsTrigger.addEventListener('click', (e) => { e.stopPropagation(); toggleActionsPanel(); });
        if (openGmailItem) openGmailItem.addEventListener('click', (e) => { e.stopPropagation(); toggleActionsPanel(); });

        // Popout modal open/close
        function openReplyModal() {
          showMailView();
          if (replyModal) {
            replyModal.style.display = 'flex';
            setTimeout(() => { if (replyBody) replyBody.focus(); }, 50);
          }
        }
        function closeReplyModal() {
          if (replyModal) replyModal.style.display = 'none';
        }
        if (respondBtn) respondBtn.addEventListener('click', openReplyModal);
        if (replyCancel) replyCancel.addEventListener('click', closeReplyModal);
        if (replyClose) replyClose.addEventListener('click', closeReplyModal);
        if (replySend) replySend.addEventListener('click', () => {
          const to = (replyTo && replyTo.value) || '';
          const subject = (replySubject && replySubject.value) || '';
          const bodyText = (replyBody && replyBody.value) || '';
          if (isAppsScript && google.script && google.script.run && google.script.run.sendEmail) {
            try { google.script.run.sendEmail(to, subject, bodyText); } catch(e) {}
          } else {
            console.log('Sample send:', { to, subject, body: bodyText });
          }
          closeReplyModal();
        });

        // Toggle list width between compact and expanded
        function getListWidth() {
          const val = getComputedStyle(mailView).getPropertyValue('--mail-list-width').trim();
          return val || '360px';
        }
        function setListWidth(px) {
          if (mailView) mailView.style.setProperty('--mail-list-width', px);
        }
        // Ensure default
        setListWidth(getListWidth());

        // Draggable divider to resize list/detail
        const resizer = document.getElementById('mail-resizer');
        if (resizer) {
          let startX = 0;
          let startWidth = 0;
          const minWidth = 260; // px
          const maxWidth = 800; // px
          function onMouseMove(e) {
            const delta = e.clientX - startX;
            const next = Math.min(maxWidth, Math.max(minWidth, startWidth + delta));
            setListWidth(next + 'px');
          }
          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            document.body.style.cursor = '';
            document.body.classList.remove('resizing');
            // Sync the zoom label if applicable
            const leb = document.getElementById('mail-list-expand');
            if (leb) {
              const cur = parseInt(getListWidth());
              leb.textContent = (isNaN(cur) || cur <= 400) ? 'Expand List' : 'Reset Width';
            }
          }
          resizer.addEventListener('mousedown', (e) => {
            showMailView();
            e.preventDefault();
            startX = e.clientX;
            startWidth = parseInt(getListWidth()) || 360;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.body.style.cursor = 'col-resize';
            document.body.classList.add('resizing');
          });
        }

        if (listExpandBtn) listExpandBtn.addEventListener('click', () => {
          showMailView();
          const cur = parseInt(getListWidth());
          const next = (isNaN(cur) || cur <= 400) ? 520 : 360;
          setListWidth(next + 'px');
          // Apply focus-like layout when expanded
          const view = document.getElementById('mail-view');
          if (view) view.classList.toggle('mail-zoom', next > 400);
          listExpandBtn.textContent = next > 400 ? 'Reset Width' : 'Expand List';
        });

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
          if (actionsPanel && actionsPanel.style.display === 'block') {
            const inside = e.target.closest('#mail-actions-panel') || e.target.closest('#mail-actions-trigger');
            if (!inside) { actionsPanel.style.display = 'none'; if (actionsTrigger) actionsTrigger.setAttribute('aria-expanded','false'); }
          }
        });

        // ESC closes reply modal or dropdown
        window.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            if (actionsPanel && actionsPanel.style.display === 'block') {
              actionsPanel.style.display = 'none';
              if (actionsTrigger) actionsTrigger.setAttribute('aria-expanded','false');
              return;
            }
            if (replyModal && replyModal.style.display === 'flex') {
              closeReplyModal();
              return;
            }
          }
        });

        // Note: The Mail nav now opens the AI Compose modal directly.
        // We no longer auto-open the mail view overlay from the sidebar nav.
      });

      // Mail overlay removed: Mail view is embedded in the Gmail tab
    })();
  </script>

    <script>
    // --- Settings Modal Helpers (Presto-X mirror) ---
    (function(){
      let currentWidgetFilter = 'all';

      window.switchSettingsTab = function(tab){
        const btnIds = ['widgets','layout','demo','theme','idle'];
        btnIds.forEach(id => {
          const btn = document.getElementById('settingsTabBtn' + id.charAt(0).toUpperCase() + id.slice(1));
          if(btn){ btn.classList.toggle('active', id === tab); }
          const panel = document.getElementById('settingsTab' + id.charAt(0).toUpperCase() + id.slice(1));
          if(panel){ panel.classList.toggle('hidden', id !== tab); }
        });
        if(tab === 'widgets'){ populateWidgetLibraryGrid(); }
        if(tab === 'theme'){ try { loadIconRegistrationStatus(); buildIconTestGrid(); } catch(e){} }
        if(tab === 'idle'){ try { loadIdleSettingsIntoUI(); } catch(e){} }
      };

      window.filterWidgets = function(section, ev){
        currentWidgetFilter = section;
        document.querySelectorAll('.widget-filter').forEach(btn => btn.classList.remove('bg-red-700'));
        if(ev && ev.target){ ev.target.classList.add('bg-red-700'); }
        populateWidgetLibraryGrid();
      };

      window.populateWidgetLibraryGrid = function(){
        const grid = document.getElementById('widgetLibraryGrid');
        if(!grid) return;
        const widgets = [
          { id:'sales-kpis', name:'Sales KPIs', desc:'Key performance metrics', section:'sales' },
          { id:'pipeline', name:'Pipeline', desc:'Opportunities by stage', section:'sales' },
          { id:'quality', name:'Quality', desc:'Service quality dashboard', section:'operations' },
          { id:'calendar', name:'Calendar', desc:'Week plan and visits', section:'operations' },
          { id:'gmail', name:'Gmail', desc:'Mail in context', section:'executive' },
          { id:'drive', name:'Drive', desc:'Shared files', section:'executive' }
        ];
        const items = widgets.filter(w => currentWidgetFilter==='all' || w.section===currentWidgetFilter);
        grid.innerHTML = items.map(w => `
          <div class="widget-card">
            <h4>${w.name}</h4>
            <p>${w.desc}</p>
            <button onclick="(window.addWidgetById?addWidgetById('${w.id}'):(console.log('Add widget', '${w.id}')))">Add</button>
          </div>
        `).join('');
      };

      window.updateGridColumns = function(val){
        const grid = document.getElementById('layoutPreviewGrid');
        if(grid){ grid.style.gridTemplateColumns = `repeat(${val}, minmax(0, 1fr))`; }
        const label = document.getElementById('gridColumnsValue');
        if(label){ label.textContent = String(val); }
      };

      window.updateWidgetSpacing = function(val){
        const grid = document.getElementById('layoutPreviewGrid');
        if(grid){ grid.style.gap = `${val}px`; }
        const label = document.getElementById('widgetSpacingValue');
        if(label){ label.textContent = String(val); }
      };

      window.showAppToast = function(msg){
        const toast = document.createElement('div');
        toast.className = 'notification-toast';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'slideOutRight 0.25s ease';
          setTimeout(() => toast.remove(), 220);
        }, 2500);
      };

      window.applyThemeMode = function(mode){
        const root = document.documentElement;
        root.setAttribute('data-theme-mode', mode);
        showAppToast(`Theme mode: ${mode}`);
      };

      window.toggleIconRenderingFixes = function(on){
        document.body.classList.toggle('icon-fix-png', !!on);
        showAppToast(on ? 'PNG rendering fixes enabled' : 'PNG rendering fixes disabled');
      };

      window.loadIconRegistrationStatus = function(){
        const el = document.getElementById('iconRegistrationStatus');
        if(el){ el.textContent = 'Registered 12 icons (PNG) â€¢ 4 inline SVG'; }
      };

      window.buildIconTestGrid = function(){
        const grid = document.getElementById('iconTestGrid');
        if(!grid) return;
        const samples = ['ðŸ­','ðŸ•·ï¸','ðŸª³','ðŸœ','ðŸ¦Ÿ','ðŸ¦—','ðŸª°','ðŸª²'];
        grid.innerHTML = samples.map(s => `<div class="preview-card" style="font-size:24px">${s}</div>`).join('');
      };

      const idleSettingsKey = 'prestoXIdleSettings';
      window.loadIdleSettings = function(){
        try{ return JSON.parse(localStorage.getItem(idleSettingsKey)||'{}'); }catch(_){ return {}; }
      };
      window.saveIdleSettings = function(s){ localStorage.setItem(idleSettingsKey, JSON.stringify(s||{})); };
      window.loadIdleSettingsIntoUI = function(){
        const s = loadIdleSettings();
        const enabled = !!s.enabled; const mode = s.mode||'floating'; const delay = s.delay||3;
        const en = document.getElementById('idleEnabled'); if(en) en.checked = enabled;
        const sel = document.getElementById('idleModeSelect'); if(sel) sel.value = mode;
        const rng = document.getElementById('idleDelay'); if(rng) rng.value = delay;
        const val = document.getElementById('idleDelayValue'); if(val) val.textContent = `${delay} min`;
      };
      let idleTimer = null;
      window.startIdleCountdown = function(){
        const s = loadIdleSettings();
        clearTimeout(idleTimer);
        if(!s.enabled) return;
        idleTimer = setTimeout(startIdleNow, (s.delay||3) * 60 * 1000);
      };
      window.startIdleNow = function(){ document.body.classList.add('idle-active'); showAppToast('Idle mode started'); };
      window.stopIdle = function(){ document.body.classList.remove('idle-active'); clearTimeout(idleTimer); showAppToast('Idle mode stopped'); };
      window.updateIdleSettings = function(){
        const s = {
          enabled: !!document.getElementById('idleEnabled')?.checked,
          mode: document.getElementById('idleModeSelect')?.value || 'floating',
          delay: Number(document.getElementById('idleDelay')?.value || 3)
        };
        saveIdleSettings(s);
        loadIdleSettingsIntoUI();
        startIdleCountdown();
        showAppToast('Idle settings saved');
      };

      // Initialize defaults when modal opens
      document.addEventListener('DOMContentLoaded', () => {
        populateWidgetLibraryGrid();
      });
    })();
    </script>
  <script>
    // =============================
    // Unified Command System
    // =============================
    (function(){
      // --- Palette Element Helpers ---
      const paletteEl = () => document.getElementById('commandPalette');
      const inputEl = () => document.getElementById('commandInput');
      const resultsEl = () => document.getElementById('commandResults');

      // --- Idempotent Wrappers ---
      window.enterPresentationMode = function(){
        try {
          if (!window.presentationMode && typeof togglePresentationMode === 'function') {
            togglePresentationMode();
          } else {
            document.body.classList.add('presentation-mode');
          }
        } catch(_) { /* noop */ }
      };
      window.exitPresentationMode = function(){
        try {
          if (window.presentationMode && typeof togglePresentationMode === 'function') {
            togglePresentationMode();
          } else {
            document.body.classList.remove('presentation-mode');
            try { if (document.exitFullscreen) document.exitFullscreen(); } catch(_){}
          }
        } catch(_) { /* noop */ }
      };

      window.cycleViewMode = function(){
        try {
          const next = (window.dashboardViewPref === 'charts') ? 'dashboard' : 'charts';
          if (typeof setDashboardViewPreference === 'function') {
            setDashboardViewPreference(next);
          } else {
            window.dashboardViewPref = next;
            try { localStorage.setItem('dashboardView', next); } catch(_){}
          }
          const tip = document.getElementById('viewModeTooltip');
          if (tip) tip.textContent = `View: ${next === 'charts' ? 'Charts' : 'Dashboard'}`;
        } catch(_) { /* noop */ }
      };

      window.openUnifiedSettings = function(){
        try { if (typeof openSettingsPanel === 'function') openSettingsPanel(); } catch(_){}
      };

      window.openWidgetManager = function(){
        try { if (typeof toggleLayoutEditMode === 'function') toggleLayoutEditMode(); } catch(_){}
        try { if (typeof switchSettingsTab === 'function') switchSettingsTab('layout'); } catch(_){}
      };

      // --- Quick Create ---
      window.openQuickCreate = function(){
        const menu = document.getElementById('quickCreateMenu');
        if (!menu) return;
        const hidden = menu.classList.contains('hidden');
        if (hidden) menu.classList.remove('hidden'); else menu.classList.add('hidden');
      };
      document.addEventListener('click', function(e){
        const menu = document.getElementById('quickCreateMenu');
        if (!menu || menu.classList.contains('hidden')) return;
        if (!e.target.closest('#quickCreateMenu') && !e.target.closest('.command-quick-btn')) {
          menu.classList.add('hidden');
        }
      });

      // --- Command Registry ---
      window.COMMAND_REGISTRY = {
        // Widgets & Layout
        'add-widget': { title: 'Add Widget to Dashboard', icon: 'âž•', category: 'Widgets', keywords: ['widget','add','new','create'], action: () => openWidgetManager() },
        'edit-layout': { title: 'Edit Dashboard Layout', icon: 'âœï¸', category: 'Layout', keywords: ['layout','edit','customize'], action: () => toggleLayoutEditMode() },
        'reset-layout': { title: 'Reset Layout', icon: 'ðŸ”„', category: 'Layout', keywords: ['reset','restore','default'], action: () => { try { resetLayout(); } catch(_) { try { resetLayoutConfig(); } catch(_){} } } },

        // View
        'view-dashboard': { title: 'Switch to Dashboard View', icon: 'ðŸ“Š', category: 'View', keywords: ['view','dashboard','widgets'], action: () => setDashboardViewPreference ? setDashboardViewPreference('dashboard') : (window.dashboardViewPref='dashboard') },
        'view-charts': { title: 'Switch to Charts View', icon: 'ðŸ“ˆ', category: 'View', keywords: ['view','charts','analytics'], action: () => setDashboardViewPreference ? setDashboardViewPreference('charts') : (window.dashboardViewPref='charts') },
        'presentation-mode': { title: 'Enter Presentation Mode', icon: 'ðŸŽ¬', category: 'View', keywords: ['presentation','fullscreen','present'], action: () => enterPresentationMode() },
        'presentation-exit': { title: 'Exit Presentation Mode', icon: 'ðŸ›‘', category: 'View', keywords: ['presentation','exit','leave'], action: () => exitPresentationMode() },

        // Theme
        'theme-dark': { title: 'Switch to Dark Theme', icon: 'ðŸŒ™', category: 'Theme', keywords: ['theme','dark'], action: () => changeTheme ? changeTheme('dark') : document.body.classList.add('theme-dark') },
        'theme-light': { title: 'Switch to Light Theme', icon: 'â˜€ï¸', category: 'Theme', keywords: ['theme','light'], action: () => changeTheme ? changeTheme('light') : document.body.classList.remove('theme-dark') },
        'theme-auto': { title: 'Auto Theme (System)', icon: 'ðŸ”„', category: 'Theme', keywords: ['theme','auto','system'], action: () => { try { applyThemeMode('auto'); } catch(_) { /* noop */ } } },

        // Demo Mode Commands
        'demo-mode-enable': { title: 'Enable Demo Mode', icon: 'ðŸŽ­', category: 'Demo', keywords: ['demo','enable','test'], action: () => { if (typeof enableDemoMode === 'function') { enableDemoMode(true); } else { console.log('Demo mode not available'); } } },
        'demo-bruce': { title: 'Demo: Bruce Hockless (Operations Manager)', icon: 'ðŸ”§', category: 'Demo', keywords: ['demo','bruce','operations','ops'], action: () => { if (typeof loadDemoUser === 'function') { loadDemoUser('bruce'); } else if (typeof selectDemoUser === 'function') { selectDemoUser('bruce'); } } },
        'demo-brad': { title: 'Demo: Brad Hudson (Branch Manager)', icon: 'ðŸ“Š', category: 'Demo', keywords: ['demo','brad','branch','manager'], action: () => { if (typeof loadDemoUser === 'function') { loadDemoUser('brad'); } else if (typeof selectDemoUser === 'function') { selectDemoUser('brad'); } } },
        'demo-april': { title: 'Demo: April Wilton (Account Executive)', icon: 'ðŸ’¼', category: 'Demo', keywords: ['demo','april','sales','ae','account'], action: () => { if (typeof loadDemoUser === 'function') { loadDemoUser('april'); } else if (typeof selectDemoUser === 'function') { selectDemoUser('april'); } } },

        // Idle Mode Commands
        'idle-walking-rat': { title: 'Idle Animation: Walking Rat', icon: 'ðŸ€', category: 'Idle', keywords: ['idle','rat','animation','walking'], action: () => { if (typeof startChewMode === 'function') { startChewMode(); } else if (typeof startIdleMode === 'function') { startIdleMode('chew'); } } },
        'idle-spiders': { title: 'Idle Animation: Crawling Spiders', icon: 'ðŸ•·ï¸', category: 'Idle', keywords: ['idle','spider','crawl','animation'], action: () => { if (typeof startSpiderCrawl === 'function') { startSpiderCrawl(); } else if (typeof startIdleMode === 'function') { startIdleMode('spider'); } } },
        'idle-floating': { title: 'Idle Animation: Floating Pests', icon: 'ðŸ', category: 'Idle', keywords: ['idle','float','pests','animation'], action: () => { if (typeof startIdleMode === 'function') { startIdleMode('float'); } } },
        'idle-stop': { title: 'Stop Idle Animations', icon: 'â¹ï¸', category: 'Idle', keywords: ['idle','stop','disable'], action: () => { if (window._idleFun && window._idleFun.stop) { window._idleFun.stop(); } else if (typeof stopIdleMode === 'function') { stopIdleMode(); } } },

        // Interface
        'toggle-sidebar': { title: 'Toggle Sidebar', icon: 'ðŸ§­', category: 'Interface', keywords: ['sidebar','toggle','hide','show'], action: () => toggleSidebar() },
        'open-settings': { title: 'Open Settings', icon: 'âš™ï¸', category: 'Interface', keywords: ['settings','preferences'], action: () => openUnifiedSettings() },

        // Natural Language Commands
        'nl-command': { title: 'Run Natural Language Commandâ€¦', icon: 'ðŸ—£ï¸', category: 'Interface', keywords: ['natural','language','command','ai'], action: () => { try { const q = prompt('Describe what you need (e.g., "Show nearby prospects")'); if (q) window.processNaturalCommand(q); } catch(_){} } }
      };

      // --- Palette Rendering & Behavior ---
      function renderCommands(list){
        const el = resultsEl();
        if (!el) return;
        el.innerHTML = '';
        list.forEach((cmd, idx) => {
          const item = document.createElement('button');
          item.className = 'w-full text-left px-6 py-3 hover:bg-gray-700/60 border-b border-gray-700 flex items-center gap-3';
          item.setAttribute('data-cmd', cmd.id);
          item.innerHTML = `<span class=\"text-xl\">${cmd.icon || 'âŒ˜'}</span><div class=\"flex-1\"><div class=\"text-white\">${cmd.title}</div><div class=\"text-xs text-gray-400\">${cmd.category || ''}</div></div>`;
          item.addEventListener('click', () => executeCommand(cmd.id));
          if (idx === 0) item.classList.add('bg-gray-700/40');
          el.appendChild(item);
        });
      }

      function allCommands(){
        return Object.keys(window.COMMAND_REGISTRY).map(id => ({ id, ...window.COMMAND_REGISTRY[id] }));
      }

      window.openCommandPalette = function(){
        const pal = paletteEl();
        if (!pal) return;
        pal.classList.remove('hidden');
        const cmds = allCommands();
        renderCommands(cmds);
        const inp = inputEl();
        if (inp) { inp.value = ''; setTimeout(() => inp.focus(), 50); }
      };
      window.closeCommandPalette = function(){
        const pal = paletteEl();
        if (pal) pal.classList.add('hidden');
      };

      window.filterCommands = function(q){
        const query = String(q || '').toLowerCase();
        const cmds = allCommands().filter(c => {
          const hay = [c.title, c.category, ...(c.keywords || [])].join(' ').toLowerCase();
          return hay.includes(query);
        });
        renderCommands(cmds);
      };

      window.executeCommand = function(id){
        try {
          const cmd = window.COMMAND_REGISTRY[id];
          if (!cmd || typeof cmd.action !== 'function') return;
          cmd.action();
          closeCommandPalette();
        } catch(e) { console.warn('Command failed:', id, e); }
      };

      window.handleCommandKeydown = function(e){
        if (e.key === 'Escape') return closeCommandPalette();
        if (e.key === 'Enter') {
          const el = resultsEl();
          if (!el) return;
          const first = el.querySelector('[data-cmd]');
          if (first) executeCommand(first.getAttribute('data-cmd'));
        }
      };

      // --- Global Shortcut (Cmd+K) ---
      document.addEventListener('keydown', function(e){
        const isMac = navigator.platform.toUpperCase().includes('MAC');
        const mod = isMac ? e.metaKey : e.ctrlKey;
        if (mod && e.key.toLowerCase() === 'k') {
          e.preventDefault();
          openCommandPalette();
        }
      });
    })();
  </script>
  <script>
    // Command Bar Button Handlers and Notifications
    function showNotification(message, type) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 right-4 z-[999] px-6 py-3 rounded-lg shadow-xl';
      toast.style.background = type === 'success' ? '#10b981' : '#ef4444';
      toast.innerHTML = `<div class=\"text-white\">${message}</div>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function toggleCreateMenu() {
      // Delegates to unified Actions menu
      toggleActionsMenu();
      showNotification('Menus unified: use Actions for all options', 'success');
    }
    document.addEventListener('click', (e) => {
      const btn = document.getElementById('createNewBtn');
      const menu = document.getElementById('createMenu');
      if (!menu) return;
      const insideBtn = btn && e.target.closest('#createNewBtn');
      const insideMenu = e.target.closest('#createMenu');
      if (!insideBtn && !insideMenu) {
        menu.classList.add('hidden');
      }
    });

    function toggleActionsMenu() {
      const menu = document.getElementById('actionsMenu');
      if (!menu) return;
      const other = document.getElementById('createMenu');
      if (other) other.classList.add('hidden');
      menu.classList.toggle('hidden');
    }
    document.addEventListener('click', (e) => {
      const btn = document.getElementById('actionsBtn');
      const menu = document.getElementById('actionsMenu');
      if (!menu) return;
      const insideBtn = btn && e.target.closest('#actionsBtn');
      const insideMenu = e.target.closest('#actionsMenu');
      if (!insideBtn && !insideMenu) {
        menu.classList.add('hidden');
      }
    });

    function switchView(viewType) {
      const dashboardContent = document.getElementById('dashboardContent');
      const chartsContent = document.getElementById('chartsView');
      if (!dashboardContent || !chartsContent) return;
      const current = window.activeView || 'dashboard';
      let next = viewType;
      if (viewType === current) {
        next = current === 'charts' ? 'dashboard' : 'charts';
      }
      if (next === 'charts') {
        dashboardContent.classList.add('hidden');
        chartsContent.classList.remove('hidden');
        showNotification('Switched to Charts view', 'success');
      } else {
        chartsContent.classList.add('hidden');
        dashboardContent.classList.remove('hidden');
        showNotification('Switched to Dashboard view', 'success');
      }
      window.activeView = next;
    }

    function actuallyToggleSidebar() {
      const sidebar = document.querySelector('.sidebar') || document.getElementById('sidebar');
      const main = document.getElementById('mainContent');
      if (sidebar) {
        const isHidden = sidebar.classList.contains('hidden');
        if (isHidden) {
          sidebar.classList.remove('hidden');
          if (main) { main.classList.remove('ml-0'); main.classList.add('ml-64'); }
        } else {
          sidebar.classList.add('hidden');
          if (main) { main.classList.remove('ml-64'); main.classList.add('ml-0'); }
        }
      }
    }

    function openWidgetManager() {
      const modal = document.getElementById('dashboardCustomizerModal');
      if (modal) {
        modal.classList.remove('hidden');
        try { switchSettingsTab('widgets'); } catch(_) {}
        showNotification('Opened Widget Manager', 'success');
      }
    }

  function openSettingsAdminPanel() {
    const source = document.getElementById('settingsModalContainer') || document.getElementById('settingsPanel') || document.querySelector('.settings-panel') || document.getElementById('settingsModal');
    if (window.SlideOutPanel && source) {
      try { SlideOutPanel.openFromElement(source, { title: 'Settings & Admin' }); } catch(_) {}
      try { applySettingsIconVisibility(); } catch(_) {}
      showNotification('Opened Settings & Admin (slide-out)', 'success');
    } else if (source) {
      // Fallback to existing modal behavior
      source.classList.remove('hidden');
      source.style.display = 'block';
      try { applySettingsIconVisibility(); } catch(_) {}
      showNotification('Opened Settings & Admin Panel', 'success');
    }
  }

    // Wrapper: toggle layout editing mode (fallback to existing implementation)
    function toggleLayoutMode() {
      if (typeof toggleLayoutEditMode === 'function') {
        toggleLayoutEditMode();
        showNotification('Layout edit mode toggled', 'success');
      } else {
        showNotification('Layout edit mode not available', 'error');
      }
    }
  </script>
  <script>
    // Phase 2â€“5 Foundations: AppState, Theme, Toasts, Shortcuts, Debug, Smart Defaults

    // Global AppState
    window.AppState = {
      user: {},
      theme: localStorage.getItem('theme') || 'dark',
      layout: {},
      preferences: (() => { try { return JSON.parse(localStorage.getItem('preferences') || '{}'); } catch(_) { return {}; } })(),
      listeners: {},
      update(key, val) { this[key] = val; this.emit('update:' + key, val); this.save(); },
      save() {
        try {
          localStorage.setItem('theme', this.theme);
          localStorage.setItem('preferences', JSON.stringify(this.preferences));
        } catch (_) {}
      },
      on(evt, cb) { (this.listeners[evt] ||= []).push(cb); },
      emit(evt, payload) { (this.listeners[evt] || []).forEach(cb => { try { cb(payload); } catch (_) {} }); }
    };

    // Theme Manager
    class ThemeManager {
      static themes = {
        dark: { '--brand-color': '#e4002b', '--brand-color-dark': '#b30022' },
        light: { '--brand-color': '#e4002b', '--brand-color-dark': '#b30022' }
      };
      static apply(name) {
        const theme = ThemeManager.themes[name] || ThemeManager.themes.dark;
        const root = document.documentElement;
        Object.entries(theme).forEach(([k, v]) => root.style.setProperty(k, v));
        const next = (name === 'dark') ? 'dark' : 'light';
        AppState.update('theme', next);
        showNotification(`Theme applied: ${next}`, 'success');
        // Ensure class-based theme styles are correctly toggled
        try {
          if (typeof changeTheme === 'function') {
            changeTheme(next);
          } else {
            const htmlEl = document.documentElement;
            const bodyEl = document.body;
            htmlEl.className = htmlEl.className.replace(/\btheme-(?:dark|light)\b/g, '').replace(/\s{2,}/g, ' ').trim();
            bodyEl.className = bodyEl.className.replace(/\btheme-(?:dark|light)\b/g, '').replace(/\s{2,}/g, ' ').trim();
            htmlEl.classList.add(`theme-${next}`);
            bodyEl.classList.add(`theme-${next}`);
          }
        } catch(_) {}
        // Also set data-theme for CSS attribute-driven overrides
        try { document.documentElement.setAttribute('data-theme', next); } catch(_) {}
      }
    }

    // Toast Manager (non-disruptive, complements existing showNotification)
    class ToastManager {
      static container;
      static init() {
        if (!ToastManager.container) {
          const c = document.createElement('div');
          c.id = 'toastContainer';
          c.style.position = 'fixed';
          c.style.top = '20px';
          c.style.right = '20px';
          c.style.zIndex = '1000';
          c.style.display = 'flex';
          c.style.flexDirection = 'column';
          c.style.gap = '8px';
          document.body.appendChild(c);
          ToastManager.container = c;
        }
      }
      static show(msg, type = 'info', duration = 2500) {
        ToastManager.init();
        const t = document.createElement('div');
        t.className = 'px-4 py-2 rounded-lg shadow-xl text-white';
        t.style.background = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
        t.textContent = msg;
        ToastManager.container.appendChild(t);
        setTimeout(() => t.remove(), duration);
      }
    }

    // Keyboard Shortcuts
    (function setupKeyboardShortcuts(){
      document.addEventListener('keydown', (e) => {
        const isMac = navigator.platform.toUpperCase().includes('MAC');
        const mod = isMac ? e.metaKey : e.ctrlKey;
        if (mod && e.key.toLowerCase() === 's') { e.preventDefault(); try { if (typeof saveAllSettings === 'function') { saveAllSettings(); } } catch (_) {} showNotification('Settings saved', 'success'); }
        if (mod && e.key.toLowerCase() === 'b') { e.preventDefault(); actuallyToggleSidebar(); }
        if (mod && e.key === '1') { e.preventDefault(); switchView('dashboard'); }
        if (mod && e.key === '2') { e.preventDefault(); switchView('charts'); }
        if (mod && e.key === '3') { e.preventDefault(); switchView('table'); }
        if (mod && e.key.toLowerCase() === 'e') { e.preventDefault(); toggleLayoutMode(); }
      });
    })();

    // Debug Panel (?debug=1)
    (function debugPanelInit(){
      const params = new URLSearchParams(location.search);
      if (params.get('debug') === '1') {
        const panel = document.createElement('div');
        panel.id = 'debugPanel';
        panel.style.position = 'fixed'; panel.style.bottom = '10px'; panel.style.right = '10px';
        panel.style.background = 'rgba(0,0,0,0.7)'; panel.style.color = '#fff'; panel.style.padding = '12px';
        panel.style.border = '1px solid #e4002b'; panel.style.borderRadius = '8px'; panel.style.zIndex = '10000';
        panel.innerHTML = '<div>Debug Panel</div><div id="fpsRow">FPS: --</div><div id="memRow">Memory: n/a</div><div id="errRow">Errors: 0</div>';
        document.body.appendChild(panel);
        let frames = 0; let lastUpdate = performance.now();
        function tick(){ frames++; const now = performance.now(); if (now - lastUpdate > 1000) { document.getElementById('fpsRow').textContent = 'FPS: ' + frames; frames = 0; lastUpdate = now; } requestAnimationFrame(tick); }
        requestAnimationFrame(tick);
        const origErr = console.error; let errCount = 0;
        console.error = function(...args){ errCount++; document.getElementById('errRow').textContent = 'Errors: ' + errCount; origErr.apply(console, args); };
        const safeSetInterval = (fn, ms) => (window.EventRegistry && typeof EventRegistry.setInterval === 'function') ? EventRegistry.setInterval(fn, ms) : setInterval(fn, ms);
        if (performance && performance.memory) {
          safeSetInterval(() => { const m = performance.memory; document.getElementById('memRow').textContent = `Memory: ${(m.usedJSHeapSize/1048576).toFixed(1)}MB`; }, 1500);
        }
      }
    })();

    // Smart Defaults: remember branch/market selections if present
    (function smartDefaults(){
      function bind(id, prefKey){
        const el = document.getElementById(id);
        if (!el) return;
        const saved = localStorage.getItem('pref:' + prefKey);
        if (saved !== null) { try { el.value = saved; } catch(_){} }
        el.addEventListener('change', () => {
          localStorage.setItem('pref:' + prefKey, el.value);
          AppState.preferences[prefKey] = el.value;
          AppState.save();
        });
      }
      bind('branchInput','branch');
      bind('marketSelect','market');
    })();

    // Auto-Update emitters (every 5 minutes)
    (function autoUpdateCounters(){
      const intervalMs = 5 * 60 * 1000;
      const safeSetInterval = (fn, ms) => (window.EventRegistry && typeof EventRegistry.setInterval === 'function') ? EventRegistry.setInterval(fn, ms) : setInterval(fn, ms);
      safeSetInterval(() => { AppState.emit('dashboard:autoUpdate', Date.now()); }, intervalMs);
    })();

    // Idle Loop @30fps (start/stop)
    window.IdleLoop = (function(){
      let running = false; let lastRun = 0; let step = () => {};
      function start(fn){ step = fn || step; if (running) return; running = true; requestAnimationFrame(loop); ToastManager.show('Started idle mode', 'info'); }
      function stop(){ running = false; ToastManager.show('Stopped idle mode', 'info'); }
      function loop(now){ if (!running) return; if (now - lastRun > (1000/30)) { try { step(now); } catch(_) {} lastRun = now; } requestAnimationFrame(loop); }
      return { start, stop };
    })();

    // Theme dropdowns + Save Settings wiring
    function initThemeSelects() {
      const cmdSel = document.getElementById('themeSelectCommand');
      if (cmdSel) {
        cmdSel.value = (window.AppState?.theme) || 'dark';
        cmdSel.addEventListener('change', (e) => ThemeManager.apply(e.target.value));
      }
      const setSel = document.getElementById('themeSelectSettings');
      if (setSel) {
        setSel.value = (window.AppState?.theme) || 'dark';
        setSel.addEventListener('change', (e) => ThemeManager.apply(e.target.value));
      }
    }

    // Settings icons visibility
    function applySettingsIconVisibility() {
      try {
        const hide = (localStorage.getItem('settings.hideIcons') === 'true');
        const container = document.getElementById('settingsModalContainer');
        if (!container) return;
        if (hide) { container.classList.add('hide-settings-icons'); }
        else { container.classList.remove('hide-settings-icons'); }
        // Also apply to global menus like Actions menu
        document.body.classList.toggle('hide-menu-icons', hide);
        const toggle = document.getElementById('settingsHideIconsToggle');
        if (toggle) { toggle.checked = !hide; }
      } catch(_) {}
    }
    function setSettingsIconVisibility(hide) {
      try { localStorage.setItem('settings.hideIcons', hide ? 'true' : 'false'); } catch(_) {}
      applySettingsIconVisibility();
    }

    function saveSettingsFromUI() {
      try {
        if (typeof saveAllSettings === 'function') { saveAllSettings(); }
        if (window.AppState) { window.AppState.save(); }
        if (typeof ToastManager !== 'undefined') { ToastManager.show('Settings saved', 'success'); }
        else { showNotification('Settings saved', 'success'); }
      } catch (err) {
        console.error('Save error:', err);
        if (typeof ToastManager !== 'undefined') { ToastManager.show('Failed to save settings', 'error'); }
        else { showNotification('Failed to save settings', 'error'); }
      }
    }

    document.addEventListener('DOMContentLoaded', () => { initThemeSelects(); applySettingsIconVisibility(); });
  </script>
  <style id="settings-icons-visibility-styles">
    /* Hide previews and decorative icons within the Settings panel when enabled */
    #settingsModalContainer.hide-settings-icons .sidebar-icon-preview { display: none !important; }
    #settingsModalContainer.hide-settings-icons #pestIconDemoList { display: none !important; }
    #settingsModalContainer.hide-settings-icons .data-icon { display: none !important; }
    /* Removed Actions menu icon hide from global rule to preserve Action icons */
    /* Hide icons in the left sidebar navigation when preference is off */
  body.hide-menu-icons #sidebarNav svg.icon { display: none !important; }
  /* Hide PNG/SVG assets from the provided Icons/ folder within sidebar/nav only */
  body.hide-menu-icons #sidebarNav img[src*="Icons/"],
  body.hide-menu-icons #sidebarNav img[src^="/Icons/"],
  body.hide-menu-icons .nav-btn img[src*="Icons/"] {
    display: none !important;
  }
  /* Hide emoji spans used as menu icons in sidebar/nav only */
  body.hide-menu-icons #sidebarNav span.text-xl {
    display: none !important;
  }
    body.hide-menu-icons #sidebarNav span.text-xl[aria-hidden="true"] { display: none !important; }
    body.hide-menu-icons #sidebarNav span.text-xl { display: none !important; }
    body.hide-menu-icons #sidebarNav .inline-flex > span:first-child { display: none !important; }
    body.hide-menu-icons #sidebarNav img[src^="/Icons/"] { display: none !important; }
  </style>
  <style id="modal-glow-resize-styles">
    .modal-container .resize-handle { position: absolute; bottom: 0; right: 0; width: 32px; height: 32px; cursor: nwse-resize; z-index: 10; opacity: 0.6; transition: all 0.2s ease; }
    .modal-container:hover .resize-handle { opacity: 1; }
    .modal-container .resize-handle:hover { transform: scale(1.2); filter: drop-shadow(0 0 8px var(--brand-color)); }
    .modal-container.resizing { user-select: none; }
    .modal-container.resizing .resize-handle { opacity: 1; transform: scale(1.3); filter: drop-shadow(0 0 12px var(--brand-color)); }
    .modal-container { position: relative; --mouse-x: 50%; --mouse-y: 50%; --glow-intensity: 0; }
  .modal-container::before { content: ''; position: absolute; inset: -2px; border-radius: inherit; padding: 2px; background: radial-gradient(600px circle at var(--mouse-x) var(--mouse-y), rgba(228, 0, 43, calc(0.4 * var(--glow-intensity))), transparent 40%); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none; z-index: -1; transition: opacity 0.3s ease; opacity: var(--glow-intensity); }
    .modal-container:hover::before { animation: glowPulse 2s ease-in-out infinite; }
    @keyframes glowPulse { 0%,100% { filter: brightness(1);} 50% { filter: brightness(1.2);} }
    .modal-container::after { content: ''; position: absolute; inset: -20px; border-radius: inherit; background: radial-gradient(800px circle at var(--mouse-x) var(--mouse-y), rgba(228, 0, 43, calc(0.15 * var(--glow-intensity))), transparent 60%); pointer-events: none; z-index: -2; filter: blur(20px); opacity: var(--glow-intensity); }
    .resize-handle::before { content: ''; position: absolute; inset: -4px; border-radius: inherit; background: radial-gradient(circle at center, rgba(228, 0, 43, 0.6), transparent 70%); opacity: 0; transition: opacity 0.2s ease; }
    .resize-handle:hover::before { opacity: 1; animation: glowPulse 1.5s ease-in-out infinite; }
  </style>
  <script>
    function makeModalDraggableAndResizable(modalId, headerId, resizeHandleId) {
      const modal = document.getElementById(modalId);
      const header = document.getElementById(headerId);
      const resizeHandle = document.getElementById(resizeHandleId);
      if (!modal || !header) return;
      let isDragging = false; let dragStartX = 0, dragStartY = 0; let startLeft = 0, startTop = 0;
      header.style.cursor = 'move';
      header.addEventListener('mousedown', (e) => { isDragging = true; dragStartX = e.clientX; dragStartY = e.clientY; const rect = modal.getBoundingClientRect(); startLeft = rect.left; startTop = rect.top; document.body.style.userSelect = 'none'; });
      document.addEventListener('mousemove', (e) => { if (!isDragging) return; const dx = e.clientX - dragStartX; const dy = e.clientY - dragStartY; modal.style.position = 'absolute'; modal.style.left = `${startLeft + dx}px`; modal.style.top = `${startTop + dy}px`; });
      document.addEventListener('mouseup', () => { if (isDragging) { isDragging = false; document.body.style.userSelect = ''; } });
      if (!resizeHandle) return;
      let isResizing = false; let resizeStartX = 0; let resizeStartY = 0; let startWidth = 0; let startHeight = 0;
      resizeHandle.style.display = 'flex'; resizeHandle.style.pointerEvents = 'auto';
      resizeHandle.addEventListener('mousedown', (e) => { e.stopPropagation(); e.preventDefault(); isResizing = true; resizeStartX = e.clientX; resizeStartY = e.clientY; startWidth = modal.offsetWidth; startHeight = modal.offsetHeight; modal.classList.add('resizing'); resizeHandle.style.transform = 'scale(1.3)'; document.body.style.cursor = 'nwse-resize'; });
      document.addEventListener('mousemove', (e) => { if (!isResizing) return; e.preventDefault(); e.stopPropagation(); const deltaX = e.clientX - resizeStartX; const deltaY = e.clientY - resizeStartY; const minWidth = 900; const minHeight = 600; const maxWidth = window.innerWidth - 40; const maxHeight = window.innerHeight - 40; const newWidth = Math.max(minWidth, Math.min(startWidth + deltaX, maxWidth)); const newHeight = Math.max(minHeight, Math.min(startHeight + deltaY, maxHeight)); modal.style.width = newWidth + 'px'; modal.style.height = newHeight + 'px'; });
      document.addEventListener('mouseup', (e) => { if (isResizing) { isResizing = false; e.preventDefault(); e.stopPropagation(); modal.classList.remove('resizing'); resizeHandle.style.transform = ''; document.body.style.cursor = ''; } });
      resizeHandle.addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); });
    }
    function addDynamicGlowEffect(modalId) { const modal = document.getElementById(modalId); if (!modal) return; let glowElement = modal.querySelector('.dynamic-glow'); if (!glowElement) { glowElement = document.createElement('div'); glowElement.className = 'dynamic-glow'; modal.appendChild(glowElement); } modal.addEventListener('mousemove', (e) => { const rect = modal.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; modal.style.setProperty('--mouse-x', `${x}px`); modal.style.setProperty('--mouse-y', `${y}px`); const distanceFromEdge = Math.min(x, y, rect.width - x, rect.height - y); const intensity = Math.max(0, 1 - (distanceFromEdge / 100)); modal.style.setProperty('--glow-intensity', intensity); }); modal.addEventListener('mouseleave', () => { modal.style.setProperty('--glow-intensity', 0); }); }
    document.addEventListener('DOMContentLoaded', () => { makeModalDraggableAndResizable('settingsModalContainer', 'settingsModalHeader', 'settingsResizeHandle'); addDynamicGlowEffect('settingsModalContainer'); makeModalDraggableAndResizable('commandPaletteContainer', 'commandPaletteHeader', 'commandPaletteResize'); addDynamicGlowEffect('commandPaletteContainer'); });
  </script>
  <!-- Accessibility: ensure datalist options have visible text/labels -->
  <script>
    (function() {
      try {
        document.querySelectorAll('datalist option').forEach(opt => {
          const text = (opt.textContent || '').trim();
          if (!text) {
            const val = opt.getAttribute('value') || '';
            opt.textContent = val;
            if (!opt.getAttribute('label')) opt.setAttribute('label', val);
          }
        });
      } catch (_) {}
    })();
  </script>
    <!-- Optional vendor emoji set: Twemoji (jsDelivr) for consistent cross-platform look -->
    <script src="js/eventRegistry.js"></script>
    <script src="js/slideout.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/main.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script>
  <script src="js/proposals.js"></script>
  <script>
    // Phase 5.1: Override legacy sales entry to use new Proposal Form
    window.openSalesEntryForm = function(){
      if (window.showProposalForm) { window.showProposalForm(); }
      else { alert('Proposal form module not loaded'); }
    };
  </script>
</body>
</html>
    <!-- Preload critical icons for crisp DPR rendering -->
    <link rel="preload" as="image" href="/Icons/chart@2x.png">
    <link rel="preload" as="image" href="/Icons/gmail@2x.png">
    <link rel="preload" as="image" href="/Icons/download@2x.png">
    <link rel="preload" as="image" href="/Icons/upload@2x.png">
    <link rel="preload" as="image" href="/Icons/trash@2x.png">
    <link rel="preload" as="image" href="/Icons/warning@2x.png">
